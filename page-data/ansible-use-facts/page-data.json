{"componentChunkName":"component---src-templates-blog-js","path":"/ansible-use-facts/","result":{"data":{"blog":{"id":"3c6e6260-4e97-56d3-b14e-b8891d46612e","html":"<iframe src=\"//player.bilibili.com/player.html?aid=475933411&bvid=BV1MK41197sr&cid=914635147&page=1\" width=\"800\" height=\"640\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n<p>最近在看以前的代码，发现 <code>ansible</code> 的代码里有一些模板是从 <code>ansible</code> 的 <code>vars</code> 生成 <code>/etc/hsots</code> 的代码。这里做了些调研，了解了下用法。这里大量的过程都放到了视频里了，下面的算是笔记吧。</p>\n<h2 id=\"facts-是什么如何收集\" style=\"position:relative;\"><code>facts</code> 是什么，如何收集<a href=\"#facts-%E6%98%AF%E4%BB%80%E4%B9%88%E5%A6%82%E4%BD%95%E6%94%B6%E9%9B%86\" aria-label=\"facts 是什么如何收集 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code>facts</code> 可以理解为 <code>ansible</code> 从主机收集的各种信息，通过如下命令可以看其到底收集了什么：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ansible all <span class=\"token parameter variable\">-i</span> inventory.yaml <span class=\"token parameter variable\">-m</span> gather_facts</code></pre></div>\n<p>通过 <code>ansible-doc gather_facts</code> 可以知道这个行为是在 <code>playbook</code> 执行之处就自动执行的。</p>\n<h2 id=\"如何使用-facts-生成-hosts-文件\" style=\"position:relative;\">如何使用 <code>facts</code> 生成 <code>hosts</code> 文件<a href=\"#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-facts-%E7%94%9F%E6%88%90-hosts-%E6%96%87%E4%BB%B6\" aria-label=\"如何使用 facts 生成 hosts 文件 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code>ansible</code> 帮我们收集的 <code>facts</code> 会放进 <code>vars</code> 里供我们使用。比如 <code>hostvars</code> 这个变量里就有了 <code>facts</code> 的信息，可以通过 <code>debug</code> 来展示这个信息：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Debug hostvars\n    <span class=\"token key atrule\">ansible.builtin.debug</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">var</span><span class=\"token punctuation\">:</span> hostvars</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Debug groups\n    <span class=\"token key atrule\">ansible.builtin.debug</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">var</span><span class=\"token punctuation\">:</span> groups</code></pre></div>\n<p>执行命令 <code>ansible-playbook all -i inventory.yaml generate_hosts.yaml</code> 可以看到其中的内容。</p>\n<p>然后这里我提供一个简单的模板文件 <code>hosts.j2</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{% for host in groups[\"all\"] | sort -%}\n  {% if hostvars[host]['ansible_default_ipv4'] is defined -%}\n    {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host].hostname }}\n  {%- endif %}  \n{% endfor %}</code></pre></div>\n<p>利用如下的 playbook 就可以生成 <code>hosts</code> 文件了（我这里就放到了 home/test 做了个测试，没有实际覆盖 <code>/etc/hosts</code>）。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Test hosts\n    <span class=\"token key atrule\">ansible.builtin.blockinfile</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /home/ubuntu/test\n      <span class=\"token key atrule\">marker</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"# -----{mark} NODES IN CLUSTER-----\"</span>\n      <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">block</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ lookup('template', 'templates/hosts.j2') }}\"</span></code></pre></div>\n<h2 id=\"补充-inventoryyaml\" style=\"position:relative;\">补充 <code>inventory.yaml</code><a href=\"#%E8%A1%A5%E5%85%85-inventoryyaml\" aria-label=\"补充 inventoryyaml permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">virtualmachines</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">vars</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ansible_user</span><span class=\"token punctuation\">:</span> ubuntu\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">vm01</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ansible_host</span><span class=\"token punctuation\">:</span> 106.75.236.174\n      <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> vm01\n    <span class=\"token key atrule\">vm02</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ansible_host</span><span class=\"token punctuation\">:</span> 113.31.107.13\n      <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> vm02</code></pre></div>\n<p>可以看到这里给每个 <code>vm</code> 配了一个 <code>hostname</code> 然后在 <code>hostvars</code> 里也能拿到的。</p>\n<h2 id=\"参考资料\" style=\"position:relative;\">参考资料<a href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\" aria-label=\"参考资料 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://ttl255.com/jinja2-tutorial-part-3-whitespace-control/\">Jinja2 template white space control</a></li>\n</ul>","tableOfContents":"<ul>\n<li><a href=\"#facts-%E6%98%AF%E4%BB%80%E4%B9%88%E5%A6%82%E4%BD%95%E6%94%B6%E9%9B%86\"><code>facts</code> 是什么，如何收集</a></li>\n<li><a href=\"#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-facts-%E7%94%9F%E6%88%90-hosts-%E6%96%87%E4%BB%B6\">如何使用 <code>facts</code> 生成 <code>hosts</code> 文件</a></li>\n<li><a href=\"#%E8%A1%A5%E5%85%85-inventoryyaml\">补充 <code>inventory.yaml</code></a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\">参考资料</a></li>\n</ul>","frontmatter":{"title":"使用 ansible 的 facts 生成 hosts 信息","date":"December 06, 2022","tags":["ansible"]},"excerpt":"最近在看以前的代码，发现 ansible 的代码里有一些模板是从 ansible 的 vars 生…"}},"pageContext":{"id":"3c6e6260-4e97-56d3-b14e-b8891d46612e"}},"staticQueryHashes":["26522286"],"slicesMap":{}}
{
    "componentChunkName": "component---src-templates-blog-js",
    "path": "/kubernetes-certs-renew",
    "result": {"data":{"blog":{"id":"ab7349fa-d565-51c5-8f7f-0890065a2f93","html":"<h2 id=\"简单记录\" style=\"position:relative;\">简单记录<a href=\"#%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95\" aria-label=\"简单记录 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>k8s 为了鼓励大家更新，其 kubeadm 默认的证书有效期为 1 年，任何 k8s 版本的更新都会触发证书的更新。如果证书过期了可以按照如下方式处理：</p>\n<ol>\n<li>如果发现自己本地 kubectl 无法访问集群并报错就很有可能是证书过期了，登陆任意一台 master 执行命令 <code>kubeadm certs check-expiration</code> 可以查看证书的有效期，如果报错没有命令 <code>certs</code> 那么可以尝试命令 <code>kubeadm alpha certs ...</code></li>\n<li>过期后可以用命令 <code>kubeadm certs renew all</code> 更新所有证书</li>\n<li>更新后需要将 <code>/etc/kubernetes/manifests/</code> 挪走，比如重命名为 <code>manifests.1</code> 20 秒以上，等待 static pod 全部都关闭了，然后重命名回来，这个步骤就是强迫所有的 static pod 重启，<a href=\"https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#manual-certificate-renewal\">官网文档</a> 就是这么建议操作的</li>\n<li>如果是 HA 高可用模式，那么需要将每一台 master 都这么操作一下</li>\n<li>将新的 <code>/etc/kubernetes/admin.conf</code> 拷贝到自己的电脑，并将其其中的 api-server 的访问地址修改成从自己电脑可以访问的地址即可，然后具体的管理可以参考 <a href=\"/kubeconfig-management\">维护一大堆 kubeconfig 的一些实践</a></li>\n</ol>\n<h2 id=\"更好的办法\" style=\"position:relative;\">更好的办法<a href=\"#%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%8A%9E%E6%B3%95\" aria-label=\"更好的办法 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这样做现在并不是最好的方法，目前可以改进的方式有如下几个：</p>\n<ol>\n<li>按照官方推荐，更频繁的升级 k8s 避免自己的集群版本掉队到无法维护，这应该是最好的方法，当然听起来成本也高一些</li>\n<li>简单粗暴，修改对应版本的 kubeadm 源码，将 renew 时间改成什么 100 年之类的，然后用这个编译的版本去 renew 就是 100 年有效期了</li>\n<li><a href=\"https://github.com/fanux/sealos\">https://github.com/fanux/sealos</a> <strong>可能是不错的方案，具体还没看</strong></li>\n</ol>\n<h2 id=\"资料\" style=\"position:relative;\">资料<a href=\"#%E8%B5%84%E6%96%99\" aria-label=\"资料 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li><a href=\"https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/\">Certificate Management with kubeadm</a></li>\n<li><a href=\"https://cloud.tencent.com/developer/article/1650657\">kubeadm 集群修改证书时间到 99 年</a></li>\n</ol>","tableOfContents":"<ul>\n<li><a href=\"#%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95\">简单记录</a></li>\n<li><a href=\"#%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%8A%9E%E6%B3%95\">更好的办法</a></li>\n<li><a href=\"#%E8%B5%84%E6%96%99\">资料</a></li>\n</ul>","frontmatter":{"title":"处理 k8s 证书过期","date":"January 18, 2022","tags":["devops","kubernetes","kubeadm"]},"excerpt":"简单记录 k8s 为了鼓励大家更新，其 kubeadm 默认的证书有效期为 1 年，任何 k8s …"}},"pageContext":{"id":"ab7349fa-d565-51c5-8f7f-0890065a2f93"}},
    "staticQueryHashes": ["4202924991"]}
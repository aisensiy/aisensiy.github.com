{
    "componentChunkName": "component---src-templates-blogs-js",
    "path": "/page/8",
    "result": {"data":{"site":{"siteMetadata":{"title":"eisen-s-blog"}},"blogs":{"nodes":[{"id":"9ed405fc-55bf-5469-b5a6-8c0d70dcf561","frontmatter":{"title":"Real World 的 GraphQL 版本","date":"2021 June-16"},"html":"<p>在很久之前的一篇 <a href=\"/real-world-spring-boot-and-mybatis\">文章</a> 介绍了我做的一个 <a href=\"https://github.com/gothinkster/spring-boot-realworld-example-app\">RealWorld 的 SpringBoot + MyBatis</a> 的实现。这个项目我也一直在维护，一方面是因为这是一个很好的 demo 项目，可以很好的体现一些设计思路 <a href=\"/real-world-spring-boot-and-mybatis\">文章</a> 也都说了不再重复。另一方面，我觉得也是一个新人练手不错的选择，可以让大家可以通过这个项目来入门。</p>\n<p>最近在做 GraphQL 的调研和测试，我第一个想到的就是把这个项目添加上 GraphQL 的接口，一方面可以熟悉 GraphQL 的体系，另一方面也是个很好的机会去验证下是不是 REST 层是按照 <a href=\"https://alistair.cockburn.us/Hexagonal+architecture\">六边形架构</a> 或者说是 <a href=\"https://www.infoq.com/news/2014/10/ddd-onion-architecture\">洋葱架构</a> 那样子做成的是薄薄的一层，可以轻易的被替换掉。</p>\n<h2 id=\"对-api-层与-application-层做重构\" style=\"position:relative;\">对 api 层与 application 层做重构<a href=\"#%E5%AF%B9-api-%E5%B1%82%E4%B8%8E-application-%E5%B1%82%E5%81%9A%E9%87%8D%E6%9E%84\" aria-label=\"对 api 层与 application 层做重构 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>当然，api 层和 application 层一点都不修改就能添加 GraphQL 是不可能的。主要是因为之前有不少的逻辑写在了 SpringBoot 的 Controller 里面了。那么这一部分的工作基本就是把大量放在 Controller 的代码挪动到 application 层。</p>\n<h2 id=\"确认-graphql-的-schema\" style=\"position:relative;\">确认 GraphQL 的 schema<a href=\"#%E7%A1%AE%E8%AE%A4-graphql-%E7%9A%84-schema\" aria-label=\"确认 graphql 的 schema permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>然后就需要按照 REST api 提供一个对等的 GraphQL 的 schema 了。这里参考的是 <a href=\"https://github.com/thebergamo/realworld-graphql/blob/master/data/schema.graphql\">https://github.com/thebergamo/realworld-graphql/blob/master/data/schema.graphql</a> 。</p>\n<blockquote>\n<p>Real World 似乎对 GraphQL 这部分的工作不太上心，这个东西已经挺久的了，但是官方并没有很好的支持。</p>\n</blockquote>\n<p>不过它这个 schema 明显有两个问题：</p>\n<ol>\n<li>少了 <code>unfavoriteArticle</code> 的 <code>Mutation</code></li>\n<li><code>deleteArticle</code> 返回了错误的结果，明明应该是 <code>DeletionStatus</code></li>\n</ol>\n<p>用 <a href=\"https://apis.guru/graphql-voyager/\">https://apis.guru/graphql-voyager/</a> 做展示基本就是这个样子：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/94ea71f61f1d7c04895366a54ea95552/73dae/2021-06-16-19-22-23.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQoz3VS227bMAz1///OsBXYw4A+7DHt2rTGmqQXX2TJlzjzXbIkn4FsUiRDR4CgREmH1DkM8I8ty4L/5Sg67zFbB++Xizzt/bIg+OyhsQ7NOKGdNAOQzdby+WMs8HW1xqsqsHgP69xF8eAcyB/jVih+9O02hNgf4L2HmWc+S1WOjchRtQOss5i0QdV0uI9S/BYKAYGdO1m1r5EIgViVODQdd0mAozZIpUK42aJpu4+u0qLE9d0Dft4/fv5lmRcINxs8xwliqfCn69H0A4y1DKSKEpPW3DlZ23V4SxJEaYag04b5osvEB7ksSwZKpEJZH+Aoby2GaWKfjEE7DGi6Hu0wIhISu9cX7GSF4PvNGl9WazxlBbx3zKPMc2RFgZc4Qd/32KoSV79CFM37N6moPwoyThrDpHlN6gepEJB1g6xuoY15r94P6IYR/Tiyursoxip8Qr4/MC2UIydBKF6o/CYyPMsSoqqZl56+P898UR+V3aYZftyusT926ByJZDmeuD954Lh1+0EwDykPqmenfVpWuIsytKNmPk8zeQ52Wv8FjwgDL6/mN3wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 06 16 19 22 23\"\n        title=\"2021 06 16 19 22 23\"\n        src=\"/static/94ea71f61f1d7c04895366a54ea95552/5a190/2021-06-16-19-22-23.png\"\n        srcset=\"/static/94ea71f61f1d7c04895366a54ea95552/772e8/2021-06-16-19-22-23.png 200w,\n/static/94ea71f61f1d7c04895366a54ea95552/e17e5/2021-06-16-19-22-23.png 400w,\n/static/94ea71f61f1d7c04895366a54ea95552/5a190/2021-06-16-19-22-23.png 800w,\n/static/94ea71f61f1d7c04895366a54ea95552/c1b63/2021-06-16-19-22-23.png 1200w,\n/static/94ea71f61f1d7c04895366a54ea95552/29007/2021-06-16-19-22-23.png 1600w,\n/static/94ea71f61f1d7c04895366a54ea95552/73dae/2021-06-16-19-22-23.png 2122w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>schema 在 <a href=\"https://github.com/gothinkster/spring-boot-realworld-example-app/blob/master/src/main/resources/schema/schema.graphqls\">https://github.com/gothinkster/spring-boot-realworld-example-app/blob/master/src/main/resources/schema/schema.graphqls</a> 可以看到。</p>\n<p>可以看到 GraphQL 的 schema 是一张图，有点像是数据库的 <a href=\"https://www.guru99.com/er-diagram-tutorial-dbms.html\">ER Diagram</a>。不过很显然，GraphQL 的关系肯定不是数据库级别的 CRUD 而是一个业务层级的关联图：</p>\n<ol>\n<li><code>User</code> 的 <code>Profile</code> 下可以有很多 <code>Article</code> 的视图 <code>favorites</code> <code>feed</code>；</li>\n<li><code>Article</code> 则有其自己的全量属性：<code>author</code> <code>comments</code>；</li>\n<li><code>Comment</code> 也有自己的 <code>article</code> <code>author</code>；</li>\n</ol>\n<p>这部分让我想起来 DDD 书中提到的 Domain Model 对象之间的关联关系（第五章 A Model Expressed in Software）。和 REST 相比，通过 GraphQL 所组织的 schema 有更好的整体性和一致性。当然，这也有可能是它的缺点：它缺少了 REST 的那种随便搞个接口的灵活性。</p>\n<h2 id=\"增加-graphql-的代码\" style=\"position:relative;\">增加 GraphQL 的代码<a href=\"#%E5%A2%9E%E5%8A%A0-graphql-%E7%9A%84%E4%BB%A3%E7%A0%81\" aria-label=\"增加 graphql 的代码 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这里的实现采用了 <a href=\"https://netflix.github.io/dgs/\">Netflix DGS</a> 这个框架，很符合 SpringBoot 的设计逻辑，并且最近也一直在密集的更新中。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 252px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADr0lEQVQ4y42US4sjZRSGa6W/wP/hD9CFy1Zw4V4QFJcOggj+AXcDDjS0LYggyDCrsRGXIoyDdifpJJWq3FNJVZK635KqXLodh1fe0/2lkxkGXbw53y3ne+pcPk379A+89tlfeP3eOd78Wsc735h4+76Bt+4beOPLKrSPnkD75Cm0j/+n3j/t4L2TNj74foAvzqb46lcX9x7P8PnPc3z40wRHpwO8e9rH0UkXR9/2/lPa8+sV/l4vsS0y5GmMbqeNYb+LXsfEsGtiavVkD8+vgGcb4Nn2Zf1zJy3NckRxgqwowPF0NoPrerAdB3PXg+v5yBdLrNYblKv1gbhWlCvZXywLkRaEIWa2jfaDY1iVKsxeD61WC6ZpiqXq9ToqlQr0VgvNZhPtdlv2dV3HaDRCHMeIokik8cfzPLhNHcF0holtw7IsDAYDOUz1ej0Mh0MZ03K/3++L48lkgjRNkSSJSCuKAkkUwXr4CGF/AMd1MbYs2LaN8XgsThzHwdgaiw3DUKzruthsNqKyLLFarUTiME0SBOcVxCR0HLlV0ShLYl4wn8+FjpR0cHV1JaLjG4dliTSO4Zz9gtgaY+77NyFwXfi+Lw54AcckoyOuUTw3m80wnU7ls+n0hjBO4P72OxJ+mm0LlYqjouNat9uVeHKuiDlnLHnhncMkgffkKbL5HHGaylwFmRnkYSaPFMrmeS77tNfX1y98chTDfnyGaDhCnySdjtDw5k6nA72pwzAMKROWEddIxhLiWCXkLilpCv/8AinjFoaIo2hXW8wqSTjOskzE87Tb7XZHtl6vRULIshk/fASv3UG1XpebWbiXl5ciUpFWiWuMn3KmHB4QRrqBPAiQ5TmWy6UQkoL7nHO8WCzE8o9c55w1qJztYpiEEUY//AjXMKGTwjRxcXEhLUe6arUqajQau7ZkPLnGUuKnK0ohlLiMLBQkKku5XREokYRW7ZFadYgivIthGGJw8h1mjSb+rFRQrVRQq9Uks6TgmLS0Kssqzvufe0CY2Q6KLD+gym/jqepO0al4Uq8k7D04xrzRRI03G4bUGYlomVVmlzGkVSXCLO87OyBceD6WiwXSLBMq3k5LMsaKZzjmOpPAB2Hf2cuExyfw9BY6gwFq1equKxgrRcY5e5t77CTCvJIwHU9Q5gskaSqlwDoMgkDsfl+rDuLefg0edsotoW+YQsg6NPdEMhLxGWOG+dIoB/vOdoQ5CS0LyySBHwTy1rGH/du3kZZEtHwnufZihyiH/wLy0wNdJDaQBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 06 16 20 03 53\"\n        title=\"2021 06 16 20 03 53\"\n        src=\"/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png\"\n        srcset=\"/static/106be036b30c8ae5022ab6f9fafc3496/772e8/2021-06-16-20-03-53.png 200w,\n/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png 252w\"\n        sizes=\"(max-width: 252px) 100vw, 252px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>从文件组织上看，每个 Entity 或者是 EntityList 可以组织一个 Datafetcher 提供给具体某一个 <code>Query</code> 下的特定 type 的查询。而针对某个 Entity 的 Mutation 可以放到一起？这部分不太确定，可能还是刚刚开始做，感受不是很明显。</p>\n<h3 id=\"对于-nested-query-的处理\" style=\"position:relative;\">对于 nested query 的处理<a href=\"#%E5%AF%B9%E4%BA%8E-nested-query-%E7%9A%84%E5%A4%84%E7%90%86\" aria-label=\"对于 nested query 的处理 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>既然是一张图，那么查询就可以是一个树，比如可以有这么一个查询：</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token object\">me</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token object\">profile</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token object\">articles</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token object\">edges</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token object\">node</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token object\">comments</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token object\">edges</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token object\">node</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token property\">body</span>\n                <span class=\"token punctuation\">}</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>获取当前用户的 <code>articles</code> 并且包含它的 <code>comment</code> 的 <code>body</code>。类似的问题在 <a href=\"https://netflix.github.io/dgs/advanced/context-passing/\">Nested data fetchers</a> 有做一些阐述。而我这个例子就是遇到了 <a href=\"https://netflix.github.io/dgs/advanced/context-passing/#no-showid-use-local-context\">https://netflix.github.io/dgs/advanced/context-passing/#no-showid-use-local-context</a> 这部分阐述的情况，需要自己创建一个 Map 并放到 localContext 中做传递。具体的代码如下：</p>\n<p><code>ArticleDatafetcher.java</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>spring<span class=\"token punctuation\">.</span>graphql</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token annotation punctuation\">@DgsComponent</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ArticleDatafetcher</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token annotation punctuation\">@DgsData</span><span class=\"token punctuation\">(</span>parentType <span class=\"token operator\">=</span> PROFILE<span class=\"token punctuation\">.</span>TYPE_NAME<span class=\"token punctuation\">,</span> field <span class=\"token operator\">=</span> <span class=\"token class-name\">PROFILE<span class=\"token punctuation\">.</span>Articles</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticlesConnection</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">userArticles</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      <span class=\"token class-name\">DgsDataFetchingEnvironment</span> dfe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">User</span> current <span class=\"token operator\">=</span> <span class=\"token class-name\">SecurityUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Profile</span> profile <span class=\"token operator\">=</span> dfe<span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">CursorPager</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticleData</span><span class=\"token punctuation\">></span></span> articles<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token class-name\"><span class=\"token namespace\">graphql<span class=\"token punctuation\">.</span>relay<span class=\"token punctuation\">.</span></span>PageInfo</span> pageInfo <span class=\"token operator\">=</span> <span class=\"token function\">buildArticlePageInfo</span><span class=\"token punctuation\">(</span>articles<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">ArticlesConnection</span> articlesConnection <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">ArticlesConnection</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">pageInfo</span><span class=\"token punctuation\">(</span>pageInfo<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">edges</span><span class=\"token punctuation\">(</span>\n                articles<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n                        a <span class=\"token operator\">-></span>\n                            <span class=\"token class-name\">ArticleEdge</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">cursor</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">getCursor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">node</span><span class=\"token punctuation\">(</span><span class=\"token function\">buildArticleResult</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticlesConnection</span><span class=\"token punctuation\">></span></span><span class=\"token function\">newResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>articlesConnection<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">localContext</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 这里将 slug : article 的 map 传递到下一个层级了</span>\n            articles<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArticleData</span><span class=\"token operator\">::</span><span class=\"token function\">getSlug</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">-></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><code>CommentDatafetcher.java</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>spring<span class=\"token punctuation\">.</span>graphql</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token annotation punctuation\">@DgsComponent</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommentDatafetcher</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token annotation punctuation\">@DgsData</span><span class=\"token punctuation\">(</span>parentType <span class=\"token operator\">=</span> ARTICLE<span class=\"token punctuation\">.</span>TYPE_NAME<span class=\"token punctuation\">,</span> field <span class=\"token operator\">=</span> <span class=\"token class-name\">ARTICLE<span class=\"token punctuation\">.</span>Comments</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CommentsConnection</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">articleComments</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      <span class=\"token class-name\">DgsDataFetchingEnvironment</span> dfe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> last <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"first 和 last 必须只存在一个\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">User</span> current <span class=\"token operator\">=</span> <span class=\"token class-name\">SecurityUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Article</span> article <span class=\"token operator\">=</span> dfe<span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ArticleData</span><span class=\"token punctuation\">></span></span> map <span class=\"token operator\">=</span> dfe<span class=\"token punctuation\">.</span><span class=\"token function\">getLocalContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取 map</span>\n    <span class=\"token class-name\">ArticleData</span> articleData <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">.</span><span class=\"token function\">getSlug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 使用 slug 获取具体的 ArticleData</span>\n\n    <span class=\"token class-name\">CursorPager</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CommentData</span><span class=\"token punctuation\">></span></span> comments<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token class-name\"><span class=\"token namespace\">graphql<span class=\"token punctuation\">.</span>relay<span class=\"token punctuation\">.</span></span>PageInfo</span> pageInfo <span class=\"token operator\">=</span> <span class=\"token function\">buildCommentPageInfo</span><span class=\"token punctuation\">(</span>comments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">CommentsConnection</span> result <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">CommentsConnection</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">pageInfo</span><span class=\"token punctuation\">(</span>pageInfo<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">edges</span><span class=\"token punctuation\">(</span>\n                comments<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n                        a <span class=\"token operator\">-></span>\n                            <span class=\"token class-name\">CommentEdge</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">cursor</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">getCursor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">node</span><span class=\"token punctuation\">(</span><span class=\"token function\">buildCommentResult</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CommentsConnection</span><span class=\"token punctuation\">></span></span><span class=\"token function\">newResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">localContext</span><span class=\"token punctuation\">(</span>\n            comments<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommentData</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> c <span class=\"token operator\">-></span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 这里同样传递了一个 id : comment 的 map 到下一个层级</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>这种传递 map 的方式也算是官方指定的最佳实践了吧，并且基本不可或缺。因为很多时候 <code>Source</code> 和实际从 <code>Application</code> 层传递的 DTO 的类型就是不一样的，可能缺了不少数据。</p>\n<h2 id=\"效果\" style=\"position:relative;\">效果<a href=\"#%E6%95%88%E6%9E%9C\" aria-label=\"效果 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>只要 Application 层保证重用并且捋清楚了 DataFetcher 之间的数据传递关系，后面做起来感觉就一马平川了，毕竟这也不是一个什么很大很复杂的项目。</p>\n<p>完成之后感觉这种网状关系的调用体验还是很好的，感觉对 API 的调用方来说，一旦熟悉了这种模式就可以更容易的组合各种比较复杂的视图，而不会像 REST 那样担心大量的手工数据组合。</p>\n<h2 id=\"开发过程中的一些小问题\" style=\"position:relative;\">开发过程中的一些小问题<a href=\"#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E9%97%AE%E9%A2%98\" aria-label=\"开发过程中的一些小问题 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li>Intellij 对 GraphQL 本身的支持还不够好</li>\n<li>Dgs 是个比较新的框架，加上国内似乎很少有做类似东西的人，资料很少</li>\n<li>RealWorld 本身对 GraphQL 的推进也很慢，后续我应该会增加英文版本的 ReadME 介绍 GraphQL 这部分的工作，并且希望可以有前端做支持</li>\n</ol>","fields":{"slug_without_date":"/graphql-example"}},{"id":"9e07605d-cff2-5cdf-ade2-d48be6dcce67","frontmatter":{"title":"Github Actions 的一些使用体会","date":"2021 May-11"},"html":"<h2 id=\"2021-年-7-月更新\" style=\"position:relative;\">2021 年 7 月更新<a href=\"#2021-%E5%B9%B4-7-%E6%9C%88%E6%9B%B4%E6%96%B0\" aria-label=\"2021 年 7 月更新 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<blockquote>\n<p>随着最近又更深入的使用了 Github Actions 对其又有了一些新的认识。这里对原来的一些些观点做一些补充。</p>\n</blockquote>\n<p>再之前的一篇 <a href=\"/github-actions\">文章</a> 对 github actions 做了一些简单的介绍，距离上次记录已经超过半年的时间了，在这段时间我们逐渐将大部分的 circleci 执行的 ci/cd 内容挪动到 github actions 了。这里在对目前的一些使用体会做一个记录。</p>\n<h2 id=\"good-part\" style=\"position:relative;\">Good part<a href=\"#good-part\" aria-label=\"good part permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>github actions 配合 github 自身的 api 可以玩出很多花样，把很多手工的工作都变成自动化的流程，确实节省了不少时间。其实每个东西都没什么复杂的，这里主要是罗列和记录吧。</p>\n<h3 id=\"依据标签自动发布-release\" style=\"position:relative;\">依据标签自动发布 release<a href=\"#%E4%BE%9D%E6%8D%AE%E6%A0%87%E7%AD%BE%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83-release\" aria-label=\"依据标签自动发布 release permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>首先，我们通常都需要在打 tag 的时候搞出来一个发布。github actions 可以在 push tag 的时候触发相应的流程，实现这个功能。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b2e3ed895967bbe447329d0a8784a75/6da96/2021-05-15-12-58-38.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABO0lEQVQoz5WS627DIAyF+/5vuO3P1ksGuJgAwcQmwJS0U7eu0rZPlixkjo9leWcme044l/ruSsxL7731v7ITESIalHk9qBBpI6/MnOZGmbdHJsqt3bfdTYl8iMwy89L/yW6ptbWWpQ4oLLW3K+v83+hb3Kqr+JKWWnnjf86XlIjelYpxuhh+/VHbGq33T/P+zXkrNIuotUF01qJ1zo0jOkREF8iOZIOAL2dfwBeMJXOdpd3EwzA8Pb+8vu2VUscB3gY8ar9X09FMBz3tTQZfxmnBwJE4c81cb2JE1AbcOIYYfQjCzLJk6XNps/Qsq9UsLXMppdyPDQBaaWMAAE6nk1L61/1dFyYi1iIAGIC0XUlK6aGgPRQbA1obi0hEUsrPe3rsfN22tQYA3WitBTiPkX2qgRafrhFzvev3AYHX95PjAqa4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 05 15 12 58 38\"\n        title=\"2021 05 15 12 58 38\"\n        src=\"/static/6b2e3ed895967bbe447329d0a8784a75/5a190/2021-05-15-12-58-38.png\"\n        srcset=\"/static/6b2e3ed895967bbe447329d0a8784a75/772e8/2021-05-15-12-58-38.png 200w,\n/static/6b2e3ed895967bbe447329d0a8784a75/e17e5/2021-05-15-12-58-38.png 400w,\n/static/6b2e3ed895967bbe447329d0a8784a75/5a190/2021-05-15-12-58-38.png 800w,\n/static/6b2e3ed895967bbe447329d0a8784a75/6da96/2021-05-15-12-58-38.png 922w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Java CI\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'**'</span>\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'v*'</span> <span class=\"token comment\"># Push events to matching v*, i.e. v1.0, v20.15.10</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'**'</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">-</span>hosted\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"! contains(github.event.head_commit.message, '[ci skip]')\"</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Prepare release\n      <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> startsWith(github.ref<span class=\"token punctuation\">,</span> 'refs/tags/')\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">CURRENT_TAG</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.version_tag.outputs.VERSION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        cp build/libs/openbayes-server-0.0.1-SNAPSHOT.jar app.jar\n        docker run -v \"$PWD\":/workdir quay.io/git-chglog/git-chglog $CURRENT_TAG > CHANGELOG.md</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Release\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> softprops/action<span class=\"token punctuation\">-</span>gh<span class=\"token punctuation\">-</span>release@v1\n      <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> startsWith(github.ref<span class=\"token punctuation\">,</span> 'refs/tags/')\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">body_path</span><span class=\"token punctuation\">:</span> CHANGELOG.md\n        <span class=\"token key atrule\">files</span><span class=\"token punctuation\">:</span> app.jar\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>如上所示，最后两个 step 分别是准备要发布的内容以及执行实际的发布：</p>\n<ol>\n<li>这是一个 java 的项目，我将 build 出来的 jar 作为一个 asset 重命名成 <code>app.jar</code> 。然后使用工具 <a href=\"https://github.com/git-chglog/git-chglog\">git-chglog</a> 生成当前 tag 的 changelog 保存到 <code>CHANGELOG.md</code> 中。</li>\n<li>使用一个第三方的 github action <a href=\"https://github.com/softprops/action-gh-release\">softprops/action-gh-release</a> 用来创建一个 release 其实就是调用了 github 的 api 创建了一个 release 罢了。具体怎么做看文档就好。</li>\n</ol>\n<h3 id=\"goreleaser-与-ghr-的帮助\" style=\"position:relative;\">goreleaser 与 ghr 的帮助<a href=\"#goreleaser-%E4%B8%8E-ghr-%E7%9A%84%E5%B8%AE%E5%8A%A9\" aria-label=\"goreleaser 与 ghr 的帮助 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>同样是在打 tag 的时候做一个发布，openbayes 的命令行工具要做的事情就会多不少：</p>\n<ol>\n<li>作为一个需要别人下载的东西，我们需要对国内提供比较好的访问速度</li>\n<li>作为一个私有仓库，我们需要同时将 release 放到另外的公有仓库里</li>\n<li>我们需要更新 homebrew 的源以保证用户通过 homebrew 安装的时候是最新的版本</li>\n</ol>\n<p>由于这个项目是 golang 开发的，我们使用了一个名为 <a href=\"https://github.com/goreleaser/goreleaser\">goreleaser</a> 的工具。它能够帮助我们完成如下事情：</p>\n<ol>\n<li>构建针对不同操作系统的二进制文件并提供 checksum 文件</li>\n<li>更新对应的 homebrew 仓库</li>\n<li>将代码上传到一个国内访问速度比较快的对象存储上，见<a href=\"https://goreleaser.com/customization/blob/\">Blobs</a></li>\n</ol>\n<p>使用 goreleaser 的 <a href=\"https://github.com/goreleaser/goreleaser-action\">action</a> 就可以完成以上三个事情。但是除此之外，我们还需要发布到另外一个公开的仓库里。</p>\n<p>本想继续采用上面的那个 <code>action-gh-release</code> 无奈这个东西有个 bug：虽然它允许指定另外一个仓库作为发布的仓库，但是在发布前它居然会检查自己以这个名字命名的 release 是否存在（而不是去检查要发布的仓库的 release 是否存在），所以我们就继续采用了 <a href=\"https://github.com/tcnksm/ghr\">ghr</a> 这个古老的东西。</p>\n<p><strong>注意</strong> 在将东西发布到其他仓库的时候，github action 所提供的默认的 GITHUB_TOKEN 是不够的：它不具备操纵其他仓库的权限。需要自己创建一个新的 token 并通过 env 传递过来。文档见 <a href=\"https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token\">Creating a personal access token\n</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Release to other repository\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GH_PAT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># 这里就是一个自己创建的 TOKEN 了</span>\n        <span class=\"token key atrule\">CURRENT_TAG</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.version_tag.outputs.VERSION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        ...\n        go get -u github.com/tcnksm/ghr\n        ghr -u signcl -r bayes-releases -body=\"$(cat tmpDist/CHANGELOG.md)\" $CURRENT_TAG dist</span></code></pre></div>\n<p>这里在吐槽一下 gitee 的 api。最开始我们是将命令行工具发布到 gitee 的一个仓库的，采用 github action 后也想通过 gitee 的 api 去创建相应的发布到 gitee 对应的仓库。无奈 gitee 的仓库居然只有创建一个空 release 的接口，<strong>而没有向 release 里面提供额外 assets 的接口</strong>，相当于这 api 就只做了一半而已，询问客服也没什么结果（不过起码有人回复），并且我们也不希望通过模拟表单提交的方式去做了，毕竟也不是非要发布到 gitee 上，最终还是采用了将二进制文件放到国内对象存储的方案。</p>\n<h3 id=\"同步到-gitee\" style=\"position:relative;\">同步到 gitee<a href=\"#%E5%90%8C%E6%AD%A5%E5%88%B0-gitee\" aria-label=\"同步到 gitee permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>由于 github 在国内的访问不是很稳定，但是我们有一些样例项目希望其他人可以 git clone 去尝试，那么就有这种将 github 的项目同步到 gitee 以提升可访问性的需求：</p>\n<ol>\n<li>去 gitee 创建一个 access token</li>\n<li>在 github 每次 push 的时候都触发一个 github action 将 commit 主动 push 到 gitee 那边的仓库就好了</li>\n</ol>\n<p>这里我直接使用了 <a href=\"https://github.com/wangchucheng/git-repo-sync\">https://github.com/wangchucheng/git-repo-sync</a> 这个 action 看里面的代码也就是这么个流程。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sync<span class=\"token punctuation\">-</span>gitee\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'**'</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">sync</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Git Repo Sync\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">fetch-depth</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> wangchucheng/git<span class=\"token punctuation\">-</span>repo<span class=\"token punctuation\">-</span>sync@v0.1.0\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">target-url</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.REMOTE_GIT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">target-username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.username <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">target-token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.ACCESS_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"bad-part\" style=\"position:relative;\">Bad part<a href=\"#bad-part\" aria-label=\"bad part permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>github action 确实通过和 api 的集成帮我们生了不少事情，但是在使用的过程中也遇到了一些问题。槽点不是很多，目前也一定程度上可以接受吧。如果能够再稳定一些那就更好了。</p>\n<h3 id=\"不太稳定的服务\" style=\"position:relative;\">不太稳定的服务<a href=\"#%E4%B8%8D%E5%A4%AA%E7%A8%B3%E5%AE%9A%E7%9A%84%E6%9C%8D%E5%8A%A1\" aria-label=\"不太稳定的服务 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>github action 这种模式其实本身是有点危险的：相当于把大量的用户代码在自己的系统里去跑，并且还有非常复杂的沟通与集成的工作。可能因为各种自身或者<a href=\"https://www.infoq.cn/article/6bipjclk9anzvda4uecm\">用户的问题</a>，服务确实有 down 过那么几次。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 606px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/97b2c712207efcf6af6911c7a4cb7a80/4d4a2/2021-05-16-11-00-21.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.999999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAoUlEQVQI13XLSwqDQAyAYe9/Fq/gSpDZia4UfBBBxzgmGRUdsV2UsRTaRb9FCCF/ICIAMAwDACCi1rptWwAwxkzTpDUuy7Guh7W7yG6XY9vcdT2et6Dve6VUHMdKqaIouq5rmqaqKkRkFhEmmolonv0kIma/v/k4SZIwDKMoKsvSWst39Hll+sPH4zhmWZbneZqmdV2LCN6MMczsnDt/fV9eNM3Z2lZFOf8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 05 16 11 00 21\"\n        title=\"2021 05 16 11 00 21\"\n        src=\"/static/97b2c712207efcf6af6911c7a4cb7a80/4d4a2/2021-05-16-11-00-21.png\"\n        srcset=\"/static/97b2c712207efcf6af6911c7a4cb7a80/772e8/2021-05-16-11-00-21.png 200w,\n/static/97b2c712207efcf6af6911c7a4cb7a80/e17e5/2021-05-16-11-00-21.png 400w,\n/static/97b2c712207efcf6af6911c7a4cb7a80/4d4a2/2021-05-16-11-00-21.png 606w\"\n        sizes=\"(max-width: 606px) 100vw, 606px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"不太完善的封装\" style=\"position:relative;\">不太完善的封装<a href=\"#%E4%B8%8D%E5%A4%AA%E5%AE%8C%E5%96%84%E7%9A%84%E5%B0%81%E8%A3%85\" aria-label=\"不太完善的封装 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>其次就是我们一直吐槽的 action 的写法问题了：很多 action 是那种不通过 docker 封装的版本，这势必会引入依赖不全的问题。尤其是对于我们这种 self-hosted 的用户，经常会出现因为依赖不齐全而导致 ci 挂掉。</p>\n<blockquote>\n<p><strong>更新</strong> 目前并没有很系统的去了解撰写 github action 的方法，最近接触到的是 <a href=\"https://docs.github.com/en/actions/creating-actions/about-actions#javascript-actions\">JS Action</a> 的流程。其文档也提到</p>\n<p>\"To ensure your JavaScript actions are compatible with all GitHub-hosted runners (Ubuntu, Windows, and macOS), the packaged JavaScript code you write should be pure JavaScript and not rely on other binaries. JavaScript actions run directly on the runner and use binaries that already exist in the virtual environment.\"</p>\n<p>也就是说其平台兼容性是建立在你自己的 nodejs 依赖是可以跨平台的前提下的。</p>\n</blockquote>","fields":{"slug_without_date":"/github-actions-tips"}},{"id":"69433720-0a26-522b-8342-9915cc7277d8","frontmatter":{"title":"Spring Security Jwt 的实现","date":"2021 April-12"},"html":"<p>突然发现除了<a href=\"/spring-cors-and-security\">跨域问题</a>之外从来没有好好记录过 Spring Security 的其他内容。最近也是比较系统的看了些资料，这里就算是做一个总结吧，方便后面忘记了回看。</p>\n<p>这里只介绍怎么把 jwt 的流程跑通以及对关键的代码做解释，不涉及 Authorization 部分，同时也只有 username password 单一的 authentication 流程，不涉及其他。</p>\n<h2 id=\"关键概念解释\" style=\"position:relative;\">关键概念解释<a href=\"#%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E8%A7%A3%E9%87%8A\" aria-label=\"关键概念解释 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>首先要明白 spring security 主要通过 filter 拦截请求并做处理的，在 <a href=\"/servlet-and-filter-with-web-framework\">有关 servlet 和 filter 的基础知识</a> 已经做了介绍。</p>\n<p>在 Spring Security 有一个概念 <code>Authentication</code> 它同时记录了一个用户授权的凭证（Credentials）以及验证通过后的产物（Principal）。而负责这个凭据验证并基于 Principal 的东西就是 <code>AuthenticationProvider</code>。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e1d64627c81bf20bc5344f3d928d8257/6029f/2021-04-12-23-24-37.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFklEQVQ4y5VSiW7aQBD1b7ff1kRR2lShgCtSQwg2GJ/r9XoNNr45XjRLjEKVSulIT571zr55c2hFUcAwppjNnmH8mSqwMIJMJOiO7HQ6/RPH01HF7Nodvn7/Ak3KFAtrDo+vIPIQ4caBrCKkeYzdbof/MZ5xaEVeICkZvHyOdTqDvzUR5BaCxEae5yqwrmtUVaUUbzYbSCmvkKYpRCxQFRW0tu3gMhuBWENsIvCEIYx9BJGHtm1RNzXiOFbkpHi/3+N4POJwOFxApVPSRCbQ6EAPGWO4+XYLfayjbVrkWa4el2WpcLGTauo1AEVMSjVyqIw0lWAsvKihLynq2hZZnn2qh4mUZ4VUAqH33xvlF1GEmnFUAUPNBVq5QSMk6jBCEycXX8QxtH4t/rY+Ad4IGy5QBREqP1SkKoHPzklYjCYSZ8L+EU1xsVjANE1st9srUiqFbF+UKEwb5dJBHXKUaw/FysGhrNQ9TVzrFdFQJpMJxuMxooipPmbZuXfUbHxQxXvbd50SovUrYBgG5vMXTI0ZxiMdS2uFJEnQdR2EEGriCl13Bbqn/1QhxWm0rKSElOmTEUz7GS/2FCzx4XqOWh/XdeC67hs8eJ6n/P5r2zYcxzkTcs4R+gz6bIDfqwcY9giD+S2ezF/Qn4bgUaxW6ENwfnUmLm25XKpB3D/c4f7xBj8Gd3gc/sRg+IjReAS6tyzrU6DYV6dSJI+QJX2yAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 04 12 23 24 37\"\n        title=\"2021 04 12 23 24 37\"\n        src=\"/static/e1d64627c81bf20bc5344f3d928d8257/5a190/2021-04-12-23-24-37.png\"\n        srcset=\"/static/e1d64627c81bf20bc5344f3d928d8257/772e8/2021-04-12-23-24-37.png 200w,\n/static/e1d64627c81bf20bc5344f3d928d8257/e17e5/2021-04-12-23-24-37.png 400w,\n/static/e1d64627c81bf20bc5344f3d928d8257/5a190/2021-04-12-23-24-37.png 800w,\n/static/e1d64627c81bf20bc5344f3d928d8257/6029f/2021-04-12-23-24-37.png 906w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>然后一个系统可能会支持多种凭据，比如最典型的 UsernamePasswordAuthentication 也可以是通过 OAuth 的 Authentication。为了处理不同的授权流程，Spring Security 有另外一个概念 <code>AuthenticationManager</code> 用于管理多个 <code>AuthenticationProvider</code>：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/395e312f669700efde6155bce5e7b201/a0730/2021-04-12-23-32-28.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEUlEQVQ4y4VTaW/aQBD1//87nAFUlQ/QNuFMyEEVsCkE3PjC62Pt9cKrZsAoKZW60tPMzs4+vZmdNbTWWCwWWK/X2G63bB8fn7BcLmGaJjzPw8PDA8fTNEUkIiRJwn4JKSWDfMN1XaxWK+x2O74URRHCMEQcx2xpv9/vEQoBQX64RxAETEo5JYhss9nAcBwH/1s6V1BhBC1iFCLCQet/5pEAQwiBPM85cDwer5LiPIRI95BugHhjQ8UJikJd8kvQItVMmGXZSYnWKIqCoQsNqRIkSkAVBZfFZSbJlYDS+r7/WSE1Vh809OHApDKTHFdKQRXqFNea8z+SlT6170R4VpiKCCoIkXkBcn/PpVHJQeQgcwPIdxe56yNP5Ynkr5LpgQ16xVJhJiU3n8hUFCNXGY44sDoZCoi3HTKOq6t+055e36C6qT/FuU/UoySlkUgQRgGyXCKTGY+M+DBS3IYz6C4J4x6WM0gbklzCcz04zjus7Ss2b7/w27Z5yF3HhW3bn3J9z2cOy7JgzGYzzOdzWKbJv6P8Iaa5hGVaWCxf8TJ/xstwjKfvd5iPJvj5/IIl55zuEFHJY/T7fQyHQw7c398zptMpJpMJg/zhaITbfh/fvnzF3Y9bDAaDyxmB7vZ6PYzHYxitVgvNZhOdTgftdptB+3q9jkajwSC/WquhSrZaRa1Wu5zd3NywrVQq6Ha7+AORis91ptOV0wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 04 12 23 32 28\"\n        title=\"2021 04 12 23 32 28\"\n        src=\"/static/395e312f669700efde6155bce5e7b201/5a190/2021-04-12-23-32-28.png\"\n        srcset=\"/static/395e312f669700efde6155bce5e7b201/772e8/2021-04-12-23-32-28.png 200w,\n/static/395e312f669700efde6155bce5e7b201/e17e5/2021-04-12-23-32-28.png 400w,\n/static/395e312f669700efde6155bce5e7b201/5a190/2021-04-12-23-32-28.png 800w,\n/static/395e312f669700efde6155bce5e7b201/a0730/2021-04-12-23-32-28.png 1131w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>而具体到我们这次要构建的 JwtUsernamePassword 的流程，当我们登录的时候需要拿着登录信息（username + password）去数据库（或者其他地方）校验有没有这样子的组合，而这个地方 Spring Security 也抽取了概念叫做 <code>UserDetailsService</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/02d0ffa1cbb85e4e5ecafb8addf28a32/302a4/2021-04-12-23-37-33.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/0lEQVQY021QW5KEIAz0/lfzAjt/lliuOgoCyht7Klmdr01VoBJCp7sbALiuC6UU1FJRS+H6v6A+5XEcMMbAWMuptUYIgWcaGkgpIeWMVDJiSogx8mOtlT/SB0oKWqykQkkZKUbknOGcw77vNyAuROcRtUUyB6I2SPc2YtL3PcZxxDzP2LYNlhgphTC94X4XhGXDuazfhQ0dxCjuBuEt/wBvhuu6Msg0TZBSMgvvPYzWSLuBXxXCqnBKxUoYkGQRoA+BfXDe8019suI8T7Rti5/Xi2uafeQ9kWvhHtnXEFUqlFLfpPrxjSQSQ5JsjeV3skEIAdH3GIRA13UYhoFnPyMwz0KaAT2oAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 04 12 23 37 33\"\n        title=\"2021 04 12 23 37 33\"\n        src=\"/static/02d0ffa1cbb85e4e5ecafb8addf28a32/5a190/2021-04-12-23-37-33.png\"\n        srcset=\"/static/02d0ffa1cbb85e4e5ecafb8addf28a32/772e8/2021-04-12-23-37-33.png 200w,\n/static/02d0ffa1cbb85e4e5ecafb8addf28a32/e17e5/2021-04-12-23-37-33.png 400w,\n/static/02d0ffa1cbb85e4e5ecafb8addf28a32/5a190/2021-04-12-23-37-33.png 800w,\n/static/02d0ffa1cbb85e4e5ecafb8addf28a32/302a4/2021-04-12-23-37-33.png 1080w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Spring Security 有提供一个名为 <code>WebSecurityConfigurerAdapter</code> 的基类，它已经提供了基本的框架，我们通常只需要对需要自定义的地方做覆盖即可。</p>\n<p>那么总结下具体要做什么：</p>\n<ol>\n<li>增加一个 InMemoryUserDetailsManager 假装是个数据库。</li>\n<li>完成两个 Filter：\n<ol>\n<li><code>JwtUsernameAndPasswordAuthenticationFilter</code> 覆盖默认的 <code>UsernamePasswordAuthenticationFilter</code> 支持依据请求生成 jwt token</li>\n<li><code>JwtTokenVerifier</code> 检查请求的 header <code>Authorization</code> 获取并验证所附带的 token 判断这个 token 是否合法并返回对应的 Principle</li>\n</ol>\n</li>\n<li>覆盖 <code>WebSecurityConfigurerAdapter.configure</code> 把以上配置传起来</li>\n</ol>\n<h2 id=\"基本依赖\" style=\"position:relative;\">基本依赖<a href=\"#%E5%9F%BA%E6%9C%AC%E4%BE%9D%E8%B5%96\" aria-label=\"基本依赖 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>首先 gradle 依赖如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"gradle\"><pre class=\"language-gradle\"><code class=\"language-gradle\">dependencies {\r\n    implementation &#39;org.springframework.boot:spring-boot-starter-security&#39;\r\n    implementation &#39;org.springframework.boot:spring-boot-starter-validation&#39;\r\n    implementation &#39;org.springframework.boot:spring-boot-starter-web&#39;\r\n    compileOnly &#39;org.projectlombok:lombok&#39;\r\n\r\n    compile &#39;io.jsonwebtoken:jjwt-api:0.11.2&#39;\r\n    runtime &#39;io.jsonwebtoken:jjwt-impl:0.11.2&#39;,\r\n            // Uncomment the next line if you want to use RSASSA-PSS (PS256, PS384, PS512) algorithms:\r\n            //&#39;org.bouncycastle:bcprov-jdk15on:1.60&#39;,\r\n            &#39;io.jsonwebtoken:jjwt-jackson:0.11.2&#39; // or &#39;io.jsonwebtoken:jjwt-gson:0.11.2&#39; for gson\r\n\r\n    annotationProcessor &#39;org.springframework.boot:spring-boot-configuration-processor&#39;\r\n    annotationProcessor &#39;org.projectlombok:lombok&#39;\r\n    testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39;\r\n    testImplementation &#39;org.springframework.security:spring-security-test&#39;\r\n}</code></pre></div>\n<p>通过 <a href=\"https://start.spring.io\">start.spring.io</a> 创建的项目，添加了以下依赖：</p>\n<ul>\n<li>web</li>\n<li>validation</li>\n<li>lombok</li>\n<li>spring security</li>\n</ul>\n<p>同时增加了一个 jwt 解析的类库 <a href=\"https://github.com/jwtk/jjwt\">jjwt</a>。</p>\n<h2 id=\"websecurityconfig\" style=\"position:relative;\">WebSecurityConfig<a href=\"#websecurityconfig\" aria-label=\"websecurityconfig permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>增加一个 <code>InMemoryUserDetailsManager</code>，只有一个用户：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WebSecurityConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WebSecurityConfigurerAdapter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\r\n  \r\n  <span class=\"token annotation punctuation\">@Override</span>\r\n  <span class=\"token annotation punctuation\">@Bean</span>\r\n  <span class=\"token keyword\">protected</span> <span class=\"token class-name\">UserDetailsService</span> <span class=\"token function\">userDetailsService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryUserDetailsManager</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> passwordEncoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NORMAL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>覆盖 <code>configure</code>，增加上述提及的 Filter:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WebSecurityConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WebSecurityConfigurerAdapter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token annotation punctuation\">@Override</span>\r\n  <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpSecurity</span> http<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\r\n    http<span class=\"token punctuation\">.</span><span class=\"token function\">csrf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// disable csrf</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">sessionManagement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sessionCreationPolicy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SessionCreationPolicy</span><span class=\"token punctuation\">.</span>STATELESS<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 不再使用 cookie 管理 session</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">addFilter</span><span class=\"token punctuation\">(</span>\r\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">JwtUsernameAndPasswordAuthenticationFilter</span><span class=\"token punctuation\">(</span>\r\n                <span class=\"token function\">authenticationManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> jwtConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 增加用户密码校验的 Filter</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">addFilterAfter</span><span class=\"token punctuation\">(</span>\r\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">JwtTokenVerifier</span><span class=\"token punctuation\">(</span>jwtConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token class-name\">JwtUsernameAndPasswordAuthenticationFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 增加 token 校验的 Filter</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">authorizeRequests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">anyRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">authenticated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"jwtusernameandpasswordauthenticationfilter\" style=\"position:relative;\">JwtUsernameAndPasswordAuthenticationFilter<a href=\"#jwtusernameandpasswordauthenticationfilter\" aria-label=\"jwtusernameandpasswordauthenticationfilter permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtUsernameAndPasswordAuthenticationFilter</span> <span class=\"token keyword\">extends</span>\r\n    <span class=\"token class-name\">UsernamePasswordAuthenticationFilter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">AuthenticationManager</span> authenticationManager<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">JwtConfig</span> jwtConfig<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">JwtUsernameAndPasswordAuthenticationFilter</span><span class=\"token punctuation\">(</span>\r\n      <span class=\"token class-name\">AuthenticationManager</span> authenticationManager<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 1</span>\r\n      <span class=\"token class-name\">JwtConfig</span> jwtConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>authenticationManager <span class=\"token operator\">=</span> authenticationManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jwtConfig <span class=\"token operator\">=</span> jwtConfig<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token annotation punctuation\">@Override</span>\r\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Authentication</span> <span class=\"token function\">attemptAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span>\r\n      <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">AuthenticationException</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 2</span>\r\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token class-name\">UsernamePasswordRequest</span> param <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token punctuation\">.</span><span class=\"token function\">readValue</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UsernamePasswordRequest</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token class-name\">Authentication</span> authentication <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UsernamePasswordAuthenticationToken</span><span class=\"token punctuation\">(</span>\r\n          param<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n          param<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">return</span> authenticationManager<span class=\"token punctuation\">.</span><span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span>authentication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> io<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token annotation punctuation\">@Override</span>\r\n  <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">successfulAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span>\r\n      <span class=\"token class-name\">FilterChain</span> chain<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Authentication</span> authResult<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServletException</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 3</span>\r\n    <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">setSubject</span><span class=\"token punctuation\">(</span>authResult<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">claim</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"authorities\"</span><span class=\"token punctuation\">,</span> authResult<span class=\"token punctuation\">.</span><span class=\"token function\">getAuthorities</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\r\n            <span class=\"token class-name\">GrantedAuthority</span><span class=\"token operator\">::</span><span class=\"token function\">getAuthority</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">setIssuedAt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">setExpiration</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span></span>Date</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">plusDays</span><span class=\"token punctuation\">(</span>jwtConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getDays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">signWith</span><span class=\"token punctuation\">(</span>jwtConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getSecretKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">compact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">addHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bearer \"</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>从 <code>WebSecurityConfig</code> 那边获取的 <code>AuthenticationManager</code> 里面其实就是一个默认的 <code>UsernamePasswordProvider</code> 里面用的就是我们上文配置的 <code>InMemoryUserDetailsManager</code>。</li>\n<li>尝试验证，可以看到就是把 <code>{\"username\": \"username\", \"password\": \"password\"}</code> 这种格式的 request body 做解析，然后让给 <code>AuthenticationManager</code>。</li>\n<li>生成 token，懂 jwt 的话就知道就是那么几个东西：\n<ol>\n<li>subject 里面是 username</li>\n<li>claim 一些 key-value，这里塞了权限列表</li>\n<li>issueAt 创建时间</li>\n<li>expiration 过期时间</li>\n</ol>\n</li>\n</ol>\n<blockquote>\n<p><strong>注意</strong> 其实很多时候这个 Filter 可能是一个独立的 Controller 会比较舒服一些吧，相比下文的 JwtVerifier 这个 Filter 基本就是强行复用了 Spring Security 的逻辑。</p>\n</blockquote>\n<h2 id=\"jwttokenverifier\" style=\"position:relative;\">JwtTokenVerifier<a href=\"#jwttokenverifier\" aria-label=\"jwttokenverifier permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtTokenVerifier</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OncePerRequestFilter</span> <span class=\"token punctuation\">{</span>\r\n\r\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">JwtConfig</span> jwtConfig<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">JwtTokenVerifier</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JwtConfig</span> jwtConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jwtConfig <span class=\"token operator\">=</span> jwtConfig<span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNullOrEmpty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> str<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> str <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> str<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token annotation punctuation\">@Override</span>\r\n  <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doFilterInternal</span><span class=\"token punctuation\">(</span>\r\n      <span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">FilterChain</span> filterChain<span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ServletException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token class-name\">String</span> authorizationHeader <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isNullOrEmpty</span><span class=\"token punctuation\">(</span>authorizationHeader<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>authorizationHeader<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      filterChain<span class=\"token punctuation\">.</span><span class=\"token function\">doFilter</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> authorizationHeader<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token class-name\">Jws</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Claims</span><span class=\"token punctuation\">></span></span> claimsJws <span class=\"token operator\">=</span>\r\n          <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">parserBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n              <span class=\"token punctuation\">.</span><span class=\"token function\">setSigningKey</span><span class=\"token punctuation\">(</span>jwtConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getSecretKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n              <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n              <span class=\"token punctuation\">.</span><span class=\"token function\">parseClaimsJws</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token class-name\">Claims</span> body <span class=\"token operator\">=</span> claimsJws<span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token class-name\">String</span> username <span class=\"token operator\">=</span> body<span class=\"token punctuation\">.</span><span class=\"token function\">getSubject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> authorities <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> body<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"authorities\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SimpleGrantedAuthority</span><span class=\"token punctuation\">></span></span> simpleGrantedAuthorities <span class=\"token operator\">=</span>\r\n          authorities<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SimpleGrantedAuthority</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token class-name\">Authentication</span> authentication <span class=\"token operator\">=</span> \r\n          <span class=\"token keyword\">new</span> <span class=\"token class-name\">UsernamePasswordAuthenticationToken</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> simpleGrantedAuthorities<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span>\r\n      <span class=\"token class-name\">SecurityContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAuthentication</span><span class=\"token punctuation\">(</span>authentication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JwtException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Token %s cannot be trusted\"</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    filterChain<span class=\"token punctuation\">.</span><span class=\"token function\">doFilter</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>创建一个 <code>UsernamePasswordAuthenticationToken</code> 注意，这里的第一个参数未必要 String 的，可以是任意类型的，这里只是一个 String 为例了</li>\n<li>把 <code>Authentication</code> 传递给 <code>SecurityContextHolder</code> 之后同一线程下就可以获取它并做进一步的权限验证了</li>\n</ol>\n<h2 id=\"参考资料\" style=\"position:relative;\">参考资料<a href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\" aria-label=\"参考资料 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>感觉最有用的就是这里的视频呢...</p>\n<ol>\n<li><a href=\"https://www.youtube.com/watch?v=caCJAJC41Rk\">How Spring Security Authentication works - Java Brains</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=her_7pa0vrg\">Spring Security - FULL COURSE</a></li>\n</ol>","fields":{"slug_without_date":"/spring-security-with-jwt"}}],"pageInfo":{"hasPreviousPage":true,"currentPage":8,"pageCount":44}}},"pageContext":{"limit":3,"skip":21}},
    "staticQueryHashes": []}
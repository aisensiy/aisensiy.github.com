{"componentChunkName":"component---src-templates-blogs-js","path":"/page/7/","result":{"data":{"site":{"siteMetadata":{"title":"eisen-s-blog"}},"blogs":{"nodes":[{"id":"eac27307-a5b7-54b4-9ea3-26d65f7cd1e7","frontmatter":{"title":"spring boot 整理 SpringBootApplication","date":"2021 December-23"},"html":"<p>早在 2017 年有写过一些 spring boot 测试相关的内容，比如 <a href=\"/spring-mvc-and-test\">在 Spring Boot 1.5.3 中进行 Spring MVC 测试</a>，再比如 <a href=\"/spring-mvc-and-mybatis\">把 Spring Boot 1.5.3 与 MyBatis 集成</a>。现在都 2021 年马上 2022 年了，spring boot 的最新版本已经来到了 2.6，其所依赖的一系列东西也发生了不少变化。同时随着我们项目变得越来越大，测试用例越来越多，对测试的性能、标准化的要求也越来越迫切。从这篇开始记录一些自己最近翻看 spring test 以及 spring boot test 了解到的有关 spring 测试体系的内容。</p>\n<p>spring 以及 spring boot 测试相关的内容简单 google 一下就能看到很多，但我个人感觉非常不成体系，这个应该也和 spring 不断的更迭关系很大，很多新旧知识掺杂在一起，有点摸不清楚。这里我参考的核心资料是如下两个：</p>\n<ol>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html\">Spring Testing</a></li>\n<li><a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing\">Spring Boot Testing</a></li>\n</ol>\n<p>翻看了这两部分内容后感觉 Spring 的文档写的还是比较全面的，不过很遗憾 Spring Testing 的内容写的还是不够细致，可能需要自己去结合源码和其他资料才能更好的消化吸收。但我觉得确实比直接在其他地方要系统一些。</p>\n<p>今天先介绍最近消化的第一个 Tips 什么不应该放进 <code>@SpringBootApplication</code>。</p>\n<h2 id=\"springbootapplication-简单介绍\" style=\"position:relative;\">@SpringBootApplication 简单介绍<a href=\"#springbootapplication-%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D\" aria-label=\"springbootapplication 简单介绍 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code>@SpringBootApplication</code> 是一个集成注解，翻看源码可以看到它包含了额外三个注解：</p>\n<ul>\n<li><code>@SpringBootConfiguration</code>: 作为 SpringBoot 默认的 Configuration Class</li>\n<li><code>@EnableAutoConfiguration</code>: 允许 Auto Configuration</li>\n<li><code>@ComponentScan</code>: 支持 Component Scan 的方式提供各种 <code>Bean</code></li>\n</ul>\n<p>添加这个注解的 Class 也通常就是整个应用的入口了。在这里可能会放一些全局初始化的东西，不过根据 Spring Boot Testing 的 <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing.spring-boot-applications.user-configuration-and-slicing\">User Configuration and Slicing</a> 介绍，这里反而不是那种什么都可以放的地方，随便放各种东西会影响你的测试依赖。</p>\n<h2 id=\"为什么-springbootapplication-不能添加各种依赖\" style=\"position:relative;\">为什么 SpringBootApplication 不能添加各种依赖<a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88-springbootapplication-%E4%B8%8D%E8%83%BD%E6%B7%BB%E5%8A%A0%E5%90%84%E7%A7%8D%E4%BE%9D%E8%B5%96\" aria-label=\"为什么 springbootapplication 不能添加各种依赖 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这样从 Spring Boot 写测试通常使用的 <code>@SpringBootTest</code> 和 <code>@WebMvcTest</code> 注解的行为做解释了。</p>\n<p>通常来说，如果我们的依赖链条都是靠我们自己去切断，不依赖 Spring 的 ApplicationContext 那么这种测试就算是 Unit Test 。反之任何需要依赖 ApplicationContext 的都可以称为 Integration Test。面向 WebMvc 或者需要和数据库接触的测试都需要 ApplicationContext 而这个 ApplicationContext 如何建立就是靠的 <code>@SpringBootTest</code> 或者 <code>@WebMvcTest</code> 这样的注解了。</p>\n<p>标记 <code>@SpringBootTest</code> 或者其他 Spring Boot 提供的 <code>@*Test</code> 注解的测试会尝试寻找从根目录开始寻找标记了 <code>@SpringBootApplication</code> 或者 <code>@SpringBootConfiguration</code> 的类，并以它为起点加载完整的 ApplicationContext 。在 Spring Boot 的 <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing.spring-boot-applications.detecting-configuration\">Detecting Test Configuration</a> 文档里也做了说明：</p>\n<blockquote>\n<p>When testing Spring Boot applications, this is often not required. Spring Boot’s @Test annotations search for your primary configuration automatically whenever you do not explicitly define one.</p>\n<p>The search algorithm works up from the package that contains the test until it finds a class annotated with @SpringBootApplication or @SpringBootConfiguration. As long as you structured your code in a sensible way, your main configuration is usually found.</p>\n</blockquote>\n<p>当然也可以通过增加 <code>classes</code> 参数 explicitly define 一个 Configuration 修改其默认搜索的行为：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>classes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token class-name\">GraphQLTestConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">DgsAutoConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Import</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CustomDataFetchingExceptionHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RunWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringRunner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GraphQLTestBase</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TestBase</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"应该如何修改\" style=\"position:relative;\">应该如何修改<a href=\"#%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9\" aria-label=\"应该如何修改 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在文档的 <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing.spring-boot-applications.user-configuration-and-slicing\">User Configuration and Slicing</a> 部分有做介绍：</p>\n<blockquote>\n<p>Test slices exclude @Configuration classes from scanning.</p>\n</blockquote>\n<p>但是 <code>@SpringBootApplication</code> 默认的 <code>@ComponentScan</code> 可不会跳过任何 <code>@Configuration</code> 因此，为了让全局的依赖注入不要污染不必要的 <code>Test Slices</code> 可以把额外的依赖注入放在单独的 <code>@Configuration</code> 下，这里我直接超文档的内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token annotation punctuation\">@EnableBatchProcessing</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyApplication</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>修改为</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span><span class=\"token punctuation\">(</span>proxyBeanMethods <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@EnableBatchProcessing</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyBatchConfiguration</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"总结\" style=\"position:relative;\">总结<a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li><code>@SpringBootApplication</code> 自带 <code>ComponentScan</code> 会收集自己 package 下所有的 Beans 和 Configurations</li>\n<li>Spring Boot 提供的 <code>@*Test</code> 会自己搜索 <code>@SpringBootApplication</code> 或者 <code>@SpringBootConfiguration</code> 作为默认的 <code>Configuration</code>，除非你主动做覆盖</li>\n<li>为了让 2 的行为不要导致过量的 <code>ApplicationContext</code> 在测试阶段被创建，可以把一些只有在生成环境才需要的额外的 Bean 放在独立的 <code>@Configuration</code> 类下，因为 Spring Boot 的 Testing slices 不会扫其他的 <code>@Configuration</code></li>\n</ol>","fields":{"slug_without_date":"/spring-boot-test"}},{"id":"697c4076-189a-52b7-8f55-69067fdb7b35","frontmatter":{"title":"维护一大堆 kubeconfig 的一些实践","date":"2021 December-10"},"html":"<h2 id=\"2021-12-20-更新\" style=\"position:relative;\">2021-12-20 更新<a href=\"#2021-12-20-%E6%9B%B4%E6%96%B0\" aria-label=\"2021 12 20 更新 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>由于 <code>kubie</code> 是开一个子 shell 它会导致 <code>direnv</code> 失效，也就是说 <code>kubie</code> 和 <code>direnv</code> 无法共同使用，我只好再去尝试其他兼容的方案，毕竟如果换回 <code>kubectx</code> 就依然有维护 kubeconfig 的烦恼。这里找到一个新的工具 <a href=\"https://github.com/sunny0826/kubecm\">kubecm</a> 可以帮助做 kubeconfig 的合并。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4cbacc66c4399ebc5d2825e5fe038c12/0b569/kubecm-list.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABXElEQVQozz2Ry2ocMRBF5y9mWo9uPVpSv2cICQR7wDgGZ+GVmZW9CwTjZfId2eSPTyhNkkWhKql177nqXSyFXApN0+BiwViHUoq2bXHOobWus/R1vzi6GJjXD6RhJfaZGCMhxHq+s9ZirUFrw3T/RpdPWKMYx5Ft2wghVLHj8UjOCWtayucL8+NPpscf+NNXWn1gXhasMexEVUprhQ8RrZpKJa45Z8TQe89QCiF4TBdJH58Ybl+Zzi/4+UzbWvq+x4igRJXa7/d0XVd7MRAR+Uiiy9yndO21ZfjyzvT8i/nym3j+hja2pmgkstBISbRpHOoqF4VunudKKvOyLKSUMFrR+5YUHUPJ+M7UqKWUqrO7xjU1qtse0G3AmquBiIqzRJFe9uSSTwv9ekM+3dH1M+YvUBW8EhqawwE3fqJRpv4kcRSqf4TrulZCedO83TLdXNgevpNO91it/hP+Ab+Gx0wwAGwzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kubecm list\"\n        title=\"kubecm list\"\n        src=\"/static/4cbacc66c4399ebc5d2825e5fe038c12/5a190/kubecm-list.png\"\n        srcset=\"/static/4cbacc66c4399ebc5d2825e5fe038c12/772e8/kubecm-list.png 200w,\n/static/4cbacc66c4399ebc5d2825e5fe038c12/e17e5/kubecm-list.png 400w,\n/static/4cbacc66c4399ebc5d2825e5fe038c12/5a190/kubecm-list.png 800w,\n/static/4cbacc66c4399ebc5d2825e5fe038c12/c1b63/kubecm-list.png 1200w,\n/static/4cbacc66c4399ebc5d2825e5fe038c12/29007/kubecm-list.png 1600w,\n/static/4cbacc66c4399ebc5d2825e5fe038c12/0b569/kubecm-list.png 2878w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>不过其实它也包含了 kubectx 的功能，但我的 kubectx 还提供了自动补全等东西，就这么一直用着了。</p>\n<h2 id=\"开始\" style=\"position:relative;\">开始<a href=\"#%E5%BC%80%E5%A7%8B\" aria-label=\"开始 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>如果需要维护很多 kubernetes 集群，每个集群都有一个 kubeconfig 的 yaml 那么在 <code>~/.kube</code> 目录下就会有一大堆的 yaml 。在频繁切换和修改不同的集群的内容的时候，一个不小心就可能把 A 集群的东西部署到 B 集群造成运维事故。这里介绍下到目前为止维护对多个集群环境的一些痛点和实践。</p>\n<p>首先先总结下痛点吧：</p>\n<ol>\n<li>多个集群以及集群的 namespace 切换比较繁琐，通常需要 KUBECONFIG 环境变量的切换</li>\n<li>不晓得自己当前处于哪个集群下</li>\n<li>在使用 kustomize 或者 helm 对集群做更新的时候需要确保自己切换了 kubeconfig，除了小心之外没什么办法阻止错位的环境部署</li>\n</ol>\n<p>下面记录下自己在试图解决这些痛点过程中找到的还不错的方案。</p>\n<h2 id=\"kubectx-快速切换上下文和-namespace\" style=\"position:relative;\"><a href=\"https://github.com/ahmetb/kubectx\">kubectx</a> 快速切换上下文和 namespace<a href=\"#kubectx-%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C-namespace\" aria-label=\"kubectx 快速切换上下文和 namespace permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code>kubectx</code> 可以切换 <code>~/.kube/config</code> 文件中的多个 <code>context</code>，然后可以通过 <code>kubens</code> 命令切换不同的 <code>namespace</code> 。但如果我有一堆 kubeconfig yaml 的话还需要额外的一步，将它们合并到 <code>~/.kube/config</code> 文件里。这个步骤用 kubectl 就能搞定：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=~</span>/.kube/config:~/.kube/other.yaml kubectl config view <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--merge</span> <span class=\"token parameter variable\">--flatten</span> <span class=\"token operator\">></span> out.txt</code></pre></div>\n<p>不过依然是多了一步，而且既然有添加就有删除，如果其中一个集群的配置文件变化了或者废弃了就需要把这个集群剃掉：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl config <span class=\"token builtin class-name\">unset</span> users.gke_project_zone_name\nkubectl config <span class=\"token builtin class-name\">unset</span> contexts.aws_cluster1-kubernetes\nkubectl config <span class=\"token builtin class-name\">unset</span> clusters.foobar-baz</code></pre></div>\n<h2 id=\"zsh--bash--fish-集成展示当前-context\" style=\"position:relative;\">zsh / bash / fish 集成展示当前 context<a href=\"#zsh--bash--fish-%E9%9B%86%E6%88%90%E5%B1%95%E7%A4%BA%E5%BD%93%E5%89%8D-context\" aria-label=\"zsh  bash  fish 集成展示当前 context permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>既然 <code>kubectl config current-context</code> 可以获取当前的上下文，那么如果可以在 shell 里面展示这些信息基本就可以保证自己知道当前在什么上下文了。对不同的 shell 可以用不同的方式实现类似的效果。</p>\n<h3 id=\"kube-ps1-for-zsh--bash\" style=\"position:relative;\"><a href=\"https://github.com/jonmosco/kube-ps1\">kube-ps1</a> for zsh / bash<a href=\"#kube-ps1-for-zsh--bash\" aria-label=\"kube ps1 for zsh  bash permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>安装成功后按照项目 README 提示就可以了。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b93b2ea1056f9352a88ca91ac0371715/191e2/kube-ps1-screenshot-from-readme.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.500000000000002%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAv0lEQVQI103MUUvCUACG4SMxlMgiypK1QqJ0LlSGx7WdbTo9rpludrFE6P//jzc4CHXx8sB38Qkn/0GqgiRYMQvXPFZH7ouaQV4z3Bxwi2/6eU1v+UU33hqdtMROdiZnXvGQljxle67kGtFRW3rJJ8/xhq7U2IsSO6toS03DVVhvCWdeTGOoEIMI0Q/NLl7eTwV/voaIpp9zO0q58yKuPUVrqrGkxvKXnE8yLqea1nhhvPBXppvgA+FG5tic//MX9zVbvxXO5hkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kube ps1 screenshot from readme\"\n        title=\"kube ps1 screenshot from readme\"\n        src=\"/static/b93b2ea1056f9352a88ca91ac0371715/5a190/kube-ps1-screenshot-from-readme.png\"\n        srcset=\"/static/b93b2ea1056f9352a88ca91ac0371715/772e8/kube-ps1-screenshot-from-readme.png 200w,\n/static/b93b2ea1056f9352a88ca91ac0371715/e17e5/kube-ps1-screenshot-from-readme.png 400w,\n/static/b93b2ea1056f9352a88ca91ac0371715/5a190/kube-ps1-screenshot-from-readme.png 800w,\n/static/b93b2ea1056f9352a88ca91ac0371715/c1b63/kube-ps1-screenshot-from-readme.png 1200w,\n/static/b93b2ea1056f9352a88ca91ac0371715/29007/kube-ps1-screenshot-from-readme.png 1600w,\n/static/b93b2ea1056f9352a88ca91ac0371715/191e2/kube-ps1-screenshot-from-readme.png 1836w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"custom-function-for-fish\" style=\"position:relative;\">custom function for fish<a href=\"#custom-function-for-fish\" aria-label=\"custom function for fish permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>很遗憾 fish 里不能用 <code>kube-ps1</code> 不过找一个 shell 函数做的类似的效果也可以的：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> kubectl_status\n  <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$KUBECTL_PROMPT_ICON</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> and <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> KUBECTL_PROMPT_ICON <span class=\"token string\">\"⎈\"</span>\n  <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$KUBECTL_PROMPT_SEPARATOR</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> and <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> KUBECTL_PROMPT_SEPARATOR <span class=\"token string\">\"/\"</span>\n  <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> config <span class=\"token variable\">$KUBECONFIG</span>\n  <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$config</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> and <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> config <span class=\"token string\">\"<span class=\"token environment constant\">$HOME</span>/.kube/config\"</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$config</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token punctuation\">(</span>set_color red<span class=\"token punctuation\">)</span><span class=\"token variable\">$KUBECTL_PROMPT_ICON</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">(</span>set_color white<span class=\"token punctuation\">)</span><span class=\"token string\">\"no config\"</span>\n    <span class=\"token builtin class-name\">return</span>\n  end\n\n  <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> ctx <span class=\"token punctuation\">(</span>kubectl config current-context <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$status</span> <span class=\"token parameter variable\">-ne</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token punctuation\">(</span>set_color red<span class=\"token punctuation\">)</span><span class=\"token variable\">$KUBECTL_PROMPT_ICON</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">(</span>set_color white<span class=\"token punctuation\">)</span><span class=\"token string\">\"no context\"</span>\n    <span class=\"token builtin class-name\">return</span>\n  end\n\n  <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> ns <span class=\"token punctuation\">(</span>kubectl config view <span class=\"token parameter variable\">-o</span> <span class=\"token string\">\"jsonpath={.contexts[?(@.name==<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$ctx</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>)].context.namespace}\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token variable\">$ns</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> and <span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-l</span> ns <span class=\"token string\">'default'</span>\n\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token punctuation\">(</span>set_color cyan<span class=\"token punctuation\">)</span><span class=\"token variable\">$KUBECTL_PROMPT_ICON</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">(</span>set_color white<span class=\"token punctuation\">)</span><span class=\"token string\">\"(<span class=\"token variable\">$ctx</span><span class=\"token variable\">$KUBECTL_PROMPT_SEPARATOR</span><span class=\"token variable\">$ns</span>)\"</span>\nend\n\n<span class=\"token keyword\">function</span> fish_right_prompt\n    string unescape <span class=\"token variable\">$$</span>_tide_prompt_var<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token punctuation\">(</span>kubectl_status<span class=\"token punctuation\">)</span>\nend</code></pre></div>\n<p>这个代码不是我原创的，我只是做了魔改，很遗憾忘记了出处...具体的代码在 <a href=\"https://github.com/aisensiy/dotfiles/blob/master/fish/functions/fish_prompt.fish\">fish_prompt</a> 里，这里同时包含了我公开的 dotfiles 信息。效果如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d4d4986fa57e3d4539586c7d7c271217/58a91/terminal-with-kube-context-in-fish.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtklEQVQY022O3QqDMAxG6w8IwjBtUhlVEUQ3dqG72F5i7/9A30ihzo1dHJKm4eQzwzBgHEd0XYcQAqZpwrZtkXVdsSwX3K4XzOsD7fMFP9/he4YP57iv9H2/96YsSxhjdqqqAhGhaZpYrbUgsrBEcHSCowbcClgYIhLx3u+9yfMcRVFAa5ZlqOs6fjDz16KIB7PAORePJPR9JAoTmvAo/MhknyWh1jQ7YjSVchRqsn8kYeJXpsI3rWh5X3QOJ7EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"terminal with kube context in fish\"\n        title=\"terminal with kube context in fish\"\n        src=\"/static/d4d4986fa57e3d4539586c7d7c271217/5a190/terminal-with-kube-context-in-fish.png\"\n        srcset=\"/static/d4d4986fa57e3d4539586c7d7c271217/772e8/terminal-with-kube-context-in-fish.png 200w,\n/static/d4d4986fa57e3d4539586c7d7c271217/e17e5/terminal-with-kube-context-in-fish.png 400w,\n/static/d4d4986fa57e3d4539586c7d7c271217/5a190/terminal-with-kube-context-in-fish.png 800w,\n/static/d4d4986fa57e3d4539586c7d7c271217/c1b63/terminal-with-kube-context-in-fish.png 1200w,\n/static/d4d4986fa57e3d4539586c7d7c271217/29007/terminal-with-kube-context-in-fish.png 1600w,\n/static/d4d4986fa57e3d4539586c7d7c271217/58a91/terminal-with-kube-context-in-fish.png 1990w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>注意</strong> 这个最终效果是建立在我的 fish 主题之上的，单独使用效果如何不得而知。</p>\n<h2 id=\"kubie-一站式解决方案\" style=\"position:relative;\"><del>kubie 一站式解决方案</del><a href=\"#kubie-%E4%B8%80%E7%AB%99%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\" aria-label=\"kubie 一站式解决方案 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>除了 kubectx 外我在最近装机的时候还发现了一个更完善的解决方案：<a href=\"https://github.com/sbstp/kubie\">kubie</a>。它有三个优势：</p>\n<ol>\n<li>包含了 kubectx 的功能</li>\n<li>不用合并 config 文件，可以通过配置读取文件列表，甚至支持 <code>~/.kube/*.yaml</code> 这样的通配符匹配</li>\n<li>自带 shell 的 prompt 提示，类似于上文 <code>kube-ps1</code> 的功能</li>\n</ol>\n<p>当然，也有坏处：</p>\n<ol>\n<li>你不能自定义你的 prompt 样式了，不过它支持关掉自己的 prompt 提示。我目前就逐渐从 kubectx 切换到了 kubie 但依然保持我自己的 fish 的 prompt 。</li>\n<li>存在一个小问题（我觉得是 bug），它默认不把 <code>~/.kube/config</code> 下当前的上下文认为是默认的上下文，它的 prompt 不会在你新建一个 terminal 的时候假设是没有上下文的，然而事实上在这个时候 kubectl 的 context 已经指向了 <code>~/.kube/config</code> 的上下文了。你需要做一次切换后才会弹出。</li>\n</ol>\n<h2 id=\"direnv-当切换目录后自动注入环境变量\" style=\"position:relative;\"><a href=\"https://direnv.net/\">direnv</a> 当切换目录后自动注入环境变量<a href=\"#direnv-%E5%BD%93%E5%88%87%E6%8D%A2%E7%9B%AE%E5%BD%95%E5%90%8E%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F\" aria-label=\"direnv 当切换目录后自动注入环境变量 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>最后一个痛点以上的东西都没有解决。虽然增加了提示很大概率可以避免用错环境了，但还是挡不住有手比眼快的时候。这时候就需要 <code>direnv</code> 救场了。它可以在切换到某一个目录的之后触发一个 shell 执行，比如我可以强制在切换到维护 dev 集群的目录时将 <code>KUBECONFIG</code> 环境变量切换成对应集群的 kubeconfig 文件，这样就可以保证了上下文随着我操纵的 kustomize / helm charts 文件目录自动切换了。</p>\n<p>最后上 demo，这里包含了上述介绍的一些演示，顺序通过内部的标题组织的，和上述顺序不一致。</p>\n<p>\n\t\t<video\n\t\t\tsrc=/videos/kube-context-management-practices.mp4\n\t\t\twidth=\"1200\"\n\t\t\theight=\"auto\"\n\t\t\tpreload=\"auto\"\n\t\t\tmuted=\"false\"\n\t\t\ttitle=\"/videos/kube-context-management-practices.mp4\"\n\t\t\t\n\t\t\tplaysinline\n\t\t\tcontrols\n\t\t\t\n\t\t></video>\n\t</p>\n<h2 id=\"参考资料\" style=\"position:relative;\">参考资料<a href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\" aria-label=\"参考资料 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://medium.com/@ahmetb/mastering-kubeconfig-4e447aa32c75\">Mastering the KUBECONFIG file</a></li>\n<li><a href=\"https://stackoverflow.com/questions/37016546/kubernetes-how-do-i-delete-clusters-and-contexts-from-kubectl-config\">Kubernetes: How do I delete clusters and contexts from kubectl config?</a></li>\n</ul>","fields":{"slug_without_date":"/kubeconfig-management"}},{"id":"9cf571c4-8dd7-59fb-a356-83c81daf7072","frontmatter":{"title":"在 Github Actions 中获取最最最新的 commit","date":"2021 December-09"},"html":"<p>有 helm charts 管理经验的人都晓得 helm charts 发布后需要打包一个 tar 放到目录里面。helm 会要求一个特定的目录结构获取不同版本的 tar 包。在 openbayes 就有这么一个 helm charts 项目里面存放了一系列的 tar 包。目前来看这些 tar 包都很小（只有几百 K）为了方便部署，就直接把这些文件和 nginx 打包到镜像里了，部署起来就能直接提供服务了，没有其他对象存储之类的外部依赖。</p>\n<p>我们也希望把打包部署的流程通过 github workflow 实现自动化。按照上面的描述，可以分成两个步骤：</p>\n<ol>\n<li>release: 提交一个新 tag 触发 release 流程，将特定目录的文件达成 tar 包并以特定的名字保存到 packages 目录下，然后提交这个 tar 包</li>\n<li>build-and-push: 创建一个新的镜像包含刚才打的 tar 包，并提交到镜像仓库</li>\n</ol>\n<p>同时，为了适用 <a href=\"https://docs.github.com/en/actions/learn-github-actions/reusing-workflows\">reusable workflow</a> ，可调用的 workflow 必须是一个独立的 job 出现在调用方的 workflow 里。我们需要把上述两个工作分成 github workflow 中两个独立的 job：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> release a new helm version\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">...</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  \n  <span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">...</span>\n\n  <span class=\"token key atrule\">build-and-push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> release\n    <span class=\"token punctuation\">...</span></code></pre></div>\n<p>但遇到一个很奇怪的问题，<strong>在 release 中明明提交了新的内容，在 build-and-push 中却拿不到</strong>。我的第一感觉就怀疑是 github 的 <code>actions/checkout@v2</code> action 的行为有点问题。简单搜索了下，发现 <code>actions/checkout@v2</code> 默认会获取触发这次 github workflow 的 commit。也就是说，虽然我在 release 有新的提交，但是我在下一步 build-and-push 的 job 里还是 checkout 了上一个 commit 而已。</p>\n<p>查看 <code>actions/checkout@v2</code> 的 README 发现，如果想要修改上述的行为，需要修改其 <code>ref</code> 参数。修改成想要获取最新 commit 的 branch 名称即可。而具体在 github action 里则可以使用 <code>github.ref_name</code>（在 <a href=\"https://docs.github.com/en/actions/learn-github-actions/contexts#github-context\">https://docs.github.com/en/actions/learn-github-actions/contexts#github-context</a> 可以看到相关文档）这个变量获取当前的 branch。这里我提供一个例子：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test commit\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n\n  <span class=\"token key atrule\">make-commit</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest \n    \n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          FILENAME=`date  +\"%y%m%d%H%M%S\"`.txt\n          echo 123 > $FILENAME\n          echo \"::set-output name=$FILENAME\"</span>\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> write\n      \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> stefanzweifel/git<span class=\"token punctuation\">-</span>auto<span class=\"token punctuation\">-</span>commit<span class=\"token punctuation\">-</span>action@v4\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">commit_message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"add ${{ steps.write.outputs.name }}\"</span>\n  \n  <span class=\"token key atrule\">checkout-commit</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> make<span class=\"token punctuation\">-</span>commit\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">ref</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref_name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>   <span class=\"token comment\"># &lt;-------- 如果不修改这里就拿不到上面提交的文件</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          ls -lh</span></code></pre></div>\n<p>我在 <a href=\"https://github.com/aisensiy/github-checkout-test\">github-checkout-test</a> 这个仓库里做了上述的 workflow 的测试。增加 <code>ref</code> 参数为 <code>${{ github.ref_name }}</code> 就可以获取最新的提交文件了。</p>","fields":{"slug_without_date":"/checkout-latest-commit-in-github-action"}}],"pageInfo":{"hasPreviousPage":true,"currentPage":7,"pageCount":47}}},"pageContext":{"limit":3,"skip":18}},"staticQueryHashes":["26522286"],"slicesMap":{}}
{"componentChunkName":"component---src-templates-blogs-js","path":"/page/3","result":{"data":{"blogs":{"nodes":[{"id":"a5d4d343-341e-5e91-b175-13bd1fccb854","frontmatter":{"title":"pytorch tensors","date":"2021 January-18"},"html":"<p>最近在都 Deep Learning with Pytorch 这本书，目前为止感觉还是不错。尤其是它里面的手绘风插图，真的是印象深刻，好感顿生。</p>\n<p><img src=\"https://images-1300693298.cos.ap-beijing.myqcloud.com/%7B7AD75AC9-FD58-48DE-977A-7AD6503FED3A%7D.png\" alt=\"\"></p>\n<p>第三章介绍了 tensor 的数据结构，感觉讲的挺好的，做一个笔记，加深下印象。</p>\n<h2 id=\"本质\" style=\"position:relative;\">本质<a href=\"#%E6%9C%AC%E8%B4%A8\" aria-label=\"本质 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>首先，tensor 感觉就和 numpy array 非常非常像，简单的讲就是多维矩阵。但是和 python 的 list 相比，tensor / numpy array 是被分配的连续内存空间。</p>\n<p><img src=\"https://images-1300693298.cos.ap-beijing.myqcloud.com/%7B8F87E9BF-4E5C-4128-9066-5610D2CB4326%7D.png\" alt=\"\"></p>\n<h2 id=\"数据类型\" style=\"position:relative;\">数据类型<a href=\"#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B\" aria-label=\"数据类型 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>通过 <code class=\"language-text\">dtype</code> 参数可以指定 tensor 的数据类型。其名字和 numpy 里面的类型几乎一致：</p>\n<ul>\n<li>torch.float32 / torch.float</li>\n<li>torch.float64 / torch.double</li>\n<li>torch.float16 / torch.half</li>\n<li>torch.int8</li>\n<li>torch.unint8</li>\n<li>torch.int16 / torch.short</li>\n<li>torch.int32 / torch.int</li>\n<li>torch.int64 / torch.long</li>\n<li>torch.bool</li>\n</ul>\n<p>默认都是用 float 类型，double 也不会增加什么好处。然后 tensor 可以作为其他 tensor 的索引，但是必须是 long 类型。<code class=\"language-text\">torch.tensor([2, 2])</code> 会给类型为 long 。需要注意的是 numpy 默认的浮点类型是 float64，而 tensor 默认的是 float32：</p>\n<p><img src=\"https://images-1300693298.cos.ap-beijing.myqcloud.com/%7B495D4F3D-FC9C-4F62-A9BA-25413B7B6A02%7D.png\" alt=\"\"></p>\n<h2 id=\"Storage\" style=\"position:relative;\">Storage<a href=\"#Storage\" aria-label=\"Storage permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>每一个 tensor 的真是数据是由 <code class=\"language-text\">torch.Storage</code> 来维护的，它本质上就是一段连续的内存空间而已。Tensor 仅仅是为 storage 提供了 offset 和 stride 之后的视图而已。</p>\n<p><img src=\"https://images-1300693298.cos.ap-beijing.myqcloud.com/%7B4F5DC8FC-E908-408E-88C3-6FC09B95AF5E%7D.png\" alt=\"\"></p>\n<p>对于不同的 tensor 虽然它的 shape 不一样，但也可能指向了同一个的 storage。通过 tensor.storage() 可以直接访问它的内容：</p>\n<p><img src=\"https://images-1300693298.cos.ap-beijing.myqcloud.com/%7BFD54249D-DCFA-4437-905D-13F548279E5F%7D.png\" alt=\"\"></p>\n<p>不论 tensor 本身维度如何，其下的 storage 永远是一个一维数组。当然，修改 storage 的数据后，其 tensor 的数据也一定会发生变化。</p>\n<h2 id=\"size-offset-stride\" style=\"position:relative;\">size offset stride<a href=\"#size-offset-stride\" aria-label=\"size offset stride permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>offset 是 tensor 在 storage 的位置</li>\n<li>size 是当前 tensor 的维度</li>\n<li>stride 是这个 tensor 各个维度 +1 所需要跨越的 storage 索引个数</li>\n</ul>\n<p><img src=\"https://images-1300693298.cos.ap-beijing.myqcloud.com/%7B919B7731-CC39-45B5-897A-3A46180412C4%7D.png\" alt=\"\"></p>\n<p>那么当 tensor 本身发生了 transpose 之后，其实就是 size stride 发生了变化，其 storage 并没有变化的。</p>\n<h2 id=\"device-属性\" style=\"position:relative;\">device 属性<a href=\"#device-%E5%B1%9E%E6%80%A7\" aria-label=\"device 属性 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>tensor 创建时可以指定其属于什么设备：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">points_gpu = torch.tensor([[4.0, 1.0], [5.0, 3.0], [2.0, 1.0]], device='cuda')</code></pre></div>\n<p>默认是 cpu。</p>\n<p>当然也可以把 cpu 的 tensor 拷贝到 gpu：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">points_gpu = points.to(device='cuda')</code></pre></div>\n<h2 id=\"和-numpy-相互转换\" style=\"position:relative;\">和 numpy 相互转换<a href=\"#%E5%92%8C-numpy-%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2\" aria-label=\"和 numpy 相互转换 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>只要都在主内存里，numpy array 和 tensor 之间的转换是非常高效的。那么这个好处就是可以享受 numpy 生态的各种类库。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">points = torch.from_numpy(points_np)\npoints_np = points.numpy()</code></pre></div>","fields":{"slug_without_date":"/pytorch-tensors"}},{"id":"caf3322a-91c2-5b72-bd01-0edf6e5e9959","frontmatter":{"title":"spring boot 异常处理","date":"2020 December-07"},"html":"<p>最近相对比较系统的看了 spring mvc / spring boot 有关异常处理的内容。这里做一个总结。相关的代码放到了 <a href=\"https://github.com/aisensiy/springboot-exception-tutorial\">springboot exception tutorial</a>。</p>\n<p>之前确实没有比较系统的看 springmvc / springboot 有关异常处理的内容，这里直接记录一些我觉得比较有意义的知识片段以及具体的实践代码。</p>\n<h2 id=\"spring-mvc-的异常处理逻辑\" style=\"position:relative;\">spring mvc 的异常处理逻辑<a href=\"#spring-mvc-%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91\" aria-label=\"spring mvc 的异常处理逻辑 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ExceptionApplication</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExceptionApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如上所示，这是一个最基础的 <code class=\"language-text\">SpringBootApplication</code> 我们首先提供一个直接报错的 Handler 看看发送请求之后的效果：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ExceptionApplication</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExceptionApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>发送请求 <code class=\"language-text\">curl http://localhost:8080/hello</code> 会返回以下结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"timestamp\": \"2020-12-07T16:34:17.488+00:00\",\n    \"status\": 500,\n    \"error\": \"Internal Server Error\",\n    \"message\": \"\",\n    \"path\": \"/hello\"\n}</code></pre></div>\n<p>后台会打出对应的报错 stack：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java.lang.IllegalStateException: null\n\tat com.example.exception.ExceptionApplication.getHello(ExceptionApplication.java:39) ~[main/:na]\n\t...</code></pre></div>\n<p>那么这个默认的报错处理是谁处理的呢？在<a href=\"https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-ann-rest-spring-mvc-exceptions\">17.11.3 Handling Standard Spring MVC Exceptions</a>做了解释，<code class=\"language-text\">DefaultHandlerExceptionResolver</code> 会按照具体的 <code class=\"language-text\">Exception</code> 类型为请求结果报送默认的 StatusCode 具体的逻辑我贴出来以下，比较后面用的还是比较多的：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/15989324ca2a5c5551fe37d2eca46673/c929c/2020-12-08-01-08-09.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDElEQVQoz3WS6W6DMBCEef8nbI7GSX0BNsbch0FTrSOqUJIfI0ve9cfMLknXtmgqj3EcEZYFy7KgrmsURYF5njFN005936OlN00Te4wxGIYh1qg/yQUHP5+Q/TxglYSRAm1dI4QFIYSd6GMEYYxBShlBdPdaT7y1sFrBKAUjJXIhUFqza3x9QO4ISqIk5GoHtEpBXi/Q7PbUnaFrmo9A7z0458iyLMLfACXk9xXp4w7NWAS6LPub6X9gWZYQQkBrHR0eIxcUWaNIUxSpjqqci/P5FDnPc1RVhXVdD/Uk58+liMs5nvz0FV2OH4DOubgU2u5boLcmbpdckluaX991B9g2K/pdyOEWd7vfzl+uwWbeW2DBgQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 12 08 01 08 09\"\n        title=\"2020 12 08 01 08 09\"\n        src=\"/static/15989324ca2a5c5551fe37d2eca46673/5a190/2020-12-08-01-08-09.png\"\n        srcset=\"/static/15989324ca2a5c5551fe37d2eca46673/772e8/2020-12-08-01-08-09.png 200w,\n/static/15989324ca2a5c5551fe37d2eca46673/e17e5/2020-12-08-01-08-09.png 400w,\n/static/15989324ca2a5c5551fe37d2eca46673/5a190/2020-12-08-01-08-09.png 800w,\n/static/15989324ca2a5c5551fe37d2eca46673/c1b63/2020-12-08-01-08-09.png 1200w,\n/static/15989324ca2a5c5551fe37d2eca46673/c929c/2020-12-08-01-08-09.png 1218w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>当然也可以去源代码里直接看。</p>\n<p>不过文档里提到这个处理并不会返回 Body。那上面那个 JSON 的返回结果怎么来的呢？</p>\n<p>在文档里，<a href=\"https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-ann-customer-servlet-container-error-page\">17.11.5 Customizing the Default Servlet Container Error Page</a> 就做了解释：</p>\n<blockquote>\n<p>When the status of the response is set to an error status code and the body of the response is empty, Servlet containers commonly render an HTML formatted error page.\n当返回结果是错误码，但是返回的 body 为空的时候，servlet 通常会给返回一个错误页面。</p>\n</blockquote>\n<p>而 springboot 则帮我们做了这个事情，给了一个 <code class=\"language-text\">BasicErrorController</code> 所以就有了上面的那个报错结果了。</p>\n<p>知道了这个内容，我们就可以从两个地方入手去处理异常了。</p>\n<h2 id=\"覆盖默认的-BasicErrorController-的结果\" style=\"position:relative;\">覆盖默认的 BasicErrorController 的结果<a href=\"#%E8%A6%86%E7%9B%96%E9%BB%98%E8%AE%A4%E7%9A%84-BasicErrorController-%E7%9A%84%E7%BB%93%E6%9E%9C\" aria-label=\"覆盖默认的 BasicErrorController 的结果 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>比如在 sprinmvc 中我们常常在 <code class=\"language-text\">@RequestBody</code> 上使用 <code class=\"language-text\">@Valid</code> 注解，配合 BeanValidation 实现输入参数的校验，那么校验报错的时候会跑出异常 <code class=\"language-text\">MethodArgumentNotValidException</code> ，以下代码是我们什么都不处理的效果：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ExceptionApplication</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExceptionApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Hello</span> <span class=\"token function\">postHello</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token annotation punctuation\">@Valid</span> <span class=\"token class-name\">Hello</span> hello<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> hello<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Hello</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@NotBlank</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>发送请求：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$curl --location --request POST 'localhost:8080/hello' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    \"name\": \"\"\n}'</code></pre></div>\n<p>返回结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"timestamp\": \"2020-12-07T17:16:23.153+00:00\",\n    \"status\": 400,\n    \"error\": \"Bad Request\",\n    \"message\": \"\",\n    \"path\": \"/hello\"\n}</code></pre></div>\n<p>可以看到，非常的没有意义，知道错了，但是不知道具体错在哪里。Springboot 提供了对 <code class=\"language-text\">DefaultErrorAttributes</code> 扩展的方法，可以修改上面那个 JSON 的结构：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Component\nclass MyCustomErrorAttributes extends DefaultErrorAttributes {\n\n  @Override\n  public Map&lt;String, Object> getErrorAttributes(\n      WebRequest webRequest, ErrorAttributeOptions errorAttributeOptions) {\n    errorAttributeOptions = errorAttributeOptions.including(Include.EXCEPTION,\n        Include.BINDING_ERRORS);\n    Map&lt;String, Object> errorAttributes =\n        super.getErrorAttributes(webRequest, errorAttributeOptions);\n    return errorAttributes;\n  }\n}</code></pre></div>\n<p>在此发送一样的请求，会返回以下的结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"timestamp\": \"2020-12-07T17:25:16.336+00:00\",\n    \"status\": 400,\n    \"error\": \"Bad Request\",\n    \"exception\": \"org.springframework.web.bind.MethodArgumentNotValidException\",\n    \"message\": \"\",\n    \"errors\": [\n        {\n            \"codes\": [\n                \"NotBlank.hello.name\",\n                \"NotBlank.name\",\n                \"NotBlank.java.lang.String\",\n                \"NotBlank\"\n            ],\n            \"arguments\": [\n                {\n                    \"codes\": [\n                        \"hello.name\",\n                        \"name\"\n                    ],\n                    \"arguments\": null,\n                    \"defaultMessage\": \"name\",\n                    \"code\": \"name\"\n                }\n            ],\n            \"defaultMessage\": \"不能为空\",\n            \"objectName\": \"hello\",\n            \"field\": \"name\",\n            \"rejectedValue\": \"\",\n            \"bindingFailure\": false,\n            \"code\": \"NotBlank\"\n        }\n    ],\n    \"path\": \"/hello\"\n}</code></pre></div>\n<p>增加了两个额外的字段 Include.EXCEPTION Include.BINDING_ERRORS 可以更清楚的知道具体是什么异常以及具体什么报错。</p>\n<p>如果这样子还不满意，可以直接去继承 <code class=\"language-text\">BasicErrorController</code> 通常这么做是为了支持更多的返回类型（比如 XML）。</p>\n<p><strong>注意</strong> <code class=\"language-text\">MethodArgumentNotValidException</code> 还是蛮重要的，后续会经常出现。</p>\n<h2 id=\"RestControllerAdvice\" style=\"position:relative;\">RestControllerAdvice<a href=\"#RestControllerAdvice\" aria-label=\"RestControllerAdvice permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>如果不想要默认的处理，那么就需要写一个 RestControllerAdvice 来处理所有的异常。我知道还有一些其他方式处理自定义异常，但是目前来看灵活性最高的就是这个了。</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestControllerAdvice</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyExceptionHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ResponseEntityExceptionHandler</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@ExceptionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">protected</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">handleConflict</span><span class=\"token punctuation\">(</span>\n      <span class=\"token class-name\">RuntimeException</span> ex<span class=\"token punctuation\">,</span> <span class=\"token class-name\">WebRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">handleExceptionInternal</span><span class=\"token punctuation\">(</span>ex<span class=\"token punctuation\">,</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span>CONFLICT<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>有了这部分代码，上文中的 <code class=\"language-text\">@GetMapping(\"hello\") public String getHello() { throw new IllegalStateException(); }</code> 将会走 <code class=\"language-text\">handleConflict</code> 方法处理。注意这里 <code class=\"language-text\">ResponseEntityExceptionHandler</code> 是 Spring 推荐的 ControllerAdvice 的基类，它提供了大量 spring mvc 报的异常的处理方法，通过对这些方法做重载可以自定义具体的报错信息。这篇就先不讲了。后续补充。</p>\n<h2 id=\"参考\" style=\"position:relative;\">参考<a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li><a href=\"https://www.baeldung.com/exception-handling-for-rest-with-spring\">Error Handling for REST with Spring</a></li>\n<li><a href=\"https://github.com/naturalprogrammer/spring-lemon\">spring lemon</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/3.2.4.RELEASE_to_4.0.0.M3/Spring%20Framework%203.2.4.RELEASE/org/springframework/web/servlet/mvc/method/annotation/ResponseEntityExceptionHandler.html\">ResponseEntityExceptionHandler</a></li>\n</ol>","fields":{"slug_without_date":"/spring-boot-exception-handler"}},{"id":"0f171a22-d74e-5373-93b2-9bed45a03fef","frontmatter":{"title":"对目前校验与异常处理的总结","date":"2020 November-22"},"html":"<h2 id=\"目前的问题\" style=\"position:relative;\">目前的问题<a href=\"#%E7%9B%AE%E5%89%8D%E7%9A%84%E9%97%AE%E9%A2%98\" aria-label=\"目前的问题 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>很久之前记录的一篇文章<a href=\"/spring-mvc-error-handler\">在用 Spring MVC 构建 RESTful API 时进行验证和异常处理</a>，讨论了基本的 rest 的校验思路：</p>\n<ol>\n<li>区分 <code class=\"language-text\">FormObject</code> 和 <code class=\"language-text\">Domain Entity</code> 尽量以 user-case 的场景为每一个 input 做独立的校验；</li>\n<li>基本结构校验（Bean Validation）和业务校验（Service Business Logic）分别处理；</li>\n<li>基本结构校验在 MVC 层，通过 <code class=\"language-text\">ControllerAdvice</code> 和 <code class=\"language-text\">BindingResult</code> 对其校验内容做转换暴露给客户端；</li>\n</ol>\n<p>在最近几年的项目里，基本还是依照这个思路来的。但是有以下几个痛点没有解决：</p>\n<ol>\n<li>业务逻辑和基本校验的逻辑很多时候边界很模糊，对于客户端来说，其实没什么区别，强行区分显得不是那么优雅；</li>\n<li>随着业务逻辑的越发复杂，大量的校验逻辑肯定是会放在 <code class=\"language-text\">application</code> 层的，那么关注点分离的需求愈发明显，将校验逻辑和正常流程区分才能让代码变得更清晰易懂；</li>\n<li><code class=\"language-text\">Exception</code> 的类别越来越多，报错信息五花八门，需要对其进行统一的梳理，并整理出一套规则，方便后续的维护开发套用；</li>\n</ol>\n<h2 id=\"目前的尝试\" style=\"position:relative;\">目前的尝试<a href=\"#%E7%9B%AE%E5%89%8D%E7%9A%84%E5%B0%9D%E8%AF%95\" aria-label=\"目前的尝试 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>为了解决以上问题，曾经做过以下的改进：</p>\n<p>对于第一条，并没有做处理，依然让业务逻辑和基本校验做了分离，尤其是对于那种需要触碰数据库的业务（比如查重）还是把它当作是业务逻辑的，仅仅是说通过 <code class=\"language-text\">BindingResult</code> 返回一致的报错结果了。这部分还是很希望能够把一些更复杂的校验也放到 Bean Validation 中去的。</p>\n<p>对于第二条，首先在 <code class=\"language-text\">application</code> 层也提供了一个 <code class=\"language-text\">ValidationResult</code> 它实现了 <code class=\"language-text\">org.springframework.validation.Errors</code> 可是说是在 <code class=\"language-text\">application</code> 层 <code class=\"language-text\">BindingResult</code> 的同类了，这样子就可以在 <code class=\"language-text\">application</code> 层返回和 <code class=\"language-text\">web</code> 层一样的报错结果了。然后提出了一个 <code class=\"language-text\">Validator</code> 的概念，专门用来做校验工作。举一个例子，下面是一个创建 <code class=\"language-text\">AutoML</code> 的方法，可以看到第一步就是做校验：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token keyword\">public</span> <span class=\"token class-name\">AutoML</span> <span class=\"token function\">createAutoML</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CreateModelCommand</span> command<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    autoMLValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>而 <code class=\"language-text\">AutoMLValidator</code> 内容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AutoMLValidator</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CreateModelCommand</span> command<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">ValidationResult</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ValidationResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    modelTemplateValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    autoMLNameValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    resourceValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">hasErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    autoMLDataBindingsValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">hasErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    parallelRunningCountValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">ClusterResource</span> clusterResource <span class=\"token operator\">=</span> <span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    resourceRelatedValidator<span class=\"token punctuation\">.</span><span class=\"token function\">validateJobLimitationAndComputationAndStorage</span><span class=\"token punctuation\">(</span>\n        command<span class=\"token punctuation\">.</span><span class=\"token function\">getOwner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> clusterResource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">hasErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到，这里面使用了 <code class=\"language-text\">web</code> 层类似的逻辑：</p>\n<ol>\n<li>有一个和 <code class=\"language-text\">BindingResult</code> 等价的 <code class=\"language-text\">ValidationResult</code> 用于收集校验结果;</li>\n<li>当校验不通过时，抛出异常 <code class=\"language-text\">InvalidRequestException(validationResult)</code>;</li>\n</ol>\n<p>这个方法很好的将业务逻辑异常拆出来了，还是很能解决问题的，也没太多副作用。硬要说的话就是 <code class=\"language-text\">ValidationResult</code> 有点难看，<code class=\"language-text\">InvalidRequestException</code> 有点像是 web 层漏到 application 层了，应该用个更好的类替代。</p>\n<p>对于第三点，整理出了一个类 <code class=\"language-text\">ErrorCode</code> 用来安放 <code class=\"language-text\">ErrorCode</code> 与 <code class=\"language-text\">ErrorMessage</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">ErrorCode</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">TRANSFER_REQUEST_TARGET_USER_EXISTED</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"资源已经有目标用户，请先将之前请求撤销\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">RESOURCE_NAME_NOTMATCH</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" 资源名称不匹配\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">RESOURCE_TRANSFER_TO_SELF</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" 不许与资源拥有者将资源传递给自己\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">RESET_PASSWORD_MISMATCH</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"无效的验证码\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">CODE_MISMATCH</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"无效的验证码\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  \n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> message<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> message<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在具体的报错的时候将 ad-hoc 的报错替换成这样的 KV 对即可。很显然这个写法有点像一个低配版本的国际化方案，显得有点拙劣，干嘛不直接换成 i18n 的 messages 呢？并且这个报错的格式也没有做统一，依然显得有点混乱。</p>\n<p>为了进一步的解决以上依然存在的问题，最近也开始重新看了 spring / springmvc / springboot 异常处理和校验的一些内容，后面应该会做以下事情：</p>\n<ol>\n<li>梳理目前 spring exception 的方式</li>\n<li>提出适合当前项目的最佳实践</li>\n<li>对目前的校验做改进，提出校验方面的最佳实践</li>\n</ol>","fields":{"slug_without_date":"/spring-boot-current-status"}},{"id":"14d5046f-f90e-5dc9-8df5-d2663406a2fb","frontmatter":{"title":"将 MySQL 通过 presslabs/mysql-operator 部署到 k8s 内部","date":"2020 October-19"},"html":"<p>目前 openbayes 的几乎所有组件都部署在 k8s 内部，但 mysql 作为核心的数据存储节点对其要求都蛮高的，对于目前的业务场景，其要求主要包含以下几点：</p>\n<ol>\n<li>需要持久化存储，一旦数据丢失问题非常严重</li>\n<li>对性能有要求，不然会拖垮依赖它的一切服务</li>\n<li>需要一些额外的备份机制，可以快速的从一个备份做恢复</li>\n<li>需要对应的监控体系</li>\n<li>mysql 需要可以比较容易的通过各种客户端访问，方便不同的角色对数据做分析或者做 debug</li>\n<li>*在规模比较大的时候可能会做读写分离</li>\n</ol>\n<p>之所以希望将 mysql 部署到 k8s 内主要还是希望达到以下目的：</p>\n<ol>\n<li>减少外部依赖，支持更广泛部署场景；目前对于一些环境是使用了云服务商所提供的数据库（aws / ucloud），然而并不是所有的情况都能这么做。</li>\n<li>统一部署模式，降低部署门槛；对于无法使用云服务商的数据库的场景，通常需要独立在某一台机器上安装 mysql 但这个部署模式与 k8s 是分离的，相当于多了一部分手工部署的工作量，而且手动部署也很难满足以上的几点要求的，自动化越少，部署门槛就会越高。</li>\n</ol>\n<p>下面介绍 presslabs/mysql-operator 如何满足这些要求，实现在一些环境中成功使用 k8s 内的 mysql 的。</p>\n<h2 id=\"基本介绍\" style=\"position:relative;\">基本介绍<a href=\"#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D\" aria-label=\"基本介绍 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在使用云服务商的数据库的时候我就在想，如果能有一套 k8s 的 operator 能够支持快速部署 / 数据库配置 / 周期性备份 / prometheus 指标暴露也不是难事呀，在做了简单的搜索后还真的发现了这么个东西 <a href=\"https://github.com/presslabs/mysql-operator\">presslabs/mysql-operator</a> ，满足了说所提及的这一切：</p>\n<ol>\n<li>内置了 mysql 部署配置，简单修改配置可以实现将 mysql 的存储放置在 hostPath 或者指定的 storageClass 解决了持久化存储的问题</li>\n<li>既然可以指定具体部署的存储，那么也能指定 mysql 部署的节点，性能的问题基本得到解决</li>\n<li>内置 extraBackup 支持手动或者 cronjob 周期性备份数据库到指定的对象存储</li>\n<li>部署起来的 mysql 自带 exporter 可以直接和 prometheus 对接，然后把数据通过 grafana 展示，监控 / 告警也就有了</li>\n<li>通过配置额外的 nodePort 类型的 Service 可以将 mysql 服务暴露出来，外部访问的问题就解决了</li>\n<li>这个 operator 本身就支持读写分离，不过我并没测试</li>\n</ol>\n<p><a href=\"https://github.com/presslabs/mysql-operator/blob/master/charts/mysql-operator/values.yaml\">https://github.com/presslabs/mysql-operator/blob/master/charts/mysql-operator/values.yaml</a> 这是 helm charts 的 values.yaml 把这个文件下载到本地，按照具体环境做一定修改后执行以下命令即可部署 operator 了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 这里用的是 helm3 \nhelm repo add presslabs https://presslabs.github.io/charts\nhelm install mysql presslabs/mysql-operator \\\n    -f values.yaml \\\n    -n infra --create-namespace</code></pre></div>\n<p>其中 <code class=\"language-text\">values.yaml</code> 需要修改的部分主要就是两部分：</p>\n<ol>\n<li>镜像位置（image sidecarImage orchestrator.image），国内部署速度不太行，建议自行拉到访问比较好的国内节点</li>\n<li>存储，默认 <code class=\"language-text\">persistence.enabled: false</code> 可以按照自己的情况做修改，这里只支持 <code class=\"language-text\">storageClass</code> 的方式</li>\n</ol>\n<p>部署好之后才是第一步，即成功部署了 <code class=\"language-text\">operator</code> 本身，下面就是具体部署一个 <code class=\"language-text\">mysql</code> 了，在 <a href=\"https://github.com/presslabs/mysql-operator/tree/master/examples\">https://github.com/presslabs/mysql-operator/tree/master/examples</a> 有一个例子，可以看到 mysql 被定义为了一个叫做 <code class=\"language-text\">MysqlCluster</code> 的 CRD。主要需要修改的部分有以下：</p>\n<ol>\n<li><code class=\"language-text\">secretName</code> 见 <a href=\"https://github.com/presslabs/mysql-operator/blob/master/examples/example-cluster-secret.yaml\">https://github.com/presslabs/mysql-operator/blob/master/examples/example-cluster-secret.yaml</a> 指初始化的一些数据，如 root 密码，数据库名称，用户名，用户密码</li>\n<li><code class=\"language-text\">image</code> / <code class=\"language-text\">mysqlVersion</code> mysql 的镜像，同样推荐修改为国内的镜像，具体版本也依照实际情况</li>\n<li><code class=\"language-text\">backupSchedule</code> 如果设置则是需要周期性备份，数据会按照该配置定期备份到指定的对象存储中，当然 <code class=\"language-text\">backupSecretName</code> 也需要配置正确才能使用</li>\n<li><code class=\"language-text\">mysqlConf</code> 对应 mysql.cnf 中的字段，依据自己需求配置</li>\n<li><code class=\"language-text\">volumeSpec</code> 数据持久化方式，和上文中 <code class=\"language-text\">operator</code> 的类似，但是更灵活，支持 hostPath</li>\n<li><code class=\"language-text\">initFileExtraSQL</code> 感觉这个 MysqlCluster 是希望用户每个数据库建立一个独立的资源，但是 openbayes 这里有一些附属数据库如果分开放置感觉有点没必要，所以这里就采用这个机制同时初始化了其他的数据库</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  initFileExtraSQL:\n    - \"CREATE DATABASE IF NOT EXISTS `&lt;otherdb>`\"\n    - \"DROP USER IF EXISTS &lt;otheruser>@'%'\"\n    - \"CREATE USER &lt;otheruser>@'%' IDENTIFIED BY '&lt;PASSOWRD>'\"\n    - \"GRANT ALL PRIVILEGES ON &lt;otherdb>.* TO &lt;otheruser>@'%'\"\n    - \"FLUSH PRIVILEGES\"</code></pre></div>\n<p>注意这里有个奇怪的写法是需要先去 <code class=\"language-text\">DROP USER</code>... 至于为啥我并不知道，我只知道不这么做就是会报错...</p>\n<h2 id=\"备份--恢复\" style=\"position:relative;\">备份 / 恢复<a href=\"#%E5%A4%87%E4%BB%BD--%E6%81%A2%E5%A4%8D\" aria-label=\"备份  恢复 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>如上文所述，这个 <code class=\"language-text\">MysqlCluster</code> 支持自动的备份，当然也支持主动的备份，具体的文档在<a href=\"https://www.presslabs.com/docs/mysql-operator/backups/\">这里</a>。</p>\n<p>既然支持备份也支持恢复，具体的文档在<a href=\"https://www.presslabs.com/docs/mysql-operator/cluster-recover/\">这里</a>。</p>\n<p>这些步骤我都测试过了，确认可以走的通的。以及这个备份的功能已经非常体贴了：</p>\n<ol>\n<li>支持手动备份通过 cron 控制</li>\n<li>支持保存最近的 N 个版本</li>\n<li>恢复只需要在初始 mysql 时填写 s3 路径即可</li>\n</ol>\n<p>在备份到 s3 不成功可以看看具体的报错信息，它具体备份采用的是 rclone 这个工具。不成功基本就是两个方向：</p>\n<ol>\n<li>s3 设置有问题，上传直接挂了</li>\n<li>你所使用的对象存储可能不是 rclone 会完全支持的，这种情况比较少见，但是我确实踩到了，具体来讲就是 ucloud 之前缺乏某些操作的支持，但是目前已经支持了呢</li>\n</ol>\n<h2 id=\"监控\" style=\"position:relative;\">监控<a href=\"#%E7%9B%91%E6%8E%A7\" aria-label=\"监控 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><img src=\"../img/in-post/youtube-dl/2020-10-19-18-34-53.png\" alt=\"\"></p>\n<p>如上图所示，这是我直接将 <a href=\"https://grafana.com/grafana/dashboards/7362\">https://grafana.com/grafana/dashboards/7362</a> 这个仪表盘导入所看到的效果。</p>\n<h2 id=\"外部访问\" style=\"position:relative;\">外部访问<a href=\"#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE\" aria-label=\"外部访问 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>增加一个额外的 NodePort 即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: v1\nkind: Service\nmetadata:\n  name: local-openbayes-mysql-nodeport-master\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n    protocol: TCP\n    targetPort: 3306\n    nodePort: 30016\n  selector:\n    app.kubernetes.io/managed-by: mysql.presslabs.org\n    app.kubernetes.io/name: mysql\n    mysql.presslabs.org/cluster: &lt;local-openbayes>\n    role: master\n  type: NodePort</code></pre></div>\n<h2 id=\"独立-io\" style=\"position:relative;\">独立 io<a href=\"#%E7%8B%AC%E7%AB%8B-io\" aria-label=\"独立 io permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在使用的过程中遇到一个特殊的情况，mysql 如果和其他的服务共用一个 storageClass 可能会出现 io 抢占的情况，导致 mysql 的延迟非常巨大。目前 k8s 还没有一个很好的办法解决这个问题。唯一想到的就是为 mysql 分配一套单独的 storageClass （比如 <a href=\"https://github.com/rancher/local-path-provisioner\">local storage path</a> 的方案）。</p>","fields":{"slug_without_date":"/mysql-operator"}},{"id":"96fc4033-6092-5005-8860-f8eb2a9b4f3b","frontmatter":{"title":"youtube-dl 的一些实用技巧","date":"2020 October-09"},"html":"<p>众所周知，在国内 youtube 是不能使用的，但 youtube 目前已经成为了一个视频 host 的存在了，其内容是非常丰富的，丰富到各种各样的学习资源也都放在这里。对个人来说，通过一些手段勉强还能看到一些内容，但如果想要投屏、或者分享，这就需要做一些搬运的工作了。目前来看 <a href=\"https://ytdl-org.github.io/youtube-dl/index.html\">youtude-dl</a> 是最强的 youtube 资源下载工具，没有之一。这里结合场景记录一下最近使用它的一些技巧，方便后续查阅。</p>\n<p>目前来看，bilibili 的性质非常像 youtube 如果需要将一些资源投屏或者分享给其他人，比较简单的办法就是将 youtube 资源直接搬运到 bilibili。这种场景通常有以下需求：</p>\n<ol>\n<li>需要下载最好的画质</li>\n<li>需要考虑下载声音和视频，当然有些时候可能只下载声音就够了</li>\n<li>需要下载字幕</li>\n</ol>\n<p>下面以一个 fastai 的搬运为例，来看看怎么用 youtube-dl 实现上述功能。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0ee6475a1d56423e2785612337ec870b/f0293/2020-10-09-23-37-08.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACj0lEQVQoz32S60/SURzG+QO6bbW15rJl84KSXHKZNqBQuygipF0kU7NCTU2xi83UyizTgNQMo4vozMRLa0Brpoj6IqRMQev/+TR+WrMX9eLZ833OOfucZ2dHtDMxGXGRCUnFdSRXzCRerkN86RrSq7dQNXX8U5p7Vo7etaBusVDe0kRzcz1pynREW/ankNTai8I+ivzZOxS9LmQ9wxx2eimY+UG+b/W/OuVbpWFukcaPs4jVGkTb9h8g6Y4FhW0A2ZM3yC39SDtfk2Z3ofcsoPcEMHgCgm+cDet7eneA7A9f0Pl+EqXJRrQ1Amy2IrUNIrX0I7cNCJ72Ygz9x6/oPEG0ngV03qAw50bmDW7wBoVLTk+vEK05+Rto40ifi/SeIWRWpwBM7RvDOPmdypkQ5TMhSj4vUTa9jGkmxKXpZSrW1/K8QaFpgW+V3RuBmhejAjClaxC5dQ1Y/HmJqtkw1bMrVPrDVPnD1M6tUDq1hMkXEuCRlpGn+RvYZCXLMcYJxyjK3mEOWJ2k2kcpmlyk2h+meL1p3VyYan+Iwk/fyHEH1tp5g+S5NzTckigj4eZDZO0OpG12JG3PkbTZOdj9Fu3EPNqJOXLfz6N7Py/476wd96N1+ciJaGSKPPcXolRZiDbHJRFb2UDi7Q7Etx4hbniMuOYOyTWNqB90o2rtQnn/6R8JOfIHra/JdIyT2eciwz7CcaebXYdUiDbFxLO3tIb42hbia5qIq21BUlxJui4f9ZkiMo2lHLtQhqaw+E/OMpagbGxHbXOi7nyFqvMlGT1D7JClItoeE0ts3jn2nS4lWm9kj+E80YYiYs9eRHbFjNxkRmGqF3xN9SjK65GWX0dmMiM1mYVzyRU3SEhT8gvd2AyiwHV/2QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2020 10 09 23 37 08\"\n        title=\"2020 10 09 23 37 08\"\n        src=\"/static/0ee6475a1d56423e2785612337ec870b/5a190/2020-10-09-23-37-08.png\"\n        srcset=\"/static/0ee6475a1d56423e2785612337ec870b/772e8/2020-10-09-23-37-08.png 200w,\n/static/0ee6475a1d56423e2785612337ec870b/e17e5/2020-10-09-23-37-08.png 400w,\n/static/0ee6475a1d56423e2785612337ec870b/5a190/2020-10-09-23-37-08.png 800w,\n/static/0ee6475a1d56423e2785612337ec870b/c1b63/2020-10-09-23-37-08.png 1200w,\n/static/0ee6475a1d56423e2785612337ec870b/29007/2020-10-09-23-37-08.png 1600w,\n/static/0ee6475a1d56423e2785612337ec870b/f0293/2020-10-09-23-37-08.png 2250w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>这个是最新的 fastai 的视频讲解的第一节，其 url 为 <a href=\"https://www.youtube.com/watch?v=_QUEXsHfsA0&#x26;t=4s\">https://www.youtube.com/watch?v=_QUEXsHfsA0&#x26;t=4s</a> 。</p>\n<p>如果有最简单的命令如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">youtube-dl https://www.youtube.com/watch\\?v\\=_QUEXsHfsA0\\&amp;t\\=4s</code></pre></div>\n<p>其生成日志如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[youtube] _QUEXsHfsA0: Downloading webpage\nWARNING: Requested formats are incompatible for merge and will be merged into mkv.\n[download] Destination: Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.f137.mp4\n[download] 100% of 178.27MiB in 02:17\n[download] Destination: Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.f251.webm\n[download] 100% of 75.84MiB in 01:16\n[ffmpeg] Merging formats into \"Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.mkv\"\nDeleting original file Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.f137.mp4 (pass -k to keep)\nDeleting original file Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.f251.webm (pass -k to keep)</code></pre></div>\n<p>首先这样子生成的 <code class=\"language-text\">.mkv</code> 格式文件找个播放器就可以用了。自己拷贝到自己的设备上也可以看了，并且其默认下载的就是最优画质，这个甚至 bilibili 上传也没什么问题。但是有两个小缺点：</p>\n<ol>\n<li>mkv 格式相对于 mp4 的兼容性会略差，也就是有些地方不一定可以播放，并且 bilbili 是更推荐上传 mp4 格式</li>\n<li>没有下载相应的字幕，算是个生肉</li>\n</ol>\n<p>下一步为了解决以上两个问题，可以做下述的变化。</p>\n<h2 id=\"修改输出格式\" style=\"position:relative;\">修改输出格式<a href=\"#%E4%BF%AE%E6%94%B9%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F\" aria-label=\"修改输出格式 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>首先是更换输出文件格式：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">youtube-dl https://www.youtube.com/watch\\?v\\=_QUEXsHfsA0\\&amp;t\\=4s --merge-output-format mp4</code></pre></div>\n<p>这样子输出的就是 <code class=\"language-text\">.mp4</code> 格式了。</p>\n<h2 id=\"下载字幕\" style=\"position:relative;\">下载字幕<a href=\"#%E4%B8%8B%E8%BD%BD%E5%AD%97%E5%B9%95\" aria-label=\"下载字幕 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在下载字幕之前首先需要确认下该视频到底支持哪些语言的字幕：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">youtube-dl https://www.youtube.com/watch\\?v\\=_QUEXsHfsA0\\&amp;t\\=4s --list-subs</code></pre></div>\n<p>会展示所有支持的字幕以及其格式，包括机器生成字幕以及人工提交字幕等内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[youtube] _QUEXsHfsA0: Downloading webpage\n[youtube] _QUEXsHfsA0: Looking for automatic captions\nAvailable automatic captions for _QUEXsHfsA0:\nLanguage formats\nmy       vtt, ttml, srv3, srv2, srv1\nca       vtt, ttml, srv3, srv2, srv1\nceb      vtt, ttml, srv3, srv2, srv1\nzh-Hans  vtt, ttml, srv3, srv2, srv1\nzh-Hant  vtt, ttml, srv3, srv2, srv1\nco       vtt, ttml, srv3, srv2, srv1\n...\nAvailable subtitles for _QUEXsHfsA0:\nLanguage formats\nar       vtt, ttml, srv3, srv2, srv1\nbg       vtt, ttml, srv3, srv2, srv1\nzh-Hans  vtt, ttml, srv3, srv2, srv1\nen       vtt, ttml, srv3, srv2, srv1</code></pre></div>\n<p>可以看到人工提交的字幕有 <code class=\"language-text\">zh-Hans</code> 不过其提供的字幕格式（vtt, ttml, srv3, srv2, srv1）很不常见的样子。在 bilibili 是需要提交 <code class=\"language-text\">srt</code> 格式的字幕。这里 <code class=\"language-text\">youtube-dl</code> 也给考虑到了，其 <code class=\"language-text\">    --convert-subs</code> 参数支持 <code class=\"language-text\">srt ass vtt lrc</code> 这些字幕格式的转换：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">youtube-dl https://www.youtube.com/watch\\?v\\=_QUEXsHfsA0\\&amp;t\\=4s --merge-output-format mp4 --write-sub --sub-lang zh-Hans --sub-format vtt --convert-subs srt</code></pre></div>\n<p>这样子对应的字幕以及格式转换也都搞定了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[youtube] _QUEXsHfsA0: Downloading webpage\n[info] Writing video subtitles to: Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.zh-Hans.vtt\n[download] Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.mp4 has already been downloaded and merged\n[ffmpeg] Converting subtitles\nDeleting original file Lesson 1 - Deep Learning for Coders (2020)-_QUEXsHfsA0.zh-Hans.vtt (pass -k to keep)</code></pre></div>\n<h2 id=\"自定义下载格式\" style=\"position:relative;\">自定义下载格式<a href=\"#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8B%E8%BD%BD%E6%A0%BC%E5%BC%8F\" aria-label=\"自定义下载格式 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>如果需要自由选择下载视频的大小，可以按照以下方式操作：</p>\n<p>首先通过参数罗列支持的格式：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">youtube-dl https://www.youtube.com/watch\\?v\\=_QUEXsHfsA0\\&amp;t\\=4s --list-formats</code></pre></div>\n<p>输出如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[youtube] _QUEXsHfsA0: Downloading webpage\n[info] Available formats for _QUEXsHfsA0:\nformat code  extension  resolution note\n249          webm       audio only tiny   54k , opus @ 50k (48000Hz), 27.19MiB\n250          webm       audio only tiny   87k , opus @ 70k (48000Hz), 40.85MiB\n140          m4a        audio only tiny  134k , m4a_dash container, mp4a.40.2@128k (44100Hz), 76.42MiB\n251          webm       audio only tiny  164k , opus @160k (48000Hz), 75.84MiB\n160          mp4        256x144    144p   71k , avc1.4d400c, 30fps, video only, 8.53MiB\n278          webm       256x144    144p   87k , webm container, vp9, 30fps, video only, 19.13MiB\n242          webm       426x240    240p  171k , vp9, 30fps, video only, 29.85MiB\n133          mp4        426x240    240p  220k , avc1.4d4015, 30fps, video only, 15.86MiB\n243          webm       640x360    360p  406k , vp9, 30fps, video only, 58.88MiB\n134          mp4        640x360    360p  584k , avc1.4d401e, 30fps, video only, 28.04MiB\n244          webm       854x480    480p  766k , vp9, 30fps, video only, 96.62MiB\n135          mp4        854x480    480p 1157k , avc1.4d401f, 30fps, video only, 42.30MiB\n247          webm       1280x720   720p 1622k , vp9, 30fps, video only, 180.75MiB\n136          mp4        1280x720   720p 2102k , avc1.4d401f, 30fps, video only, 60.57MiB\n248          webm       1920x1080  1080p 3132k , vp9, 30fps, video only, 324.32MiB\n137          mp4        1920x1080  1080p 4356k , avc1.640028, 30fps, video only, 178.27MiB\n22           mp4        1280x720   720p  231k , avc1.64001F, 30fps, mp4a.40.2@192k (44100Hz)\n18           mp4        640x360    360p  297k , avc1.42001E, 30fps, mp4a.40.2@ 96k (44100Hz), 175.59MiB (best)</code></pre></div>\n<p>可以看到存在三种类型：</p>\n<ol>\n<li>audio only</li>\n<li>video only</li>\n<li>video + audio</li>\n</ol>\n<p>这个视频很显然其 <code class=\"language-text\">video + audio</code> 的格式 22 和 18 都不是最优解。默认是选取了 251 和 137 （最好声音 + 最好画质）做了合并（也就是 <code class=\"language-text\">--merge-output-format</code> 的作用）。如果需要其他组合可以通过命令 <code class=\"language-text\">-f &lt;video>+&lt;audio></code> 形式：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">youtube-dl https://www.youtube.com/watch\\?v\\=_QUEXsHfsA0\\&amp;t\\=4s -f 137+140 --merge-output-format mp4 --write-sub --sub-lang zh-Hans --sub-format vtt --convert-subs srt</code></pre></div>","fields":{"slug_without_date":"/youtube-dl"}}],"pageInfo":{"hasPreviousPage":true,"currentPage":3,"pageCount":22}}},"pageContext":{"limit":5,"skip":10}},"staticQueryHashes":[]}
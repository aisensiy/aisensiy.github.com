{
    "componentChunkName": "component---src-templates-blogs-js",
    "path": "/page/23",
    "result": {"data":{"site":{"siteMetadata":{"title":"eisen-s-blog"}},"blogs":{"nodes":[{"id":"0d154091-168a-5431-b72b-ce9878e9354c","frontmatter":{"title":"在 Spring Boot 中使用 HATEOAS","date":"2017 June-04"},"html":"<p>HATEOAS, Hypermedia as the Engine of Application State, 可以被简单的理解为为 REST API 中的 Resource 提供必要的链接，对，就像是 HTML 页面上的链接。我们在访问一个 web 站点的时候从来没有说要看一个说明文档并在其中找到我们所需要的资源的 URI，而是通过一个入口页面（当然，搜索引擎也提供了入口）所包含的链接，一步一步找到我们想要的内容。HATEOAS 是 REST 架构风格重要的组成部分，然而对于现在的诸多 REST 接口中却并没有它的身影。它被 <a href=\"https://martinfowler.com/articles/richardsonMaturityModel.html\">Richardson Maturity Model</a> 定义为 REST 的最终形态。</p>\n<h2 id=\"hateoas-的优势\" style=\"position:relative;\">HATEOAS 的优势<a href=\"#hateoas-%E7%9A%84%E4%BC%98%E5%8A%BF\" aria-label=\"hateoas 的优势 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>然而，使用 HATEOAS 可以带来什么样子的好处呢。从我自身的感受有以下两个方面。</p>\n<h3 id=\"1-协议解耦\" style=\"position:relative;\">1. 协议解耦<a href=\"#1-%E5%8D%8F%E8%AE%AE%E8%A7%A3%E8%80%A6\" aria-label=\"1 协议解耦 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>既然是 RESTful API 那么其用户一般来说不是写这个 API 的人，比如前端，比如其他的服务提供者。为了尽量避免不必要的资源浪费，需要他们之间协调一致。这个时候 RESTful API 的接口设计就显得尤为重要了：如何快速达成一致并保证其接口的稳定是项目快速进展的重要前提。</p>\n<p>通常的做法是通过文档定义接口的路径、动作、Payload 等内容。然后，这个文档就成了多个人或者是多个人之间的一个协议：想要做任何的修改都需要多方达成一致。并且，事无巨细的打成一直：路径、动作、Payload。不过 RESTful API 就是在规约方法和动作了：路径是资源的名称、资源的状态，动作是 <code>GET</code> <code>PUT</code> <code>POST</code> <code>DELETE</code> 的其中之一。而支持 HATEOAS 的 REST API 则更进一步，将路径转换为行为以进一步增加 REST API 自身的灵活性，尽量少让后端的接口定义与其他系统形成耦合。这样做之后，API 就可以有一个逐条定义的，非常琐碎的契约变成了一个可发现式的契约。</p>\n<p>这里引用一个在 <a href=\"https://speakerdeck.com/olivergierke/domain-driven-design-and-rest\">DDD &#x26; REST</a> 的一个例子：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/77871f1b45b12fb17f9c8b3842571f24/e6c84/raw-url-protocol.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAByUlEQVQoz11Ti47cIAy8///CSlWl0/b29vIm4Y2BqcbJ7rVFSsDGDGN7eAMAkQrnI6RW9N7pQimCUqqu6Xv6OfuQ8BwdHTFlxeB462jY3Y6ftxtsPJDEQ1rGuM76Sc+I4tWfJGI2K97vd2zWqJ1rwLhNsN49ATtqExzOo/UKaQWtNxzOYXcOvbfLJ4g54eNrxLRu+BxnZCmoXXSfcSdg75g3g8e0YDFGA0JKGJdVD7oQ1FcvwPePB34/BgUuF2DMLJecgPz5GDHMK0KK5IsignHZ9KKUs/rIotaKxzjj9jloPFkxu1QSaqvfKZdaNL3n5nZYmMNiOw6dS80Amh4iux+/brgPk9q1l/8Ae4c00dRYw1QyjLVqf15syPTwTi/ardXLtRTtLEWW/C9g04Ke87O4tK0P2K3Dtp+MzeFUWqdYmsaTxHnulJamzBvIQmpRyfhIdhOGZVEmrGGDKKOvecF9GDGuq9qMDyn83ZSudJ0Peis7uZrjxWzZdm0WmXDQz33KjIOgyhAXQwLyALvK4lIC02qwml1lROn4FLQxi9nVZjact6th2pRav2XDuvA51XZ2MsSkz4kf19wnC64ZF2J+xah0ans9zT+6GqZ5689+YgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"raw url protocol\"\n        title=\"raw url protocol\"\n        src=\"/static/77871f1b45b12fb17f9c8b3842571f24/5a190/raw-url-protocol.png\"\n        srcset=\"/static/77871f1b45b12fb17f9c8b3842571f24/772e8/raw-url-protocol.png 200w,\n/static/77871f1b45b12fb17f9c8b3842571f24/e17e5/raw-url-protocol.png 400w,\n/static/77871f1b45b12fb17f9c8b3842571f24/5a190/raw-url-protocol.png 800w,\n/static/77871f1b45b12fb17f9c8b3842571f24/e6c84/raw-url-protocol.png 1148w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c64f9671a98e016491350ad42c2cb94d/fe9e8/semantic-protocol.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABtUlEQVQoz1VTi24jIQzs/3/j6a6q0mvTzT55Y8NUY7JJuxKBwHg8HsMLANQqcD5BVAF0lCLwIdkQabbXeycUrXWEmHF+3I8pQ0Tt/0tHw+o2/Hl7g88ORSOOcODv5YLX/+/wySNrRJKALAnTOuPf5WIxRZLhr8sEn8JJ2KFNcPiA1hVVix3ElJByNnWiFdoFpVYs+47De6zHAVWBtgppFa23QcjFbd3w8XUzMAFUzb15221thI2EBR/TDdOyYl43CAl7RSrJ1kbIHx8jrrcFqWQLpKrdeRsnoTQxFct+GHacjepyzVDVZ8lVKnbvLWjIVwt0YfjSoWgYAUxO9bkU9N4Mb4TtJOzd5BLIbGOoKfi8zebX5hx278znkCK2w6HISGxWSPlNOAwdM0GnwS5ELNthaknCcZY2sE88eXizrGRKZhmUXzWbb2wI1Y1goZOm5nOa8X79ssaoWVQQc/zZlG5ZfYh3T55NYYlMKHcr+HF/JBv+jmap4ajSCGNOlpFK5X5teM9YonW5VRTJRkQcq+HMcyr81WXLIgofE7S1xxPLuSKX+nhePOOT4+BT45xSGWeqj7hvv/6qCHUNz4wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"semantic protocol\"\n        title=\"semantic protocol\"\n        src=\"/static/c64f9671a98e016491350ad42c2cb94d/5a190/semantic-protocol.png\"\n        srcset=\"/static/c64f9671a98e016491350ad42c2cb94d/772e8/semantic-protocol.png 200w,\n/static/c64f9671a98e016491350ad42c2cb94d/e17e5/semantic-protocol.png 400w,\n/static/c64f9671a98e016491350ad42c2cb94d/5a190/semantic-protocol.png 800w,\n/static/c64f9671a98e016491350ad42c2cb94d/fe9e8/semantic-protocol.png 1146w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>当然，探索式的 API 的问题在于原来一个步骤能完成的事情可能会变成多个步骤：从入口找到资源，再从资源中获取链接。</p>\n<h3 id=\"2-passive-view\" style=\"position:relative;\">2. Passive View<a href=\"#2-passive-view\" aria-label=\"2 passive view permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><a href=\"https://martinfowler.com/eaaDev/PassiveScreen.html\">Passive View</a> 是以前后端渲染的 MVC 中 View 的一种实现方式。它强调</p>\n<blockquote>\n<p>A screen and components with all application specific behavior extracted into a controller so that the widgets have their state controlled entirely by controller.</p>\n</blockquote>\n<p>也就是说 View 仅仅负责数据的展示。任何业务逻辑都不应该在前端展示，因为一方面前端有可能会被跳过（比如我直接用 curl 去访问后端 API），另一方面，面对多个前端的时候会存在重复的代码，当业务逻辑需要修改也会是沉重的负担。这里先列举把后端逻辑暴露给前端的情况</p>\n<ol>\n<li>数据验证逻辑，比如哪些字段必须是唯一的，那些数据是必选的</li>\n<li>对后端发送请求的 payload 格式、路径、方法，比如创建一个订单时提交订单的数据格式</li>\n<li>对不同用户访问相同资源时的权限差异，比如论坛系统中，只有管理员才能删除帖子，而对于普通用户就不应当出现删除的按钮</li>\n<li>相同资源在不同状态下的不同的状态迁移方法，比如订单系统中，只有未付款的订单才需要支付的链接</li>\n<li>对返回数据的格式的依赖</li>\n</ol>\n<p>其中想要对 1 2 解耦需要后端提供一个表单验证的 schema 我觉得将来还是可以解决的，但是目前没见到谁在做。5 的格式本来就存在于 API 返回的结果之中，不辩自明，所以称不上耦合。3 4 涉及了权限以及资源本身的状态迁移，是很难做到解耦的：需要前端知道资源的权限和状态迁移的方向。而 HATEOAS 恰好解决了这个问题：通过提供或者不提供向某个状态迁移的链接来表示当前用户是否有权限这么做。</p>\n<h2 id=\"在-spring-boot-实现-hateoas\" style=\"position:relative;\">在 Spring Boot 实现 HATEOAS<a href=\"#%E5%9C%A8-spring-boot-%E5%AE%9E%E7%8E%B0-hateoas\" aria-label=\"在 spring boot 实现 hateoas permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>HATEOAS 的实现，有几个比较典型的场景。我们结合代码介绍都要怎么做。不过首先先放上 <code>gradle</code> 项目的 <code>build.gradle</code> 文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">buildscript <span class=\"token punctuation\">{</span>\n\text <span class=\"token punctuation\">{</span>\n\t\tspringBootVersion <span class=\"token operator\">=</span> <span class=\"token string\">'1.5.3.RELEASE'</span>\n\t<span class=\"token punctuation\">}</span>\n\trepositories <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">mavenCentral</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tdependencies <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">classpath</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"org.springframework.boot:spring-boot-gradle-plugin:<span class=\"token expression\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>springBootVersion<span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'java'</span>\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'eclipse'</span>\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'idea'</span>\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'org.springframework.boot'</span>\n\nversion <span class=\"token operator\">=</span> <span class=\"token string\">'0.0.1-SNAPSHOT'</span>\nsourceCompatibility <span class=\"token operator\">=</span> <span class=\"token number\">1.8</span>\n\nrepositories <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">mavenCentral</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n\ndependencies <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-starter-hateoas'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-starter-web'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.atteo:evo-inflector:1.2.2'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">runtime</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-devtools'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compileOnly</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.projectlombok:lombok'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">testCompile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-starter-test'</span><span class=\"token punctuation\">)</span>\n\ttestCompile <span class=\"token string\">'io.rest-assured:rest-assured:3.0.2'</span>\n\ttestCompile <span class=\"token string\">'io.rest-assured:spring-mock-mvc:3.0.2'</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>可以看到，这里引入了 spring boot 的 <code>hateoas</code> 的依赖。</p>\n<h3 id=\"1-最基本的包装数据为其提供链接\" style=\"position:relative;\">1. 最基本的，包装数据，为其提供链接<a href=\"#1-%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%8C%85%E8%A3%85%E6%95%B0%E6%8D%AE%E4%B8%BA%E5%85%B6%E6%8F%90%E4%BE%9B%E9%93%BE%E6%8E%A5\" aria-label=\"1 最基本的包装数据为其提供链接 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>还有以 spring boot 中 Greeting 的对象为例，我们首先定义一个数据对象:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Greeting</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> content<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Greeting</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> content<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后有一个 API 可以访问到它：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"greeting\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GreetingApi</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> TEMPLATE <span class=\"token operator\">=</span> <span class=\"token string\">\"Hello, %s\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GreetingResource</span> <span class=\"token function\">getGreeting</span><span class=\"token punctuation\">(</span>\n        <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> defaultValue <span class=\"token operator\">=</span> <span class=\"token string\">\"World\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">GreetingResource</span> resource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GreetingResource</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">Greeting</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>TEMPLATE<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span>\n        resource<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>\n            <span class=\"token function\">linkTo</span><span class=\"token punctuation\">(</span><span class=\"token function\">methodOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GreetingApi</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getGreeting</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withSelfRel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2</span>\n        <span class=\"token keyword\">return</span> resource<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到</p>\n<ol>\n<li>用 <code>GreetingResource</code> 对原始的 <code>Greeting</code> 对象进行了包装。</li>\n<li>通过 <code>linkTo</code> 方法，添加了一个 <code>self</code> link</li>\n</ol>\n<p>该请求所获取的结果如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hello, World\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"_links\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"self\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"href\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://localhost/greeting?name=World\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中 <code>GreetingResource</code> 如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">GreetingResource</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Resource</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Greeting</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Greeting</span> greeting<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GreetingResource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Greeting</span> content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>通过继承自 spring hateoas 所提供的 <code>Resource&#x3C;T></code> <code>GreetingResource</code> 默认将 <code>Greeting</code> 的 Get 方法都实现了。所以，上面的返回结果中会出现 <code>content</code> 字段。</p>\n<h3 id=\"2-依据当前资源的状态提供不同的链接\" style=\"position:relative;\">2. 依据当前资源的状态，提供不同的链接<a href=\"#2-%E4%BE%9D%E6%8D%AE%E5%BD%93%E5%89%8D%E8%B5%84%E6%BA%90%E7%9A%84%E7%8A%B6%E6%80%81%E6%8F%90%E4%BE%9B%E4%B8%8D%E5%90%8C%E7%9A%84%E9%93%BE%E6%8E%A5\" aria-label=\"2 依据当前资源的状态提供不同的链接 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>这里，我们有一个 Order 对象，对于其 Status 的不同，需要提供不同的 link</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token annotation punctuation\">@EqualsAndHashCode</span><span class=\"token punctuation\">(</span>of <span class=\"token operator\">=</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Order</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Status</span> status<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LineItem</span><span class=\"token punctuation\">></span></span> items<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Order</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LineItem</span><span class=\"token punctuation\">></span></span> items<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> items<span class=\"token punctuation\">;</span>\n        status <span class=\"token operator\">=</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">pay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Only new order can be paid\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span>PAID<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">paid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> status <span class=\"token operator\">==</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span>PAID<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Value</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LineItem</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> productId<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">double</span> price<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> amount<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Status</span> <span class=\"token punctuation\">{</span>\n        CREATED<span class=\"token punctuation\">,</span> PAID<span class=\"token punctuation\">,</span> CANCELLED<span class=\"token punctuation\">,</span> FINISHED\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们可以在 <code>OrderResource</code> 的构造函数中做手脚：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderResource</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Resource</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Order</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderResource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>\n            <span class=\"token function\">linkTo</span><span class=\"token punctuation\">(</span><span class=\"token function\">methodOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderApi</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orderResource</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">withSelfRel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>order<span class=\"token punctuation\">.</span><span class=\"token function\">paid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>\n                <span class=\"token function\">linkTo</span><span class=\"token punctuation\">(</span><span class=\"token function\">methodOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderApi</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pay</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">withRel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"payment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当然，在 controller 中将 link 传入构造函数也是可行的，那样的好处是将 Controller 的信息都留在了 Controller，但是不好的地方在于 Resource 这个对象实在是有点贫血，然后 controller 就变得庞大了一些。对其的测试就不在这里展示了。</p>\n<h3 id=\"3-处理集合\" style=\"position:relative;\">3. 处理集合<a href=\"#3-%E5%A4%84%E7%90%86%E9%9B%86%E5%90%88\" aria-label=\"3 处理集合 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>除了 <code>Resource&#x3C;T></code> spring hateoas 还有一个 <code>Resources&#x3C;T></code> 用于处理集合：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@GetMapping</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Resources</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderResource</span><span class=\"token punctuation\">></span></span> resources <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Resources</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n        orderRepository\n            <span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderResource</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    resources<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">linkTo</span><span class=\"token punctuation\">(</span><span class=\"token function\">methodOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderApi</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withSelfRel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>resources<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其结果是这个样子的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"_embedded\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"orders\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token comment\">// 1</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"123\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"CREATED\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"items\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"productId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"product1\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"price\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1.22</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"amount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"_links\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"self\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"href\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://localhost/orders/123\"</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">\"payment\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"href\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://localhost/orders/123/payment\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"_links\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"self\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"href\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://localhost/orders\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>资源 order 被默默转变为了 <code>orders</code> 这是因为在 <code>build.gradle</code> 中添加了 <code>compile('org.atteo:evo-inflector:1.2.2')</code> 它可以帮助我们为集合提供英文复数的转换。如果你感兴趣可以尝试一下把这个依赖删除后会是神马样子。</li>\n</ol>\n<p>完整的代码见 <a href=\"https://github.com/aisensiy/demo-for-spring-boot-hateoas\">Github</a></p>\n<h2 id=\"相关资料\" style=\"position:relative;\">相关资料<a href=\"#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99\" aria-label=\"相关资料 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://speakerdeck.com/olivergierke/domain-driven-design-and-rest\">DDD &#x26; REST</a></li>\n<li><a href=\"https://martinfowler.com/eaaDev/PassiveScreen.html\">Passive View</a></li>\n<li><a href=\"https://spring.io/understanding/HATEOAS\">Understanding HATEOAS</a></li>\n<li><a href=\"https://spring.io/guides/gs/rest-hateoas/\">Building a Hypermedia-Driven RESTful Web Service</a></li>\n<li><a href=\"https://olivergierke.de/2016/04/benefits-of-hypermedia/\">The Benefits of Hypermedia APIs</a></li>\n</ul>","fields":{"slug_without_date":"/spring-boot-and-hateoas"}},{"id":"7ed84f88-4089-50db-af34-f67923a47a1f","frontmatter":{"title":"将 sonarQube 和 gradle spring boot 项目集成","date":"2017 May-16"},"html":"<p>在联想的项目接触了一下 <a href=\"https://www.sonarqube.org/\">sonarQube</a> 整体来说还是有很多可圈可点之处的，碰巧最近有一个相关产品的选择试用的调研，就尝试了一下下。</p>\n<p>sonarQube 自己说自己用于做 continuous code quality， 从它所生成的默认的报告来看，主要包含了如下几个部分：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bcbf88597fa43e6bf0beb5c343bdac0a/098c1/2021-07-27-13-34-04.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACvUlEQVQ4yz2RS2/cRhCE+Z/9s4LcbCfOJYfkYFmSI0vyeldWxNVySQ45fM2jex4kpwJRjgcoTNXXQB+qMynlx+J8kqYz1fvqff3m/k1939/VkWOtramttbU1P35ra2OpJuKamGtm91OWaJtlbdMU+blE3Ujk5TO+Fgc8ywZkCcYakLWwHGAtwVoNbwtM8gFj/R29eEDfHNCW3+DGI7ytkRmjc2UtjFtW1R2S1zJpnlOMIcUYEzmfonxM0XOK0afZHlLU+3R//iO14lMieZfa9io9dX+mhY4pCyHkABAXrN14xLJY/P+WdYXUhHksAKwAEhLtoPtb3FYfEOgGoB3K5hJ78TsW+4jMOZenlOCI1nEyUBwwzxHzssAYg77rMBnCPC+YY0Cwzxjbb9DtA7zONz82e0xiD1InZMMw5ELUEK1ce2Uws4c2eltmrQUzgclueZN1IPbwbgZThCUP5rAxSw6Z1io3WqEb9XoaezzpJyxxQQgBMQZY56HZIcaIEDw8VVv5xbBDpx6wsIDRZzhbwlODzPBrhz3F9WsrkfPpZ4cJwLHXeJTTa04LwHcQ9TWujr9h1H9hVV9wOH7E0H7CYg/ImkHlZadQyGFtx5drA4P1UBzRa8a56VDJ/pWRA007yOoKY30DP+3QlJdozpdoigvo4YCs77tcVBVKOa7OOQRH8I7BRGBmxOA3vfiXPok0HBswa5BVCM5seWNkkIUQc44BHan1aaB0VpwGDsnPawpLSrV26TTR5l2Myasvadafk2yvUl5epcfiMvH0TwrqOjn1LWWjCcV+HHDTVbh4anBbTsiniNLMqOyC2/OAz0WPyiaUmqGbDzDNOxTP7/B99wv+3f+KoXwLI97CyL+R9cpcNIr7VnMtJyukIiG1E63iV/1g7caMUN2tUN2NEPWNqE8XQhQXQlbXG1P9XvwHcgPRNRIAIxkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 07 27 13 34 04\"\n        title=\"2021 07 27 13 34 04\"\n        src=\"/static/bcbf88597fa43e6bf0beb5c343bdac0a/5a190/2021-07-27-13-34-04.png\"\n        srcset=\"/static/bcbf88597fa43e6bf0beb5c343bdac0a/772e8/2021-07-27-13-34-04.png 200w,\n/static/bcbf88597fa43e6bf0beb5c343bdac0a/e17e5/2021-07-27-13-34-04.png 400w,\n/static/bcbf88597fa43e6bf0beb5c343bdac0a/5a190/2021-07-27-13-34-04.png 800w,\n/static/bcbf88597fa43e6bf0beb5c343bdac0a/c1b63/2021-07-27-13-34-04.png 1200w,\n/static/bcbf88597fa43e6bf0beb5c343bdac0a/098c1/2021-07-27-13-34-04.png 1578w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>不过打开一看会发现其实 <code>Bugs &#x26; Vulnerabilities</code> 和 <code>Code Smells</code> 基本上就是 lint 所做的事情，比如代码风格不符合 java 的规约呀，在使用 <code>Optional</code> 之前判断其是否 <code>isPresent</code> 呀等等，不过人家本来就是做静态检查的也无可厚非。</p>\n<p><code>Code Smells</code> 这个名字实在是太唬人了，在 <a href=\"https://book.douban.com/subject/4262627/\">重构</a> 里定义设计的好坏在于有没有代码的坏味道，如果 sonarqube 有能力甄别所有的代码坏味道的话，那还怕神马低质量代码呢。不过起码 sonarqube 有能力甄别一部分低级的代码坏味道，比如过长的方法参数：</p>\n<blockquote>\n<p>Constructor has 9 parameters, which is greater than 7 authorized.</p>\n</blockquote>\n<p>再比如重复的代码呀</p>\n<blockquote>\n<p>1 duplicated blocks of code must be removed.</p>\n</blockquote>\n<p>甚至是提醒我们哪个方法所在的位置不合适</p>\n<blockquote>\n<p>Move this method into \"Builder\"</p>\n</blockquote>\n<p>这么看来其功能还是可圈可点的，而且我所使用的还仅仅是最基本的配置，没有做任何的自定义。</p>\n<h2 id=\"集成\" style=\"position:relative;\">集成<a href=\"#%E9%9B%86%E6%88%90\" aria-label=\"集成 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>下面我介绍一下如何把 sonarqube 和 spring boot gradle 的项目做集成的。</p>\n<h3 id=\"安装-sonarqube\" style=\"position:relative;\">安装 sonarqube<a href=\"#%E5%AE%89%E8%A3%85-sonarqube\" aria-label=\"安装 sonarqube permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>最好的安装办法自然是 <a href=\"https://store.docker.com/images/sonarqube\">docker</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run -d --name sonarqube -p 9000:9000 -p 9092:9092 sonarqube</code></pre></div>\n<h3 id=\"修改-gradle\" style=\"position:relative;\">修改 gradle<a href=\"#%E4%BF%AE%E6%94%B9-gradle\" aria-label=\"修改 gradle permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>按照 sonarqube 的<a href=\"https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Gradle\">文档</a> 添加插件。</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">plugins <span class=\"token punctuation\">{</span>\n  id <span class=\"token string gstring\">\"org.sonarqube\"</span> version <span class=\"token string gstring\">\"2.4\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后 <code>./gradlew clean test sonar</code> 执行命令。之后就可以在 <a href=\"http://localhost:9000\">http://localhost:9000</a> 看到结果了。</p>\n<p>不过这个时候你会发现并没有测试覆盖率的数据。</p>\n<p>这是因为 sonarqube 自己不做测试覆盖的处理，它依赖于其他的测试覆盖工具。比如这里我们使用 <a href=\"https://www.eclemma.org/jacoco/\">jacoco</a>。</p>\n<p>在 <code>build.gradle</code> 中添加 <code>jacoco</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">apply plugin <span class=\"token string\">'jacoco'</span></code></pre></div>\n<p>然后 <code>./gradlew clean test jacoco sonar</code> 再去 <a href=\"http://localhost:9000\">http://localhost:9000</a> 查看就有相应的数据了。</p>\n<h3 id=\"和-ci-集成\" style=\"position:relative;\">和 ci 集成<a href=\"#%E5%92%8C-ci-%E9%9B%86%E6%88%90\" aria-label=\"和 ci 集成 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>刚才我们只是将我们的项目和一个本地的 sonarqube server 集成了，但是在实际项目中我们通常都是在 ci 中执行 sonar 命令并有一个共有的 sonar server 展现目前主分支代码的质量。那么，我们就需要在 ci 中指定外部的 sonar server 地址以及一些其他自定义的内容。</p>\n<p>由于 sonarqube 支持以命令行的方式传入参数，这样的工作非常的简单：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">./gradlew sonar -Dsonar.host.url=http://sonar.mycompany.com -Dsonar.verbose=true</code></pre></div>\n<p>最后附上测试<a href=\"https://github.com/aisensiy/springboot-get-started\">项目地址</a>。</p>","fields":{"slug_without_date":"/sonarqube-integration-with-spring-boot-project"}},{"id":"ae87ae63-6a43-58c0-b41e-d0c8b22d7817","frontmatter":{"title":"在用 Spring MVC 构建 RESTful API 时进行验证和异常处理","date":"2017 May-06"},"html":"<p>这一部分介绍一下我发现的在 Spring MVC 下进行输入处理以及验证信息反馈方面的一些思路。完整的示例代码见 <a href=\"https://github.com/aisensiy/demo-for-springmvc-and-mybatis\">GitHub</a>。</p>\n<h1 id=\"区别请求对象和实体对象\" style=\"position:relative;\">区别请求对象和实体对象<a href=\"#%E5%8C%BA%E5%88%AB%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%AE%9E%E4%BD%93%E5%AF%B9%E8%B1%A1\" aria-label=\"区别请求对象和实体对象 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>目前我所构建的 spring boot 的服务都是 REST 风格的 API 了，很多时候处理的都是 json 的数据。在获取的 HTTP 请求中，BODY 中所传的也都不再是表单而是一个 json 了。看了很多的例子发现在 demo 中喜欢直接把输入转化成一个实体对象。比如我要注册用户，那么我就直接把请求中的 json 映射成一个 <code>User</code>，多方便。但是很明显，它只能处理简单的情况，强行使用容易把真正的业务实体中加入很多诡异的功能，比如什么 <code>password confirm</code>，这都是以前很多代码中会出现的。实际上就算是处理表单型的数据，也早就有了 <a href=\"https://robots.thoughtbot.com/activemodel-form-objects\">form object</a> 的概念了，不能够说换成 json 就倒回去吧，说白了这依然是个表单而已。</p>\n<h1 id=\"区别表单验证和业务逻辑验证\" style=\"position:relative;\">区别表单验证和业务逻辑验证<a href=\"#%E5%8C%BA%E5%88%AB%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%E5%92%8C%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E9%AA%8C%E8%AF%81\" aria-label=\"区别表单验证和业务逻辑验证 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>有输入就要有验证，表单验证一直是一个非常蛋疼的问题，一方面它有很多内容很无聊，比如检查非空呀，控制输入的类型呀，判断长度呀，需要一个标准的方法避免这种重复的代码。另一方面，有的时候验证中又存在业务逻辑，那到底把这个验证放到哪里以及用神马方法验证都是一个很容易让人犹豫不决的事情。</p>\n<p>要解决这个，最好的办法就是明确的区分那种和业务逻辑关系不大的格式的验证以及业务逻辑中的验证。对于长度、必选、枚举、是不是电子邮箱、是不是 URL 用 <a href=\"https://beanvalidation.org/1.0/spec/\">Bean Validation</a> 解决。对于有关业务逻辑的，比如是不是合法的产品型号、是不是重复的注册名等都在 Controller 中进行处理。下面分别对两种验证方式进行说明。</p>\n<h2 id=\"1-bean-validation-异常处理\" style=\"position:relative;\">1. Bean Validation 异常处理<a href=\"#1-bean-validation-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86\" aria-label=\"1 bean validation 异常处理 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Spring MVC 中对异常的处理基本都是在 Controller 中抛出一个具体的 Runtime 异常（比如 <code>ProductNotFoundException</code>，然后通过 ExceptionHandler 的方式去捕捉并转换为具体的报错请求。具体的示例见<a href=\"https://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc\">这里</a>，我就不再重复了，我们在这里会使用 <code>ControllerAdvice</code> 的方式处理这种比较通用的情况，对于某些特殊处理的情况在 Controller 加 <code>ExceptionHandler</code> 即可。这里想强调的是如何把一个报错转化成一个格式良好的、便于 RESTful API 消费方处理的 JSON 的。</p>\n<p>首先，有一个 <code>UsersApi</code> 用于创建用户的方法:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UsersApi</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UsersApi</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepository <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span>method <span class=\"token operator\">=</span> POST<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span> <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Valid</span> <span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token class-name\">CreateUser</span> createUser<span class=\"token punctuation\">,</span> \n                                     <span class=\"token class-name\">BindingResult</span> bindingResult<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bindingResult<span class=\"token punctuation\">.</span><span class=\"token function\">hasErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error in create user\"</span><span class=\"token punctuation\">,</span> bindingResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> createUser<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到，上面的 <code>createUser</code> 方法中，有两个参数 <code>CreateUser</code> 和 <code>BindingResult</code>。其中 <code>CreateUser</code> 是一个 <code>Form Object</code> 用于处理创建用户的输入，它通过 Bean Validation 的方式定义输入的一些要求，通过 <code>@Valid</code> 的注解可是让 java 自动帮我们进行表单验证，表单验证的结果就被放在 <code>BindingResult</code> 中了。<strong>在这里处理报错的好处在于可以附上在当前 Controller 中特有的 message (Error in create user)</strong>。<code>CreateUser</code> 类如下所示。</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span> <span class=\"token comment\">// lombok 注解</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateUser</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@NotBlank</span> <span class=\"token comment\">// hibernate.validator 注解</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>接着，我们有一个测试用例覆盖错误输入的情况。可以看到 <code>should_400_with_wrong_parameter</code> 通过 <code>rest assured</code> 方法对我们想要获得的结果格式进行了测试，<code>setUp</code> 方法以及 rest assured 内容见 <a href=\"/spring-mvc-and-test\">在 Spring Boot 1.5.3 中进行 Spring MVC 测试</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RunWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringRunner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UsersApiTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Before</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        userRepository <span class=\"token operator\">=</span> <span class=\"token function\">mock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserRepository</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">MockMvc</span> mockMvc <span class=\"token operator\">=</span> <span class=\"token class-name\">MockMvcBuilders</span><span class=\"token punctuation\">.</span><span class=\"token function\">standaloneSetup</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">UsersApi</span><span class=\"token punctuation\">(</span>userRepository<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                         <span class=\"token punctuation\">.</span><span class=\"token function\">setControllerAdvice</span><span class=\"token punctuation\">(</span>\n                                             <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomizeExceptionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">RestAssuredMockMvc</span><span class=\"token punctuation\">.</span><span class=\"token function\">mockMvc</span><span class=\"token punctuation\">(</span>mockMvc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">should_400_with_wrong_parameter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> wrongParameter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"aisensiy\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">given</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span>wrongParameter<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">statusCode</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fieldErrors[0].field\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">equalTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fieldErrors.size()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">equalTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>错误情况下 Api 的 Response 大概是这个样子：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"code\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"InvalidRequest\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Error in create user\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"fieldErrors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"createUser\"</span><span class=\"token punctuation\">,</span> \n            <span class=\"token string\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> \n            <span class=\"token string\">\"code\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NotBlank\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"may not be empty\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里我们重点看 <code>InvalidRequestException</code> 的处理。</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestControllerAdvice</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomizeExceptionHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ResponseEntityExceptionHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@ExceptionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">handleInvalidRequest</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> e<span class=\"token punctuation\">,</span> \n                                                       <span class=\"token class-name\">WebRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">InvalidRequestException</span> ire <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">)</span> e<span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FieldErrorResource</span><span class=\"token punctuation\">></span></span> errorResources <span class=\"token operator\">=</span> \n        \tire<span class=\"token punctuation\">.</span><span class=\"token function\">getErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFieldErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>fieldError <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">FieldErrorResource</span><span class=\"token punctuation\">(</span>fieldError<span class=\"token punctuation\">.</span><span class=\"token function\">getObjectName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                                   fieldError<span class=\"token punctuation\">.</span><span class=\"token function\">getField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                                   fieldError<span class=\"token punctuation\">.</span><span class=\"token function\">getCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                   fieldError<span class=\"token punctuation\">.</span><span class=\"token function\">getDefaultMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ErrorResource</span> error <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"InvalidRequest\"</span><span class=\"token punctuation\">,</span> \n                                                ire<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                                                errorResources<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span>APPLICATION_JSON<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token function\">handleExceptionInternal</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">,</span> BAD_REQUEST<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>handleInvalidRequest</code> 方法把一个 <code>InvalidRequestException</code> 中的 <code>FieldErrors</code> 转化为 <code>FieldErrorResource</code> 然后通过一个 <code>ErrorResource</code> 方法包装后交给 <code>handleExceptionInternal</code> 方法并最终转换为一个 <code>ResponseEntity</code>。</p>\n<h2 id=\"2-业务逻辑错误处理\" style=\"position:relative;\">2. 业务逻辑错误处理<a href=\"#2-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86\" aria-label=\"2 业务逻辑错误处理 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>对于业务逻辑的报错，我们依然遵循上面的思路：将错误通过 <code>BingResult</code> 包装后抛出 <code>InvalidRequestException</code>。这里提供一个处理重复用户名的情况，需要在原来的 <code>UsersApi</code> 中做一些修改：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UsersApi</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UsersApi</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepository <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span>method <span class=\"token operator\">=</span> GET<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserData</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span>method <span class=\"token operator\">=</span> POST<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span> <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Valid</span> <span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token class-name\">CreateUser</span> createUser<span class=\"token punctuation\">,</span> <span class=\"token class-name\">BindingResult</span> bindingResult<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bindingResult<span class=\"token punctuation\">.</span><span class=\"token function\">hasErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error in create user\"</span><span class=\"token punctuation\">,</span> bindingResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByUsername</span><span class=\"token punctuation\">(</span>createUser<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            bindingResult<span class=\"token punctuation\">.</span><span class=\"token function\">rejectValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Dupliated\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"duplicated username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidRequestException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error in create user\"</span><span class=\"token punctuation\">,</span> bindingResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token comment\">// 处理重复用户名的问题</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> createUser<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到，通过使用 <code>bindingResult.rejectValue</code> 方法可以把我们自定义的报错添加进去.这里的报错使用了 <code>UserRepository</code> 如果想要在别的地方去处理类似的验证就需要注入它，远不如在这里来的简单清晰。对其的测试如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">should_get_400_with_duplicated_username</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"123\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"abc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">when</span><span class=\"token punctuation\">(</span>userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByUsername</span><span class=\"token punctuation\">(</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"abc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> duplicatedUserName <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"abc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">given</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span>duplicatedUserName<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">statusCode</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">equalTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error in create user\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fieldErrors[0].field\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">equalTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fieldErrors[0].message\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">equalTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"duplicated username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fieldErrors.size()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">equalTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"slug_without_date":"/spring-mvc-error-handler"}}],"pageInfo":{"hasPreviousPage":true,"currentPage":23,"pageCount":46}}},"pageContext":{"limit":3,"skip":66}},
    "staticQueryHashes": []}
{
    "componentChunkName": "component---src-templates-blogs-js",
    "path": "/page/1",
    "result": {"data":{"site":{"siteMetadata":{"title":"eisen-s-blog"}},"blogs":{"nodes":[{"id":"90492e8e-b16f-5420-8f52-3cc32bc053a6","frontmatter":{"title":"Java 版本从 11 更新到 17","date":"2022 May-23"},"html":"<p>最近在实验一个用 GraphQL 支持 REST 接口的方案，需要在 Java 里写大量的 graphql 的内容，如下所示。</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@AllArgsConstructor</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">GraphQLTest</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">DgsQueryExecutor</span> dgsQueryExecutor<span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/g\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> query <span class=\"token operator\">=</span>\n        <span class=\"token string\">\"query {\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\" plans(category: [PERMANENT_COMPUTATION]) {\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"   id\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"   ... on TimeBoxedComputationPlan {\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"     resource {\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"       name\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"       gpu {\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"         ... on PhysicalGPU {\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"           type\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"         }\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"       }\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"     }\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"   }\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\" }\\n\"</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">\"}\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">ExecutionResult</span> result <span class=\"token operator\">=</span> dgsQueryExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到这种多行拼接的 string 非常丑陋，并且没办法使用 intellij 的 <a href=\"https://www.jetbrains.com/help/idea/using-language-injections.html\"><code>inject language</code></a> 这样的功能。</p>\n<p>不过在 java 15 就已经引入了 <a href=\"https://www.baeldung.com/java-text-blocks\">text blocks</a> 的语法了，并且在目前的情况下，引入这个语法确实会为后续开发提供不少便利。于是决定就直接从目前的 java 11 升级到最近的 LTS 版本 java 17 了。这里就记录下更新版本需要处理的问题。</p>\n<h2 id=\"安装-azul-zulu-java-17\" style=\"position:relative;\">安装 Azul Zulu Java 17<a href=\"#%E5%AE%89%E8%A3%85-azul-zulu-java-17\" aria-label=\"安装 azul zulu java 17 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>去 azul 官网安装<a href=\"https://www.azul.com/downloads/?version=java-17-lts&#x26;os=macos&#x26;architecture=arm-64-bit&#x26;package=jdk\">对应的操作系统的版本</a>。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef02107211da85dc28b4840a9ca40fe8/b5cea/zulu-java-17-for-m1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDUlEQVQoz3WSy0tVURTG9yQnjfpTggiiHFSDCEEqKjECpQfROKKicQUFjVLRgUJEUQi9QO2lPRQySsrBBekx8JF6j/fe89r7PPY++xdn3xIbuGBx1uawfnzf/rao1iM8PyJWKX4oWfZ86o0QpTJimbLkNWiEkiTNiWVCtRYQhJI81yys1rjQd5+L/Q84d3uQodH3iEa5HEqsLsBCmmrCKCGMlFssYX6o3NlfnxPiOGGtHjIxU2F8psLI9Cxfv88jvvxa4crjSa4ODnN54CGPJj6ic4NUqVOpkmbL/+YUP04I4oSsFPKvLIjesSnEgTOIvZ2I7W10XLvj/hXWslnlhcWTKYuBROWab79rnBqeZHq+iuh58gqx6zAtB7sRe47RfWtgHbgRajfMprCk2pDk2p0zY1gOFSrTiL7n47S0nWbbkfOI1uN0/QUGYey+UiXEUjVBxrjWhaUmUweJspwfawE3JmaprDQQvc/eIPafZGv7WURrB103+91ymWhZWmuXaBNYUJRAY2mojGqUOLXVOOHF3CJLvkT0PH3trG4pLe8+ug4sLdpNLJcKo0wTlAFl2sE/LXh4UdK0LHYeQuw7gdjRTuf13uYdFsXmoZiCuspYiZS75znP59LoZxeO+Lmwyt2xD9x7OcXQyDvezlSQMnVvsGz3HiNFva4JAkOuDVluUKlGptrNtmiqt8byB1ovw1Wx/IO9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"zulu java 17 for m1\"\n        title=\"zulu java 17 for m1\"\n        src=\"/static/ef02107211da85dc28b4840a9ca40fe8/5a190/zulu-java-17-for-m1.png\"\n        srcset=\"/static/ef02107211da85dc28b4840a9ca40fe8/772e8/zulu-java-17-for-m1.png 200w,\n/static/ef02107211da85dc28b4840a9ca40fe8/e17e5/zulu-java-17-for-m1.png 400w,\n/static/ef02107211da85dc28b4840a9ca40fe8/5a190/zulu-java-17-for-m1.png 800w,\n/static/ef02107211da85dc28b4840a9ca40fe8/b5cea/zulu-java-17-for-m1.png 1140w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>安装后在命令行输入命令确认安装成功了：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ java --version\nopenjdk <span class=\"token number\">17.0</span>.3 <span class=\"token number\">2022</span>-04-19 LTS\nOpenJDK Runtime Environment Zulu17.34+19-CA <span class=\"token punctuation\">(</span>build <span class=\"token number\">17.0</span>.3+7-LTS<span class=\"token punctuation\">)</span>\nOpenJDK <span class=\"token number\">64</span>-Bit Server VM Zulu17.34+19-CA <span class=\"token punctuation\">(</span>build <span class=\"token number\">17.0</span>.3+7-LTS, mixed mode, sharing<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"配置-intellij\" style=\"position:relative;\">配置 intellij<a href=\"#%E9%85%8D%E7%BD%AE-intellij\" aria-label=\"配置 intellij permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>打开 idea intellij 对配置做如下修改。</p>\n<ol>\n<li>修改 gradle 使用的 jvm</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c1d7765bc700d9d13f9b789270f7397a/69d6b/gradle-config-jvm-in-intellij.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3klEQVQoz2WT247TMBRF8/9/BC9QNCNAIDTVtJ3eppckbuJb7PiWdtphIztKacHS0pH8sLzPsZ2JRkIbi9Y6GOsTQkhQSiGEgG4kOGPQWsN7D+fcFWvtHcYYZC+rLcbTBSqhwJUFUxY1pSjzfarjkqKsKbRSUFon8UCUhhDSQRFrHbLFJsdqV/Yi2YI2BqRmmC03WO9LrAuCfV6kxJxzSCnRNA3atr1LO5DNVlvsCAVVFlUUyhY5azEuDCalQVVVEJyDC5GkSqlre5EoHmrcz2bzJXJSQaoWqrUQTYvjsUNa72dst1vsdjvkeQ5CDiCEpNlGcUx6S5RmH38u8eHHEp+fC3xbMTwuagjtku94OqEoCjDGUsohhXMWbqi3xISj5xwPM4LvrxJflwyP87/Ct7cz6tiybMC4SCm8D+i6I0Lo0HX3xIvJClJhvlpDKJ1ajq37EJLwcrmkkwlTmO1q7JlBIQOIPqH6h4M+geqA7DU/4GkyB2EN6sbgwDWc74XnywXBO6wJx2hS4mFOMZrV+PLyP5+mNX5tWH/L0+UGB6F7oYjC7powzqzzDm+dw7nzOB99XweOPe8nj98nj+xAOSrK0WiTkNqkB5pmEsLNL+hpb6u10K1Jjzx2+LTh+APO8zyvdrKrIgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"gradle config jvm in intellij\"\n        title=\"gradle config jvm in intellij\"\n        src=\"/static/c1d7765bc700d9d13f9b789270f7397a/5a190/gradle-config-jvm-in-intellij.png\"\n        srcset=\"/static/c1d7765bc700d9d13f9b789270f7397a/772e8/gradle-config-jvm-in-intellij.png 200w,\n/static/c1d7765bc700d9d13f9b789270f7397a/e17e5/gradle-config-jvm-in-intellij.png 400w,\n/static/c1d7765bc700d9d13f9b789270f7397a/5a190/gradle-config-jvm-in-intellij.png 800w,\n/static/c1d7765bc700d9d13f9b789270f7397a/c1b63/gradle-config-jvm-in-intellij.png 1200w,\n/static/c1d7765bc700d9d13f9b789270f7397a/29007/gradle-config-jvm-in-intellij.png 1600w,\n/static/c1d7765bc700d9d13f9b789270f7397a/69d6b/gradle-config-jvm-in-intellij.png 1912w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol start=\"2\">\n<li>修改 javac 字节码版本</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/47493f8f3b5eaf58dbc9d23473543632/69d6b/change-bytecode-version-to-17.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnUlEQVQoz4WT2W7bMBBF9f//koeiaL+hQB/iAHEMWo6iuBEpcRMXyYu83IKD0pCBNhVwoIGGvLzDGRXaGrgQ4eOAEEdCGwMpJbTWsNaibVuKh2FAjPGfhBBQrMo3PC0ZhO4h+wjlIraNwGazAReChLqu+69gzhWs2qKsP0isNR6tCWilQtM06KS8ExnH8a+kNckdCSaH700H5YY/gh4hRABXzJ/z+Yxpmu64XC64Xq+Uy+LFYsnwuuUQ2pGYMB5cGnDRQilFpRpjyEFyksiudrvdTSjHRVnVWL/WEFLDuAjrIoSyWLE1GGN0f7mcJOKcI7z3t3c+KFE8lh9Y1i3W3GH1y+BlayBND9dbGGNp09xBFkn0fX/LZ9fFl581Hn684esjx/cFx7cFR801rNG0OG3KZSaSUBqlFO/3eyIddiu5ES1eWAnrPM1i7wPiMNBlzzmdTtSI4/GIw+FAcWpGakxuzjSdUDyvKzyzCo3swY1HoxycDxhn4zK/o3lT7r8NOOxHFLxTEJ2CdYEwLtDYfPZHzPEhIHgHLi2eKoXfZgZEX8IUPREAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"change bytecode version to 17\"\n        title=\"change bytecode version to 17\"\n        src=\"/static/47493f8f3b5eaf58dbc9d23473543632/5a190/change-bytecode-version-to-17.png\"\n        srcset=\"/static/47493f8f3b5eaf58dbc9d23473543632/772e8/change-bytecode-version-to-17.png 200w,\n/static/47493f8f3b5eaf58dbc9d23473543632/e17e5/change-bytecode-version-to-17.png 400w,\n/static/47493f8f3b5eaf58dbc9d23473543632/5a190/change-bytecode-version-to-17.png 800w,\n/static/47493f8f3b5eaf58dbc9d23473543632/c1b63/change-bytecode-version-to-17.png 1200w,\n/static/47493f8f3b5eaf58dbc9d23473543632/29007/change-bytecode-version-to-17.png 1600w,\n/static/47493f8f3b5eaf58dbc9d23473543632/69d6b/change-bytecode-version-to-17.png 1912w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol start=\"3\">\n<li>修改启动使用的 java 版本</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 753px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6339c2e33a97e9ae80bcb37df1e077a7/17a7a/run-configuration-1.png.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVQoz62PS2/TQBSF86uhgiVI2bJCSKx5qLtKPBZ0Q9XSVqiFkjiNE9uxx7HHSZxHQ2TH9tgfmolaUNUlV/rmHs3VOXemFUeS+SqlH005sXxOOx7nPZ+TjsfxL5cLJ+G7K/lqexxZHt+uA3N3fi047o05G0pOBwLHHzNLElpO4BFFHq8PLZ4f9Hj5xebFxw6vDm3aB1323v9k790Pnu5f8fjtJY/eXPBk/4r2Z4/2J9f0Zx9cji5dRr5LKyNjXa+pqozfy5Q4DEiikEm8YyZDNqs5UNGUOSrfQLXlfsmbJcF6RYsGVKUoK8VsPqfftxEiJIpiAiHwA4EIx8RSslzdGHOj41WNqndoXRaFmbX0oZSiqiomkwlWt8tgMMBxHIbDodG2bZtuWRbT6ZSHalsUNE3zT6BSLJcrwjAkSRKEEERRhJSSOI7vCILALNakaWrI85yyLP8G1nXNJtsgJ5LRaGRMOlhr3/dZLBYURWGMt2RZdte3262Zm8CszI3QG/TwIbRRG26N99H3+pcmsFC7p/6P0oF/AK9roMS7lJ5tAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"run configuration 1 png\"\n        title=\"run configuration 1 png\"\n        src=\"/static/6339c2e33a97e9ae80bcb37df1e077a7/17a7a/run-configuration-1.png.png\"\n        srcset=\"/static/6339c2e33a97e9ae80bcb37df1e077a7/772e8/run-configuration-1.png.png 200w,\n/static/6339c2e33a97e9ae80bcb37df1e077a7/e17e5/run-configuration-1.png.png 400w,\n/static/6339c2e33a97e9ae80bcb37df1e077a7/17a7a/run-configuration-1.png.png 753w\"\n        sizes=\"(max-width: 753px) 100vw, 753px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cba3ce7d5f0e4a8fa36631ecd00cf10e/525d3/run-configuration-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxUlEQVQ4y62Sy27TQBSG/QqIh2DBI7QSIgveAZn3YcETsGJREAiRLkBCQrRJW1Bzg9hBVdTcXFInjj0e3++x5xw0UxK1IKQuGOnz8djSN/+ZGWn8/tPd0WQoz4khG4Yl60tDXixXourLlTyZTOXhcCiYz+ey4ziybduyaZoysW2ZUsq/PSGEPB4MBnck9ctxLQ4oEmuJRRJhVaQCVqSIZY6e66BlESSEIKUUPc8TxHGEnuei41DxndNut3ekFx9Oah/7M3zzuVMdny2qwSJmqh6y7oXPWlrAJpcms8wVswhhuq4zwzAYpQ6jfsSWFmUr06psQhillB0dHe1Kz+vN2vGI4ED3mTIPQNVD+LEIoTXzoDly4ZL4EIcBWISAYRhACAHqOKAvTViaBBzXhTAMwHVdFMIz9XsNrwZDRMA/RhT6OJ/P0TAM9H1fwFsOAx9N28GF5YDt+sBbbjabu1Kn062tyxIZAGPiAcipeAXEIAiEjEuSJME0TZGnsSwLiU3RMC0IoxjCMMSDg4Ndqdfr1aqqEgkBQCT8XcTIsgyjKBKyoigEeZ5vKYoc8jwHvnCz2fi3cCPlIp5mtVpt4XPTNNEihP8XQr4VjcYthJuWuYDLeeLrpGkKWZaJlm8l5O3ato2O4wg5T7KpfD+57Iaw270p3MiuC2ezGU4mExyNRlvOz89xsVhwOURRJFoWp8wTAmN/XZuNkK88Ho8FXHyhaTidTlHTNDHXNA083wffD64Stjvdh0m+xiQv12lRlklelhWDEhFKACjTNC2jKCrjOBZcf99Q5kmZxUF5eNjYkU5b7UdhkmKcceka46xAcS+rCvlW8Gty/RD4VYnjWMAPKYxiHPz0UJnZ2Pp68kB6ubd3X+n391VFqatKX9Dv30RRlC2qqtY7nU692+3Wv/V69dN2p/50r7H/7FXj7bvXe/ckRPyv/AKa43HtNUA0PAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"run configuration 2\"\n        title=\"run configuration 2\"\n        src=\"/static/cba3ce7d5f0e4a8fa36631ecd00cf10e/5a190/run-configuration-2.png\"\n        srcset=\"/static/cba3ce7d5f0e4a8fa36631ecd00cf10e/772e8/run-configuration-2.png 200w,\n/static/cba3ce7d5f0e4a8fa36631ecd00cf10e/e17e5/run-configuration-2.png 400w,\n/static/cba3ce7d5f0e4a8fa36631ecd00cf10e/5a190/run-configuration-2.png 800w,\n/static/cba3ce7d5f0e4a8fa36631ecd00cf10e/525d3/run-configuration-2.png 1090w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"修改-gradle-配置\" style=\"position:relative;\">修改 gradle 配置<a href=\"#%E4%BF%AE%E6%94%B9-gradle-%E9%85%8D%E7%BD%AE\" aria-label=\"修改 gradle 配置 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>java 17 相对比较新，有些 gradle 的插件没有做很好的适配，需要做一些修改。我这里遇到了两个插件的问题，这里也记录下。</p>\n<h3 id=\"spotless-不兼容\" style=\"position:relative;\">spotless 不兼容<a href=\"#spotless-%E4%B8%8D%E5%85%BC%E5%AE%B9\" aria-label=\"spotless 不兼容 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>spotless 是做代码格式化的，里面用了 googleJavaFormat 似乎有一些兼容性问题。这里没有花太多时间做调研，只是跟着 issue 做了调整。</p>\n<ol>\n<li><a href=\"https://github.com/diffplug/spotless/pull/998/files\">Add docs: Required export using GoogleJavaFormat on JDK 16+</a></li>\n</ol>\n<p>根据这个 PR 将 <code>gradle.properties</code> 修改如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">org.gradle.jvmargs=--add-exports jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED \\\n  --add-exports jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED \\\n  --add-exports jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED \\\n  --add-exports jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED \\\n  --add-exports jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED</code></pre></div>\n<ol start=\"2\">\n<li><code>build.gradle</code> 里更新 google java format 到最新版本</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">spotless {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   java {\n<span class=\"token prefix unchanged\"> </span>       target project.fileTree(project.rootDir) {\n<span class=\"token prefix unchanged\"> </span>           include '**/*.java'\n<span class=\"token prefix unchanged\"> </span>           exclude 'build/generated/**/*.*', 'build/generated-examples/**/*.*'\n<span class=\"token prefix unchanged\"> </span>       }\n<span class=\"token prefix unchanged\"> </span>       toggleOffOn('@formatter:off', '@formatter:on')\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>       googleJavaFormat('1.15.0')\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   }\n</span>}</code></pre></div>\n<h3 id=\"gradle-git-properties-不兼容\" style=\"position:relative;\">gradle git properties 不兼容<a href=\"#gradle-git-properties-%E4%B8%8D%E5%85%BC%E5%AE%B9\" aria-label=\"gradle git properties 不兼容 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>按照 <a href=\"https://github.com/n0mer/gradle-git-properties/issues/171#issuecomment-817569604\">https://github.com/n0mer/gradle-git-properties/issues/171#issuecomment-817569604</a> 对 <code>gradle.properties</code> 做修改：</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">org.gradle.jvmargs=--add-exports jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED \\\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> --add-exports jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED \\\n<span class=\"token prefix unchanged\"> </span> --add-exports jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED \\\n<span class=\"token prefix unchanged\"> </span> --add-exports jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED \\\n<span class=\"token prefix unchanged\"> </span> --add-exports jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED \\\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> --add-opens java.base/java.io=ALL-UNNAMED</span></code></pre></div>\n<h2 id=\"使用-text-blocks\" style=\"position:relative;\">使用 text blocks<a href=\"#%E4%BD%BF%E7%94%A8-text-blocks\" aria-label=\"使用 text blocks permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>做了如上更新后，本地跑 java 的项目就不报错了，不过还是有一些 warning 后续慢慢处理。</p>\n<p>text blocks 就能用了，效果如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b0056930251f1117d0cb51036c58c323/d2a60/graphql-use-text-blocks.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 105.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxklEQVQ4y5WUi3ajOBBE/f+fuOMkjkGEh4QknnoAd45kx0km2Tm7QNEgFUUXavo0TRNat1jbodonellgdUUMC3/bjuP4cfw0TSN68JSt51K0/Pp15not6NoOYw3LsLAox9qvOONwg2ff938VPY3jyLZFQoiEeOCcY11XpmVmWRaii8QxEqaEQFzi3wWT5XWdUUrQqwuyfaFuGoSsGMYBv23MwRO3+M3yT8iWnY/UcqYUDWVRUImKXvUM1jI7j5kW1mXl2A9IR0rsM/60nN4eo0dqiR4NPrifF+K+84j3qy8ZjhODHzCbZWaingz/VB2VqWimhm7tkKOkVR1qVKhBIa1CprhIdNTYzT5wF7SoqOhjj1wlZVHx2lw4N2fEKKh1Q1W+0XQNdXtDVb8hjEB6id76/GxCFrRhQkV9G9x0fnM1Ka6m5Fyfee6eeZJPvKgLT90zV1sgg8TsJvM/4zTPE+PSYEKLTenHHuMVoqy4vlwpugvNWFFbQTu+0U41ck58lbk36Ec8eT+wzCWza1ijYQk9btfotxolKiKWyJgRGPC7wW2GNWrW2N/jB05jsuzHD8t32+3Q8WZriqHhtX/lRV54bp9pXXezd+f1W//VcirstCiJkFZMJ2LoMYem1i0XUSEGQaGLHFVehBvvxv+KR9m8C75H6STN3GB3gz3sA/qeXRb9AV8EH6Khz2LvDz4+xXtWm/7vggnN0tD5Ll+n+lSPqD6NfcdHHaZvuPUMDLSuRXrFnP+biXEf+bYf42N+OvI53ydu/peXsKBmRa0ryq6kU11uXcMw4L3HDwHXe7wNxCHiZpfnEuZ5ztEaS4zxJrhvG3ZYKSqNEBXFtUAIQVEUKKWQQiKFohNdRlVWFGWB0Sb3zySaqmXbtlsdpmx82HERfAj5PjXZnJ33hBgI0eO8Y/XrY+7ghwab0k0C7w3q/25/Ntjf4khTLB/dMwcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"graphql use text blocks\"\n        title=\"graphql use text blocks\"\n        src=\"/static/b0056930251f1117d0cb51036c58c323/5a190/graphql-use-text-blocks.png\"\n        srcset=\"/static/b0056930251f1117d0cb51036c58c323/772e8/graphql-use-text-blocks.png 200w,\n/static/b0056930251f1117d0cb51036c58c323/e17e5/graphql-use-text-blocks.png 400w,\n/static/b0056930251f1117d0cb51036c58c323/5a190/graphql-use-text-blocks.png 800w,\n/static/b0056930251f1117d0cb51036c58c323/d2a60/graphql-use-text-blocks.png 807w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","fields":{"slug_without_date":"/java-migrate-from-11-to-17"}},{"id":"0d324ce7-77fc-530b-b2ea-97bdb60e8b51","frontmatter":{"title":"记录 nvidia gpu 报错处理","date":"2022 May-10"},"html":"<p>又发现了集群里出现了挂掉的 nvidia gpu 这里记录下如何屏蔽掉它以保证其他 GPU 可以继续被使用。</p>\n<p>首先是监控告警，告知 <code>nvidia-smi</code> 命令出错了，去机器上看一下有这么个错误：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ nvidia-smi\nUnable to determine the device handle <span class=\"token keyword\">for</span> GPU 0000:89:00.0: Unknown Error</code></pre></div>\n<p>感觉是这块卡 <code>0000:89:00.0</code> 出问题了。然后去执行下 <code>dmesg</code> 看看情况：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">dmesg</span> -T\n<span class=\"token punctuation\">[</span>Mon May  <span class=\"token number\">9</span> <span class=\"token number\">20</span>:37:33 <span class=\"token number\">2022</span><span class=\"token punctuation\">]</span> xhci_hcd 0000:89:00.2: PCI post-resume error -19<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">[</span>Mon May  <span class=\"token number\">9</span> <span class=\"token number\">20</span>:37:33 <span class=\"token number\">2022</span><span class=\"token punctuation\">]</span> xhci_hcd 0000:89:00.2: HC died<span class=\"token punctuation\">;</span> cleaning up\n<span class=\"token punctuation\">[</span>Mon May  <span class=\"token number\">9</span> <span class=\"token number\">20</span>:37:34 <span class=\"token number\">2022</span><span class=\"token punctuation\">]</span> nvidia-gpu 0000:89:00.3: i2c <span class=\"token function\">timeout</span> error ffffffff\n<span class=\"token punctuation\">[</span>Mon May  <span class=\"token number\">9</span> <span class=\"token number\">20</span>:37:34 <span class=\"token number\">2022</span><span class=\"token punctuation\">]</span> ucsi_ccg <span class=\"token number\">6</span>-0008: i2c_transfer failed -110</code></pre></div>\n<p>看不懂，搜了搜也有点懵逼。这台机器已经运行了挺久了，驱动也在短期内没有出过问题，那么就感觉是硬件出问题了。重启机器后，<code>nvidia-smi</code> 恢复了。不过如果有其他任务使用了 GPU 就又会出现这个问题了。所以考虑使用 <code>nvidia-smi</code> 的命令先屏蔽掉这块报错的 GPU 。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ nvidia-smi drain  -p 0000:89:00.0 -m <span class=\"token number\">1</span>\nSuccessfully <span class=\"token builtin class-name\">set</span> GPU 00000000:89:00.0 drain state to: draining.</code></pre></div>\n<p>然后再执行命令 <code>nvidia-smi</code> 就看不到这块卡了。</p>","fields":{"slug_without_date":"/disable-error-nvidia-gpu"}},{"id":"3118c9dd-25ab-56e9-9905-a7ee7a70d6f1","frontmatter":{"title":"配置 jacoco 以提供更合理的测试覆盖率","date":"2022 May-07"},"html":"<p>最近在做一些代码的重构和基础库的迁移，这样的工作绝大部分时候不产生新的功能点，每次更换了类库后也都会将原来对应的测试同步迁移过来，保证新的代码和原来的代码一样工作。不过在迁移的过程中我发现 jacoco 所提示的代码覆盖率越来越低，让我很慌。为了搞明白这是啥原因，做了一些调研，这里把一些结论记录在这里加深印象，也便于后续查看。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 664px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/69c841087aeaddffca07b2e66e772a58/31493/screenshot-for-openbayes-server-code-converage-before.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABVklEQVQoz6WQ2UsCARDG/Vd7C3oIKuggKg3EjpcoTdO0zaMyuzYoegmLiAzsoCi0w/siK11BLXf3Fy5WvvvBMPPNMB/fjA4gl88jSRKqqqIoCmVJIl8o8P3d0Lgsy1oulcp8lkoar399oSgq9Xpd400093XVahXvmp8lhwvniptFmwOL1c7cvIV5sxXB7cNsteMP7HByeqb1HU6B7V0Rl+BhZdXLx8fnv2CzyGZz3N7dE316JhaPk0pnSKXTPEYihK9veI3FSSRTFIvv2jyRTPJWLBJPJMlkczQaMqraJtgpmqfLiqK9RSdVKuiNs/QPjzE0aqB3cISe4AR99yYGHmaw+ZeZHNdjmprGZDKwJ3ZzeNTFRcjYElPQ7LWgq9VqeNc3cQoefOt+bMsuhOsAvheRjdgBx+dBtja3EMV9RHGb0KWN8NUCkeju39/ao6OT1TZnvw5/AGgh9S3ToLQFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot for openbayes server code converage before\"\n        title=\"screenshot for openbayes server code converage before\"\n        src=\"/static/69c841087aeaddffca07b2e66e772a58/31493/screenshot-for-openbayes-server-code-converage-before.png\"\n        srcset=\"/static/69c841087aeaddffca07b2e66e772a58/772e8/screenshot-for-openbayes-server-code-converage-before.png 200w,\n/static/69c841087aeaddffca07b2e66e772a58/e17e5/screenshot-for-openbayes-server-code-converage-before.png 400w,\n/static/69c841087aeaddffca07b2e66e772a58/31493/screenshot-for-openbayes-server-code-converage-before.png 664w\"\n        sizes=\"(max-width: 664px) 100vw, 664px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"代码测试覆盖率是什么意思\" style=\"position:relative;\">代码测试覆盖率是什么意思<a href=\"#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D\" aria-label=\"代码测试覆盖率是什么意思 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在 <a href=\"https://www.baeldung.com/jacoco\">Intro to JaCoCo</a> 这里讲的非常明白了，代码测试覆盖率（或者说代码覆盖率）讲的是在跑测试的时候，到底有多少代码被执行了。按照粒度来分可以有以下几种：</p>\n<ol>\n<li><code>Line coverage</code> 按照字节码统计的多少 instruction 被执行了</li>\n<li><code>Branch converage</code> 按照 <code>if/else</code> <code>switch</code> 等分支统计多少分支被执行了</li>\n</ol>\n<p>由于代码确实会有很多防御性的 <code>if/else</code> 导致其实每一个分支并不是很对等，所以我个人感觉 <code>Line coverage</code> 会稍微好一些。</p>\n<p>不过要注意，测试覆盖率只反映你多少代码在测试的时候被执行了，执行了一次就算是执行了，但事实上不同的参数会导致不同的结果，很多边界条件是否被测试到也表现不出来。因此 100% 测试覆盖率不表示所有代码都是对的了。如何写测试本身是一件极其复杂的事情，有些编程思路如 TDD 都是围绕测试进行的，我也讲不明白。</p>\n<h2 id=\"是什么导致覆盖率越来越低\" style=\"position:relative;\">是什么导致覆盖率越来越低<a href=\"#%E6%98%AF%E4%BB%80%E4%B9%88%E5%AF%BC%E8%87%B4%E8%A6%86%E7%9B%96%E7%8E%87%E8%B6%8A%E6%9D%A5%E8%B6%8A%E4%BD%8E\" aria-label=\"是什么导致覆盖率越来越低 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>为了搞明白为什么我的测试覆盖率一降再降，我需要用 <a href=\"https://www.eclemma.org/jacoco/\">JaCoCo</a> 给我生成一下报告，我去看一下到底哪些地方的哪些代码测试出了问题。</p>\n<p>我的项目是用 <code>gradle</code> 管理的，执行如下命令重新跑一下测试并生成报告：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./gradlew cleanTest <span class=\"token builtin class-name\">test</span> jacocoTestReport</code></pre></div>\n<p>然后去项目目录 <code>build/reports/jacoco/test/html</code> 打开 <code>index.html</code> 看看情况，发现核心为题在于<strong>很多生成的代码</strong>被纳入了代码测试覆盖中。具体来讲有两个方面的内容：</p>\n<ol>\n<li>Lombok 生成的很多代码</li>\n<li>引入 QueryDSL 后其和对应的 <code>Entity</code> 生成的 <code>Q + Entity</code> 的名称的代码</li>\n</ol>\n<p>那问题就显而易见了，尤其是后者，每次迁移一个 JPA 的 Entity 类型就会对应生成一段 <code>Q + Entity</code> 的代码，这部分代码统统成了测试覆盖率的分母，覆盖率能不低么。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14cb1429125421eb08b990822b166896/25e83/querydsl-generated-code-screenshot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACHElEQVQ4y42SiWocMRBE5/+/MQchib07o/s+54XROk4CtomgaEGjp66SttYHc56MMel9rDpe6hyT/1nneRJSXpwtOkHOiZQDIVlS8YTsiMWTSqCNQu2Z2gvn7JzneFMw4Rxs99vOvkue5Tdu5ifP+sb34zPf90/8OL7wJL+iwhOxCBiJORLnG5ojrrqlcmLDwLqMjx0bJtFXoo54FSj+mhBChTbOh8UP7G+lTaStKNcxvqNdQWtPFommKkEHlM3st0aOY+GuzN7TlutE2YZyDRMGUju0kkSTcSYhtcBoRVSOlNLrI7wLLO2y3JddFyohJGoojHa9XCGnRMmFNDK553f9XrBXyy52Qr5ytAvWYv/wi7yl370tlbnsXlNKqTjEQTSJvGfSnii24Jxj33eUUjhrcdEhkuQedkSUpJL+BUr7AAohOY6DqBP5yKQjUVzBWLOAWusFt8lxJMERBSppeu9/gKVOjG8rw+uAUpJkEjVWtNUIKbDWEkLAFIvL7p0sXoC1nSvDmMfjdmupvtJ0o5lGt51e+uoZYxY454xvAVU0plpsc5ReHo+S/5rwOnBNaZTBGYfVFiPNK+y67NovJ0bhglsupJZ471d/i3lymIr2jeMQ3Pc7Rhjc4bC7xTwbvPFI+chXKrn20iiEF9zNnZu+I50keM82xkmpg9YnpRRyyYw2mHm+6uwntdZl9aq9ddrs5OtvLhXqqMvyL2A4ji0m2rjOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"User 对应的 QUser 文件\"\n        title=\"User 对应的 QUser 文件\"\n        src=\"/static/14cb1429125421eb08b990822b166896/5a190/querydsl-generated-code-screenshot.png\"\n        srcset=\"/static/14cb1429125421eb08b990822b166896/772e8/querydsl-generated-code-screenshot.png 200w,\n/static/14cb1429125421eb08b990822b166896/e17e5/querydsl-generated-code-screenshot.png 400w,\n/static/14cb1429125421eb08b990822b166896/5a190/querydsl-generated-code-screenshot.png 800w,\n/static/14cb1429125421eb08b990822b166896/c1b63/querydsl-generated-code-screenshot.png 1200w,\n/static/14cb1429125421eb08b990822b166896/29007/querydsl-generated-code-screenshot.png 1600w,\n/static/14cb1429125421eb08b990822b166896/25e83/querydsl-generated-code-screenshot.png 2302w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">User 对应的 QUser 文件</figcaption>\n  </figure></p>\n<h2 id=\"如何改进\" style=\"position:relative;\">如何改进<a href=\"#%E5%A6%82%E4%BD%95%E6%94%B9%E8%BF%9B\" aria-label=\"如何改进 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这部分的很多信息在 <a href=\"https://www.baeldung.com/jacoco-report-exclude\">Exclusions from Jacoco Report</a> 可以找到。</p>\n<h3 id=\"修改-jacoco-配置保证代码覆盖率统计的合理性\" style=\"position:relative;\">修改 JaCoCo 配置，保证代码覆盖率统计的合理性<a href=\"#%E4%BF%AE%E6%94%B9-jacoco-%E9%85%8D%E7%BD%AE%E4%BF%9D%E8%AF%81%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E7%BB%9F%E8%AE%A1%E7%9A%84%E5%90%88%E7%90%86%E6%80%A7\" aria-label=\"修改 jacoco 配置保证代码覆盖率统计的合理性 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>我们只需要测试自己写的代码，生成的代码不应纳入统计范围。这里直接粘贴下 <code>gradle</code> 里面 <code>jacocoTestReport</code> 的配置：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">jacocoTestReport {\n    // rule from https://bottom-to-top.tistory.com/36\n    // 过滤 QA-QZ 开头的所有类，对应了 querydsl 生成的 Q + Entity 的格式\n    def Qdomains = []\n    for(qPattern in \"**/QA\" .. \"**/QZ\"){\n        Qdomains.add(qPattern + \"*\")\n    }\n    afterEvaluate {\n        classDirectories.setFrom(files(classDirectories.files.collect {\n            fileTree(dir: it, exclude: [\n                    'com/openbayes/graphql/**',          // 所有 graphql 生成的代码\n                    'com/openbayes/application/data/**', // 所有的 DTO 所在的包\n                    'db/migration/**',                   // 所有的数据库 migration 代码\n                    '**/*Exception*',                    // 所有包含 Exception 的异常类\n                    '**/*Mixin*',                        // 所有 Jackson Mixin \n                    '**/*Command',                       // 所有带 Command 的类，也是 DTO\n            ] + Qdomains)\n        }))\n    }\n    reports {\n        csv.required = true\n    }\n}</code></pre></div>\n<p>可以看到，我这里主要是按照 <code>classDirectory</code> 对类进行了过滤，包括了以下内容：</p>\n<ol>\n<li>各种生成的代码：graphql 生成代码、querydsl 生成代码</li>\n<li>各种 DTO 和 Exception：<code>*Command</code> <code>data/**</code> 等</li>\n<li>实在不太好测试的东西，比如 migration 脚本、比如 Jackson 的 Mixin</li>\n</ol>\n<p>对 querydsl 这部分的过滤比较 tricky ，因为其默认生成的名字是 <code>Q + Entity</code>，本身过滤就有点难，如果采用 <code>**/Q*</code> 的形式会导致个别以 <code>Q</code> 开头但不是 querydsl 生成的类也被纳入过滤的范围，这里我采用的是 <a href=\"https://bottom-to-top.tistory.com/36\">https://bottom-to-top.tistory.com/36</a> 的方法，过滤掉由 <code>QA-QZ</code> 开头的所有的类。</p>\n<blockquote>\n<p>这里过滤 querydsl 的方法其实官方还有其他方案，但目前 <code>gradle</code> 这边支持不是很好，我目前用的 <code>querydsl</code> 版本为 5.0 有一些 PR 还没有纳入进来，后续如果官方有了更好支持会考虑做相应的调整。</p>\n</blockquote>\n<h3 id=\"通过注解过滤-lombok-的代码\" style=\"position:relative;\">通过注解过滤 Lombok 的代码<a href=\"#%E9%80%9A%E8%BF%87%E6%B3%A8%E8%A7%A3%E8%BF%87%E6%BB%A4-lombok-%E7%9A%84%E4%BB%A3%E7%A0%81\" aria-label=\"通过注解过滤 lombok 的代码 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>JaCoCo 本身是考虑了要过滤掉生成的代码的，它提供了一个规则：</p>\n<blockquote>\n<p>Starting from JaCoCo 0.8.2, we can exclude classes and methods by annotating them with a custom annotation with the following properties:</p>\n<ul>\n<li>The name of the annotation should include Generated.</li>\n<li>The retention policy of annotation should be runtime or class.</li>\n</ul>\n</blockquote>\n<p>简单的翻一下，就是在 JaCoCo 0.8.2 后，通过提供一个带有 <code>Generated</code> 名称的 <code>RetentionPolicy</code> 为 <code>CLASS</code> 或者 <code>RUNTIME</code> 的注解，JaCoCo 会帮你自动过滤这些类。</p>\n<p>Lombok 也对这部分做了支持，只要提供一个配置 <code>lombok.config</code> 就能让 Lombok 给自己生成的代码添加上相应的注解了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">lombok.addLombokGeneratedAnnotation = true</code></pre></div>\n<h2 id=\"最后\" style=\"position:relative;\">最后<a href=\"#%E6%9C%80%E5%90%8E\" aria-label=\"最后 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在做了上述两方面的修改后，测试覆盖率重回 70% 了。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 686px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2996dcf11e841d2858f3f864fdfebfb5/f6386/openbayes-server-code-coverage-after.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABRklEQVQoz62RzUsCcRCG97/s0K1LCH1YER3SAkuIDhEUQdAtyMz8WtfVdXVTzE+kCCLt4i2CvjDQENzfPrGL7qVDHRp4mYFhnnmHkQBGoxF/Ccuyfu1J/X6fcCTqKCkrZDWdWEImENwhlzcolsrE4jJ6waBWb3BwdEwqnaHRbJFMpYlE4/R6ny5UGg6H3NzeEQpHiMaTVGp1ytUqMVlGyxc4O79woHmjSLvziKpp6IbBQ6dNwSii5w1shgvkH8IGmabAFAJpMPhCTmvEUyoJWeVSUQh3VSLPGvLrFaXWNVk1i6blyOoZlG6I1NMplZccpmk6EpblQB2Hb+8fzM4t41lYYXFpjRnvPJ6cD29zG//9Prsne2ys+wkEttgM+lgtTrPamuKw7be9/XiWe7IQwtlmCcvRaFw7vfF2e97OwjInLNfZxOE3Gony24nPymoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"openbayes server code coverage after\"\n        title=\"openbayes server code coverage after\"\n        src=\"/static/2996dcf11e841d2858f3f864fdfebfb5/f6386/openbayes-server-code-coverage-after.png\"\n        srcset=\"/static/2996dcf11e841d2858f3f864fdfebfb5/772e8/openbayes-server-code-coverage-after.png 200w,\n/static/2996dcf11e841d2858f3f864fdfebfb5/e17e5/openbayes-server-code-coverage-after.png 400w,\n/static/2996dcf11e841d2858f3f864fdfebfb5/f6386/openbayes-server-code-coverage-after.png 686w\"\n        sizes=\"(max-width: 686px) 100vw, 686px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","fields":{"slug_without_date":"/play-with-jacoco"}}],"pageInfo":{"hasPreviousPage":false,"currentPage":1,"pageCount":46}}},"pageContext":{"limit":3,"skip":0}},
    "staticQueryHashes": []}
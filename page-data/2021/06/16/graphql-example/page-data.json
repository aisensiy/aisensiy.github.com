{"componentChunkName":"component---src-templates-blog-js","path":"/2021/06/16/graphql-example/","result":{"data":{"blog":{"id":"9ed405fc-55bf-5469-b5a6-8c0d70dcf561","html":"<p>在很久之前的一篇 <a href=\"/real-world-spring-boot-and-mybatis\">文章</a> 介绍了我做的一个 <a href=\"https://github.com/gothinkster/spring-boot-realworld-example-app\">RealWorld 的 SpringBoot + MyBatis</a> 的实现。这个项目我也一直在维护，一方面是因为这是一个很好的 demo 项目，可以很好的体现一些设计思路 <a href=\"/real-world-spring-boot-and-mybatis\">文章</a> 也都说了不再重复。另一方面，我觉得也是一个新人练手不错的选择，可以让大家可以通过这个项目来入门。</p>\n<p>最近在做 GraphQL 的调研和测试，我第一个想到的就是把这个项目添加上 GraphQL 的接口，一方面可以熟悉 GraphQL 的体系，另一方面也是个很好的机会去验证下是不是 REST 层是按照 <a href=\"https://alistair.cockburn.us/Hexagonal+architecture\">六边形架构</a> 或者说是 <a href=\"https://www.infoq.com/news/2014/10/ddd-onion-architecture\">洋葱架构</a> 那样子做成的是薄薄的一层，可以轻易的被替换掉。</p>\n<h2 id=\"对-api-层与-application-层做重构\" style=\"position:relative;\">对 api 层与 application 层做重构<a href=\"#%E5%AF%B9-api-%E5%B1%82%E4%B8%8E-application-%E5%B1%82%E5%81%9A%E9%87%8D%E6%9E%84\" aria-label=\"对 api 层与 application 层做重构 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>当然，api 层和 application 层一点都不修改就能添加 GraphQL 是不可能的。主要是因为之前有不少的逻辑写在了 SpringBoot 的 Controller 里面了。那么这一部分的工作基本就是把大量放在 Controller 的代码挪动到 application 层。</p>\n<h2 id=\"确认-graphql-的-schema\" style=\"position:relative;\">确认 GraphQL 的 schema<a href=\"#%E7%A1%AE%E8%AE%A4-graphql-%E7%9A%84-schema\" aria-label=\"确认 graphql 的 schema permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>然后就需要按照 REST api 提供一个对等的 GraphQL 的 schema 了。这里参考的是 <a href=\"https://github.com/thebergamo/realworld-graphql/blob/master/data/schema.graphql\">https://github.com/thebergamo/realworld-graphql/blob/master/data/schema.graphql</a> 这里。</p>\n<blockquote>\n<p>Real World 似乎对 GraphQL 这部分的工作不太伤心，这个东西已经挺久的了，但是官方并没有很好的支持。</p>\n</blockquote>\n<p>不过它这个 schema 明显有两个问题：</p>\n<ol>\n<li>少了 <code>unfavoriteArticle</code> 的 <code>Mutation</code></li>\n<li><code>deleteArticle</code> 返回了错误的结果，明明应该是 <code>DeletionStatus</code></li>\n</ol>\n<p>用 <a href=\"https://apis.guru/graphql-voyager/\">https://apis.guru/graphql-voyager/</a> 做展示基本就是这个样子：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/94ea71f61f1d7c04895366a54ea95552/73dae/2021-06-16-19-22-23.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQoz3VS227bMAz1///OsBXYw4A+7DHt2rTGmqQXX2TJlzjzXbIkn4FsUiRDR4CgREmH1DkM8I8ty4L/5Sg67zFbB++Xizzt/bIg+OyhsQ7NOKGdNAOQzdby+WMs8HW1xqsqsHgP69xF8eAcyB/jVih+9O02hNgf4L2HmWc+S1WOjchRtQOss5i0QdV0uI9S/BYKAYGdO1m1r5EIgViVODQdd0mAozZIpUK42aJpu4+u0qLE9d0Dft4/fv5lmRcINxs8xwliqfCn69H0A4y1DKSKEpPW3DlZ23V4SxJEaYag04b5osvEB7ksSwZKpEJZH+Aoby2GaWKfjEE7DGi6Hu0wIhISu9cX7GSF4PvNGl9WazxlBbx3zKPMc2RFgZc4Qd/32KoSV79CFM37N6moPwoyThrDpHlN6gepEJB1g6xuoY15r94P6IYR/Tiyursoxip8Qr4/MC2UIydBKF6o/CYyPMsSoqqZl56+P898UR+V3aYZftyusT926ByJZDmeuD954Lh1+0EwDykPqmenfVpWuIsytKNmPk8zeQ52Wv8FjwgDL6/mN3wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 06 16 19 22 23\"\n        title=\"2021 06 16 19 22 23\"\n        src=\"/static/94ea71f61f1d7c04895366a54ea95552/5a190/2021-06-16-19-22-23.png\"\n        srcset=\"/static/94ea71f61f1d7c04895366a54ea95552/772e8/2021-06-16-19-22-23.png 200w,\n/static/94ea71f61f1d7c04895366a54ea95552/e17e5/2021-06-16-19-22-23.png 400w,\n/static/94ea71f61f1d7c04895366a54ea95552/5a190/2021-06-16-19-22-23.png 800w,\n/static/94ea71f61f1d7c04895366a54ea95552/c1b63/2021-06-16-19-22-23.png 1200w,\n/static/94ea71f61f1d7c04895366a54ea95552/29007/2021-06-16-19-22-23.png 1600w,\n/static/94ea71f61f1d7c04895366a54ea95552/73dae/2021-06-16-19-22-23.png 2122w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>schema 在 <a href=\"https://github.com/gothinkster/spring-boot-realworld-example-app/blob/master/src/main/resources/schema/schema.graphqls\">https://github.com/gothinkster/spring-boot-realworld-example-app/blob/master/src/main/resources/schema/schema.graphqls</a> 可以看到。</p>\n<p>可以看到 GraphQL 的 schema 是一张图，有点像是数据库的 <a href=\"https://www.guru99.com/er-diagram-tutorial-dbms.html\">ER Diagram</a>。不过很显然，GraphQL 的关系肯定不是数据库级别的 CRUD 而是一个业务层级的关联图：</p>\n<ol>\n<li><code>User</code> 的 <code>Profile</code> 下可以有很多 <code>Article</code> 的视图 <code>favorites</code> <code>feed</code>；</li>\n<li><code>Article</code> 则有其自己的全量属性：<code>author</code> <code>comments</code>；</li>\n<li><code>Comment</code> 也有自己的 <code>article</code> <code>author</code>；</li>\n</ol>\n<p>这部分让我想起来 DDD 书中提到的 Domain Model 对象之间的关联关系（第五章 A Model Expressed in Software）。和 REST 相比，通过 GraphQL 所组织的 schema 有更好的整体性和一致性。当然，这也有可能是它的缺点：它缺少了 REST 的那种随便搞个接口的灵活性。</p>\n<h2 id=\"增加-graphql-的代码\" style=\"position:relative;\">增加 GraphQL 的代码<a href=\"#%E5%A2%9E%E5%8A%A0-graphql-%E7%9A%84%E4%BB%A3%E7%A0%81\" aria-label=\"增加 graphql 的代码 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这里的实现采用了 <a href=\"https://netflix.github.io/dgs/\">Netflix DGS</a> 这个框架，很符合 SpringBoot 的设计逻辑，并且最近也一直在密集的更新中。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 252px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADr0lEQVQ4y42US4sjZRSGa6W/wP/hD9CFy1Zw4V4QFJcOggj+AXcDDjS0LYggyDCrsRGXIoyDdifpJJWq3FNJVZK635KqXLodh1fe0/2lkxkGXbw53y3ne+pcPk379A+89tlfeP3eOd78Wsc735h4+76Bt+4beOPLKrSPnkD75Cm0j/+n3j/t4L2TNj74foAvzqb46lcX9x7P8PnPc3z40wRHpwO8e9rH0UkXR9/2/lPa8+sV/l4vsS0y5GmMbqeNYb+LXsfEsGtiavVkD8+vgGcb4Nn2Zf1zJy3NckRxgqwowPF0NoPrerAdB3PXg+v5yBdLrNYblKv1gbhWlCvZXywLkRaEIWa2jfaDY1iVKsxeD61WC6ZpiqXq9ToqlQr0VgvNZhPtdlv2dV3HaDRCHMeIokik8cfzPLhNHcF0holtw7IsDAYDOUz1ej0Mh0MZ03K/3++L48lkgjRNkSSJSCuKAkkUwXr4CGF/AMd1MbYs2LaN8XgsThzHwdgaiw3DUKzruthsNqKyLLFarUTiME0SBOcVxCR0HLlV0ShLYl4wn8+FjpR0cHV1JaLjG4dliTSO4Zz9gtgaY+77NyFwXfi+Lw54AcckoyOuUTw3m80wnU7ls+n0hjBO4P72OxJ+mm0LlYqjouNat9uVeHKuiDlnLHnhncMkgffkKbL5HHGaylwFmRnkYSaPFMrmeS77tNfX1y98chTDfnyGaDhCnySdjtDw5k6nA72pwzAMKROWEddIxhLiWCXkLilpCv/8AinjFoaIo2hXW8wqSTjOskzE87Tb7XZHtl6vRULIshk/fASv3UG1XpebWbiXl5ciUpFWiWuMn3KmHB4QRrqBPAiQ5TmWy6UQkoL7nHO8WCzE8o9c55w1qJztYpiEEUY//AjXMKGTwjRxcXEhLUe6arUqajQau7ZkPLnGUuKnK0ohlLiMLBQkKku5XREokYRW7ZFadYgivIthGGJw8h1mjSb+rFRQrVRQq9Uks6TgmLS0Kssqzvufe0CY2Q6KLD+gym/jqepO0al4Uq8k7D04xrzRRI03G4bUGYlomVVmlzGkVSXCLO87OyBceD6WiwXSLBMq3k5LMsaKZzjmOpPAB2Hf2cuExyfw9BY6gwFq1equKxgrRcY5e5t77CTCvJIwHU9Q5gskaSqlwDoMgkDsfl+rDuLefg0edsotoW+YQsg6NPdEMhLxGWOG+dIoB/vOdoQ5CS0LyySBHwTy1rGH/du3kZZEtHwnufZihyiH/wLy0wNdJDaQBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 06 16 20 03 53\"\n        title=\"2021 06 16 20 03 53\"\n        src=\"/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png\"\n        srcset=\"/static/106be036b30c8ae5022ab6f9fafc3496/772e8/2021-06-16-20-03-53.png 200w,\n/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png 252w\"\n        sizes=\"(max-width: 252px) 100vw, 252px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>从文件组织上看，每个 Entity 或者是 EntityList 可以组织一个 Datafetcher 提供给具体某一个 <code>Query</code> 下的特定 type 的查询。而针对某个 Entity 的 Mutation 可以放到一起？这部分不太确定，可能还是刚刚开始做，感受不是很明显。</p>\n<h3 id=\"对于-nested-query-的处理\" style=\"position:relative;\">对于 nested query 的处理<a href=\"#%E5%AF%B9%E4%BA%8E-nested-query-%E7%9A%84%E5%A4%84%E7%90%86\" aria-label=\"对于 nested query 的处理 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>既然是一张图，那么查询就可以是一个树，比如可以有这么一个查询：</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token object\">me</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token object\">profile</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token object\">articles</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token object\">edges</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token object\">node</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token object\">comments</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token object\">edges</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token object\">node</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token property\">body</span>\n                <span class=\"token punctuation\">}</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>获取当前用户的 <code>articles</code> 并且包含它的 <code>comment</code> 的 <code>body</code>。类似的问题在 <a href=\"https://netflix.github.io/dgs/advanced/context-passing/\">Nested data fetchers</a> 有做一些阐述。而我这个例子就是遇到了 <a href=\"https://netflix.github.io/dgs/advanced/context-passing/#no-showid-use-local-context\">https://netflix.github.io/dgs/advanced/context-passing/#no-showid-use-local-context</a> 这部分阐述的情况，需要自己创建一个 Map 并放到 localContext 中做传递。具体的代码如下：</p>\n<p><code>ArticleDatafetcher.java</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>spring<span class=\"token punctuation\">.</span>graphql</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token annotation punctuation\">@DgsComponent</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ArticleDatafetcher</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token annotation punctuation\">@DgsData</span><span class=\"token punctuation\">(</span>parentType <span class=\"token operator\">=</span> PROFILE<span class=\"token punctuation\">.</span>TYPE_NAME<span class=\"token punctuation\">,</span> field <span class=\"token operator\">=</span> <span class=\"token class-name\">PROFILE<span class=\"token punctuation\">.</span>Articles</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticlesConnection</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">userArticles</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      <span class=\"token class-name\">DgsDataFetchingEnvironment</span> dfe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">User</span> current <span class=\"token operator\">=</span> <span class=\"token class-name\">SecurityUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Profile</span> profile <span class=\"token operator\">=</span> dfe<span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">CursorPager</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticleData</span><span class=\"token punctuation\">></span></span> articles<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token class-name\"><span class=\"token namespace\">graphql<span class=\"token punctuation\">.</span>relay<span class=\"token punctuation\">.</span></span>PageInfo</span> pageInfo <span class=\"token operator\">=</span> <span class=\"token function\">buildArticlePageInfo</span><span class=\"token punctuation\">(</span>articles<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">ArticlesConnection</span> articlesConnection <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">ArticlesConnection</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">pageInfo</span><span class=\"token punctuation\">(</span>pageInfo<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">edges</span><span class=\"token punctuation\">(</span>\n                articles<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n                        a <span class=\"token operator\">-></span>\n                            <span class=\"token class-name\">ArticleEdge</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">cursor</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">getCursor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">node</span><span class=\"token punctuation\">(</span><span class=\"token function\">buildArticleResult</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticlesConnection</span><span class=\"token punctuation\">></span></span><span class=\"token function\">newResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>articlesConnection<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">localContext</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 这里将 slug : article 的 map 传递到下一个层级了</span>\n            articles<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArticleData</span><span class=\"token operator\">::</span><span class=\"token function\">getSlug</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">-></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><code>CommentDatafetcher.java</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>spring<span class=\"token punctuation\">.</span>graphql</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token annotation punctuation\">@DgsComponent</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommentDatafetcher</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token annotation punctuation\">@DgsData</span><span class=\"token punctuation\">(</span>parentType <span class=\"token operator\">=</span> ARTICLE<span class=\"token punctuation\">.</span>TYPE_NAME<span class=\"token punctuation\">,</span> field <span class=\"token operator\">=</span> <span class=\"token class-name\">ARTICLE<span class=\"token punctuation\">.</span>Comments</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CommentsConnection</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">articleComments</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n      <span class=\"token class-name\">DgsDataFetchingEnvironment</span> dfe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> last <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"first 和 last 必须只存在一个\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">User</span> current <span class=\"token operator\">=</span> <span class=\"token class-name\">SecurityUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Article</span> article <span class=\"token operator\">=</span> dfe<span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ArticleData</span><span class=\"token punctuation\">></span></span> map <span class=\"token operator\">=</span> dfe<span class=\"token punctuation\">.</span><span class=\"token function\">getLocalContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取 map</span>\n    <span class=\"token class-name\">ArticleData</span> articleData <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">.</span><span class=\"token function\">getSlug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 使用 slug 获取具体的 ArticleData</span>\n\n    <span class=\"token class-name\">CursorPager</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CommentData</span><span class=\"token punctuation\">></span></span> comments<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token class-name\"><span class=\"token namespace\">graphql<span class=\"token punctuation\">.</span>relay<span class=\"token punctuation\">.</span></span>PageInfo</span> pageInfo <span class=\"token operator\">=</span> <span class=\"token function\">buildCommentPageInfo</span><span class=\"token punctuation\">(</span>comments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">CommentsConnection</span> result <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">CommentsConnection</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">pageInfo</span><span class=\"token punctuation\">(</span>pageInfo<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">edges</span><span class=\"token punctuation\">(</span>\n                comments<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n                        a <span class=\"token operator\">-></span>\n                            <span class=\"token class-name\">CommentEdge</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">cursor</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">getCursor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">node</span><span class=\"token punctuation\">(</span><span class=\"token function\">buildCommentResult</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">DataFetcherResult</span><span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CommentsConnection</span><span class=\"token punctuation\">></span></span><span class=\"token function\">newResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">localContext</span><span class=\"token punctuation\">(</span>\n            comments<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommentData</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> c <span class=\"token operator\">-></span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 这里同样传递了一个 id : comment 的 map 到下一个层级</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>这种传递 map 的方式也算是官方指定的最佳实践了吧，并且基本不可或缺。因为很多时候 <code>Source</code> 和实际从 <code>Application</code> 层传递的 DTO 的类型就是不一样的，可能缺了不少数据。</p>\n<h2 id=\"效果\" style=\"position:relative;\">效果<a href=\"#%E6%95%88%E6%9E%9C\" aria-label=\"效果 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>只要 Application 层保证重用并且捋清楚了 DataFetcher 之间的数据传递关系，后面做起来感觉就一马平川了，毕竟这也不是一个什么很大很复杂的项目。</p>\n<p>完成之后感觉这种网状关系的调用体验还是很好的，感觉对 API 的调用方来说，一旦熟悉了这种模式就可以更容易的组合各种比较复杂的视图，而不会像 REST 那样担心大量的手工数据组合。</p>\n<h2 id=\"开发过程中的一些小问题\" style=\"position:relative;\">开发过程中的一些小问题<a href=\"#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E9%97%AE%E9%A2%98\" aria-label=\"开发过程中的一些小问题 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li>Intellij 对 GraphQL 本身的支持还不够好</li>\n<li>Dgs 是个比较新的框架，加上国内似乎很少有做类似东西的人，资料很少</li>\n<li>RealWorld 本身对 GraphQL 的推进也很慢，后续我应该会增加英文版本的 ReadME 介绍 GraphQL 这部分的工作，并且希望可以有前端做支持</li>\n</ol>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%AF%B9-api-%E5%B1%82%E4%B8%8E-application-%E5%B1%82%E5%81%9A%E9%87%8D%E6%9E%84\">对 api 层与 application 层做重构</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%A1%AE%E8%AE%A4-graphql-%E7%9A%84-schema\">确认 GraphQL 的 schema</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%A2%9E%E5%8A%A0-graphql-%E7%9A%84%E4%BB%A3%E7%A0%81\">增加 GraphQL 的代码</a></p>\n<ul>\n<li><a href=\"#%E5%AF%B9%E4%BA%8E-nested-query-%E7%9A%84%E5%A4%84%E7%90%86\">对于 nested query 的处理</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%95%88%E6%9E%9C\">效果</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E9%97%AE%E9%A2%98\">开发过程中的一些小问题</a></p>\n</li>\n</ul>","frontmatter":{"title":"Real World 的 GraphQL 版本","date":"June 16, 2021"},"excerpt":"在很久之前的一篇 文章 介绍了我做的一个 RealWorld 的 SpringBoot + MyB…"}},"pageContext":{"id":"9ed405fc-55bf-5469-b5a6-8c0d70dcf561"}},"staticQueryHashes":["4202924991"]}
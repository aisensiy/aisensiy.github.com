{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"site":{"siteMetadata":{"title":"eisen-s-blog"}},"blogs":{"nodes":[{"id":"3c6e6260-4e97-56d3-b14e-b8891d46612e","frontmatter":{"title":"使用 ansible 的 facts 生成 hosts 信息","date":"2022 December-06"},"html":"<iframe src=\"//player.bilibili.com/player.html?aid=475933411&bvid=BV1MK41197sr&cid=914635147&page=1\" width=\"100%\" height=\"640\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n<p>最近在看以前的代码，发现 <code>ansible</code> 的代码里有一些模板是从 <code>ansible</code> 的 <code>vars</code> 生成 <code>/etc/hsots</code> 的代码。这里做了些调研，了解了下用法。这里大量的过程都放到了视频里了，下面的算是笔记吧。</p>\n<h2 id=\"facts-是什么如何收集\" style=\"position:relative;\"><code>facts</code> 是什么，如何收集<a href=\"#facts-%E6%98%AF%E4%BB%80%E4%B9%88%E5%A6%82%E4%BD%95%E6%94%B6%E9%9B%86\" aria-label=\"facts 是什么如何收集 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code>facts</code> 可以理解为 <code>ansible</code> 从主机收集的各种信息，通过如下命令可以看其到底收集了什么：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ansible all <span class=\"token parameter variable\">-i</span> inventory.yaml <span class=\"token parameter variable\">-m</span> gather_facts</code></pre></div>\n<p>通过 <code>ansible-doc gather_facts</code> 可以知道这个行为是在 <code>playbook</code> 执行之处就自动执行的。</p>\n<h2 id=\"如何使用-facts-生成-hosts-文件\" style=\"position:relative;\">如何使用 <code>facts</code> 生成 <code>hosts</code> 文件<a href=\"#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-facts-%E7%94%9F%E6%88%90-hosts-%E6%96%87%E4%BB%B6\" aria-label=\"如何使用 facts 生成 hosts 文件 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code>ansible</code> 帮我们收集的 <code>facts</code> 会放进 <code>vars</code> 里供我们使用。比如 <code>hostvars</code> 这个变量里就有了 <code>facts</code> 的信息，可以通过 <code>debug</code> 来展示这个信息：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Debug hostvars\n    <span class=\"token key atrule\">ansible.builtin.debug</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">var</span><span class=\"token punctuation\">:</span> hostvars</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Debug groups\n    <span class=\"token key atrule\">ansible.builtin.debug</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">var</span><span class=\"token punctuation\">:</span> groups</code></pre></div>\n<p>执行命令 <code>ansible-playbook all -i inventory.yaml generate_hosts.yaml</code> 可以看到其中的内容。</p>\n<p>然后这里我提供一个简单的模板文件 <code>hosts.j2</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{% for host in groups[\"all\"] | sort -%}\n  {% if hostvars[host]['ansible_default_ipv4'] is defined -%}\n    {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host].hostname }}\n  {%- endif %}  \n{% endfor %}</code></pre></div>\n<p>利用如下的 playbook 就可以生成 <code>hosts</code> 文件了（我这里就放到了 home/test 做了个测试，没有实际覆盖 <code>/etc/hosts</code>）。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Test hosts\n    <span class=\"token key atrule\">ansible.builtin.blockinfile</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /home/ubuntu/test\n      <span class=\"token key atrule\">marker</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"# -----{mark} NODES IN CLUSTER-----\"</span>\n      <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">block</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ lookup('template', 'templates/hosts.j2') }}\"</span></code></pre></div>\n<h2 id=\"补充-inventoryyaml\" style=\"position:relative;\">补充 <code>inventory.yaml</code><a href=\"#%E8%A1%A5%E5%85%85-inventoryyaml\" aria-label=\"补充 inventoryyaml permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">virtualmachines</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">vars</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ansible_user</span><span class=\"token punctuation\">:</span> ubuntu\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">vm01</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ansible_host</span><span class=\"token punctuation\">:</span> 106.75.236.174\n      <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> vm01\n    <span class=\"token key atrule\">vm02</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ansible_host</span><span class=\"token punctuation\">:</span> 113.31.107.13\n      <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> vm02</code></pre></div>\n<p>可以看到这里给每个 <code>vm</code> 配了一个 <code>hostname</code> 然后在 <code>hostvars</code> 里也能拿到的。</p>\n<h2 id=\"参考资料\" style=\"position:relative;\">参考资料<a href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\" aria-label=\"参考资料 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://ttl255.com/jinja2-tutorial-part-3-whitespace-control/\">Jinja2 template white space control</a></li>\n</ul>","fields":{"slug_without_date":"/ansible-use-facts"}},{"id":"3bf72e1c-6b3b-5812-9aab-8768418766d6","frontmatter":{"title":"unbound 的安装与基础应用","date":"2022 December-06"},"html":"<p>了解到 unbound 可以用于做本地的 recursive dns server 同时也能支持本地的域名解析，打算用这个东西给内网做域名解析。而用 unbound 有这么两个好处：</p>\n<ol>\n<li>使用 recursive dns server 可以避免把请求都发给上级的缓存服务器，很大程度上保证了个人隐私，也相对会更安全，当然搭配 pi-hole 这样的东西使用效果更佳 <a href=\"https://docs.pi-hole.net/guides/dns/unbound/\">https://docs.pi-hole.net/guides/dns/unbound/</a></li>\n<li>unbound 除了做 recursive dns server 外也能接管内网域名解析，作为一个 authoritative server 使用（当然，它并不是专门做这个的，但是规模比较小的网络是没问题的）</li>\n</ol>\n<h2 id=\"unbound-的安装\" style=\"position:relative;\">unbound 的安装<a href=\"#unbound-%E7%9A%84%E5%AE%89%E8%A3%85\" aria-label=\"unbound 的安装 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>以下是在 ubuntu 20.04 的安装流程：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> unbound <span class=\"token parameter variable\">-y</span></code></pre></div>\n<h3 id=\"基础配置\" style=\"position:relative;\">基础配置<a href=\"#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE\" aria-label=\"基础配置 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>先来一个简单的配置：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server:\n    # can be uncommented if you do not need user privilige protection\n    # username: \"\"\n\n    # can be uncommented if you do not need file access protection\n    # chroot: \"\"\n\n    # location of the trust anchor file that enables DNSSEC. note that\n    # the location of this file can be elsewhere\n    auto-trust-anchor-file: \"/usr/local/etc/unbound/root.key\"\n    # auto-trust-anchor-file: \"/var/lib/unbound/root.key\"\n\n    # send minimal amount of information to upstream servers to enhance privacy\n    qname-minimisation: yes\n\n    # specify the interface to answer queries from by ip-address.\n    interface: 0.0.0.0\n    # interface: ::0\n\n    # addresses from the IP range that are allowed to connect to the resolver\n    access-control: 192.168.0.0/16 allow\n    # access-control: 2001:DB8/64 allow</code></pre></div>\n<p>把它放到 <code>/etc/unbound/unbound.conf.d/myunbound.conf</code> 这里，然后 <code>systemctl restart unbound</code> 重启服务。</p>\n<h3 id=\"解决-53-端口冲突的问题\" style=\"position:relative;\">解决 53 端口冲突的问题<a href=\"#%E8%A7%A3%E5%86%B3-53-%E7%AB%AF%E5%8F%A3%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98\" aria-label=\"解决 53 端口冲突的问题 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>不出意外的话，重启 <code>unbound</code> 服务会报错，大概的报错信息是说 53 端口已经被占用了。这个时候可以通过 <code>netstat -tulpn</code> 来查看端口占用情况，发现是 <code>systemd-resolved</code> 占用了 53 端口，简单搜索会找到 <a href=\"https://unix.stackexchange.com/questions/304050/how-to-avoid-conflicts-between-dnsmasq-and-systemd-resolved\">https://unix.stackexchange.com/questions/304050/how-to-avoid-conflicts-between-dnsmasq-and-systemd-resolved</a> 这么一个问题。按照其中内容修改 <code>/etc/systemd/resolved.conf</code> 设置 <code>DNSStubListener=no</code> 并重启 <code>systemd-resolved</code> 服务就可以了。</p>\n<h2 id=\"测试-unbound-是否工作\" style=\"position:relative;\">测试 unbound 是否工作<a href=\"#%E6%B5%8B%E8%AF%95-unbound-%E6%98%AF%E5%90%A6%E5%B7%A5%E4%BD%9C\" aria-label=\"测试 unbound 是否工作 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">dig</span> openbayes.com @127.0.0.1\n\n<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> DiG <span class=\"token number\">9.16</span>.1-Ubuntu <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> openbayes.com @127.0.0.1\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> global options: +cmd\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Got answer:\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> -<span class=\"token operator\">>></span>HEADER<span class=\"token operator\">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class=\"token number\">52191</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> flags: qr rd ra<span class=\"token punctuation\">;</span> QUERY: <span class=\"token number\">1</span>, ANSWER: <span class=\"token number\">1</span>, AUTHORITY: <span class=\"token number\">0</span>, ADDITIONAL: <span class=\"token number\">1</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags:<span class=\"token punctuation\">;</span> udp: <span class=\"token number\">4096</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>openbayes.com.\t\t\tIN\tA\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\nopenbayes.com.\t\t<span class=\"token number\">600</span>\tIN\tA\t<span class=\"token number\">106.75</span>.109.110\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">1524</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">127.0</span>.0.1<span class=\"token comment\">#53(127.0.0.1)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Sun Dec 04 <span class=\"token number\">14</span>:59:32 CST <span class=\"token number\">2022</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">58</span></code></pre></div>\n<p>可以看到第一次很慢，但是第二次由于已经有了缓存，速度会快起来：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">dig</span> openbayes.com @127.0.0.1\n\n<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> DiG <span class=\"token number\">9.16</span>.1-Ubuntu <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> openbayes.com @127.0.0.1\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> global options: +cmd\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Got answer:\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> -<span class=\"token operator\">>></span>HEADER<span class=\"token operator\">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class=\"token number\">26243</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> flags: qr rd ra<span class=\"token punctuation\">;</span> QUERY: <span class=\"token number\">1</span>, ANSWER: <span class=\"token number\">1</span>, AUTHORITY: <span class=\"token number\">0</span>, ADDITIONAL: <span class=\"token number\">1</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags:<span class=\"token punctuation\">;</span> udp: <span class=\"token number\">4096</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>openbayes.com.\t\t\tIN\tA\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\nopenbayes.com.\t\t<span class=\"token number\">535</span>\tIN\tA\t<span class=\"token number\">106.75</span>.109.110\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">0</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">127.0</span>.0.1<span class=\"token comment\">#53(127.0.0.1)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Sun Dec 04 <span class=\"token number\">15</span>:00:37 CST <span class=\"token number\">2022</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">58</span></code></pre></div>\n<h2 id=\"让-unbound-接管本机的域名解析\" style=\"position:relative;\">让 unbound 接管本机的域名解析<a href=\"#%E8%AE%A9-unbound-%E6%8E%A5%E7%AE%A1%E6%9C%AC%E6%9C%BA%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90\" aria-label=\"让 unbound 接管本机的域名解析 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>上面的 <code>dig</code> 命令需要主动选择 <code>@127.0.0.1</code> 作为域名解析的服务。我们当然是希望默认就使用 <code>unbound</code> 来做域名解析。这里我参考的 unbound 文旦 <a href=\"https://unbound.docs.nlnetlabs.nl/en/latest/use-cases/home-resolver.html#setting-up-for-a-single-machine\">https://unbound.docs.nlnetlabs.nl/en/latest/use-cases/home-resolver.html#setting-up-for-a-single-machine</a> 进行配置。</p>\n<p>首先继续修改 <code>/etc/systemd/resolved.conf</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Resolve]\nDNS=127.0.0.1\n#FallbackDNS=\n#Domains=\nDNSSEC=yes\n#DNSOverTLS=no\n#MulticastDNS=no\n#LLMNR=no\n#Cache=no-negative\nDNSStubListener=no\n#DNSStubListenerExtra=</code></pre></div>\n<p>然后强制更新下 <code>/etc/resolv.conf</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-fs</span> /run/systemd/resolve/resolv.conf /etc/resolv.conf</code></pre></div>\n<p>最后重启 <code>systemd-resolved</code> 服务：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">systemctl restart systemd-resolved</code></pre></div>\n<p>执行 <code>dig</code> 的时候，就默认使用 <code>127.0.0.1#53</code> 了呢。</p>\n<p>到此为止，unbound 的基本配置就完成了。</p>\n<h2 id=\"添加-local-zone\" style=\"position:relative;\">添加 local-zone<a href=\"#%E6%B7%BB%E5%8A%A0-local-zone\" aria-label=\"添加 local zone permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>最后就是利用 <code>unbound</code> 所提供的 <code>local-zone</code> 配置实现内网域名解析了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server:\n    # can be uncommented if you do not need user privilige protection\n    # username: \"\"\n\n    # can be uncommented if you do not need file access protection\n    # chroot: \"\"\n\n    # location of the trust anchor file that enables DNSSEC. note that\n    # the location of this file can be elsewhere\n    # auto-trust-anchor-file: \"/usr/local/etc/unbound/root.key\"\n    # auto-trust-anchor-file: \"/var/lib/unbound/root.key\"\n\n    # send minimal amount of information to upstream servers to enhance privacy\n    qname-minimisation: yes\n\n    # specify the interface to answer queries from by ip-address.\n    interface: 0.0.0.0\n    # interface: ::0\n\n    # addresses from the IP range that are allowed to connect to the resolver\n    access-control: 192.168.0.0/16 allow\n    access-control: 10.23.0.0/16 allow\n    # access-control: 2001:DB8/64 allow\n\n    local-zone: \"home.lan.\" static\n    local-data: \"abc.home.lan. A 127.0.0.1\"\n    local-data: \"bbc.home.lan. A 127.0.0.1\"</code></pre></div>\n<p><code>dig abc.home.lan</code> 就发现域名指向了 <code>127.0.0.1</code> 了。</p>","fields":{"slug_without_date":"/unbound-get-started"}},{"id":"5f835784-3402-51f6-ba36-a459fcf751d6","frontmatter":{"title":"记一次 k8s gpu 集群中半精度性能差异引发的系统调优","date":"2022 November-17"},"html":"<p>最近发现跑 pytorch gpu benchmark 的时候，AMD epyc cpu 下的 rtx 3090 明显要比 intel 下 3090 慢，而且差距挺大的，非常不能理解。折腾了挺长一段时间才最终定位到是因为 cpu 在容器里的调度问题导致的。过程兜兜转转花了不少时间，这里就不说太多了，记录下大体过程和最后调优的措施。</p>\n<h2 id=\"最开始的测试\" style=\"position:relative;\">最开始的测试<a href=\"#%E6%9C%80%E5%BC%80%E5%A7%8B%E7%9A%84%E6%B5%8B%E8%AF%95\" aria-label=\"最开始的测试 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"测试脚本\" style=\"position:relative;\">测试脚本<a href=\"#%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC\" aria-label=\"测试脚本 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<ul>\n<li>python gpu benchmark: <a href=\"https://github.com/ryujaehun/pytorch-gpu-benchmark\">https://github.com/ryujaehun/pytorch-gpu-benchmark</a></li>\n<li>model: <code>models.resnet.__all__[1:]</code> 只测试 resnet 模型</li>\n<li>batch size: 64</li>\n<li>cpu limit: 12</li>\n<li>memory limit: 30G</li>\n<li>gpu limit: 1</li>\n<li>shm: docker 给 30G 而 k8s 里由于无法直接设置，就给了机器内存的大小</li>\n</ul>\n<h3 id=\"nvidia-docker-脚本\" style=\"position:relative;\">nvidia docker 脚本<a href=\"#nvidia-docker-%E8%84%9A%E6%9C%AC\" aria-label=\"nvidia docker 脚本 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-it</span> --shm-size<span class=\"token operator\">=</span>30g <span class=\"token parameter variable\">--cpus</span><span class=\"token operator\">=</span><span class=\"token number\">12</span> <span class=\"token parameter variable\">--memory</span><span class=\"token operator\">=</span>30G --\ngpus <span class=\"token string\">'\"device=1\"'</span> uhub.service.ucloud.cn/openbayesruntimes/pytorch:1.9.0-py36-cu111.70</code></pre></div>\n<h3 id=\"两个差异很大的结果\" style=\"position:relative;\">两个差异很大的结果<a href=\"#%E4%B8%A4%E4%B8%AA%E5%B7%AE%E5%BC%82%E5%BE%88%E5%A4%A7%E7%9A%84%E7%BB%93%E6%9E%9C\" aria-label=\"两个差异很大的结果 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<h4 id=\"intel-平台\" style=\"position:relative;\">Intel 平台<a href=\"#intel-%E5%B9%B3%E5%8F%B0\" aria-label=\"intel 平台 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">start\nbenchmark start : 2022/11/17 06:15:23\nNumber of GPUs on current device : 1\nCUDA Version : 11.1\nCudnn Version : 8005\nDevice Name : NVIDIA GeForce RTX 3090\nuname_result(system='Linux', node='d1d271bdf102', release='5.4.0-131-generic', version='#147-Ubuntu SMP Fri Oct 14 17:07:22 UTC 2022', machine='x86_64', processor='x86_64')\n                     scpufreq(current=1184.1902125, min=800.0, max=3400.0)\n                    cpu_count: 80\n                    memory_available: 258789797888\nBenchmarking Training half precision type resnet18\n/usr/local/lib/python3.6/site-packages/torch/nn/functional.py:718: UserWarning: Named tensors and all their associated APIs are an experimental feature and subject to change. Please do not use them for anything important until they are released as stable. (Triggered internally at  /pytorch/c10/core/TensorImpl.h:1156.)\n  return torch.max_pool2d(input, kernel_size, stride, padding, dilation, ceil_mode)\nresnet18 model average train time : 41.39636039733887ms\nBenchmarking Training half precision type resnet34\nresnet34 model average train time : 55.32251834869385ms\nBenchmarking Training half precision type resnet50\nresnet50 model average train time : 92.97645568847656ms\nBenchmarking Training half precision type resnet101\nresnet101 model average train time : 147.91772842407227ms\nBenchmarking Training half precision type resnet152\nresnet152 model average train time : 209.90628242492676ms\nBenchmarking Training half precision type resnext50_32x4d\nresnext50_32x4d model average train time : 132.71542072296143ms\nBenchmarking Training half precision type resnext101_32x8d\nresnext101_32x8d model average train time : 336.4134645462036ms\nBenchmarking Training half precision type wide_resnet50_2\nwide_resnet50_2 model average train time : 156.14235401153564ms\nBenchmarking Training half precision type wide_resnet101_2\nwide_resnet101_2 model average train time : 259.703106880188ms\nBenchmarking Inference half precision type resnet18\nresnet18 model average inference time : 31.02853298187256ms\nBenchmarking Inference half precision type resnet34\nresnet34 model average inference time : 39.35199737548828ms\nBenchmarking Inference half precision type resnet50\nresnet50 model average inference time : 41.26767635345459ms\nBenchmarking Inference half precision type resnet101\nresnet101 model average inference time : 48.41951370239258ms\nBenchmarking Inference half precision type resnet152\nresnet152 model average inference time : 67.41719722747803ms\nBenchmarking Inference half precision type resnext50_32x4d\nresnext50_32x4d model average inference time : 44.739885330200195ms\nBenchmarking Inference half precision type resnext101_32x8d\nresnext101_32x8d model average inference time : 103.05868148803711ms\nBenchmarking Inference half precision type wide_resnet50_2\nwide_resnet50_2 model average inference time : 49.078497886657715ms\nBenchmarking Inference half precision type wide_resnet101_2\nwide_resnet101_2 model average inference time : 83.67201805114746ms\nbenchmark end : 2022/11/17 06:21:41\nend</code></pre></div>\n<h4 id=\"amd-平台\" style=\"position:relative;\">AMD 平台<a href=\"#amd-%E5%B9%B3%E5%8F%B0\" aria-label=\"amd 平台 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">start\nbenchmark start : 2022/11/17 06:14:11\nNumber of GPUs on current device : 1\nCUDA Version : 11.1\nCudnn Version : 8005\nDevice Name : NVIDIA GeForce RTX 3090\nuname_result(system='Linux', node='925b73b78805', release='5.15.0-43-generic', version='#46-Ubuntu SMP Tue Jul 12 10:30:17 UTC 2022', machine='x86_64', processor='x86_64')\n                     scpufreq(current=2784.047382812501, min=1500.0, max=2200.0)\n                    cpu_count: 256\n                    memory_available: 485026041856\nBenchmarking Training half precision type resnet18\n/usr/local/lib/python3.6/site-packages/torch/nn/functional.py:718: UserWarning: Named tensors and all their associated APIs are an experimental feature and subject to change. Please do not use them for anything important until they are released as stable. (Triggered internally at  /pytorch/c10/core/TensorImpl.h:1156.)\n  return torch.max_pool2d(input, kernel_size, stride, padding, dilation, ceil_mode)\nresnet18 model average train time : 75.70790767669678ms\nBenchmarking Training half precision type resnet34\nresnet34 model average train time : 82.6269006729126ms\nBenchmarking Training half precision type resnet50\nresnet50 model average train time : 111.1276912689209ms\nBenchmarking Training half precision type resnet101\nresnet101 model average train time : 161.16506576538086ms\nBenchmarking Training half precision type resnet152\nresnet152 model average train time : 228.9912509918213ms\nBenchmarking Training half precision type resnext50_32x4d\nresnext50_32x4d model average train time : 143.40569496154785ms\nBenchmarking Training half precision type resnext101_32x8d\nresnext101_32x8d model average train time : 354.08830165863037ms\nBenchmarking Training half precision type wide_resnet50_2\nwide_resnet50_2 model average train time : 164.76832389831543ms\nBenchmarking Training half precision type wide_resnet101_2\nwide_resnet101_2 model average train time : 271.076135635376ms\nBenchmarking Inference half precision type resnet18\nresnet18 model average inference time : 63.87866973876953ms\nBenchmarking Inference half precision type resnet34\nresnet34 model average inference time : 68.00977230072021ms\nBenchmarking Inference half precision type resnet50\nresnet50 model average inference time : 73.05157661437988ms\nBenchmarking Inference half precision type resnet101\nresnet101 model average inference time : 81.68745994567871ms\nBenchmarking Inference half precision type resnet152\nresnet152 model average inference time : 87.46984004974365ms\nBenchmarking Inference half precision type resnext50_32x4d\nresnext50_32x4d model average inference time : 83.56608867645264ms\nBenchmarking Inference half precision type resnext101_32x8d\nresnext101_32x8d model average inference time : 108.2996940612793ms\nBenchmarking Inference half precision type wide_resnet50_2\nwide_resnet50_2 model average inference time : 78.30146789550781ms\nBenchmarking Inference half precision type wide_resnet101_2\nwide_resnet101_2 model average inference time : 90.06356239318848ms\nbenchmark end : 2022/11/17 06:23:29\nend</code></pre></div>\n<p>可以看到，越小的模型性能差异越大，这里就让我非常怀疑是 cpu 的问题。</p>\n<h2 id=\"关注主频\" style=\"position:relative;\">关注主频<a href=\"#%E5%85%B3%E6%B3%A8%E4%B8%BB%E9%A2%91\" aria-label=\"关注主频 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这里 AMD 的 cpu 是 <a href=\"https://www.amd.com/en/products/cpu/amd-epyc-7773x\">7773x</a> ，64 核心，128 线程，看起来是个 monster 可是这种超多核心的服务器 cpu 的主频相对都低一些，比如这个 Base Clock 是 2.2GHz，Boost Clock 是 3.5GHz。和 Intel 平台的比，差了一点点（那边是 3.8GHz）但这不足以引起如此大的性能差异，同时在通过 <code>cat /proc/cpuinfo</code> 命令查看运行时的主频后也确认很多核心的主频都可以跑到 3.4GHz 的水平，说明没有什么诡异的 BIOS 配置限制了性能的发挥。所以主频不是导致性能差的罪魁祸首。</p>\n<h2 id=\"继续翻阅-amd-的-cpu-调优手册\" style=\"position:relative;\">继续翻阅 AMD 的 CPU 调优手册<a href=\"#%E7%BB%A7%E7%BB%AD%E7%BF%BB%E9%98%85-amd-%E7%9A%84-cpu-%E8%B0%83%E4%BC%98%E6%89%8B%E5%86%8C\" aria-label=\"继续翻阅 amd 的 cpu 调优手册 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>虽然主频没问题，但还是觉得 cpu 哪里不太对，于是开始在 bios 里翻各种配置项目，越翻越懵逼，看不懂那些项目什么意思，就只能通过搜索引擎找到 AMD EPYC CPU 的配置手册，不经意间看到一个 <a href=\"https://www.amd.com/system/files/documents/container-tuning-guide-kubernetes-amd-epyc7003-series-processors.pdf\">Kubernetes Container Tuning Guide for AMD EPYC 7003 Series Processors</a> 这不就是我目前所需要的？在 3.2 Container Pinning Settings 这部分提到默认的调度规则是在所有的 cpu 上做调度：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/decdc5e60d0d898f78237884f3840635/dc333/container-pinning-settings.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhUlEQVQoz6WRX4vaQBTF8/2/ig/rQ/MkokZQi6tRmlYTNclk8s+ZZKLVtZvEcsqd4rLsQl964ccZuHDunXONn79e8do0WMYp5lECO06x4AkWPMVXxjHc+XBzgd9ti7quUdcNmqZB27Za33O/32H82GwQBAGel0s4mw3c/R5bz4Pn+/i+3SLgHFIpKKVQFIVWKQXKskRRSAghIaXUvevLCwwhJaQQiDlHGAQIwwCHw0G/szSFKktEjCFNU1SVwu12w7/KmM/nsG0bS9vGYvGM2WyG9XqN1WqFb44Dx3F0n9TzPOz3BzAW6l+9h5YQQsDodDrodrt4eurCNL/ANE30ej0Mh0MMBgOtljXS79FohH6/r7EsC9PpFJPJROt4PMZut4NB7owx+L6POI5xPB6RZdknkiTR+siLMqyq6g3K9nq9wsiyXJu5rqsn0LfImDLL81xDQ0jJ6HFNuvJH9JU554iiCCFjWmkTMiQlHhs9IPOPUHY08Hw+wzidTn/XVwqXywX/W38AW6uW7/q11S4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"container pinning settings\"\n        title=\"container pinning settings\"\n        src=\"/static/decdc5e60d0d898f78237884f3840635/5a190/container-pinning-settings.png\"\n        srcset=\"/static/decdc5e60d0d898f78237884f3840635/772e8/container-pinning-settings.png 200w,\n/static/decdc5e60d0d898f78237884f3840635/e17e5/container-pinning-settings.png 400w,\n/static/decdc5e60d0d898f78237884f3840635/5a190/container-pinning-settings.png 800w,\n/static/decdc5e60d0d898f78237884f3840635/dc333/container-pinning-settings.png 938w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>那对于这个双路一共 256 线程的机器来说，调度频繁切换应该会是一个很大的开销吧？这里提到的 <code>static</code> 则是说只在特定的 cpu 里做调度。按照这个关键信息，我翻阅了 <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/\"></a> 知道了 <code>static</code> 规则用的就是 <code>cgroup</code> 的 <code>cpuset</code> 系统。那我是不是可以先用 <code>docker</code> 试试看？</p>\n<h2 id=\"使用-cpuset-命令测试\" style=\"position:relative;\">使用 cpuset 命令测试<a href=\"#%E4%BD%BF%E7%94%A8-cpuset-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95\" aria-label=\"使用 cpuset 命令测试 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run --rm -it --shm-size=30g --cpuset-cpus 4-15 --cpus=12 --memory=30G --\ngpus '\"device=1\"' uhub.service.ucloud.cn/openbayesruntimes/pytorch:1.9.0-py36-cu111.70</code></pre></div>\n<p>这里就是增加了 <code>--cpuset-cpus 4-15</code> 告知 <code>docker</code> 这个容器的可用 cpu 的区间。结果发现性能有了很大的提升，实际速度也超过了 Intel 平台。那么这里就大体确定了是默认调度规则的问题了。</p>\n<h2 id=\"解决-nvidia-docker-与-cpu-调度策略冲突的问题\" style=\"position:relative;\">解决 nvidia-docker 与 cpu 调度策略冲突的问题<a href=\"#%E8%A7%A3%E5%86%B3-nvidia-docker-%E4%B8%8E-cpu-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98\" aria-label=\"解决 nvidia docker 与 cpu 调度策略冲突的问题 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>按照 <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/\">Changing the CPU Manager Policy</a> 我很快对一台机器进行了调整，并准备在 k8s 平台上再做一次 benchmark 结果发现使用 <code>nvidia-smi</code> 命令查看显卡信息的时候报错了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Failed to initialize NVML: Unknown Error</code></pre></div>\n<p>又是一番查询，发现是刚刚使用的 <code>cpu-manager-polcy=static</code> 会和 nvidia-docker 有冲突：容器因为 <code>static</code> 的调度规则必须修改容器的运行时，而这种行为是 nvidia docker 所不支持的。目前的解决方式是<strong>让所有调度 gpu 的 Pod 都必须具备 <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/\">Guaranteed 级别的 QoS</a>，同时所有的容器都必须有整数个的 cpu limitation</strong>。对于这种 Pod kubelet 会特殊对待，跳过对其 cpuset 进行更新（因为它锁定了 cpuset 所以按理说也不用更新）。同时这个支持也是在 k8s 1.22 版本之后才支持的。为此我们的集群也不得不升级到了 1.22 版本。</p>","fields":{"slug_without_date":"/amd-3090-half-precision"}}],"pageInfo":{"pageCount":47,"hasPreviousPage":false,"currentPage":1}}},"pageContext":{}},"staticQueryHashes":["26522286"],"slicesMap":{}}
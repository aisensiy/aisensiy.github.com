{"componentChunkName":"component---src-templates-blog-js","path":"/blog-migrate-from-jekyll-to-gatsby","result":{"data":{"blog":{"id":"ca5034b7-1b2a-53bf-a94c-89290d8fc673","html":"<p>考虑到自己的前端技能有一阵子没有更新了，同时看到刘老师用 <a href=\"https://docusaurus.io\">docusaurus</a> 把 openbayes docs 切换之后的顺滑体验，于是就打算了解和折腾了一下和 docusaurus 技术栈类似但适用范围大大增加的 <a href=\"https://www.gatsbyjs.org/\">gatsby</a>。这里先那自己的小博客开刀，把原来的 jekyll 技术栈切换过来。</p>\n<p>本来打算一小步一小步走过来，先不要管太多的细节，可结果依然是给自己加了码，甚至同时体验了 tailwindcss 的部分。这里还是会分开几篇做介绍吧。首先是介绍把 jekyll 迁移到 gatsby 的部分。</p>\n<p>以及这里不会介绍如下内容：</p>\n<ol>\n<li>gatsby 的安装</li>\n<li>graphql 的知识</li>\n</ol>\n<h2 id=\"gatsby-的思路\" style=\"position:relative;\">Gatsby 的思路<a href=\"#gatsby-%E7%9A%84%E6%80%9D%E8%B7%AF\" aria-label=\"gatsby 的思路 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>虽然 gatsby 官方把 static 划掉了加上了 dynamic，但从我粗浅的体验来看，它依然是一个 static site generator。只是在具体生成的路由上玩出了不少的花，后续也会做介绍。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 772px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e153ee034e6e26509318a47a5247d08b/940c5/2021-07-17-20-10-00.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABU0lEQVQY06WRXU+CYACF/fmu1l3mR2lt6SL83CTNUqA2Qfw2hFJQVF58RTAFtGU6aNhV1z73z9nZOR7nCDxNDOJhSR2sVWnTykEOn1OIvFS2BEE8YLlatc4wDE1TJEkSJK4rZis/ZfHZl/njyrBv0Shgi3OptaIQmYxI1D0YtpbxNHJ6doLEY+HIVfQ2mkymEDQ2bOvco9nM6J9g68qG+g14E/DmuLOCgjUT1z1qMe6sNHFbxxRd2C+mBoZhXJdjWbbC0LVm5amUFweCK1fTSv5c7OLzSgI0c7BTUJkkKN/JUDQ/yno9DXtdMXTt8wcvUBT1er1+fyAYCBWfi64M3k2ZNQRmwb9qULAaGFQHa8AbjSwEvDHtm5M3S25vtInlOI5t/x9s1F42slMmASoJwJFa6VLiDi2qKeXlZlTwDZgUqGXAqL1yHHu32/9hH2I8x1z1C8gfodvGHSbEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 07 17 20 10 00\"\n        title=\"2021 07 17 20 10 00\"\n        src=\"/static/e153ee034e6e26509318a47a5247d08b/940c5/2021-07-17-20-10-00.png\"\n        srcset=\"/static/e153ee034e6e26509318a47a5247d08b/772e8/2021-07-17-20-10-00.png 200w,\n/static/e153ee034e6e26509318a47a5247d08b/e17e5/2021-07-17-20-10-00.png 400w,\n/static/e153ee034e6e26509318a47a5247d08b/940c5/2021-07-17-20-10-00.png 772w\"\n        sizes=\"(max-width: 772px) 100vw, 772px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>把 gatsby 的思路拆分为以下几个部分：</p>\n<ol>\n<li>gatsby 使用的模板引擎是 react（jekyll 用的就是 ruby 的 erb），相比于其他的后端模板引擎，使用 react 相当于前端功能全开了，确实甩其他的模板引擎几条街。</li>\n<li>当然它自然也有自己的一套静态路由的生成体系。以及最近出现的动态路由可能就是他们说自己的 dynamic 的点？在我看来，这部分似乎没有特别多的新意，毕竟路由也是很多后端服务器一定会有的东西。唯一我看到的新意在于通过一个 php 式的文件结构去定义了路由，似乎是一种把路由的使用门槛降低的好办法，next.js 也使用了类似的方式。</li>\n<li>最后，它有一个 graphql data layer（好像有一些文章成为 data mesh）它可以通过一系列插件将各种各样的数据源做集成，并暴露出 graphql 的接口给处于 <code class=\"language-text\">develop mode</code> 的 gatsby server ，用来填充模板的数据。这部分内容不单单是说我可以集成多个数据源这么简单，其数据层甚至可以对每个数据源做增强，以达到非常多复杂的功能。在后面有关插件的部分我也会做一些介绍。</li>\n</ol>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b825b58bb44d2080bfd119800d2a2d5/5df5d/data-layer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzElEQVQozz1Sy3LbMAzU//9Ye8s1mSZOmjaRKtsSXyDxZoeyEwwPxM4sd7HEhGJrwh14Dvixt4RSSc+ZQhUU24DniEvESyFSzyhzxDliQUWxCUjer+3P1p6X/LKWSyZAOa35nLCgLKG9/Bv42wUyylb4aU6PnzEAAenUuwNACEGYVdjdeu8i0hr2o5hZmHvvZkbEwtS7m7mqTu4+L+vL6xsxqxpALQC995QzEvXer/uuqgWgAIiIe/fezd3MBtnd1Tw1Liix0nyNsfGe655ranwOOTWeryEA5iapMqC4u7lPd29qKMOwf7WnC/y+1o+9LZE+A97wfmgC6e0+DRujOpAUlNQ4VkqNt9y2jBFoLy0AHTjnNmQLytC9KReo121HpDHMgbaGrSEiIZGo5gKq6l/VDzlVG+T1fHl8eo4xDSvuhEhHVKoqIsOqWq3NzL68D/Y9MJHxKosi63UPsVRzZzVACjEhq7mLWky5NWSx75puz3T3Y7Hw1xJDZRJrrOeEvy+lkpAooM6hva45o4haH+b79J1wRn1ays/TdloLq5PaHPHhPeQmrBaAH97jj9P2d2/m9+yn7zHUxm+P9dKR5e24dxI7Jrwzju5O+Q8cUvLI8mjQAQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"graphql data layer\"\n        title=\"graphql data layer\"\n        src=\"/static/1b825b58bb44d2080bfd119800d2a2d5/5a190/data-layer.png\"\n        srcset=\"/static/1b825b58bb44d2080bfd119800d2a2d5/772e8/data-layer.png 200w,\n/static/1b825b58bb44d2080bfd119800d2a2d5/e17e5/data-layer.png 400w,\n/static/1b825b58bb44d2080bfd119800d2a2d5/5a190/data-layer.png 800w,\n/static/1b825b58bb44d2080bfd119800d2a2d5/c1b63/data-layer.png 1200w,\n/static/1b825b58bb44d2080bfd119800d2a2d5/5df5d/data-layer.png 1572w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">graphql data layer</figcaption>\n  </figure></p>\n<h2 id=\"快速开始\" style=\"position:relative;\">快速开始<a href=\"#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B\" aria-label=\"快速开始 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>有了上面的介绍，然后我简单 google 了下，发现和我一样把 jekyll 切到 gatsby 的人不在少数。官方网站里也有适配 markdown 作为数据源的相关资源。这里先罗列下从 jekyll 到 gatsby 迁移的几个必须的步骤，并在下文一一介绍。</p>\n<ol>\n<li>markdown 文件的整体迁移</li>\n<li>生成路由</li>\n<li>处理 blog 中的代码高亮</li>\n<li>优化 blog 中的 image</li>\n<li>部署</li>\n</ol>\n<h2 id=\"markdown-文件的整体迁移\" style=\"position:relative;\">markdown 文件的整体迁移<a href=\"#markdown-%E6%96%87%E4%BB%B6%E7%9A%84%E6%95%B4%E4%BD%93%E8%BF%81%E7%A7%BB\" aria-label=\"markdown 文件的整体迁移 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>jekyll 的时代假设其静态页面生成的数据源一定是文件，但这种假设在 2021 年看起来是被打破了。从 gatsby 的官方数据源插件来看，其中大量的数据源是 headless cms，比如 contentful 比如 wordpress。这个思路在国内似乎没有被很好的传播开来，以及对我来说从从 jekyll 迁移过来也就一定是文件。</p>\n<p>这里我用到了两个插件：</p>\n<ol>\n<li><code class=\"language-text\">gatsby-source-filesystem</code> 将特定目录作为数据源添加到 gatsby 的数据层</li>\n<li><code class=\"language-text\">gatsby-transformer-remark</code> 使用 <a href=\"https://remark.js.org/\">remark</a> 将 <code class=\"language-text\">markdown</code> 文件解析为 html 并且它有强大的扩展功能实现 markdown 里面特定的解析功能</li>\n</ol>\n<p>gatsby 所有的插件都需要单独安装并在 <code class=\"language-text\">gatsby-config.js</code> 做配置，这里就罗列下上述两个插件的基本配置：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  siteMetadata<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      resolve<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">gatsby-transformer-remark</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Plugins configs 这里后续做扩展，支持语法高亮、图片优化</span>\n        plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      resolve<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">gatsby-source-filesystem</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">blogs</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        path<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>__dirname<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/src/blogs/</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">gatsby-source-filesystem</code> 的配置我把 markdown 文件全部放到了 <code class=\"language-text\">src/blogs</code> 目录下，在 <code class=\"language-text\">yarn run start</code> 之后，通过 <code class=\"language-text\">http://localhost:8000/__graphql</code> 构建如下 graphql 语句获取对应的文件内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property-query\">allFile</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">filter</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token attr-name\">sourceInstanceName</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token attr-name\">eq</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"blogs\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token object\">nodes</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">relativePath</span>\n      <span class=\"token property\">extension</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到对应的结果如下所示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/903572f815ccd4e832fc819eed8580f7/9b379/2021-07-18-14-20-38.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABRklEQVQoz42R247cIBBE/f//mEykWZtLYzf0DewxbGTnJVI2mj2qR44oVU8fz495Xrz3MQa4CSEkAB+8cy6tX7O4sLg4ad33epzHebRzt9deX+dxvup+9lNEMiCRmFX9K6JWW4sAk9i+AFk9Rh/9HL2P0cc4+xjDzFakOSJpFWsm1axa27W2drwW56be+/1yfP6DFKZngkdwPxw+Ez2BY5aNeC2WJYQ4fan9QdW48JpygkwbyUZKqkW0iOlVfvr8P8rKyCliRKYiiqysWi7f7K2sxkhrRPBbAeSIqtVas7Zbbe9lKZIgu0vODNnsNu+8k0UFCQJ6v+Ww8Zw4Fc1yhfS9zFu5agcsMbPHa7N7MBX7xs8bp4DBY/HIy8rrJQvJd2obb7RChpgLZIlZ8j04qb4/VWGaE/wK7qfHRyiPQMvK/p79rv0buuHtxVAbKOgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 07 18 14 20 38\"\n        title=\"2021 07 18 14 20 38\"\n        src=\"/static/903572f815ccd4e832fc819eed8580f7/5a190/2021-07-18-14-20-38.png\"\n        srcset=\"/static/903572f815ccd4e832fc819eed8580f7/772e8/2021-07-18-14-20-38.png 200w,\n/static/903572f815ccd4e832fc819eed8580f7/e17e5/2021-07-18-14-20-38.png 400w,\n/static/903572f815ccd4e832fc819eed8580f7/5a190/2021-07-18-14-20-38.png 800w,\n/static/903572f815ccd4e832fc819eed8580f7/9b379/2021-07-18-14-20-38.png 951w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>不过直接使用这个似乎也做不了什么，在获取了这个数据之后我们需要自己写代码去解析每个文件的内容。幸好有 <code class=\"language-text\">gatsby-transformer-remark</code> 它会帮助我们做这个事情，并提供另外一个 graphql 的接口方便我们直接获取 markdown 的内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token object\">allMarkdownRemark</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token object\">nodes</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">id</span>\n      <span class=\"token property\">html</span>\n      <span class=\"token object\">frontmatter</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">title</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/766fff3e9096e10adfe8fb7d7c67d123/d7abb/2021-07-18-14-26-08.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABYklEQVQoz4WRi27qMBBE8/+fVhVuAyRAq6rk4UdC7F3b6zgUEioT3UpVSzsarSzLRzsjJ0VRcMZkI2Uzq5VStm0jhOCcq//qvrrmUogmsWjJD304jeM4TdM8ZxERdoCWLHnyve/Dp0MYlFIJ+UGhv4zj9aumaepDOGpTNVpp68j3YQjh1IchHt7fHVFyuYxg++F0vn6TJ0/aHhuN5dG8NlYox5XlylQdKescJefz5XpH1IJOS7MXsGW4ZZjVsKkxZ3pRYM4jPE3TD9ztzjUATyWkFSwLzFl0xnBdweLgSuW8vwPPsbXFV4k7jjsWZ87gXwHLUj8eSIDrf4WpM7CuzbPALTd7gRnTiwOsYhBXdH9sphbi01WFOTM5w7nwstCLQ+xMv3cWGtLK7PiNr3FdY1rhJoY3O3Ef/oy9Zbi5Lc8YrMq481lAVpsX+RfcIGQ17jmkZcwfv6qCtNIPb/bt6Dx9AFzAp7PaF+fLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2021 07 18 14 26 08\"\n        title=\"2021 07 18 14 26 08\"\n        src=\"/static/766fff3e9096e10adfe8fb7d7c67d123/5a190/2021-07-18-14-26-08.png\"\n        srcset=\"/static/766fff3e9096e10adfe8fb7d7c67d123/772e8/2021-07-18-14-26-08.png 200w,\n/static/766fff3e9096e10adfe8fb7d7c67d123/e17e5/2021-07-18-14-26-08.png 400w,\n/static/766fff3e9096e10adfe8fb7d7c67d123/5a190/2021-07-18-14-26-08.png 800w,\n/static/766fff3e9096e10adfe8fb7d7c67d123/d7abb/2021-07-18-14-26-08.png 959w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>gatsby 提供的 graphiql 界面增加了 <a href=\"https://github.com/OneGraph/graphiql-explorer\">graphql-explorer</a> 用起来似乎更方便了一些。看着所提供的 graphql schema 如果具备基本的 graphql 知识，就应该明白如何从这个数据中间层获取想要的 markdown 数据了。</p>\n<h2 id=\"生成路由\" style=\"position:relative;\">生成路由<a href=\"#%E7%94%9F%E6%88%90%E8%B7%AF%E7%94%B1\" aria-label=\"生成路由 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"固定路由\" style=\"position:relative;\">固定路由<a href=\"#%E5%9B%BA%E5%AE%9A%E8%B7%AF%E7%94%B1\" aria-label=\"固定路由 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>有了数据源之后，下一步就是构建博客的基本的路由结构了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/ -- 首页，展示最新的 N 篇博客\n/about -- 关于，一个独立的页面\n/page/{page-number} -- 做分页，每页固定数量的博客，当然提供翻页功能\n/{slug} -- 每篇博客的语义 url 用来展示每篇独立的博客\n/archive -- 所有博客的总览页面，罗列了所有的博客标题</code></pre></div>\n<p>上文提了，gatsby 为了简化路由，为 <code class=\"language-text\">/src/pages</code> 每个文件和带文件夹的层级的文件都提供对应的目录。比如 <code class=\"language-text\">src/pages/about.js</code> 的内容就对应了 <code class=\"language-text\">/about</code> 路由。也就是说对于固定路由来说，直接给个对应文件并且按照 gatsby 的规约，用 graphql 获取数据做渲染就好了。这里我展示下 <code class=\"language-text\">/archive</code> 的代码做个说明：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Archive</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> groupByYearResult <span class=\"token operator\">=</span> <span class=\"token function\">groupByYear</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>allMarkdownRemark<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Base<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>h1 className<span class=\"token operator\">=</span><span class=\"token string\">\"text-4xl font-extrabold tracking-tight my-4 text-gray-800\"</span><span class=\"token operator\">></span>Archive<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">{</span>groupByYearResult<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> key<span class=\"token punctuation\">,</span> value <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>h2 className<span class=\"token operator\">=</span><span class=\"token string\">\"text-3xl font-bold tracking-tight my-4 text-gray-800\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h2<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>YearItems blogs<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Base<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">YearItems</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> blogs <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>省略了<span class=\"token operator\">...</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> query <span class=\"token operator\">=</span> graphql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  query QueryBlogTitles {\n    allMarkdownRemark(sort: { fields: frontmatter___date, order: DESC }) {\n      nodes {\n        id\n        frontmatter {\n          title\n          date(formatString: \"MMMM-DD\")\n          year: date(formatString: \"YYYY\")\n        }\n        fields {\n          slug_without_date\n        }\n      }\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">groupByYear</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 省略了...</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>文件会分两个部分一部分是 react 的渲染，一部分是 graphql 数据的获取，非常简单明了。这里就不再赘述了。</p>\n<h3 id=\"从文件生成-slug-并使用-react-模板生成-blog-页面\" style=\"position:relative;\">从文件生成 slug 并使用 react 模板生成 blog 页面<a href=\"#%E4%BB%8E%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90-slug-%E5%B9%B6%E4%BD%BF%E7%94%A8-react-%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90-blog-%E9%A1%B5%E9%9D%A2\" aria-label=\"从文件生成 slug 并使用 react 模板生成 blog 页面 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>相对于固定路由，动态路由不是指 <a href=\"/blog-migrate-from-jekyll-to-gatsby\">/blog-migrate-from-jekyll-to-gatsby</a> 就是在用户请求的时候用 server 端临时拼装页面，而是说我可以在 gatsby 部署的时候动态的生成一系列的静态页面。这也是我觉得 gatsby 并不是 dynamic 的重要原因。</p>\n<p>上文提到了，既然我可以从 graphql 里面罗列一系列的 markdown 内容了，那我自然可以通过遍历的方式去生成一个个页面并对应上相应的路由。具体在 gatsby 做的时候需要这么做：</p>\n<h4 id=\"1-准备单个-blog-的模板页面\" style=\"position:relative;\">1. 准备单个 blog 的模板页面<a href=\"#1-%E5%87%86%E5%A4%87%E5%8D%95%E4%B8%AA-blog-%E7%9A%84%E6%A8%A1%E6%9D%BF%E9%A1%B5%E9%9D%A2\" aria-label=\"1 准备单个 blog 的模板页面 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">BlogTemplate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Base<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Blog data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">.</span>blog<span class=\"token punctuation\">}</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Base<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> pageQuery <span class=\"token operator\">=</span> graphql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  query BlogPostQuery($id: String) {\n    blog: markdownRemark(id: { eq: $id }) {\n      id\n      html\n      tableOfContents\n      frontmatter {\n        title\n        date(formatString: \"MMMM DD, YYYY\")\n      }\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>这是 <code class=\"language-text\">src/templates/blog.js</code> 文件的内容，可以看到，这里在 <code class=\"language-text\">pageQuery</code>  里引入了参数 <code class=\"language-text\">$id</code> 马上我们就介绍怎么用这个东西。</p>\n<h4 id=\"2-在-gatsby-nodejs-中创建页面\" style=\"position:relative;\">2. 在 gatsby-node.js 中创建页面<a href=\"#2-%E5%9C%A8-gatsby-nodejs-%E4%B8%AD%E5%88%9B%E5%BB%BA%E9%A1%B5%E9%9D%A2\" aria-label=\"2 在 gatsby nodejs 中创建页面 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<p>gatsby 在 build 的时候会执行 gatsby-node.js 文件，在这里可以调用 gatsby 的内部 api 做一系列小动作，以实现动态创建页面的目的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createFilePath <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gatsby-source-filesystem\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 1. 为 markdown 增加额外的字段 slug 和 slug_without_date</span>\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreateNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> actions<span class=\"token punctuation\">,</span> getNode <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createNodeField <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> actions\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">MarkdownRemark</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> filename <span class=\"token operator\">=</span> <span class=\"token function\">createFilePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> getNode <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// get the date and title from the file name</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> date<span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> filename<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>\n      <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^\\/([\\d]{4}-[\\d]{2}-[\\d]{2})-{1}(.+)\\/$</span><span class=\"token regex-delimiter\">/</span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// create a new slug concatenating everything</span>\n    <span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">slug</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>date<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\-</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">slug_without_date</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 2. 获取所有的 markdown 数据</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">createPages</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> graphql<span class=\"token punctuation\">,</span> actions<span class=\"token punctuation\">,</span> reporter <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Destructure the createPage function from the actions object</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createPage <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> actions\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">graphql</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    {\n      allMarkdownRemark {\n        nodes {\n          id\n          fields {\n            slug\n            slug_without_date\n          }\n        }\n        pageInfo {\n          totalCount\n        }\n      }\n    }\n  </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>errors<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    reporter<span class=\"token punctuation\">.</span><span class=\"token function\">panicOnBuild</span><span class=\"token punctuation\">(</span><span class=\"token string\">'🚨  ERROR: Loading \"createPages\" query'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">const</span> posts <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>allMarkdownRemark<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 3. 调用 api createPage 创建</span>\n  posts<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">createPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>slug<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 这里是路由</span>\n      component<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./src/templates/blog.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 这里是模板的位置</span>\n      context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 这里是传递给模板的参数</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">createPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>slug_without_date<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 生成另外一个路由</span>\n      component<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./src/templates/blog.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>首先，这里通过 <code class=\"language-text\">onCreateNode</code> 的 hook 通过文件名解析出来了 slug 比如文件名是 <code class=\"language-text\">2021-07-17-blog-migrate-from-jekylly-to-gatsby.md</code> 那么就会解析出两个 slug：</p>\n<ul>\n<li>/2021/07/17/blog-migrate-from-jekylly-to-gatsby</li>\n<li>/blog-migrate-from-jekylly-to-gatsby</li>\n</ul>\n<p>然后通过 <code class=\"language-text\">createNodeField</code> 把 slug 就再次塞回了 <code class=\"language-text\">MarkdownRemark</code> 类型的 <code class=\"language-text\">fields</code> 属性里。后面就可以通过 <code class=\"language-text\">fields.slug</code> 使用了。</p>\n<p>之所有有 /2021/07/17/xxx 这样子的路由是因为之前 jekyll 就是这样子的路由，算是做一个兼容吧。</p>\n<p>到目前为止，blog 的主要功能算是建立好了。</p>\n<h2 id=\"处理-blog-中的代码高亮\" style=\"position:relative;\">处理 blog 中的代码高亮<a href=\"#%E5%A4%84%E7%90%86-blog-%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E9%AB%98%E4%BA%AE\" aria-label=\"处理 blog 中的代码高亮 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>remark 这个插件自己还有额外的插件，通过增加额外的 <a href=\"https://www.gatsbyjs.com/plugins/gatsby-remark-prismjs/\">prismjs</a> 的支持就可以实现代码的高亮了。</p>\n<p>简单罗列下配置：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n      resolve<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">gatsby-transformer-remark</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Plugins configs</span>\n        plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            resolve<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">gatsby-remark-prismjs</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              aliases<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 这里仅仅是多了两个语言的 alias</span>\n                sh<span class=\"token operator\">:</span> <span class=\"token string\">\"bash\"</span><span class=\"token punctuation\">,</span>\n                gql<span class=\"token operator\">:</span> <span class=\"token string\">\"graphql\"</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>然后记得按照文档把 css 文件添加进来。</p>\n<h2 id=\"优化-blog-中的-image\" style=\"position:relative;\">优化 blog 中的 image<a href=\"#%E4%BC%98%E5%8C%96-blog-%E4%B8%AD%E7%9A%84-image\" aria-label=\"优化 blog 中的 image permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这部分算是 gatsby 相对于 jekyll 的另一个亮点吧，通过对 img 的 srcset 的支持，可以实现在不同宽度的页面上去加载不同宽度的图片。并且，这些不同宽度的图片全部由插件自动生成，基本上是开箱即用了。更多的信息去 <a href=\"https://www.gatsbyjs.com/plugins/gatsby-remark-images/?=image#gatsby-remark-images\">gatsby remark images</a> 一看就晓得了。</p>\n<h2 id=\"在-github-pages-部署\" style=\"position:relative;\">在 github pages 部署<a href=\"#%E5%9C%A8-github-pages-%E9%83%A8%E7%BD%B2\" aria-label=\"在 github pages 部署 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>这部分 gatsby 已经给准备好了，跟着 <a href=\"https://www.gatsbyjs.com/docs/how-to/previews-deploys-hosting/how-gatsby-works-with-github-pages/\">How Gatsby Works with GitHub Pages</a> 基本就能解决。唯一的不同在于我通过一个 github action 实现了自动部署（而不是每次都自己 yarn run deploy）：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build<span class=\"token punctuation\">-</span>and<span class=\"token punctuation\">-</span>deploy\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'**'</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Git Repo Sync\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v2\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'14'</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> install deps\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> yarn install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> yarn run build\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> peaceiris/actions<span class=\"token punctuation\">-</span>gh<span class=\"token punctuation\">-</span>pages@v3\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">github_token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">publish_branch</span><span class=\"token punctuation\">:</span> main\n        <span class=\"token key atrule\">publish_dir</span><span class=\"token punctuation\">:</span> ./public</code></pre></div>\n<p>这里我的主分支是 master 然后采用 main 作为了发布分支，直接使用 action  <code class=\"language-text\">actions-gh-pages</code> 把 public 目录提交到 main 就可以了。</p>\n<h2 id=\"小结\" style=\"position:relative;\">小结<a href=\"#%E5%B0%8F%E7%BB%93\" aria-label=\"小结 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>gatsby 并不像 jekyll 那么开箱即用，但其功能相对来说确实强大不少。灵活性和扩展性确实不是一个数量级了。当然，这前提是你对前端的技术栈足够了解，不然可能就只能在 <a href=\"https://www.gatsbyjs.com/docs/starters/\">gatsby starters</a> 找找有没有合适的东西了。</p>\n<p>后面还有一些工作要做的：</p>\n<ol>\n<li>样式...现在是 plain html 默认样式，只有代码块是花花绿绿的</li>\n<li>优化，标题，meta 应该还是需要花点点时间的</li>\n<li>首页，在路由的部分提及了，这部分在 jekyll 的时候是个分页，现在想要做类似的实现，应该不难</li>\n<li>tags 的展示和按照 tags 罗列文章，这也是之前 jekyll 的功能，也希望做成类似的样子</li>\n</ol>\n<h2 id=\"相关资源\" style=\"position:relative;\">相关资源<a href=\"#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90\" aria-label=\"相关资源 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>把几个用到但是没有提及的链接放到了这里。</p>\n<ul>\n<li><a href=\"https://deborah-digges.github.io/2020/09/16/Jekyll-to-Gatsby/\">From Jekyll to Gatsby: 7 Simple Steps</a></li>\n<li><a href=\"https://www.gatsbyjs.com/docs/how-to/routing/adding-markdown-pages/\">Adding Markdown Pages</a></li>\n<li><a href=\"https://www.gatsbyjs.com/docs/reference/routing/creating-routes/#using-gatsby-nodejs\">Create routing</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#gatsby-%E7%9A%84%E6%80%9D%E8%B7%AF\">Gatsby 的思路</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B\">快速开始</a></p>\n</li>\n<li>\n<p><a href=\"#markdown-%E6%96%87%E4%BB%B6%E7%9A%84%E6%95%B4%E4%BD%93%E8%BF%81%E7%A7%BB\">markdown 文件的整体迁移</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%94%9F%E6%88%90%E8%B7%AF%E7%94%B1\">生成路由</a></p>\n<ul>\n<li>\n<p><a href=\"#%E5%9B%BA%E5%AE%9A%E8%B7%AF%E7%94%B1\">固定路由</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BB%8E%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90-slug-%E5%B9%B6%E4%BD%BF%E7%94%A8-react-%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90-blog-%E9%A1%B5%E9%9D%A2\">从文件生成 slug 并使用 react 模板生成 blog 页面</a></p>\n<ul>\n<li><a href=\"#1-%E5%87%86%E5%A4%87%E5%8D%95%E4%B8%AA-blog-%E7%9A%84%E6%A8%A1%E6%9D%BF%E9%A1%B5%E9%9D%A2\">1. 准备单个 blog 的模板页面</a></li>\n<li><a href=\"#2-%E5%9C%A8-gatsby-nodejs-%E4%B8%AD%E5%88%9B%E5%BB%BA%E9%A1%B5%E9%9D%A2\">2. 在 gatsby-node.js 中创建页面</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%A4%84%E7%90%86-blog-%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E9%AB%98%E4%BA%AE\">处理 blog 中的代码高亮</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BC%98%E5%8C%96-blog-%E4%B8%AD%E7%9A%84-image\">优化 blog 中的 image</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%9C%A8-github-pages-%E9%83%A8%E7%BD%B2\">在 github pages 部署</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%B0%8F%E7%BB%93\">小结</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90\">相关资源</a></p>\n</li>\n</ul>","frontmatter":{"title":"把博客从 jekyll 迁移到 gatsby","date":"July 17, 2021"}}},"pageContext":{"id":"ca5034b7-1b2a-53bf-a94c-89290d8fc673"}},"staticQueryHashes":[]}
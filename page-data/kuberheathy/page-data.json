{"componentChunkName":"component---src-templates-blog-js","path":"/kuberheathy","result":{"data":{"blog":{"id":"f1a20a6c-4a28-5951-8104-fe4c1d377f1c","html":"<p>几年前 k8s 就是 openbayes 部署的基础平台了，它算是一个相当不错的 PaaS 了。这里介绍一个最近发现的做 healthcheck 的 operator（我不知道这东西用中文怎么说）。</p>\n<h2 id=\"需求\" style=\"position:relative;\">需求<a href=\"#%E9%9C%80%E6%B1%82\" aria-label=\"需求 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>当我们的子系统越来越多的时候，我们希望每个系统有一些监控用于检测其核心的功能是否跑起来了，并希望知晓每个服务的宕机事件。<a href=\"https://uptimerobot.com/\">uptimerobot</a> 就是在做类似的事情。我们可以给它一个 http 访问地址，当访问成功的之后就标记为「健康」，当访问失败的时候就标记为「不健康」。这个检测在指定的周期执行，日积月累就能知道一个服务的稳定情况了。</p>\n<p>不过以上所述的健康检查就像是一个 <code>curl https://targeturl</code> 似乎在假设所有的子系统都需要有一个可以方便访问的 http path。不过有些时候，我们会需要一些稍微复杂的健康检查：</p>\n<ul>\n<li>希望知道一些非 http 请求访问的服务是否健康</li>\n<li>希望知道一些以灵活的请求内容访问的服务是否健康</li>\n<li>希望有一些端到端的健康检查，以联通多个系统</li>\n</ul>\n<p>这里就推荐一下 <a href=\"https://comcast.github.io/kuberhealthy/\">kuberhealthy</a> 这个项目。首先它是一个 kubernetes 的 operator 那么只有你在使用 k8s 的时候这个东西才算是有意义的。它有两个我很看中的地方：</p>\n<ol>\n<li>kuberhealthy 提供了一个健康检查的框架，用于让你构建任意形式的健康检查，并且这个框架我觉得很清晰，构建起来也很容易，理解起来一点都不晦涩</li>\n<li>它已经包含了不少预置健康检查了，尤其是与 k8s 集成的健康检查，算是做到了一定程度的开箱即用</li>\n</ol>\n<h2 id=\"几个不错的预置健康检查\" style=\"position:relative;\">几个不错的预置健康检查<a href=\"#%E5%87%A0%E4%B8%AA%E4%B8%8D%E9%94%99%E7%9A%84%E9%A2%84%E7%BD%AE%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5\" aria-label=\"几个不错的预置健康检查 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li><a href=\"https://comcast.github.io/kuberhealthy/cmd/pod-restarts-check/\">pod-restarts-check</a> 用于检查是否存在 pod 在不断的重启，可以快速的发现是不是有服务出现了些导致其不断重启的行为。</li>\n<li><a href=\"https://comcast.github.io/kuberhealthy/cmd/pod-status-check/\">pod-status-check</a> 用于检查是否存在 pod 一直处于失败的状态。</li>\n<li><a href=\"https://github.com/ChrisHirsch/kuberhealthy-storage-check\">storage-check</a> 用于判断是否可以使用某一个 storageclass 成功创建 pvc。每个集群的分布式存储的健康基本就是各种服务不出问题的基石，即使发现存储出现问题太重要了。</li>\n</ol>\n<p>更多的可以在<a href=\"https://comcast.github.io/kuberhealthy/docs/EXTERNAL_CHECKS_REGISTRY.html\">这里</a>找到。</p>\n<h2 id=\"自定义-healthcheck\" style=\"position:relative;\">自定义 healthcheck<a href=\"#%E8%87%AA%E5%AE%9A%E4%B9%89-healthcheck\" aria-label=\"自定义 healthcheck permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>在 <a href=\"https://github.com/Comcast/kuberhealthy/blob/master/docs/EXTERNAL_CHECK_CREATION.md\">文档</a> 里做了介绍，简单的说就是这样一个东西：</p>\n<ul>\n<li>做一件事情去检查你想要测试的东西是否「健康」，总之这个行为可以很灵活，你想怎么测试就怎么测试</li>\n<li>如果健康就把 <code>{\"OK\": true}</code> 以 POST 发送到 <code>http://$KH_REPORTING_URL</code></li>\n<li>如果不健康就发以下的内容，其中 <code>Errors</code> 自然就是具体的出错原因了。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  \"Errors\": [\n    \"Error 1 here\",\n    \"Error 2 here\"\n  ],\n  \"OK\": false\n}</code></pre></div>\n<p>这里我写了一个用来测试 openbayes 的服务是否可用的端到端的健康检查，它主要做如下的事情：</p>\n<ol>\n<li>用 openbayes 的命令行工具登录到预置的账号</li>\n<li>创建一个脚步任务提交到 openbayes</li>\n<li>如果任务提交成功则是「健康」的</li>\n<li>否则系统就是「不健康」的</li>\n</ol>\n<p>具体的 crd 定义如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> comcast.github.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> KuberhealthyCheck\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> openbayes<span class=\"token punctuation\">-</span>gear<span class=\"token punctuation\">-</span>check\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">runInterval</span><span class=\"token punctuation\">:</span> 6h <span class=\"token comment\"># 指定多久时间跑一次</span>\n  <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 5m <span class=\"token comment\"># 指定执行的最长时间</span>\n  <span class=\"token key atrule\">podSpec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 自定义的环境变量</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> OPENBAYES_TOKEN\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> &lt;THE TOKEN<span class=\"token punctuation\">></span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ENTRYPOINT\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> &lt;THE ENTRYPOINT<span class=\"token punctuation\">></span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> RUNTIME\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> pytorch<span class=\"token punctuation\">-</span>1.7.0\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> RESOURCE\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> titan_rtx\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> xxxx <span class=\"token comment\"># 镜像</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main</code></pre></div>\n<p>容器的 Dockerfile 如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM ubuntu\n\nRUN apt update\nRUN apt install wget curl git -y\nRUN wget https://gitee.com/openbayes/bayes-releases/attach_files/606636/download/bayes_amd64.deb\nRUN dpkg -i bayes_amd64.deb\nWORKDIR /empty\nCOPY run.sh .\nCMD [\"/bin/bash\", \"run.sh\"]</code></pre></div>\n<p>只做了两件事：</p>\n<ol>\n<li>下载 bayes 命令行工具</li>\n<li>执行 <code>run.sh</code> 脚本</li>\n</ol>\n<p>其中 <code>run.sh</code> 如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">set</span> -e <span class=\"token comment\"># 任意一行错了就不再继续执行了</span>\n\nbayes upgrade <span class=\"token comment\"># 更新命令行工具到最新</span>\nbayes switch <span class=\"token builtin class-name\">test</span> -e <span class=\"token variable\">$ENTRYPOINT</span> <span class=\"token comment\"># 切换 bayes 命令行的上下文</span>\nbayes login <span class=\"token variable\">$OPENBAYES_TOKEN</span> <span class=\"token comment\"># 登录</span>\nbayes gear init healthcheck -m <span class=\"token string\">'自动测试项目'</span> <span class=\"token comment\"># 创建项目</span>\nbayes gear run task --env <span class=\"token variable\">$RUNTIME</span> --resource <span class=\"token variable\">$RESOURCE</span> -f -- <span class=\"token builtin class-name\">echo</span> <span class=\"token number\">123</span> <span class=\"token comment\"># 提交 Python 脚本</span>\n<span class=\"token function\">curl</span> --location --request POST <span class=\"token variable\">$KH_REPORTING_URL</span> <span class=\"token punctuation\">\\</span>\n--header <span class=\"token string\">'Content-Type: application/json'</span> <span class=\"token punctuation\">\\</span>\n--data-raw <span class=\"token string\">'{ \"OK\": true }'</span> <span class=\"token comment\"># 提交成功就告知 kuberhealthy 这次检查是成功的</span></code></pre></div>\n<p>下面是执行的样子，可以看到这个任务就像是 crd 设置的那个样子，每 6 个小时跑一次。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/110b3181022997cbc48206f77e7dafba/681f1/2021-03-01-14-07-25.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.999999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY0z2OQW7DMAwE8/9H9tACaZzYluzIlCiJnMJy0D0NlsAsb3zSe8d6G2xm/9xqA/dxz7lcXWuo1tFpUVrroztz0/iipUhW45WMIE6uF6cCW3kz5w0phWUJ7HtCJBPjPgbWdaOrYr3j7tx0fVDjk1yd392ZkyPVeezOliHqmymHIZznMEQihRA2Sj5HIlYVN7uEcv9Cnz8c6nyHSzQ4OkFgyZG7LBwiTNM8BCkdQ35+Oj0XTAtu54fwB6PVNriy5jptAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"openbayes healthcheck 的执行记录\"\n        title=\"openbayes healthcheck 的执行记录\"\n        src=\"/static/110b3181022997cbc48206f77e7dafba/5a190/2021-03-01-14-07-25.png\"\n        srcset=\"/static/110b3181022997cbc48206f77e7dafba/772e8/2021-03-01-14-07-25.png 200w,\n/static/110b3181022997cbc48206f77e7dafba/e17e5/2021-03-01-14-07-25.png 400w,\n/static/110b3181022997cbc48206f77e7dafba/5a190/2021-03-01-14-07-25.png 800w,\n/static/110b3181022997cbc48206f77e7dafba/681f1/2021-03-01-14-07-25.png 899w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">openbayes healthcheck 的执行记录</figcaption>\n  </figure></p>\n<h2 id=\"与-prometheus--grafana-集成\" style=\"position:relative;\">与 prometheus / grafana 集成<a href=\"#%E4%B8%8E-prometheus--grafana-%E9%9B%86%E6%88%90\" aria-label=\"与 prometheus  grafana 集成 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>首先 kuberhealthy 自己有一个汇总页面，可以通过 <code>kubectl port-forward svc/kuberhealthy 8888:80</code> 类似的方式去访问：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"CheckDetails\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"kuberhealthy/dns-status-internal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"RunDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.359431829s\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Namespace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"LastRun\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-03-01T06:08:09.35793049Z\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AuthoritativePod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1d309ed7-4b7a-4fd5-9706-d04f53c9ed30\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"kuberhealthy/namespace-pod-check\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"RunDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"13.589526741s\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Namespace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"LastRun\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-03-01T05:50:19.584075218Z\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AuthoritativePod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"49f7bef3-f5d4-4e25-bf06-acd260d52e27\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"kuberhealthy/openbayes-gear-check\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"RunDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1m8.486351014s\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Namespace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"LastRun\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-03-01T00:51:14.477191396Z\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AuthoritativePod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"c13aea0d-52ca-4777-a6e0-551d0c59962a\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"kuberhealthy/openbayes-random-image-serving-check\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"RunDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9.008124976s\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Namespace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"LastRun\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-03-01T06:08:15.000563842Z\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AuthoritativePod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eb1341d3-9bbf-44ab-9348-76715464df6b\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"kuberhealthy/pod-restarts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"RunDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2.903617967s\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Namespace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"LastRun\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-03-01T06:05:09.40445213Z\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AuthoritativePod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4cf2c122-95ac-4902-8ecf-ee484a54c475\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"kuberhealthy/pod-status\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"OK\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Errors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"RunDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2.845955825s\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Namespace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"LastRun\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-03-01T06:05:08.84049994Z\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AuthoritativePod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"77af9108-720b-4ad4-b8cc-2fe81e751d8d\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"JobDetails\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"CurrentMaster\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kuberhealthy-84bf9fd647-2x72f\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>但是谁也没空去看这么个 json 的，还是需要和 prometheus 这样的东西集成才行：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    scrape_configs:\n      ...\n      - job_name: kuberhealthy\n        scrape_interval: 1m\n        honor_labels: true\n        metrics_path: /metrics\n        static_configs:\n          - targets:\n            - kuberhealthy.kuberhealthy\n</code></pre></div>\n<p>然后就可以在 grafana 那边去设置具体的展示了，这里我有一个比较简单的：</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0a78967408a2ebd5ab5262c5b295bd72/c45c7/2021-03-01-14-13-46.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACNElEQVQoz0WPS08TARSFZ4W8als603l1OjPtdKaPKVPaaWsJ1VRhATECViQajYAGSRDREB8scCEbQ4xLE40bVrpzocZEE//aZ2YkcXFycu8999xzBUMzkTIKifEUEyMJJkYTjI1MMDmWZHL0PONR71yC8XOTsSbqi6ksUlohnRSRMiqqbCCmZTJJGUFfqFJb61FYDcgu2iiXHIwFn8K1BvZKgHrVQR4U0AdVvGGHys0u5qqPOG+i9j1KyyHuMMRda5FdshFufNrh6McJr/+8o/9+Cf1RwOHXE+6c7vH82zF7Pw/JH0yz8eGA7c8v2P7yjJe/jmm8ucjc0QpH39+y+nGLV79PWDpdR3DutQl3B3SfXiHY76EPy5TudnA3Q/ydHvUnFzDWy9hrM7ibbbwHIY39WcoPm5jDgMpWD/d+C3+3R+1xF0HMqqREibSUxXJcavUZim4FPW8hyirJKRExqyEbNllFQ9JNdLuE41UoOGWyao7IQ9LyyI4fGWrxQkZUyeVtGs02zbBDq93Fq9RQdQNZzVGuNXDcKlbRww9alKvTyEouhqIZiJKKYRYR5i/3mR/M0Z/tYBUcwk6P7uwc041mXJsFB1nV8ap1HK+KaTuxYYSK38AquOh5m4ykxIGEjdsrbNxaZv36Iop2Fl/RYo5EESRZo+IHlMo1rKJLvRFSC5rxkWg2Jcqx3rCKCJpuoOcMIk5PSSTTGZJpkVSEqf+s5cz49cggSqIb1pn+3zzai0z/As6tFJrmBIMIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grafana 的示例\"\n        title=\"grafana 的示例\"\n        src=\"/static/0a78967408a2ebd5ab5262c5b295bd72/5a190/2021-03-01-14-13-46.png\"\n        srcset=\"/static/0a78967408a2ebd5ab5262c5b295bd72/772e8/2021-03-01-14-13-46.png 200w,\n/static/0a78967408a2ebd5ab5262c5b295bd72/e17e5/2021-03-01-14-13-46.png 400w,\n/static/0a78967408a2ebd5ab5262c5b295bd72/5a190/2021-03-01-14-13-46.png 800w,\n/static/0a78967408a2ebd5ab5262c5b295bd72/c1b63/2021-03-01-14-13-46.png 1200w,\n/static/0a78967408a2ebd5ab5262c5b295bd72/c45c7/2021-03-01-14-13-46.png 1346w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">grafana 的示例</figcaption>\n  </figure></p>\n<p>具体的集成文档见<a href=\"https://github.com/Comcast/kuberhealthy/blob/master/docs/K8s-KPIs-with-Kuberhealthy.md\">K8s-KPIs-with-Kuberhealthy.md</a>。</p>\n<h2 id=\"遇到的坑\" style=\"position:relative;\">遇到的坑<a href=\"#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91\" aria-label=\"遇到的坑 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ol>\n<li>kuberhealthy 的 service account 需要好好制定，对于跨 namespace 的东西，需要给 <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#clusterrole-example\">clusterRole</a> 才可以</li>\n<li>kuberhealthy 在每次有新的 KuberhealthyCheck 创建的时候似乎都会刷新它自己的周期计时，导致一些数个小时才需要跑一次的检查会立即跑一次，这个行为对于某些场景可能无法接受</li>\n</ol>","tableOfContents":"<ul>\n<li><a href=\"#%E9%9C%80%E6%B1%82\">需求</a></li>\n<li><a href=\"#%E5%87%A0%E4%B8%AA%E4%B8%8D%E9%94%99%E7%9A%84%E9%A2%84%E7%BD%AE%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5\">几个不错的预置健康检查</a></li>\n<li><a href=\"#%E8%87%AA%E5%AE%9A%E4%B9%89-healthcheck\">自定义 healthcheck</a></li>\n<li><a href=\"#%E4%B8%8E-prometheus--grafana-%E9%9B%86%E6%88%90\">与 prometheus / grafana 集成</a></li>\n<li><a href=\"#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91\">遇到的坑</a></li>\n</ul>","frontmatter":{"title":"Kuberhealthy 一个还不错的健康检查 operator","date":"March 01, 2021"}}},"pageContext":{"id":"f1a20a6c-4a28-5951-8104-fe4c1d377f1c"}},"staticQueryHashes":[]}
{"componentChunkName":"component---src-templates-blog-js","path":"/2013/08/24/self-join-graph-relatiion-in-rails/","result":{"data":{"blog":{"id":"a42cbe7e-e5d4-5d1f-9c0b-9262d9f5d3f0","html":"<p>最近有一个诡异的需求，需要做一个多对多的图关系。情况是这样的，有一堆本来是扁平关系的标签，现在需要给他们组织出来层级关系了。那么一个 tag 就会有很多的 父节点 以及 子节点。那么，简单来看，其实就是一个自身元素的多对多关系了。</p>\n<p>通常的，针对两个 model 的多对多关系是这样的。<a href=\"https://guides.rubyonrails.org/association_basics.html#the-has-and-belongs-to-many-association\">link here</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Physician</span> <span class=\"token operator\">&lt;</span> ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base\n  has_many <span class=\"token symbol\">:appointments</span>\n  has_many <span class=\"token symbol\">:patients</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">through</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:appointments</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Appointment</span> <span class=\"token operator\">&lt;</span> ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base\n  belongs_to <span class=\"token symbol\">:physician</span>\n  belongs_to <span class=\"token symbol\">:patient</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Patient</span> <span class=\"token operator\">&lt;</span> ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base\n  has_many <span class=\"token symbol\">:appointments</span>\n  has_many <span class=\"token symbol\">:physicians</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">through</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:appointments</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>而对于通常的，对于自身做树级关系的 model 如下: <a href=\"https://guides.rubyonrails.org/association_basics.html#self-joins\">link here</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Employee</span> <span class=\"token operator\">&lt;</span> ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base\n  has_many <span class=\"token symbol\">:subordinates</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Employee\"</span></span><span class=\"token punctuation\">,</span>\n                          <span class=\"token symbol\">foreign_key</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"manager_id\"</span></span>\n\n  belongs_to <span class=\"token symbol\">:manager</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Employee\"</span></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>那么，我现在所需要的差不多就是把这两个结合一下。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Word</span> <span class=\"token operator\">&lt;</span> ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base\n\n  has_many <span class=\"token symbol\">:parent_relations</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:WordRelation</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">foreign_key</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:child_id</span>\n  has_many <span class=\"token symbol\">:child_relations</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:WordRelation</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">foreign_key</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:parent_id</span>\n\n  has_many <span class=\"token symbol\">:parents</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">through</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:parent_relations</span>\n  has_many <span class=\"token symbol\">:children</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">through</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:child_relations</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">WordRelation</span> <span class=\"token operator\">&lt;</span> ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base\n  attr_accessible <span class=\"token symbol\">:child_id</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:parent_id</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:parent</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:child</span>\n\n  belongs_to <span class=\"token symbol\">:parent</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:Word</span>\n  belongs_to <span class=\"token symbol\">:child</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:Word</span>\n<span class=\"token keyword\">end</span>\n</code></pre></div>\n<p>两个 model <code>word</code> 以及 <code>word_relation</code>。对于这种 self join 的关系，通常是不能按照默认的外键的。那么就像第二个例子一样。我们需要自己指定 <code>foreign_key</code>。这里有个比较特别的地方。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">has_many <span class=\"token symbol\">:parent_relations</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">class_name</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:WordRelation</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">foreign_key</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:child_id</span></code></pre></div>\n<p><code>parent_relations</code> 需要的外键居然是 <code>child_id</code> 感觉有点奇怪吧。不过理清 activerecord 帮你生成的 sql 是什么样子就明白了。为了找其父亲节点，那么 sql 语句大概如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> word_relations <span class=\"token keyword\">where</span> <span class=\"token punctuation\">[</span>one <span class=\"token keyword\">column</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'[this word id]'</span></code></pre></div>\n<p>要找父亲节点，那么 where 中就是找 <em>哪个节点的子节点是这个 word</em>。所以就应当是反着的才对的。</p>\n<hr>\n<p>做了上述的工作之后，一个图状的 word 关系就可以搞定了。</p>","tableOfContents":"","frontmatter":{"title":"Self join graph relation in rails","date":"August 24, 2013","tags":["rails"]},"excerpt":"最近有一个诡异的需求，需要做一个多对多的图关系。情况是这样的，有一堆本来是扁平关系的标签，现在需要…"}},"pageContext":{"id":"a42cbe7e-e5d4-5d1f-9c0b-9262d9f5d3f0"}},"staticQueryHashes":["26522286"],"slicesMap":{}}
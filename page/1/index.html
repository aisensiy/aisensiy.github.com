<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.7665ee681b2a464cd92f.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! tailwindcss v2.2.4 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.main h1{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.875rem;font-weight:800;letter-spacing:-.025em;line-height:2.25rem;margin-bottom:1rem;margin-top:1rem}@media (min-width:768px){.main h1{font-size:2.25rem;line-height:2.5rem}}.main :not(pre)>code{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity));color:rgba(107,114,128,var(--tw-text-opacity));font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;margin-left:.25rem;margin-right:.25rem;padding-left:.25rem;padding-right:.25rem}.main{overflow-wrap:break-word}.blog-post-content h2{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.5rem;font-weight:800;letter-spacing:-.025em;line-height:2rem;margin-bottom:.75rem;margin-top:.75rem}@media (min-width:768px){.blog-post-content h2{font-size:1.875rem;line-height:2.25rem}}.blog-post-content h3{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.25rem;font-weight:800;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem}@media (min-width:768px){.blog-post-content h3{font-size:1.5rem;line-height:2rem}}.blog-post-content h4{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-weight:800;letter-spacing:-.025em;margin-bottom:.75rem;margin-top:.75rem}@media (min-width:768px){.blog-post-content h4{font-size:1.25rem;line-height:1.75rem}}.main ol,.main ul{margin-bottom:1rem;margin-left:1rem}.main ul{list-style-type:disc}.main ol{list-style-position:inside;list-style-type:decimal}.main a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.main a:hover{text-decoration:underline}.main img{--tw-border-opacity:1;--tw-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);border-color:rgba(229,231,235,var(--tw-border-opacity));border-radius:.75rem;border-width:1px;box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.main blockquote{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity));border-left-width:4px;padding-left:1.5rem}.main p,.table-of-content{margin-bottom:1rem}.table-of-content{--tw-border-opacity:1;--tw-bg-opacity:1;background-color:rgba(219,234,254,var(--tw-bg-opacity));border-color:rgba(107,114,128,var(--tw-border-opacity));border-width:1px;display:inline-block;margin-top:1rem;overflow:auto;padding:1rem}.table-of-content ul{margin-bottom:0}.table-of-content h2{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.25rem;font-weight:600;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem}.table-of-content p{display:inline;margin:0}.bottom-0{bottom:0}.m-0{margin:0}.mx-4{margin-left:1rem;margin-right:1rem}.mx-12{margin-left:3rem;margin-right:3rem}.my-3{margin-bottom:.75rem;margin-top:.75rem}.my-4{margin-bottom:1rem;margin-top:1rem}.mt-8{margin-top:2rem}.mb-4{margin-bottom:1rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.w-32{width:8rem}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.list-decimal{list-style-type:decimal}.flex-row{flex-direction:row}.justify-center{justify-content:center}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(.25rem*var(--tw-space-y-reverse));margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(2rem*var(--tw-space-y-reverse));margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)))}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-l-4{border-left-width:4px}.border-solid{border-style:solid}.border-gray-200{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity))}.border-gray-500{--tw-border-opacity:1;border-color:rgba(107,114,128,var(--tw-border-opacity))}.border-gray-800{--tw-border-opacity:1;border-color:rgba(31,41,55,var(--tw-border-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.bg-gray-900{--tw-bg-opacity:1;background-color:rgba(17,24,39,var(--tw-bg-opacity))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgba(219,234,254,var(--tw-bg-opacity))}.p-4{padding:1rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-bottom:.25rem;padding-top:.25rem}.py-12{padding-bottom:3rem;padding-top:3rem}.text-center{text-align:center}.font-serif{font-family:ui-serif,Georgia,Cambria,Times New Roman,Times,serif}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.font-semibold{font-weight:600}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-black{font-weight:900}.leading-7{line-height:1.75rem}.tracking-tight{letter-spacing:-.025em}.text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.text-blue-600{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.hover\:underline:hover{text-decoration:underline}*,:after,:before{--tw-shadow:0 0 #0000;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}@media (min-width:768px){.md\:fixed{position:fixed}.md\:absolute{position:absolute}.md\:ml-80{margin-left:20rem}.md\:h-full{height:100%}.md\:w-80{width:20rem}.md\:max-w-6xl{max-width:72rem}.md\:p-8{padding:2rem}.md\:text-left{text-align:left}.md\:text-xl{font-size:1.25rem;line-height:1.75rem}.md\:text-2xl{font-size:1.5rem;line-height:2rem}.md\:text-3xl{font-size:1.875rem;line-height:2.25rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}</style><meta name="generator" content="Gatsby 3.9.1"/><style type="text/css">
    .custom-class.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .custom-class.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .custom-class svg,
    h2 .custom-class svg,
    h3 .custom-class svg,
    h4 .custom-class svg,
    h5 .custom-class svg,
    h6 .custom-class svg {
      visibility: hidden;
    }
    h1:hover .custom-class svg,
    h2:hover .custom-class svg,
    h3:hover .custom-class svg,
    h4:hover .custom-class svg,
    h5:hover .custom-class svg,
    h6:hover .custom-class svg,
    h1 .custom-class:focus svg,
    h2 .custom-class:focus svg,
    h3 .custom-class:focus svg,
    h4 .custom-class:focus svg,
    h5 .custom-class:focus svg,
    h6 .custom-class:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><link as="script" rel="preload" href="/webpack-runtime-276957d512995944f9b0.js"/><link as="script" rel="preload" href="/framework-e728256d7a1d703d32c2.js"/><link as="script" rel="preload" href="/app-7172dabcafa34b87636a.js"/><link as="script" rel="preload" href="/component---src-templates-blogs-js-4995d0944825796984cb.js"/><link as="fetch" rel="preload" href="/page-data/page/1/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="md:text-left text-center md:fixed md:w-80 bg-gray-900 md:h-full text-white"><div class="md:absolute bottom-0 py-12 mx-12 space-y-8"><h1 class="text-6xl font-black font-serif">Eisen&#x27;s Blog</h1><nav><ul class="text-md flex-row"><li><a class="leading-7 block hover:underline" href="/">Home</a></li><li><a class="leading-7 block hover:underline" href="/about">About</a></li><li><a class="leading-7 block hover:underline" href="/archive">Archive</a></li><li><a href="https://github.com/aisensiy" target="_blank" rel="noreferrer" class="leading-7 block hover:underline">GitHub</a></li></ul></nav><footer class="text-gray-400">© <!-- -->2021<!-- -->. All rights reserved.</footer></div></div><div class="md:ml-80 p-4 md:p-8 md:max-w-6xl main"><div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/github-actions-integration-with-github">Github Actions 与 Github 自身 API 集成生成周报</a></h1><h2 class="text-gray-600 mb-4">2021 July-01</h2><div class="blog-post-content"><p>最近又用 Github Actions 玩出了花样。这里记录一下通过 Github Api 和 Github Actions 怎么去做组织内的 commits 统计。</p>
<h2 id="为啥要自己做统计" style="position:relative;">为啥要自己做统计<a href="#%E4%B8%BA%E5%95%A5%E8%A6%81%E8%87%AA%E5%B7%B1%E5%81%9A%E7%BB%9F%E8%AE%A1" aria-label="为啥要自己做统计 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>之前一直有一个想法，能不能通过 github 的 api 去将组织内的工作量做成报表以方便查看每个人工作的进度以及各个 issue 的进展。做了简单的调研，发现现有的东西都不太能满足具体的需求：</p>
<ol>
<li>我希望统计 org 下所有仓库的数据，而不是单个仓库（目前所在组织里有 100+ 个仓库）</li>
<li>目前 org 内以 issue 作为工作的一个最小单位，希望提交的 commit 都与 issue 做关联，那么势必需要统计每个周期内 issue 的进展以及关联的 commit 做统计，显然现有的 <a href="https://docs.github.com/en/github/visualizing-repository-data-with-graphs/accessing-basic-repository-data/viewing-a-summary-of-repository-activity">insights</a> 也是不太够的</li>
</ol>
<p>然后就去评估了下自己做统计的工作量。github 早已经发布了 GraphQL 的 API 并且通过 <a href="https://docs.github.com/en/graphql/overview/explorer">explorer</a> 去测试和使用其 API 的体验是相当好于是就心动了，决定自己做这个统计。</p>
<h2 id="先看看最终效果" style="position:relative;">先看看最终效果<a href="#%E5%85%88%E7%9C%8B%E7%9C%8B%E6%9C%80%E7%BB%88%E6%95%88%E6%9E%9C" aria-label="先看看最终效果 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>报表数据主要包括每个人的活跃数据以及每个人所涉及的 issue。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 669px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c3806d03a6c11981ad9fe6ac95454325/99272/2021-07-02-01-00-14.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 65.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABNElEQVQoz5WSu07EQAxF8/+fwCdQUFIgIdFQQMWjAaFlYTebZGY8Hs8rz3mgBJGW7JULy9LxvbJcaGPqshR11TTN4XBUivJmFdM4fkr/IVttndbaeR8WbYJzjLcsXlUZSSNKRQQAfd+nLXAM4bqKD2LkgAIJEbuuizFtdA6X3+FiF26OHcPZVhvb+jal//kixfBY+5dKAWeAUgAQmXGaNsXOOd/z6UmOVhMZY50bhmHrwZz3QiIqEgBam3yOZhhR0gIrovSnTfCrzXeYnxfLlPNKrTt+h3Ot/Qqbtj9wBNsu7xHPix1jUCiN1qiUAPDO+9Yb51AwqyzYoF0o5cBpJB+VC19sAN1574dxKlJKnPOaMcZ5eTpxARyAquZtJ/elfT91u3quPes5ekBNdhimOE0hxvQDyRL0FtUprv0AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 07 02 01 00 14"
        title="2021 07 02 01 00 14"
        src="/static/c3806d03a6c11981ad9fe6ac95454325/99272/2021-07-02-01-00-14.png"
        srcset="/static/c3806d03a6c11981ad9fe6ac95454325/772e8/2021-07-02-01-00-14.png 200w,
/static/c3806d03a6c11981ad9fe6ac95454325/e17e5/2021-07-02-01-00-14.png 400w,
/static/c3806d03a6c11981ad9fe6ac95454325/99272/2021-07-02-01-00-14.png 669w"
        sizes="(max-width: 669px) 100vw, 669px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="具体怎么做" style="position:relative;">具体怎么做<a href="#%E5%85%B7%E4%BD%93%E6%80%8E%E4%B9%88%E5%81%9A" aria-label="具体怎么做 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<h3 id="用到的-graphql-api" style="position:relative;">用到的 GraphQL API<a href="#%E7%94%A8%E5%88%B0%E7%9A%84-graphql-api" aria-label="用到的 graphql api permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>首先，我集成的是 Github 的 GraphQL API 主要用到了以下几个接口：</p>
<h4 id="1-获取组织内的-repositories" style="position:relative;">1. 获取组织内的 repositories<a href="#1-%E8%8E%B7%E5%8F%96%E7%BB%84%E7%BB%87%E5%86%85%E7%9A%84-repositories" aria-label="1 获取组织内的 repositories permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Repositories</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token variable">$cursor</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token property-query">organization</span><span class="token punctuation">(</span><span class="token attr-name">login</span><span class="token punctuation">:</span> <span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property-query">repositories</span><span class="token punctuation">(</span>
      <span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token attr-name">isLocked</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token attr-name">orderBy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token attr-name">field</span><span class="token punctuation">:</span> <span class="token constant">PUSHED_AT</span><span class="token punctuation">,</span> <span class="token attr-name">direction</span><span class="token punctuation">:</span> <span class="token constant">DESC</span> <span class="token punctuation">}</span>
      <span class="token attr-name">after</span><span class="token punctuation">:</span> <span class="token variable">$cursor</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token object">pageInfo</span> <span class="token punctuation">{</span>
        <span class="token property">hasNextPage</span>
        <span class="token property">endCursor</span>
      <span class="token punctuation">}</span>
      <span class="token object">edges</span> <span class="token punctuation">{</span>
        <span class="token object">node</span> <span class="token punctuation">{</span>
          <span class="token property">pushedAt</span>
          <span class="token property">name</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="2-获取-repository-下的-commits" style="position:relative;">2. 获取 repository 下的 commits<a href="#2-%E8%8E%B7%E5%8F%96-repository-%E4%B8%8B%E7%9A%84-commits" aria-label="2 获取 repository 下的 commits permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Commits</span><span class="token punctuation">(</span><span class="token variable">$owner</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token variable">$cursor</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token property-query">repository</span><span class="token punctuation">(</span><span class="token attr-name">owner</span><span class="token punctuation">:</span> <span class="token variable">$owner</span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token object">defaultBranchRef</span> <span class="token punctuation">{</span>
      <span class="token object">target</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span> <span class="token keyword">on</span> <span class="token class-name">Commit</span> <span class="token punctuation">{</span>
          <span class="token property-query">history</span><span class="token punctuation">(</span><span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token attr-name">after</span><span class="token punctuation">:</span> <span class="token variable">$cursor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token object">pageInfo</span> <span class="token punctuation">{</span>
              <span class="token property">hasNextPage</span>
              <span class="token property">endCursor</span>
            <span class="token punctuation">}</span>
            <span class="token object">edges</span> <span class="token punctuation">{</span>
              <span class="token object">node</span> <span class="token punctuation">{</span>
                <span class="token object">author</span> <span class="token punctuation">{</span>
                  <span class="token object">user</span> <span class="token punctuation">{</span>
                    <span class="token property">name</span>
                    <span class="token property">login</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token property">commitUrl</span>
                <span class="token property">abbreviatedOid</span>
                <span class="token property">pushedDate</span>
                <span class="token property">additions</span>
                <span class="token property">deletions</span>
                <span class="token property">message</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="3-获取-issue" style="position:relative;">3. 获取 issue<a href="#3-%E8%8E%B7%E5%8F%96-issue" aria-label="3 获取 issue permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Issue</span><span class="token punctuation">(</span><span class="token variable">$owner</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token variable">$number</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token property-query">repository</span><span class="token punctuation">(</span><span class="token attr-name">owner</span><span class="token punctuation">:</span> <span class="token variable">$owner</span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property-query">issue</span><span class="token punctuation">(</span><span class="token attr-name">number</span><span class="token punctuation">:</span> <span class="token variable">$number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>
      <span class="token property">url</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>使用的 Client 就是 Apollo GraphQL Client。</p>
<h3 id="对每个人的活动量做细节处理" style="position:relative;">对每个人的活动量做细节处理<a href="#%E5%AF%B9%E6%AF%8F%E4%B8%AA%E4%BA%BA%E7%9A%84%E6%B4%BB%E5%8A%A8%E9%87%8F%E5%81%9A%E7%BB%86%E8%8A%82%E5%A4%84%E7%90%86" aria-label="对每个人的活动量做细节处理 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>原始的 Commit 包含行的增加和删减，但这里有个问题：</p>
<ol>
<li>很多代码其实是自动生成的，这部分并不能算是个人的工作量，并且这种生成代码的规模对于不同编程语言也有很大差异，希望在统计时忽略这些自动生成的代码</li>
<li>有一些 Merge commit 其实也不能算是个人工作量，也应该剔除</li>
<li>不同编程语言的工作规模有差异，比如前端 js 通常生产出来的代码规模就比写 python 的要大不少，纯粹按照行数统计没有可比性</li>
</ol>
<p>这里我处理了前两个，第三个感觉有点复杂，并且我也觉得没必要如此仔细的量化。</p>
<h4 id="通过-node-ignore-去过滤掉那些生成代码" style="position:relative;">通过 <code class="language-text">node-ignore</code> 去过滤掉那些生成代码<a href="#%E9%80%9A%E8%BF%87-node-ignore-%E5%8E%BB%E8%BF%87%E6%BB%A4%E6%8E%89%E9%82%A3%E4%BA%9B%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81" aria-label="通过 node ignore 去过滤掉那些生成代码 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<p><a href="https://github.com/kaelzhang/node-ignore">node-ignore</a> 是一个很不错的库，实现了 gitignore 的标准，用这个我们就可以将每个 commit 的每个文件扫一遍，过滤掉那些模板的文件后重新统计删减就好了。</p>
<p>这里吐槽 Github GraphQL API 发现其并没有实现具体一个 commit 下文件修改的接口，还需要我去调用 REST 的接口。</p>
<h4 id="通过-commit-message-过滤掉-merge-的-commit" style="position:relative;">通过 commit message 过滤掉 Merge 的 commit<a href="#%E9%80%9A%E8%BF%87-commit-message-%E8%BF%87%E6%BB%A4%E6%8E%89-merge-%E7%9A%84-commit" aria-label="通过 commit message 过滤掉 merge 的 commit permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<p>这里似乎有点不太严谨，但是似乎问题不大吧...</p>
<h3 id="用-ejs-做模板生成-markdown" style="position:relative;">用 ejs 做模板生成 markdown<a href="#%E7%94%A8-ejs-%E5%81%9A%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90-markdown" aria-label="用 ejs 做模板生成 markdown permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>自从用了 react 似乎很少和各种模板引擎打交道了。上次使用类似的东西还是用 freemarker 做简单的文本内容模板。这次我也做了简单的调研，看了 mustache handlebars 和 ejs 最后还是觉得 ejs 这种可以直接写 js 的比较舒服。尤其是我在尝试 mustache 的时候没找到去迭代 Object 的方法...</p>
<p>写出来就是这个样子，实在是好久没写 nodejs 以及对 ejs 也是现学现用...</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">## Commit Summary

&lt;% Object.keys(userCommitSummary).forEach(function(username) { -%>
- &lt;%= username %>: &lt;%= userCommitSummary[username].commitCount %> commits +&lt;%= userCommitSummary[username].additions %> -&lt;%= userCommitSummary[username].deletions %>
&lt;% }); -%>

## Issue Summary

&lt;% Object.keys(userIssueSummary).forEach(function(username) { -%>
### &lt;%= username %>

工作涉及 &lt;%= userIssueSummary[username].issueCount %> 个 issue：
&lt;% userIssueSummary[username].issues.forEach(function(issue) { %>
- &lt;%= issue -%>
&lt;% }); %>

&lt;% }); -%>

## Commit Details

&lt;% Object.keys(userRepositoryCommitsDetails).forEach(function(username) { -%>
### &lt;%= username %>
  &lt;% Object.keys(userRepositoryCommitsDetails[username]).forEach(function(repo) { %>
####  &lt;%= repo %>

    &lt;%_ userRepositoryCommitsDetails[username][repo].forEach(function(commit) { -%>
- &lt;%= commit.url %> - &lt;%= commit.message %> &lt;&lt;%= commit.pushedDate %>>
    &lt;%_ }); -%>
  &lt;% }); -%>

&lt;% }); -%></code></pre></div>
<h3 id="用-github-actions-去跑任务做周期性统计" style="position:relative;">用 github actions 去跑任务做周期性统计<a href="#%E7%94%A8-github-actions-%E5%8E%BB%E8%B7%91%E4%BB%BB%E5%8A%A1%E5%81%9A%E5%91%A8%E6%9C%9F%E6%80%A7%E7%BB%9F%E8%AE%A1" aria-label="用 github actions 去跑任务做周期性统计 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> statistics of github org

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">timezone</span><span class="token punctuation">:</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"TimeZone default is +8"</span>
        <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token string">"Asia/Shanghai"</span>
      <span class="token key atrule">date</span><span class="token punctuation">:</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Any date in the week, default is now"</span>
        <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span>
    <span class="token comment"># https://crontab.guru</span>
    <span class="token punctuation">-</span> <span class="token key atrule">cron</span><span class="token punctuation">:</span> 0 18 * * *

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">report</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup node
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">"14"</span>
          <span class="token key atrule">check-latest</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> generate report
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GH_PAT <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> TZ=$<span class="token punctuation">{</span><span class="token punctuation">{</span>github.event.inputs.timezone<span class="token punctuation">}</span><span class="token punctuation">}</span> DATE=$<span class="token punctuation">{</span><span class="token punctuation">{</span>github.event.inputs.date<span class="token punctuation">}</span><span class="token punctuation">}</span> node main.js
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload results
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> reports
          <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            rawdata.json
            report.md</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare Issue Title
        <span class="token key atrule">id</span><span class="token punctuation">:</span> issue_title
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          export TZ=${{github.event.inputs.timezone}}
          export DATE=${{github.event.inputs.date}}
          echo ::set-output name=ISSUE_TITLE::$(node week.js)</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create Issue From File
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> aisensiy/create<span class="token punctuation">-</span>issue<span class="token punctuation">-</span>from<span class="token punctuation">-</span>file@af97df85a971093700b62d1bde8339c4fabb35ff
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">title</span><span class="token punctuation">:</span> Weekly Statistics $<span class="token punctuation">{</span><span class="token punctuation">{</span>steps.issue_title.outputs.ISSUE_TITLE<span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GH_PAT <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">update-existing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">content-filepath</span><span class="token punctuation">:</span> ./report.md
          <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            report</span>
</code></pre></div>
<p>首先，这里使用了两个 github workflow 的 trigger：</p>
<ul>
<li>schedule 也就是 cron 用于周期性跑任务</li>
<li>workflow_dispatch 可以提供个简单的表单，用来主动去创建一个 workflow</li>
</ul>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/85118802a9232dab272a6133372e6368/a0b80/2021-07-02-01-23-57.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 41.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABMElEQVQY01WNy27cMAxF/f+f0l323XVfZDNtgklmMHl5MrYkUg9KFkWqsYPmcXAgEAIO7uDAj6+zhUClUuG8ud2f+kgYEviEgZxPPhUIJKrD/VR3z+nmXG4v9eZc/o5l95z2E98b/aIc7PreGTle0vHFnqZUWx+eID5M4XGKp0s4Q5mjXAKbJJb6f9XFOmMG4lR7KpyohMwsOviMzllnV0rJjbkx9+8E78dxRIQu8v4jIio6WMLJGGPdbCxRrpVrrar9Q5GeKBmwkVKtS5MmIq01WZdLdIiIHgBLWXjj66x2DWGxU/K4GIizC54qLU11jYNzAIDOAeVcNz5L1d7775fDj92v6/MpLd0XxdJD3mLIiN4HHxH9mqm+Bx+zvfc/0/5q//PWHLS1TMS1MvNb/A+KTsqL7RVgYQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 07 02 01 23 57"
        title="2021 07 02 01 23 57"
        src="/static/85118802a9232dab272a6133372e6368/5a190/2021-07-02-01-23-57.png"
        srcset="/static/85118802a9232dab272a6133372e6368/772e8/2021-07-02-01-23-57.png 200w,
/static/85118802a9232dab272a6133372e6368/e17e5/2021-07-02-01-23-57.png 400w,
/static/85118802a9232dab272a6133372e6368/5a190/2021-07-02-01-23-57.png 800w,
/static/85118802a9232dab272a6133372e6368/a0b80/2021-07-02-01-23-57.png 955w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>然后，这里在完成统计后（就是 generate report 这个步骤）将所有的数据做成了 artifact 保存了下来，方便后续的数据的追溯。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/183db6a9d17a90648b97b5707fd332e1/ef916/2021-07-02-01-25-25.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 68%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABBklEQVQoz5VTa2vDMAz0//+RgzFWykicxvJDb42kK4OuK81xH4zk0wkhJSQqpUCtrfU+hkf0MUQ1IpAJAERNREoBEfWI1rqaeYRHpGmeTqcT1LqWlYgiYl1XAIiI0fuyLBHBzDln3Ssyc9yQRM09zHxzUGVRFmEWFpWde0Rvqd8Hi6Zlhbf3j/PX3AZ15ENMtWO+lHwpK/SG3A6JOzHgQNr6JBZiOSAGGp/LufdtzuauZog0SF5zRu5j67YN+uHrzvsAjUhwIx9iIqI8ZxGJ40iIOE1TrQ3HcPeHn9zjYSbJthL83MFUr8t3L66tTfPcWnsmNoMK5vbHea8qIv4/zLbbMLO7+Dcw0TR6psAb7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Artifact 可以直接下载下来"
        title="Artifact 可以直接下载下来"
        src="/static/183db6a9d17a90648b97b5707fd332e1/5a190/2021-07-02-01-25-25.png"
        srcset="/static/183db6a9d17a90648b97b5707fd332e1/772e8/2021-07-02-01-25-25.png 200w,
/static/183db6a9d17a90648b97b5707fd332e1/e17e5/2021-07-02-01-25-25.png 400w,
/static/183db6a9d17a90648b97b5707fd332e1/5a190/2021-07-02-01-25-25.png 800w,
/static/183db6a9d17a90648b97b5707fd332e1/ef916/2021-07-02-01-25-25.png 815w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>最后，通过一个 create-issue-from-file 的 github action 将 report 的内容创建成一个 issue 展示出来，展示出来就是上文的截图的效果了。</p>
<blockquote>
<p>这里我为了避免每次执行都创建重复性的内容还特意把原来的 action 做了修改，提交了 PR <a href="https://github.com/aisensiy/create-issue-from-file">https://github.com/aisensiy/create-issue-from-file</a> 。</p>
</blockquote>
<h2 id="总结" style="position:relative;">总结<a href="#%E6%80%BB%E7%BB%93" aria-label="总结 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ul>
<li>GraphQL 的 API 相对于 REST 更容易上手</li>
<li>了解了 Github Actions 除了 CI/CD 的功能外还能做很多奇奇怪怪的东西，甚至让我觉得它是一个 serverless 平台，这里还看到另外一个新奇的使用方式 <a href="https://github.blog/2020-06-17-using-github-actions-for-mlops-data-science/">https://github.blog/2020-06-17-using-github-actions-for-mlops-data-science/</a></li>
<li>自己撰写 Github Actions 似乎挺简单的，文档还算是比较清楚，不过那个 <a href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs">outputs</a> 确实是花了些时间</li>
</ul></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/graphql-example">Real World 的 GraphQL 版本</a></h1><h2 class="text-gray-600 mb-4">2021 June-16</h2><div class="blog-post-content"><p>在很久之前的一篇 <a href="/real-world-spring-boot-and-mybatis">文章</a> 介绍了我做的一个 <a href="https://github.com/gothinkster/spring-boot-realworld-example-app">RealWorld 的 SpringBoot + MyBatis</a> 的实现。这个项目我也一直在维护，一方面是因为这是一个很好的 demo 项目，可以很好的体现一些设计思路 <a href="/real-world-spring-boot-and-mybatis">文章</a> 也都说了不再重复。另一方面，我觉得也是一个新人练手不错的选择，可以让大家可以通过这个项目来入门。</p>
<p>最近在做 GraphQL 的调研和测试，我第一个想到的就是把这个项目添加上 GraphQL 的接口，一方面可以熟悉 GraphQL 的体系，另一方面也是个很好的机会去验证下是不是 REST 层是按照 <a href="http://alistair.cockburn.us/Hexagonal+architecture">六边形架构</a> 或者说是 <a href="https://www.infoq.com/news/2014/10/ddd-onion-architecture">洋葱架构</a> 那样子做成的是薄薄的一层，可以轻易的被替换掉。</p>
<h2 id="对-api-层与-application-层做重构" style="position:relative;">对 api 层与 application 层做重构<a href="#%E5%AF%B9-api-%E5%B1%82%E4%B8%8E-application-%E5%B1%82%E5%81%9A%E9%87%8D%E6%9E%84" aria-label="对 api 层与 application 层做重构 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>当然，api 层和 application 层一点都不修改就能添加 GraphQL 是不可能的。主要是因为之前有不少的逻辑写在了 SpringBoot 的 Controller 里面了。那么这一部分的工作基本就是把大量放在 Controller 的代码挪动到 application 层。</p>
<h2 id="确认-graphql-的-schema" style="position:relative;">确认 GraphQL 的 schema<a href="#%E7%A1%AE%E8%AE%A4-graphql-%E7%9A%84-schema" aria-label="确认 graphql 的 schema permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>然后就需要按照 REST api 提供一个对等的 GraphQL 的 schema 了。这里参考的是 <a href="https://github.com/thebergamo/realworld-graphql/blob/master/data/schema.graphql">https://github.com/thebergamo/realworld-graphql/blob/master/data/schema.graphql</a> 这里。</p>
<blockquote>
<p>Real World 似乎对 GraphQL 这部分的工作不太伤心，这个东西已经挺久的了，但是官方并没有很好的支持。</p>
</blockquote>
<p>不过它这个 schema 明显有两个问题：</p>
<ol>
<li>少了 <code class="language-text">unfavoriteArticle</code> 的 <code class="language-text">Mutation</code></li>
<li><code class="language-text">deleteArticle</code> 返回了错误的结果，明明应该是 <code class="language-text">DeletionStatus</code></li>
</ol>
<p>用 <a href="https://apis.guru/graphql-voyager/">https://apis.guru/graphql-voyager/</a> 做展示基本就是这个样子：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/94ea71f61f1d7c04895366a54ea95552/73dae/2021-06-16-19-22-23.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQoz3VS227bMAz1///OsBXYw4A+7DHt2rTGmqQXX2TJlzjzXbIkn4FsUiRDR4CgREmH1DkM8I8ty4L/5Sg67zFbB++Xizzt/bIg+OyhsQ7NOKGdNAOQzdby+WMs8HW1xqsqsHgP69xF8eAcyB/jVih+9O02hNgf4L2HmWc+S1WOjchRtQOss5i0QdV0uI9S/BYKAYGdO1m1r5EIgViVODQdd0mAozZIpUK42aJpu4+u0qLE9d0Dft4/fv5lmRcINxs8xwliqfCn69H0A4y1DKSKEpPW3DlZ23V4SxJEaYag04b5osvEB7ksSwZKpEJZH+Aoby2GaWKfjEE7DGi6Hu0wIhISu9cX7GSF4PvNGl9WazxlBbx3zKPMc2RFgZc4Qd/32KoSV79CFM37N6moPwoyThrDpHlN6gepEJB1g6xuoY15r94P6IYR/Tiyursoxip8Qr4/MC2UIydBKF6o/CYyPMsSoqqZl56+P898UR+V3aYZftyusT926ByJZDmeuD954Lh1+0EwDykPqmenfVpWuIsytKNmPk8zeQ52Wv8FjwgDL6/mN3wAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 06 16 19 22 23"
        title="2021 06 16 19 22 23"
        src="/static/94ea71f61f1d7c04895366a54ea95552/5a190/2021-06-16-19-22-23.png"
        srcset="/static/94ea71f61f1d7c04895366a54ea95552/772e8/2021-06-16-19-22-23.png 200w,
/static/94ea71f61f1d7c04895366a54ea95552/e17e5/2021-06-16-19-22-23.png 400w,
/static/94ea71f61f1d7c04895366a54ea95552/5a190/2021-06-16-19-22-23.png 800w,
/static/94ea71f61f1d7c04895366a54ea95552/c1b63/2021-06-16-19-22-23.png 1200w,
/static/94ea71f61f1d7c04895366a54ea95552/29007/2021-06-16-19-22-23.png 1600w,
/static/94ea71f61f1d7c04895366a54ea95552/73dae/2021-06-16-19-22-23.png 2122w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>schema 在 <a href="https://github.com/gothinkster/spring-boot-realworld-example-app/blob/master/src/main/resources/schema/schema.graphqls">https://github.com/gothinkster/spring-boot-realworld-example-app/blob/master/src/main/resources/schema/schema.graphqls</a> 可以看到。</p>
<p>可以看到 GraphQL 的 schema 是一张图，有点像是数据库的 <a href="https://www.guru99.com/er-diagram-tutorial-dbms.html">ER Diagram</a>。不过很显然，GraphQL 的关系肯定不是数据库级别的 CRUD 而是一个业务层级的关联图：</p>
<ol>
<li><code class="language-text">User</code> 的 <code class="language-text">Profile</code> 下可以有很多 <code class="language-text">Article</code> 的视图 <code class="language-text">favorites</code> <code class="language-text">feed</code>；</li>
<li><code class="language-text">Article</code> 则有其自己的全量属性：<code class="language-text">author</code> <code class="language-text">comments</code>；</li>
<li><code class="language-text">Comment</code> 也有自己的 <code class="language-text">article</code> <code class="language-text">author</code>；</li>
</ol>
<p>这部分让我想起来 DDD 书中提到的 Domain Model 对象之间的关联关系（第五章 A Model Expressed in Software）。和 REST 相比，通过 GraphQL 所组织的 schema 有更好的整体性和一致性。当然，这也有可能是它的缺点：它缺少了 REST 的那种随便搞个接口的灵活性。</p>
<h2 id="增加-graphql-的代码" style="position:relative;">增加 GraphQL 的代码<a href="#%E5%A2%9E%E5%8A%A0-graphql-%E7%9A%84%E4%BB%A3%E7%A0%81" aria-label="增加 graphql 的代码 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>这里的实现采用了 <a href="https://netflix.github.io/dgs/">Netflix DGS</a> 这个框架，很符合 SpringBoot 的设计逻辑，并且最近也一直在密集的更新中。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 252px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADr0lEQVQ4y42US4sjZRSGa6W/wP/hD9CFy1Zw4V4QFJcOggj+AXcDDjS0LYggyDCrsRGXIoyDdifpJJWq3FNJVZK635KqXLodh1fe0/2lkxkGXbw53y3ne+pcPk379A+89tlfeP3eOd78Wsc735h4+76Bt+4beOPLKrSPnkD75Cm0j/+n3j/t4L2TNj74foAvzqb46lcX9x7P8PnPc3z40wRHpwO8e9rH0UkXR9/2/lPa8+sV/l4vsS0y5GmMbqeNYb+LXsfEsGtiavVkD8+vgGcb4Nn2Zf1zJy3NckRxgqwowPF0NoPrerAdB3PXg+v5yBdLrNYblKv1gbhWlCvZXywLkRaEIWa2jfaDY1iVKsxeD61WC6ZpiqXq9ToqlQr0VgvNZhPtdlv2dV3HaDRCHMeIokik8cfzPLhNHcF0holtw7IsDAYDOUz1ej0Mh0MZ03K/3++L48lkgjRNkSSJSCuKAkkUwXr4CGF/AMd1MbYs2LaN8XgsThzHwdgaiw3DUKzruthsNqKyLLFarUTiME0SBOcVxCR0HLlV0ShLYl4wn8+FjpR0cHV1JaLjG4dliTSO4Zz9gtgaY+77NyFwXfi+Lw54AcckoyOuUTw3m80wnU7ls+n0hjBO4P72OxJ+mm0LlYqjouNat9uVeHKuiDlnLHnhncMkgffkKbL5HHGaylwFmRnkYSaPFMrmeS77tNfX1y98chTDfnyGaDhCnySdjtDw5k6nA72pwzAMKROWEddIxhLiWCXkLilpCv/8AinjFoaIo2hXW8wqSTjOskzE87Tb7XZHtl6vRULIshk/fASv3UG1XpebWbiXl5ciUpFWiWuMn3KmHB4QRrqBPAiQ5TmWy6UQkoL7nHO8WCzE8o9c55w1qJztYpiEEUY//AjXMKGTwjRxcXEhLUe6arUqajQau7ZkPLnGUuKnK0ohlLiMLBQkKku5XREokYRW7ZFadYgivIthGGJw8h1mjSb+rFRQrVRQq9Uks6TgmLS0Kssqzvufe0CY2Q6KLD+gym/jqepO0al4Uq8k7D04xrzRRI03G4bUGYlomVVmlzGkVSXCLO87OyBceD6WiwXSLBMq3k5LMsaKZzjmOpPAB2Hf2cuExyfw9BY6gwFq1equKxgrRcY5e5t77CTCvJIwHU9Q5gskaSqlwDoMgkDsfl+rDuLefg0edsotoW+YQsg6NPdEMhLxGWOG+dIoB/vOdoQ5CS0LyySBHwTy1rGH/du3kZZEtHwnufZihyiH/wLy0wNdJDaQBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 06 16 20 03 53"
        title="2021 06 16 20 03 53"
        src="/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png"
        srcset="/static/106be036b30c8ae5022ab6f9fafc3496/772e8/2021-06-16-20-03-53.png 200w,
/static/106be036b30c8ae5022ab6f9fafc3496/5e02b/2021-06-16-20-03-53.png 252w"
        sizes="(max-width: 252px) 100vw, 252px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>从文件组织上看，每个 Entity 或者是 EntityList 可以组织一个 Datafetcher 提供给具体某一个 <code class="language-text">Query</code> 下的特定 type 的查询。而针对某个 Entity 的 Mutation 可以放到一起？这部分不太确定，可能还是刚刚开始做，感受不是很明显。</p>
<h3 id="对于-nested-query-的处理" style="position:relative;">对于 nested query 的处理<a href="#%E5%AF%B9%E4%BA%8E-nested-query-%E7%9A%84%E5%A4%84%E7%90%86" aria-label="对于 nested query 的处理 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>既然是一张图，那么查询就可以是一个树，比如可以有这么一个查询：</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token punctuation">{</span>
  <span class="token object">me</span> <span class="token punctuation">{</span>
    <span class="token object">profile</span> <span class="token punctuation">{</span>
      <span class="token object">articles</span> <span class="token punctuation">{</span>
        <span class="token object">edges</span> <span class="token punctuation">{</span>
          <span class="token object">node</span> <span class="token punctuation">{</span>
            <span class="token object">comments</span> <span class="token punctuation">{</span>
              <span class="token object">edges</span> <span class="token punctuation">{</span>
                <span class="token object">node</span> <span class="token punctuation">{</span>
                  <span class="token property">body</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>获取当前用户的 <code class="language-text">articles</code> 并且包含它的 <code class="language-text">comment</code> 的 <code class="language-text">body</code>。类似的问题在 <a href="https://netflix.github.io/dgs/advanced/context-passing/">Nested data fetchers</a> 有做一些阐述。而我这个例子就是遇到了 <a href="https://netflix.github.io/dgs/advanced/context-passing/#no-showid-use-local-context">https://netflix.github.io/dgs/advanced/context-passing/#no-showid-use-local-context</a> 这部分阐述的情况，需要自己创建一个 Map 并放到 localContext 中做传递。具体的代码如下：</p>
<p><code class="language-text">ArticleDatafetcher.java</code>:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>graphql</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token annotation punctuation">@DgsComponent</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleDatafetcher</span> <span class="token punctuation">{</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token annotation punctuation">@DgsData</span><span class="token punctuation">(</span>parentType <span class="token operator">=</span> PROFILE<span class="token punctuation">.</span>TYPE_NAME<span class="token punctuation">,</span> field <span class="token operator">=</span> <span class="token class-name">PROFILE<span class="token punctuation">.</span>Articles</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">DataFetcherResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticlesConnection</span><span class="token punctuation">></span></span> <span class="token function">userArticles</span><span class="token punctuation">(</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token class-name">DgsDataFetchingEnvironment</span> dfe<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">User</span> current <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Profile</span> profile <span class="token operator">=</span> dfe<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CursorPager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleData</span><span class="token punctuation">></span></span> articles<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name"><span class="token namespace">graphql<span class="token punctuation">.</span>relay<span class="token punctuation">.</span></span>PageInfo</span> pageInfo <span class="token operator">=</span> <span class="token function">buildArticlePageInfo</span><span class="token punctuation">(</span>articles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArticlesConnection</span> articlesConnection <span class="token operator">=</span>
        <span class="token class-name">ArticlesConnection</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">pageInfo</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">edges</span><span class="token punctuation">(</span>
                articles<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
                        a <span class="token operator">-></span>
                            <span class="token class-name">ArticleEdge</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">cursor</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token function">buildArticleResult</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">DataFetcherResult</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticlesConnection</span><span class="token punctuation">></span></span><span class="token function">newResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>articlesConnection<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">localContext</span><span class="token punctuation">(</span> <span class="token comment">// 这里将 slug : article 的 map 传递到下一个层级了</span>
            articles<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">ArticleData</span><span class="token operator">::</span><span class="token function">getSlug</span><span class="token punctuation">,</span> a <span class="token operator">-></span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><code class="language-text">CommentDatafetcher.java</code>:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>graphql</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token annotation punctuation">@DgsComponent</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommentDatafetcher</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token annotation punctuation">@DgsData</span><span class="token punctuation">(</span>parentType <span class="token operator">=</span> ARTICLE<span class="token punctuation">.</span>TYPE_NAME<span class="token punctuation">,</span> field <span class="token operator">=</span> <span class="token class-name">ARTICLE<span class="token punctuation">.</span>Comments</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">DataFetcherResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommentsConnection</span><span class="token punctuation">></span></span> <span class="token function">articleComments</span><span class="token punctuation">(</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token class-name">DgsDataFetchingEnvironment</span> dfe<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> last <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"first 和 last 必须只存在一个"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">User</span> current <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Article</span> article <span class="token operator">=</span> dfe<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ArticleData</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> dfe<span class="token punctuation">.</span><span class="token function">getLocalContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 map</span>
    <span class="token class-name">ArticleData</span> articleData <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span><span class="token function">getSlug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 slug 获取具体的 ArticleData</span>

    <span class="token class-name">CursorPager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommentData</span><span class="token punctuation">></span></span> comments<span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name"><span class="token namespace">graphql<span class="token punctuation">.</span>relay<span class="token punctuation">.</span></span>PageInfo</span> pageInfo <span class="token operator">=</span> <span class="token function">buildCommentPageInfo</span><span class="token punctuation">(</span>comments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CommentsConnection</span> result <span class="token operator">=</span>
        <span class="token class-name">CommentsConnection</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">pageInfo</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">edges</span><span class="token punctuation">(</span>
                comments<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
                        a <span class="token operator">-></span>
                            <span class="token class-name">CommentEdge</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">cursor</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token function">buildCommentResult</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">DataFetcherResult</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommentsConnection</span><span class="token punctuation">></span></span><span class="token function">newResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">localContext</span><span class="token punctuation">(</span>
            comments<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">CommentData</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> c <span class="token operator">-></span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 这里同样传递了一个 id : comment 的 map 到下一个层级</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>这种传递 map 的方式也算是官方指定的最佳实践了吧，并且基本不可或缺。因为很多时候 <code class="language-text">Source</code> 和实际从 <code class="language-text">Application</code> 层传递的 DTO 的类型就是不一样的，可能缺了不少数据。</p>
<h2 id="效果" style="position:relative;">效果<a href="#%E6%95%88%E6%9E%9C" aria-label="效果 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>只要 Application 层保证重用并且捋清楚了 DataFetcher 之间的数据传递关系，后面做起来感觉就一马平川了，毕竟这也不是一个什么很大很复杂的项目。</p>
<p>完成之后感觉这种网状关系的调用体验还是很好的，感觉对 API 的调用方来说，一旦熟悉了这种模式就可以更容易的组合各种比较复杂的视图，而不会像 REST 那样担心大量的手工数据组合。</p>
<h2 id="开发过程中的一些小问题" style="position:relative;">开发过程中的一些小问题<a href="#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E9%97%AE%E9%A2%98" aria-label="开发过程中的一些小问题 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ol>
<li>Intellij 对 GraphQL 本身的支持还不够好</li>
<li>Dgs 是个比较新的框架，加上国内似乎很少有做类似东西的人，资料很少</li>
<li>RealWorld 本身对 GraphQL 的推进也很慢，后续我应该会增加英文版本的 ReadME 介绍 GraphQL 这部分的工作，并且希望可以有前端做支持</li>
</ol></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/github-actions-tips">Github Actions 的一些使用体会</a></h1><h2 class="text-gray-600 mb-4">2021 May-11</h2><div class="blog-post-content"><h2 id="2021-年-7-月更新" style="position:relative;">2021 年 7 月更新<a href="#2021-%E5%B9%B4-7-%E6%9C%88%E6%9B%B4%E6%96%B0" aria-label="2021 年 7 月更新 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<blockquote>
<p>随着最近又更深入的使用了 Github Actions 对其又有了一些新的认识。这里对原来的一些些观点做一些补充。</p>
</blockquote>
<p>再之前的一篇 <a href="/github-actions">文章</a> 对 github actions 做了一些简单的介绍，距离上次记录已经超过半年的时间了，在这段时间我们逐渐将大部分的 circleci 执行的 ci/cd 内容挪动到 github actions 了。这里在对目前的一些使用体会做一个记录。</p>
<h2 id="good-part" style="position:relative;">Good part<a href="#good-part" aria-label="good part permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>github actions 配合 github 自身的 api 可以玩出很多花样，把很多手工的工作都变成自动化的流程，确实节省了不少时间。其实每个东西都没什么复杂的，这里主要是罗列和记录吧。</p>
<h3 id="依据标签自动发布-release" style="position:relative;">依据标签自动发布 release<a href="#%E4%BE%9D%E6%8D%AE%E6%A0%87%E7%AD%BE%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83-release" aria-label="依据标签自动发布 release permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>首先，我们通常都需要在打 tag 的时候搞出来一个发布。github actions 可以在 push tag 的时候触发相应的流程，实现这个功能。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6b2e3ed895967bbe447329d0a8784a75/6da96/2021-05-15-12-58-38.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 66.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABO0lEQVQoz5WS627DIAyF+/5vuO3P1ksGuJgAwcQmwJS0U7eu0rZPlixkjo9leWcme044l/ruSsxL7731v7ITESIalHk9qBBpI6/MnOZGmbdHJsqt3bfdTYl8iMwy89L/yW6ptbWWpQ4oLLW3K+v83+hb3Kqr+JKWWnnjf86XlIjelYpxuhh+/VHbGq33T/P+zXkrNIuotUF01qJ1zo0jOkREF8iOZIOAL2dfwBeMJXOdpd3EwzA8Pb+8vu2VUscB3gY8ar9X09FMBz3tTQZfxmnBwJE4c81cb2JE1AbcOIYYfQjCzLJk6XNps/Qsq9UsLXMppdyPDQBaaWMAAE6nk1L61/1dFyYi1iIAGIC0XUlK6aGgPRQbA1obi0hEUsrPe3rsfN22tQYA3WitBTiPkX2qgRafrhFzvev3AYHX95PjAqa4AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 05 15 12 58 38"
        title="2021 05 15 12 58 38"
        src="/static/6b2e3ed895967bbe447329d0a8784a75/5a190/2021-05-15-12-58-38.png"
        srcset="/static/6b2e3ed895967bbe447329d0a8784a75/772e8/2021-05-15-12-58-38.png 200w,
/static/6b2e3ed895967bbe447329d0a8784a75/e17e5/2021-05-15-12-58-38.png 400w,
/static/6b2e3ed895967bbe447329d0a8784a75/5a190/2021-05-15-12-58-38.png 800w,
/static/6b2e3ed895967bbe447329d0a8784a75/6da96/2021-05-15-12-58-38.png 922w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Java CI

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'**'</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'v*'</span> <span class="token comment"># Push events to matching v*, i.e. v1.0, v20.15.10</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'**'</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>

    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> self<span class="token punctuation">-</span>hosted
    <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">"! contains(github.event.head_commit.message, '[ci skip]')"</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v1
    <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare release
      <span class="token key atrule">if</span><span class="token punctuation">:</span> startsWith(github.ref<span class="token punctuation">,</span> 'refs/tags/')
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token key atrule">CURRENT_TAG</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.version_tag.outputs.VERSION <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        cp build/libs/openbayes-server-0.0.1-SNAPSHOT.jar app.jar
        docker run -v "$PWD":/workdir quay.io/git-chglog/git-chglog $CURRENT_TAG > CHANGELOG.md</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
      <span class="token key atrule">if</span><span class="token punctuation">:</span> startsWith(github.ref<span class="token punctuation">,</span> 'refs/tags/')
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">body_path</span><span class="token punctuation">:</span> CHANGELOG.md
        <span class="token key atrule">files</span><span class="token punctuation">:</span> app.jar
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div>
<p>如上所示，最后两个 step 分别是准备要发布的内容以及执行实际的发布：</p>
<ol>
<li>这是一个 java 的项目，我将 build 出来的 jar 作为一个 asset 重命名成 <code class="language-text">app.jar</code> 。然后使用工具 <a href="https://github.com/git-chglog/git-chglog">git-chglog</a> 生成当前 tag 的 changelog 保存到 <code class="language-text">CHANGELOG.md</code> 中。</li>
<li>使用一个第三方的 github action <a href="https://github.com/softprops/action-gh-release">softprops/action-gh-release</a> 用来创建一个 release 其实就是调用了 github 的 api 创建了一个 release 罢了。具体怎么做看文档就好。</li>
</ol>
<h3 id="goreleaser-与-ghr-的帮助" style="position:relative;">goreleaser 与 ghr 的帮助<a href="#goreleaser-%E4%B8%8E-ghr-%E7%9A%84%E5%B8%AE%E5%8A%A9" aria-label="goreleaser 与 ghr 的帮助 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>同样是在打 tag 的时候做一个发布，openbayes 的命令行工具要做的事情就会多不少：</p>
<ol>
<li>作为一个需要别人下载的东西，我们需要对国内提供比较好的访问速度</li>
<li>作为一个私有仓库，我们需要同时将 release 放到另外的公有仓库里</li>
<li>我们需要更新 homebrew 的源以保证用户通过 homebrew 安装的时候是最新的版本</li>
</ol>
<p>由于这个项目是 golang 开发的，我们使用了一个名为 <a href="https://github.com/goreleaser/goreleaser">goreleaser</a> 的工具。它能够帮助我们完成如下事情：</p>
<ol>
<li>构建针对不同操作系统的二进制文件并提供 checksum 文件</li>
<li>更新对应的 homebrew 仓库</li>
<li>将代码上传到一个国内访问速度比较快的对象存储上，见<a href="https://goreleaser.com/customization/blob/">Blobs</a></li>
</ol>
<p>使用 goreleaser 的 <a href="https://github.com/goreleaser/goreleaser-action">action</a> 就可以完成以上三个事情。但是除此之外，我们还需要发布到另外一个公开的仓库里。</p>
<p>本想继续采用上面的那个 <code class="language-text">action-gh-release</code> 无奈这个东西有个 bug：虽然它允许指定另外一个仓库作为发布的仓库，但是在发布前它居然会检查自己以这个名字命名的 release 是否存在（而不是去检查要发布的仓库的 release 是否存在），所以我们就继续采用了 <a href="https://github.com/tcnksm/ghr">ghr</a> 这个古老的东西。</p>
<p><strong>注意</strong> 在将东西发布到其他仓库的时候，github action 所提供的默认的 GITHUB_TOKEN 是不够的：它不具备操纵其他仓库的权限。需要自己创建一个新的 token 并通过 env 传递过来。文档见 <a href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token">Creating a personal access token
</a>。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release to other repository
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GH_PAT <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment"># 这里就是一个自己创建的 TOKEN 了</span>
        <span class="token key atrule">CURRENT_TAG</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.version_tag.outputs.VERSION <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        ...
        go get -u github.com/tcnksm/ghr
        ghr -u signcl -r bayes-releases -body="$(cat tmpDist/CHANGELOG.md)" $CURRENT_TAG dist</span></code></pre></div>
<p>这里在吐槽一下 gitee 的 api。最开始我们是将命令行工具发布到 gitee 的一个仓库的，采用 github action 后也想通过 gitee 的 api 去创建相应的发布到 gitee 对应的仓库。无奈 gitee 的仓库居然只有创建一个空 release 的接口，<strong>而没有向 release 里面提供额外 assets 的接口</strong>，相当于这 api 就只做了一半而已，询问客服也没什么结果（不过起码有人回复），并且我们也不希望通过模拟表单提交的方式去做了，毕竟也不是非要发布到 gitee 上，最终还是采用了将二进制文件放到国内对象存储的方案。</p>
<h3 id="同步到-gitee" style="position:relative;">同步到 gitee<a href="#%E5%90%8C%E6%AD%A5%E5%88%B0-gitee" aria-label="同步到 gitee permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>由于 github 在国内的访问不是很稳定，但是我们有一些样例项目希望其他人可以 git clone 去尝试，那么就有这种将 github 的项目同步到 gitee 以提升可访问性的需求：</p>
<ol>
<li>去 gitee 创建一个 access token</li>
<li>在 github 每次 push 的时候都触发一个 github action 将 commit 主动 push 到 gitee 那边的仓库就好了</li>
</ol>
<p>这里我直接使用了 <a href="https://github.com/wangchucheng/git-repo-sync">https://github.com/wangchucheng/git-repo-sync</a> 这个 action 看里面的代码也就是这么个流程。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">
<span class="token key atrule">name</span><span class="token punctuation">:</span> sync<span class="token punctuation">-</span>gitee

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'**'</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">sync</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Git Repo Sync
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> wangchucheng/git<span class="token punctuation">-</span>repo<span class="token punctuation">-</span>sync@v0.1.0
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">target-url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.REMOTE_GIT <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">target-username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.username <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">target-token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.ACCESS_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div>
<h2 id="bad-part" style="position:relative;">Bad part<a href="#bad-part" aria-label="bad part permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>github action 确实通过和 api 的集成帮我们生了不少事情，但是在使用的过程中也遇到了一些问题。槽点不是很多，目前也一定程度上可以接受吧。如果能够再稳定一些那就更好了。</p>
<h3 id="不太稳定的服务" style="position:relative;">不太稳定的服务<a href="#%E4%B8%8D%E5%A4%AA%E7%A8%B3%E5%AE%9A%E7%9A%84%E6%9C%8D%E5%8A%A1" aria-label="不太稳定的服务 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>github action 这种模式其实本身是有点危险的：相当于把大量的用户代码在自己的系统里去跑，并且还有非常复杂的沟通与集成的工作。可能因为各种自身或者<a href="https://www.infoq.cn/article/6bipjclk9anzvda4uecm">用户的问题</a>，服务确实有 down 过那么几次。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 606px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/97b2c712207efcf6af6911c7a4cb7a80/4d4a2/2021-05-16-11-00-21.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 21.999999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAoUlEQVQI13XLSwqDQAyAYe9/Fq/gSpDZia4UfBBBxzgmGRUdsV2UsRTaRb9FCCF/ICIAMAwDACCi1rptWwAwxkzTpDUuy7Guh7W7yG6XY9vcdT2et6Dve6VUHMdKqaIouq5rmqaqKkRkFhEmmolonv0kIma/v/k4SZIwDKMoKsvSWst39Hll+sPH4zhmWZbneZqmdV2LCN6MMczsnDt/fV9eNM3Z2lZFOf8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 05 16 11 00 21"
        title="2021 05 16 11 00 21"
        src="/static/97b2c712207efcf6af6911c7a4cb7a80/4d4a2/2021-05-16-11-00-21.png"
        srcset="/static/97b2c712207efcf6af6911c7a4cb7a80/772e8/2021-05-16-11-00-21.png 200w,
/static/97b2c712207efcf6af6911c7a4cb7a80/e17e5/2021-05-16-11-00-21.png 400w,
/static/97b2c712207efcf6af6911c7a4cb7a80/4d4a2/2021-05-16-11-00-21.png 606w"
        sizes="(max-width: 606px) 100vw, 606px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3 id="不太完善的封装" style="position:relative;">不太完善的封装<a href="#%E4%B8%8D%E5%A4%AA%E5%AE%8C%E5%96%84%E7%9A%84%E5%B0%81%E8%A3%85" aria-label="不太完善的封装 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>其次就是我们一直吐槽的 action 的写法问题了：很多 action 是那种不通过 docker 封装的版本，这势必会引入依赖不全的问题。尤其是对于我们这种 self-hosted 的用户，经常会出现因为依赖不齐全而导致 ci 挂掉。</p>
<blockquote>
<p><strong>更新</strong> 目前并没有很系统的去了解撰写 github action 的方法，最近接触到的是 <a href="https://docs.github.com/en/actions/creating-actions/about-actions#javascript-actions">JS Action</a> 的流程。其文档也提到</p>
<p>"To ensure your JavaScript actions are compatible with all GitHub-hosted runners (Ubuntu, Windows, and macOS), the packaged JavaScript code you write should be pure JavaScript and not rely on other binaries. JavaScript actions run directly on the runner and use binaries that already exist in the virtual environment."</p>
<p>也就是说其平台兼容性是建立在你自己的 nodejs 依赖是可以跨平台的前提下的。</p>
</blockquote></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/spring-security-with-jwt">Spring Security Jwt 的实现</a></h1><h2 class="text-gray-600 mb-4">2021 April-12</h2><div class="blog-post-content"><p>突然发现除了<a href="/spring-cors-and-security">跨域问题</a>之外从来没有好好记录过 Spring Security 的其他内容。最近也是比较系统的看了些资料，这里就算是做一个总结吧，方便后面忘记了回看。</p>
<p>这里只介绍怎么把 jwt 的流程跑通以及对关键的代码做解释，不涉及 Authorization 部分，同时也只有 username password 单一的 authentication 流程，不涉及其他。</p>
<h2 id="关键概念解释" style="position:relative;">关键概念解释<a href="#%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E8%A7%A3%E9%87%8A" aria-label="关键概念解释 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>首先要明白 spring security 主要通过 filter 拦截请求并做处理的，在 <a href="/servlet-and-filter-with-web-framework">有关 servlet 和 filter 的基础知识</a> 已经做了介绍。</p>
<p>在 Spring Security 有一个概念 <code class="language-text">Authentication</code> 它同时记录了一个用户授权的凭证（Credentials）以及验证通过后的产物（Principal）。而负责这个凭据验证并基于 Principal 的东西就是 <code class="language-text">AuthenticationProvider</code>。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e1d64627c81bf20bc5344f3d928d8257/6029f/2021-04-12-23-24-37.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 70.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFklEQVQ4y5VSiW7aQBD1b7ff1kRR2lShgCtSQwg2GJ/r9XoNNr45XjRLjEKVSulIT571zr55c2hFUcAwppjNnmH8mSqwMIJMJOiO7HQ6/RPH01HF7Nodvn7/Ak3KFAtrDo+vIPIQ4caBrCKkeYzdbof/MZ5xaEVeICkZvHyOdTqDvzUR5BaCxEae5yqwrmtUVaUUbzYbSCmvkKYpRCxQFRW0tu3gMhuBWENsIvCEIYx9BJGHtm1RNzXiOFbkpHi/3+N4POJwOFxApVPSRCbQ6EAPGWO4+XYLfayjbVrkWa4el2WpcLGTauo1AEVMSjVyqIw0lWAsvKihLynq2hZZnn2qh4mUZ4VUAqH33xvlF1GEmnFUAUPNBVq5QSMk6jBCEycXX8QxtH4t/rY+Ad4IGy5QBREqP1SkKoHPzklYjCYSZ8L+EU1xsVjANE1st9srUiqFbF+UKEwb5dJBHXKUaw/FysGhrNQ9TVzrFdFQJpMJxuMxooipPmbZuXfUbHxQxXvbd50SovUrYBgG5vMXTI0ZxiMdS2uFJEnQdR2EEGriCl13Bbqn/1QhxWm0rKSElOmTEUz7GS/2FCzx4XqOWh/XdeC67hs8eJ6n/P5r2zYcxzkTcs4R+gz6bIDfqwcY9giD+S2ezF/Qn4bgUaxW6ENwfnUmLm25XKpB3D/c4f7xBj8Gd3gc/sRg+IjReAS6tyzrU6DYV6dSJI+QJX2yAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 04 12 23 24 37"
        title="2021 04 12 23 24 37"
        src="/static/e1d64627c81bf20bc5344f3d928d8257/5a190/2021-04-12-23-24-37.png"
        srcset="/static/e1d64627c81bf20bc5344f3d928d8257/772e8/2021-04-12-23-24-37.png 200w,
/static/e1d64627c81bf20bc5344f3d928d8257/e17e5/2021-04-12-23-24-37.png 400w,
/static/e1d64627c81bf20bc5344f3d928d8257/5a190/2021-04-12-23-24-37.png 800w,
/static/e1d64627c81bf20bc5344f3d928d8257/6029f/2021-04-12-23-24-37.png 906w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>然后一个系统可能会支持多种凭据，比如最典型的 UsernamePasswordAuthentication 也可以是通过 OAuth 的 Authentication。为了处理不同的授权流程，Spring Security 有另外一个概念 <code class="language-text">AuthenticationManager</code> 用于管理多个 <code class="language-text">AuthenticationProvider</code>：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/395e312f669700efde6155bce5e7b201/a0730/2021-04-12-23-32-28.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 66%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEUlEQVQ4y4VTaW/aQBD1//87nAFUlQ/QNuFMyEEVsCkE3PjC62Pt9cKrZsAoKZW60tPMzs4+vZmdNbTWWCwWWK/X2G63bB8fn7BcLmGaJjzPw8PDA8fTNEUkIiRJwn4JKSWDfMN1XaxWK+x2O74URRHCMEQcx2xpv9/vEQoBQX64RxAETEo5JYhss9nAcBwH/1s6V1BhBC1iFCLCQet/5pEAQwiBPM85cDwer5LiPIRI95BugHhjQ8UJikJd8kvQItVMmGXZSYnWKIqCoQsNqRIkSkAVBZfFZSbJlYDS+r7/WSE1Vh809OHApDKTHFdKQRXqFNea8z+SlT6170R4VpiKCCoIkXkBcn/PpVHJQeQgcwPIdxe56yNP5Ynkr5LpgQ16xVJhJiU3n8hUFCNXGY44sDoZCoi3HTKOq6t+055e36C6qT/FuU/UoySlkUgQRgGyXCKTGY+M+DBS3IYz6C4J4x6WM0gbklzCcz04zjus7Ss2b7/w27Z5yF3HhW3bn3J9z2cOy7JgzGYzzOdzWKbJv6P8Iaa5hGVaWCxf8TJ/xstwjKfvd5iPJvj5/IIl55zuEFHJY/T7fQyHQw7c398zptMpJpMJg/zhaITbfh/fvnzF3Y9bDAaDyxmB7vZ6PYzHYxitVgvNZhOdTgftdptB+3q9jkajwSC/WquhSrZaRa1Wu5zd3NywrVQq6Ha7+AORis91ptOV0wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 04 12 23 32 28"
        title="2021 04 12 23 32 28"
        src="/static/395e312f669700efde6155bce5e7b201/5a190/2021-04-12-23-32-28.png"
        srcset="/static/395e312f669700efde6155bce5e7b201/772e8/2021-04-12-23-32-28.png 200w,
/static/395e312f669700efde6155bce5e7b201/e17e5/2021-04-12-23-32-28.png 400w,
/static/395e312f669700efde6155bce5e7b201/5a190/2021-04-12-23-32-28.png 800w,
/static/395e312f669700efde6155bce5e7b201/a0730/2021-04-12-23-32-28.png 1131w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>而具体到我们这次要构建的 JwtUsernamePassword 的流程，当我们登录的时候需要拿着登录信息（username + password）去数据库（或者其他地方）校验有没有这样子的组合，而这个地方 Spring Security 也抽取了概念叫做 <code class="language-text">UserDetailsService</code>:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/02d0ffa1cbb85e4e5ecafb8addf28a32/302a4/2021-04-12-23-37-33.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 31%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/0lEQVQY021QW5KEIAz0/lfzAjt/lliuOgoCyht7Klmdr01VoBJCp7sbALiuC6UU1FJRS+H6v6A+5XEcMMbAWMuptUYIgWcaGkgpIeWMVDJiSogx8mOtlT/SB0oKWqykQkkZKUbknOGcw77vNyAuROcRtUUyB6I2SPc2YtL3PcZxxDzP2LYNlhgphTC94X4XhGXDuazfhQ0dxCjuBuEt/wBvhuu6Msg0TZBSMgvvPYzWSLuBXxXCqnBKxUoYkGQRoA+BfXDe8019suI8T7Rti5/Xi2uafeQ9kWvhHtnXEFUqlFLfpPrxjSQSQ5JsjeV3skEIAdH3GIRA13UYhoFnPyMwz0KaAT2oAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2021 04 12 23 37 33"
        title="2021 04 12 23 37 33"
        src="/static/02d0ffa1cbb85e4e5ecafb8addf28a32/5a190/2021-04-12-23-37-33.png"
        srcset="/static/02d0ffa1cbb85e4e5ecafb8addf28a32/772e8/2021-04-12-23-37-33.png 200w,
/static/02d0ffa1cbb85e4e5ecafb8addf28a32/e17e5/2021-04-12-23-37-33.png 400w,
/static/02d0ffa1cbb85e4e5ecafb8addf28a32/5a190/2021-04-12-23-37-33.png 800w,
/static/02d0ffa1cbb85e4e5ecafb8addf28a32/302a4/2021-04-12-23-37-33.png 1080w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Spring Security 有提供一个名为 <code class="language-text">WebSecurityConfigurerAdapter</code> 的基类，它已经提供了基本的框架，我们通常只需要对需要自定义的地方做覆盖即可。</p>
<p>那么总结下具体要做什么：</p>
<ol>
<li>增加一个 InMemoryUserDetailsManager 假装是个数据库。</li>
<li>完成两个 Filter：
<ol>
<li><code class="language-text">JwtUsernameAndPasswordAuthenticationFilter</code> 覆盖默认的 <code class="language-text">UsernamePasswordAuthenticationFilter</code> 支持依据请求生成 jwt token</li>
<li><code class="language-text">JwtTokenVerifier</code> 检查请求的 header <code class="language-text">Authorization</code> 获取并验证所附带的 token 判断这个 token 是否合法并返回对应的 Principle</li>
</ol>
</li>
<li>覆盖 <code class="language-text">WebSecurityConfigurerAdapter.configure</code> 把以上配置传起来</li>
</ol>
<h2 id="基本依赖" style="position:relative;">基本依赖<a href="#%E5%9F%BA%E6%9C%AC%E4%BE%9D%E8%B5%96" aria-label="基本依赖 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>首先 gradle 依赖如下：</p>
<div class="gatsby-highlight" data-language="gradle"><pre class="language-gradle"><code class="language-gradle">dependencies {
    implementation &#39;org.springframework.boot:spring-boot-starter-security&#39;
    implementation &#39;org.springframework.boot:spring-boot-starter-validation&#39;
    implementation &#39;org.springframework.boot:spring-boot-starter-web&#39;
    compileOnly &#39;org.projectlombok:lombok&#39;

    compile &#39;io.jsonwebtoken:jjwt-api:0.11.2&#39;
    runtime &#39;io.jsonwebtoken:jjwt-impl:0.11.2&#39;,
            // Uncomment the next line if you want to use RSASSA-PSS (PS256, PS384, PS512) algorithms:
            //&#39;org.bouncycastle:bcprov-jdk15on:1.60&#39;,
            &#39;io.jsonwebtoken:jjwt-jackson:0.11.2&#39; // or &#39;io.jsonwebtoken:jjwt-gson:0.11.2&#39; for gson

    annotationProcessor &#39;org.springframework.boot:spring-boot-configuration-processor&#39;
    annotationProcessor &#39;org.projectlombok:lombok&#39;
    testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39;
    testImplementation &#39;org.springframework.security:spring-security-test&#39;
}</code></pre></div>
<p>通过 <a href="https://start.spring.io">start.spring.io</a> 创建的项目，添加了以下依赖：</p>
<ul>
<li>web</li>
<li>validation</li>
<li>lombok</li>
<li>spring security</li>
</ul>
<p>同时增加了一个 jwt 解析的类库 <a href="https://github.com/jwtk/jjwt">jjwt</a>。</p>
<h2 id="websecurityconfig" style="position:relative;">WebSecurityConfig<a href="#websecurityconfig" aria-label="websecurityconfig permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>增加一个 <code class="language-text">InMemoryUserDetailsManager</code>，只有一个用户：</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
  <span class="token annotation punctuation">@Override</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">protected</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"NORMAL"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>覆盖 <code class="language-text">configure</code>，增加上述提及的 Filter:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// disable csrf</span>
        <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span> <span class="token comment">// 不再使用 cookie 管理 session</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">JwtUsernameAndPasswordAuthenticationFilter</span><span class="token punctuation">(</span>
                <span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jwtConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 增加用户密码校验的 Filter</span>
        <span class="token punctuation">.</span><span class="token function">addFilterAfter</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">JwtTokenVerifier</span><span class="token punctuation">(</span>jwtConfig<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">JwtUsernameAndPasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 增加 token 校验的 Filter</span>
        <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="jwtusernameandpasswordauthenticationfilter" style="position:relative;">JwtUsernameAndPasswordAuthenticationFilter<a href="#jwtusernameandpasswordauthenticationfilter" aria-label="jwtusernameandpasswordauthenticationfilter permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUsernameAndPasswordAuthenticationFilter</span> <span class="token keyword">extends</span>
    <span class="token class-name">UsernamePasswordAuthenticationFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">JwtConfig</span> jwtConfig<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">JwtUsernameAndPasswordAuthenticationFilter</span><span class="token punctuation">(</span>
      <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">,</span> <span class="token comment">// 1</span>
      <span class="token class-name">JwtConfig</span> jwtConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jwtConfig <span class="token operator">=</span> jwtConfig<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
      <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span> <span class="token comment">// 2</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">UsernamePasswordRequest</span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
          param<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          param<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> io<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
      <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span> <span class="token comment">// 3</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>authResult<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"authorities"</span><span class="token punctuation">,</span> authResult<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
            <span class="token class-name">GrantedAuthority</span><span class="token operator">::</span><span class="token function">getAuthority</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span>jwtConfig<span class="token punctuation">.</span><span class="token function">getDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>jwtConfig<span class="token punctuation">.</span><span class="token function">getSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<ol>
<li>从 <code class="language-text">WebSecurityConfig</code> 那边获取的 <code class="language-text">AuthenticationManager</code> 里面其实就是一个默认的 <code class="language-text">UsernamePasswordProvider</code> 里面用的就是我们上文配置的 <code class="language-text">InMemoryUserDetailsManager</code>。</li>
<li>尝试验证，可以看到就是把 <code class="language-text">{"username": "username", "password": "password"}</code> 这种格式的 request body 做解析，然后让给 <code class="language-text">AuthenticationManager</code>。</li>
<li>生成 token，懂 jwt 的话就知道就是那么几个东西：
<ol>
<li>subject 里面是 username</li>
<li>claim 一些 key-value，这里塞了权限列表</li>
<li>issueAt 创建时间</li>
<li>expiration 过期时间</li>
</ol>
</li>
</ol>
<blockquote>
<p><strong>注意</strong> 其实很多时候这个 Filter 可能是一个独立的 Controller 会比较舒服一些吧，相比下文的 JwtVerifier 这个 Filter 基本就是强行复用了 Spring Security 的逻辑。</p>
</blockquote>
<h2 id="jwttokenverifier" style="position:relative;">JwtTokenVerifier<a href="#jwttokenverifier" aria-label="jwttokenverifier permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenVerifier</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token class-name">JwtConfig</span> jwtConfig<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">JwtTokenVerifier</span><span class="token punctuation">(</span><span class="token class-name">JwtConfig</span> jwtConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jwtConfig <span class="token operator">=</span> jwtConfig<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>
      <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> authorizationHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>authorizationHeader<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>authorizationHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> token <span class="token operator">=</span> authorizationHeader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">></span></span> claimsJws <span class="token operator">=</span>
          <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parserBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>jwtConfig<span class="token punctuation">.</span><span class="token function">getSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Claims</span> body <span class="token operator">=</span> claimsJws<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> authorities <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"authorities"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">></span></span> simpleGrantedAuthorities <span class="token operator">=</span>
          authorities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SimpleGrantedAuthority</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> 
          <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> simpleGrantedAuthorities<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
      <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JwtException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Token %s cannot be trusted"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<ol>
<li>创建一个 <code class="language-text">UsernamePasswordAuthenticationToken</code> 注意，这里的第一个参数未必要 String 的，可以是任意类型的，这里只是一个 String 为例了</li>
<li>把 <code class="language-text">Authentication</code> 传递给 <code class="language-text">SecurityContextHolder</code> 之后同一线程下就可以获取它并做进一步的权限验证了</li>
</ol>
<h2 id="参考资料" style="position:relative;">参考资料<a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" aria-label="参考资料 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>感觉最有用的就是这里的视频呢...</p>
<ol>
<li><a href="https://www.youtube.com/watch?v=caCJAJC41Rk">How Spring Security Authentication works - Java Brains</a></li>
<li><a href="https://www.youtube.com/watch?v=her_7pa0vrg">Spring Security - FULL COURSE</a></li>
</ol></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/graphql-connection-specification">GraphQL Cursor 分页</a></h1><h2 class="text-gray-600 mb-4">2021 March-21</h2><div class="blog-post-content"><p>GraphQL 之前已经夸了不少了，见 <a href="/rest-vs-graphql">REST vs GraphQL</a>，确实在<strong>标准化</strong>方面远超 REST 了，这也是我想要切换到 GraphQL 的一大原因。不过 GraphQL 甚至连分页也提了一个标准，挺有意思的，看了看他们的 <a href="https://relay.dev/graphql/connections.htm">GraphQL Cursor Connections Specification</a> ，想做一些自己理解的记录。</p>
<p>这样标准化的好处就是可以让前端也有一个类似的组件去处理分页，让这部分的工作就直接通过这个公共组件给覆盖了。想象一下，如果有更多的东西可以以这种方式形成标准，那相当于不少工作也就可以复用了呢？</p>
<p>分页这个东西虽然没有这样子如此明确的标准，但其实从各种文档、书籍、博客里也都逐渐形成了类似的标准了呢，毕竟这已经是一个非常古老的需求了。这里我就以最简单的方式介绍目前两种针对不同场景的分页风格，更多的信息可以从下文的参考中找的到。</p>
<h2 id="两种分页方式" style="position:relative;">两种分页方式<a href="#%E4%B8%A4%E7%A7%8D%E5%88%86%E9%A1%B5%E6%96%B9%E5%BC%8F" aria-label="两种分页方式 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<h3 id="limit-offset-分页" style="position:relative;">limit offset 分页<a href="#limit-offset-%E5%88%86%E9%A1%B5" aria-label="limit offset 分页 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>对于记录不多并且增删不频繁的场景，<code class="language-text">limit-offset</code> 的方式基本是最健全的分页了。通过从数据库的 <code class="language-text">select * from xx limit xxx offset xxx</code> 配合 <code class="language-text">select count(*) from xx</code> 可以获取非常全面的分页信息以及动作：</p>
<ul>
<li>一共多少页</li>
<li>当前是第几页</li>
<li>去下一页</li>
<li>去上一页</li>
<li>去第一页</li>
<li>去最后一页</li>
</ul>
<p>但缺点也很明确：offset 这个语法对数据记录多的场景不友好，查询速度会明显下降，同时对快速变化的数据也不友好，很容易丢查询数据。</p>
<h3 id="cursor-limit-分页" style="position:relative;">cursor limit 分页<a href="#cursor-limit-%E5%88%86%E9%A1%B5" aria-label="cursor limit 分页 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p><code class="language-text">cursor-limit</code> 分页则是以类似于 <code class="language-text">select * from xxx where cursor &lt; xxx order by cursor limit xx</code> 的方式获取相对于 <code class="language-text">cursor</code> 的记录。相对于 <code class="language-text">limit-offset</code> 的方式会<strong>很难</strong>获取以下信息：</p>
<ul>
<li>一共多少页</li>
<li>当前是第几页</li>
<li>去最后一页</li>
</ul>
<h2 id="graphql-cursor-connection-标准的一些细节" style="position:relative;">graphql cursor connection 标准的一些细节<a href="#graphql-cursor-connection-%E6%A0%87%E5%87%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82" aria-label="graphql cursor connection 标准的一些细节 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<h3 id="保留字段" style="position:relative;">保留字段<a href="#%E4%BF%9D%E7%95%99%E5%AD%97%E6%AE%B5" aria-label="保留字段 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>GraphQL 定义凡事以 <code class="language-text">Connection</code> 结尾的结构都遵循 <code class="language-text">Cursor Connection</code> 的数据结构，并且名为 <code class="language-text">PageInfo</code> 的东西都是 <code class="language-text">Cursor Connection</code> 下的 <code class="language-text">PageInfo</code> 结构。</p>
<h3 id="查询参数" style="position:relative;">查询参数<a href="#%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0" aria-label="查询参数 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p><code class="language-text">first after</code> 与 <code class="language-text">last before</code> 必须分组出现，也就是说可以是以下几种形式:</p>
<ol>
<li><code class="language-text">articles(first: Int!, after: String!)</code></li>
<li><code class="language-text">articles(last: Int!, before: String!)</code></li>
<li><code class="language-text">articles(first: Int, after: String, last: Int, before: String)</code></li>
</ol>
<p>第三种就是同时支持正序和倒序查找，也就是支持向前翻页。</p>
<h3 id="具体算法和实施" style="position:relative;">具体算法和实施<a href="#%E5%85%B7%E4%BD%93%E7%AE%97%E6%B3%95%E5%92%8C%E5%AE%9E%E6%96%BD" aria-label="具体算法和实施 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>这里就按照 <code class="language-text">first after</code> 为例子做介绍了，<code class="language-text">last before</code> 都是反过来的，就不复读机了：</p>
<ol>
<li>首先查询的时候按照 <code class="language-text">after + 1</code> 去查询，如果返回的个数为 <code class="language-text">after + 1</code> 那就意味着有下一页（hasNextPage），否则就是没有。</li>
<li>如果还要考虑判断 <code class="language-text">hasPreviousPage</code> 那意味着每次都多一个查询 <code class="language-text">select * from xxx where cursor &lt; #{startCursor} limit 1</code>，如果有结果就意味着返回 <code class="language-text">true</code>。</li>
<li>当然对很多自动加载下一页的场景就不考虑往前翻页了，这个就直接全部 <code class="language-text">false</code> 就好了。</li>
</ol>
<h2 id="最后" style="position:relative;">最后<a href="#%E6%9C%80%E5%90%8E" aria-label="最后 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>最近把 <a href="https://github.com/gothinkster/spring-boot-realworld-example-app">realworld-example-app</a> 改写的差不多了，已经同时支持 GraphQL 和 REST 了，其中 GraphQL 部分的分页也是按照 <code class="language-text">cursor connection</code> 的形式做的，然后我需要找个前端的 RealWorld 项目去对接下，看看我这个分页折腾的对不对了。</p>
<h2 id="参考" style="position:relative;">参考<a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ul>
<li><a href="https://medium.com/swlh/how-to-implement-cursor-pagination-like-a-pro-513140b65f32">How to Implement Cursor Pagination Like a Pro</a></li>
<li><a href="https://uxdesign.cc/why-facebook-says-cursor-pagination-is-the-greatest-d6b98d86b6c0">Is offset pagination dead? Why cursor pagination is taking over</a></li>
<li><a href="https://graphql.org/learn/pagination/">GraphQL Pagination</a></li>
</ul></div></div><div class="flex justify-center mt-8"><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/2">Next</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/page/1";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f53e78942ac2ddb4ecf0.js"],"app":["/app-7172dabcafa34b87636a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-66993b9f94f8c62f0827.js"],"component---src-pages-about-js":["/component---src-pages-about-js-693c80a0972b77ff60e6.js"],"component---src-pages-archive-js":["/component---src-pages-archive-js-6f4194b64c9f2aea9d16.js"],"component---src-pages-index-js":["/component---src-pages-index-js-27a14a6666e932854dfc.js"],"component---src-templates-blog-js":["/component---src-templates-blog-js-8584aaf113e5c2a5c191.js"],"component---src-templates-blogs-js":["/component---src-templates-blogs-js-4995d0944825796984cb.js"]};/*]]>*/</script><script src="/polyfill-f53e78942ac2ddb4ecf0.js" nomodule=""></script><script src="/component---src-templates-blogs-js-4995d0944825796984cb.js" async=""></script><script src="/app-7172dabcafa34b87636a.js" async=""></script><script src="/framework-e728256d7a1d703d32c2.js" async=""></script><script src="/webpack-runtime-276957d512995944f9b0.js" async=""></script></body></html>
<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.2.0"/><meta name="description" content="来自 Eisen 的开发日志" data-gatsby-head="true"/><meta name="image" content="https://blog.aisensiy.me/icon.jpg" data-gatsby-head="true"/><meta property="og:url" content="https://blog.aisensiy.me/page/2/" data-gatsby-head="true"/><meta property="og:title" content="eisen-s-blog" data-gatsby-head="true"/><meta property="og:description" content="来自 Eisen 的开发日志" data-gatsby-head="true"/><meta property="og:image" content="https://blog.aisensiy.me/icon.jpg" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta name="twitter:creator" content="eisenxu1727" data-gatsby-head="true"/><meta name="twitter:title" content="eisen-s-blog" data-gatsby-head="true"/><meta name="twitter:description" content="来自 Eisen 的开发日志" data-gatsby-head="true"/><meta name="twitter:image" content="https://blog.aisensiy.me/icon.jpg" data-gatsby-head="true"/><style data-href="/styles.1c8b6c4082ef4143c694.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*
! tailwindcss v3.2.4 | MIT License | https://tailwindcss.com
*/*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}:after,:before{--tw-content:""}html{-webkit-text-size-adjust:100%;font-feature-settings:normal;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{line-height:inherit;margin:0}hr{border-top-width:1px;color:inherit;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{color:inherit;font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;margin:0;padding:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]{display:none}*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }.prose{color:var(--tw-prose-body);max-width:65ch}.prose :where([class~=lead]):not(:where([class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-bottom:1.2em;margin-top:1.2em}.prose :where(a):not(:where([class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}.prose :where(strong):not(:where([class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}.prose :where(a strong):not(:where([class~=not-prose] *)){color:inherit}.prose :where(blockquote strong):not(:where([class~=not-prose] *)){color:inherit}.prose :where(thead th strong):not(:where([class~=not-prose] *)){color:inherit}.prose :where(ol):not(:where([class~=not-prose] *)){list-style-type:decimal;margin-bottom:1.25em;margin-top:1.25em;padding-left:1.625em}.prose :where(ol[type=A]):not(:where([class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a]):not(:where([class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=A s]):not(:where([class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a s]):not(:where([class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=I]):not(:where([class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i]):not(:where([class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type=I s]):not(:where([class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i s]):not(:where([class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type="1"]):not(:where([class~=not-prose] *)){list-style-type:decimal}.prose :where(ul):not(:where([class~=not-prose] *)){list-style-type:disc;margin-bottom:1.25em;margin-top:1.25em;padding-left:1.625em}.prose :where(ol>li):not(:where([class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}.prose :where(ul>li):not(:where([class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}.prose :where(hr):not(:where([class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-bottom:3em;margin-top:3em}.prose :where(blockquote):not(:where([class~=not-prose] *)){border-left-color:var(--tw-prose-quote-borders);border-left-width:.25rem;color:var(--tw-prose-quotes);font-style:italic;font-weight:500;margin-bottom:1.6em;margin-top:1.6em;padding-left:1em;quotes:"\201C""\201D""\2018""\2019"}.prose :where(blockquote p:first-of-type):not(:where([class~=not-prose] *)):before{content:open-quote}.prose :where(blockquote p:last-of-type):not(:where([class~=not-prose] *)):after{content:close-quote}.prose :where(h1):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-size:2.25em;font-weight:800;line-height:1.1111111;margin-bottom:.8888889em;margin-top:0}.prose :where(h1 strong):not(:where([class~=not-prose] *)){color:inherit;font-weight:900}.prose :where(h2):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.5em;font-weight:700;line-height:1.3333333;margin-bottom:1em;margin-top:2em}.prose :where(h2 strong):not(:where([class~=not-prose] *)){color:inherit;font-weight:800}.prose :where(h3):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.25em;font-weight:600;line-height:1.6;margin-bottom:.6em;margin-top:1.6em}.prose :where(h3 strong):not(:where([class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(h4):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;line-height:1.5;margin-bottom:.5em;margin-top:1.5em}.prose :where(h4 strong):not(:where([class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(img):not(:where([class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(figure>*):not(:where([class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(figcaption):not(:where([class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose :where(code):not(:where([class~=not-prose] *)){color:var(--tw-prose-code);font-size:.875em;font-weight:600}.prose :where(code):not(:where([class~=not-prose] *)):before{content:"`"}.prose :where(code):not(:where([class~=not-prose] *)):after{content:"`"}.prose :where(a code):not(:where([class~=not-prose] *)){color:inherit}.prose :where(h1 code):not(:where([class~=not-prose] *)){color:inherit}.prose :where(h2 code):not(:where([class~=not-prose] *)){color:inherit;font-size:.875em}.prose :where(h3 code):not(:where([class~=not-prose] *)){color:inherit;font-size:.9em}.prose :where(h4 code):not(:where([class~=not-prose] *)){color:inherit}.prose :where(blockquote code):not(:where([class~=not-prose] *)){color:inherit}.prose :where(thead th code):not(:where([class~=not-prose] *)){color:inherit}.prose :where(pre):not(:where([class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);border-radius:.375rem;color:var(--tw-prose-pre-code);font-size:.875em;font-weight:400;line-height:1.7142857;margin-bottom:1.7142857em;margin-top:1.7142857em;overflow-x:auto;padding:.8571429em 1.1428571em}.prose :where(pre code):not(:where([class~=not-prose] *)){background-color:transparent;border-radius:0;border-width:0;color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;padding:0}.prose :where(pre code):not(:where([class~=not-prose] *)):before{content:none}.prose :where(pre code):not(:where([class~=not-prose] *)):after{content:none}.prose :where(table):not(:where([class~=not-prose] *)){font-size:.875em;line-height:1.7142857;margin-bottom:2em;margin-top:2em;table-layout:auto;text-align:left;width:100%}.prose :where(thead):not(:where([class~=not-prose] *)){border-bottom-color:var(--tw-prose-th-borders);border-bottom-width:1px}.prose :where(thead th):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;padding-bottom:.5714286em;padding-left:.5714286em;padding-right:.5714286em;vertical-align:bottom}.prose :where(tbody tr):not(:where([class~=not-prose] *)){border-bottom-color:var(--tw-prose-td-borders);border-bottom-width:1px}.prose :where(tbody tr:last-child):not(:where([class~=not-prose] *)){border-bottom-width:0}.prose :where(tbody td):not(:where([class~=not-prose] *)){vertical-align:baseline}.prose :where(tfoot):not(:where([class~=not-prose] *)){border-top-color:var(--tw-prose-th-borders);border-top-width:1px}.prose :where(tfoot td):not(:where([class~=not-prose] *)){vertical-align:top}.prose{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:rgba(0,0,0,.5);--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}.prose :where(p):not(:where([class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where(video):not(:where([class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(figure):not(:where([class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(li):not(:where([class~=not-prose] *)){margin-bottom:.5em;margin-top:.5em}.prose :where(ol>li):not(:where([class~=not-prose] *)){padding-left:.375em}.prose :where(ul>li):not(:where([class~=not-prose] *)){padding-left:.375em}.prose :where(.prose>ul>li p):not(:where([class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(.prose>ul>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ul>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.25em}.prose :where(.prose>ol>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ol>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.25em}.prose :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(hr+*):not(:where([class~=not-prose] *)){margin-top:0}.prose :where(h2+*):not(:where([class~=not-prose] *)){margin-top:0}.prose :where(h3+*):not(:where([class~=not-prose] *)){margin-top:0}.prose :where(h4+*):not(:where([class~=not-prose] *)){margin-top:0}.prose :where(thead th:first-child):not(:where([class~=not-prose] *)){padding-left:0}.prose :where(thead th:last-child):not(:where([class~=not-prose] *)){padding-right:0}.prose :where(tbody td,tfoot td):not(:where([class~=not-prose] *)){padding:.5714286em}.prose :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose] *)){padding-left:0}.prose :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose] *)){padding-right:0}.prose :where(.prose>:first-child):not(:where([class~=not-prose] *)){margin-top:0}.prose :where(.prose>:last-child):not(:where([class~=not-prose] *)){margin-bottom:0}.prose-blog{--tw-prose-links:#0d9488;--tw-prose-code:#be123c;--tw-prose-invert-links:#5eead4;--tw-prose-invert-code:#fda4af}body{background-color:rgb(255 255 255/var(--tw-bg-opacity));transition-duration:.5s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.dark body,body{--tw-bg-opacity:1}.dark body{background-color:rgb(55 65 81/var(--tw-bg-opacity))}.main .permalink{fill:currentColor;--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity))}.dark .main .permalink{--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity))}.main{color:rgb(31 41 55/var(--tw-text-opacity))}.dark .main,.main{--tw-text-opacity:1}.dark .main{color:rgb(229 231 235/var(--tw-text-opacity))}.main h1{font-size:1.875rem;font-weight:800;letter-spacing:-.025em;line-height:2.25rem;margin-bottom:1rem;margin-top:2rem}@media (min-width:768px){.main h1{font-size:2.25rem;line-height:2.5rem}}@media (min-width:1280px){.main h1{font-size:3rem;line-height:1}}.main h2{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity));margin-bottom:1rem}.dark .main h2{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity))}.main{overflow-wrap:break-word}.table-of-content ol,.table-of-content ul{margin-bottom:1rem;margin-left:1rem}.table-of-content ul{list-style-type:disc}.table-of-content ol{list-style-position:inside;list-style-type:decimal}.table-of-content{--tw-border-opacity:1;--tw-bg-opacity:1;background-color:rgb(191 219 254/var(--tw-bg-opacity));border-color:rgb(59 130 246/var(--tw-border-opacity));border-width:1px;display:inline-block;margin-bottom:1rem;margin-top:1rem;overflow:auto;padding:1rem}.dark .table-of-content{--tw-border-opacity:1;--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity));border-color:rgb(30 64 175/var(--tw-border-opacity))}.table-of-content a{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity))}.table-of-content a:hover{text-decoration-line:underline}.dark .table-of-content a{--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity))}.table-of-content ul{margin-bottom:0}.table-of-content h2{font-size:1.25rem;font-weight:600;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem}.table-of-content p{display:inline;margin:0}.gatsby-highlight-code-line{--tw-bg-opacity:1!important;background-color:rgb(55 65 81/var(--tw-bg-opacity))!important}.bottom-0{bottom:0}.m-0{margin:0}.mx-auto{margin-left:auto;margin-right:auto}.mx-12{margin-left:3rem;margin-right:3rem}.my-4{margin-bottom:1rem;margin-top:1rem}.mx-4{margin-left:1rem;margin-right:1rem}.mr-1{margin-right:.25rem}.mt-8{margin-top:2rem}.mb-4{margin-bottom:1rem}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.h-5{height:1.25rem}.w-5{width:1.25rem}.w-32{width:8rem}.max-w-none{max-width:none}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.list-decimal{list-style-type:decimal}.flex-row{flex-direction:row}.justify-center{justify-content:center}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(2rem*var(--tw-space-y-reverse));margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)))}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(.25rem*var(--tw-space-y-reverse));margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)))}.overflow-auto{overflow:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rounded{border-radius:.25rem}.border{border-width:1px}.border-solid{border-style:solid}.border-gray-800{--tw-border-opacity:1;border-color:rgb(31 41 55/var(--tw-border-opacity))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity))}.bg-rose-200{--tw-bg-opacity:1;background-color:rgb(254 205 211/var(--tw-bg-opacity))}.bg-gray-900{--tw-bg-opacity:1;background-color:rgb(17 24 39/var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity))}.bg-blue-200{--tw-bg-opacity:1;background-color:rgb(191 219 254/var(--tw-bg-opacity))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81/var(--tw-bg-opacity))}.fill-current{fill:currentColor}.p-4{padding:1rem}.py-1{padding-bottom:.25rem;padding-top:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-12{padding-bottom:3rem;padding-top:3rem}.px-4{padding-left:1rem;padding-right:1rem}.text-center{text-align:center}.font-serif{font-family:ui-serif,Georgia,Cambria,Times New Roman,Times,serif}.text-xs{font-size:.75rem;line-height:1rem}.text-6xl{font-size:3.75rem;line-height:1}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-semibold{font-weight:600}.font-black{font-weight:900}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.leading-7{line-height:1.75rem}.tracking-tight{letter-spacing:-.025em}.text-rose-700{--tw-text-opacity:1;color:rgb(190 18 60/var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity))}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-duration:.15s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.last\:mr-0:last-child{margin-right:0}.hover\:underline:hover{text-decoration-line:underline}.prose-p\:leading-normal :is(:where(p):not(:where([class~=not-prose] *))){line-height:1.5}.prose-blockquote\:leading-tight :is(:where(blockquote):not(:where([class~=not-prose] *))){line-height:1.25}.prose-li\:leading-tight :is(:where(li):not(:where([class~=not-prose] *))){line-height:1.25}.dark .dark\:border-blue-800{--tw-border-opacity:1;border-color:rgb(30 64 175/var(--tw-border-opacity))}.dark .dark\:bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81/var(--tw-bg-opacity))}.dark .dark\:prose-invert{--tw-prose-body:var(--tw-prose-invert-body);--tw-prose-headings:var(--tw-prose-invert-headings);--tw-prose-lead:var(--tw-prose-invert-lead);--tw-prose-links:var(--tw-prose-invert-links);--tw-prose-bold:var(--tw-prose-invert-bold);--tw-prose-counters:var(--tw-prose-invert-counters);--tw-prose-bullets:var(--tw-prose-invert-bullets);--tw-prose-hr:var(--tw-prose-invert-hr);--tw-prose-quotes:var(--tw-prose-invert-quotes);--tw-prose-quote-borders:var(--tw-prose-invert-quote-borders);--tw-prose-captions:var(--tw-prose-invert-captions);--tw-prose-code:var(--tw-prose-invert-code);--tw-prose-pre-code:var(--tw-prose-invert-pre-code);--tw-prose-pre-bg:var(--tw-prose-invert-pre-bg);--tw-prose-th-borders:var(--tw-prose-invert-th-borders);--tw-prose-td-borders:var(--tw-prose-invert-td-borders)}.dark .dark\:text-gray-200{--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity))}@media (min-width:768px){.md\:fixed{position:fixed}.md\:absolute{position:absolute}.md\:ml-80{margin-left:20rem}.md\:h-full{height:100%}.md\:w-80{width:20rem}.md\:max-w-6xl{max-width:72rem}.md\:p-8{padding:2rem}.md\:text-left{text-align:left}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}@media (min-width:1024px){.lg\:prose-lg{font-size:1.125rem;line-height:1.7777778}.lg\:prose-lg :where(p):not(:where([class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.lg\:prose-lg :where([class~=lead]):not(:where([class~=not-prose] *)){font-size:1.2222222em;line-height:1.4545455;margin-bottom:1.0909091em;margin-top:1.0909091em}.lg\:prose-lg :where(blockquote):not(:where([class~=not-prose] *)){margin-bottom:1.6666667em;margin-top:1.6666667em;padding-left:1em}.lg\:prose-lg :where(h1):not(:where([class~=not-prose] *)){font-size:2.6666667em;line-height:1;margin-bottom:.8333333em;margin-top:0}.lg\:prose-lg :where(h2):not(:where([class~=not-prose] *)){font-size:1.6666667em;line-height:1.3333333;margin-bottom:1.0666667em;margin-top:1.8666667em}.lg\:prose-lg :where(h3):not(:where([class~=not-prose] *)){font-size:1.3333333em;line-height:1.5;margin-bottom:.6666667em;margin-top:1.6666667em}.lg\:prose-lg :where(h4):not(:where([class~=not-prose] *)){line-height:1.5555556;margin-bottom:.4444444em;margin-top:1.7777778em}.lg\:prose-lg :where(img):not(:where([class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.lg\:prose-lg :where(video):not(:where([class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.lg\:prose-lg :where(figure):not(:where([class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.lg\:prose-lg :where(figure>*):not(:where([class~=not-prose] *)){margin-bottom:0;margin-top:0}.lg\:prose-lg :where(figcaption):not(:where([class~=not-prose] *)){font-size:.8888889em;line-height:1.5;margin-top:1em}.lg\:prose-lg :where(code):not(:where([class~=not-prose] *)){font-size:.8888889em}.lg\:prose-lg :where(h2 code):not(:where([class~=not-prose] *)){font-size:.8666667em}.lg\:prose-lg :where(h3 code):not(:where([class~=not-prose] *)){font-size:.875em}.lg\:prose-lg :where(pre):not(:where([class~=not-prose] *)){border-radius:.375rem;font-size:.8888889em;line-height:1.75;margin-bottom:2em;margin-top:2em;padding:1em 1.5em}.lg\:prose-lg :where(ol):not(:where([class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-left:1.5555556em}.lg\:prose-lg :where(ul):not(:where([class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-left:1.5555556em}.lg\:prose-lg :where(li):not(:where([class~=not-prose] *)){margin-bottom:.6666667em;margin-top:.6666667em}.lg\:prose-lg :where(ol>li):not(:where([class~=not-prose] *)){padding-left:.4444444em}.lg\:prose-lg :where(ul>li):not(:where([class~=not-prose] *)){padding-left:.4444444em}.lg\:prose-lg :where(.lg\:prose-lg>ul>li p):not(:where([class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.lg\:prose-lg :where(.lg\:prose-lg>ul>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.3333333em}.lg\:prose-lg :where(.lg\:prose-lg>ul>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.3333333em}.lg\:prose-lg :where(.lg\:prose-lg>ol>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.3333333em}.lg\:prose-lg :where(.lg\:prose-lg>ol>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.3333333em}.lg\:prose-lg :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.lg\:prose-lg :where(hr):not(:where([class~=not-prose] *)){margin-bottom:3.1111111em;margin-top:3.1111111em}.lg\:prose-lg :where(hr+*):not(:where([class~=not-prose] *)){margin-top:0}.lg\:prose-lg :where(h2+*):not(:where([class~=not-prose] *)){margin-top:0}.lg\:prose-lg :where(h3+*):not(:where([class~=not-prose] *)){margin-top:0}.lg\:prose-lg :where(h4+*):not(:where([class~=not-prose] *)){margin-top:0}.lg\:prose-lg :where(table):not(:where([class~=not-prose] *)){font-size:.8888889em;line-height:1.5}.lg\:prose-lg :where(thead th):not(:where([class~=not-prose] *)){padding-bottom:.75em;padding-left:.75em;padding-right:.75em}.lg\:prose-lg :where(thead th:first-child):not(:where([class~=not-prose] *)){padding-left:0}.lg\:prose-lg :where(thead th:last-child):not(:where([class~=not-prose] *)){padding-right:0}.lg\:prose-lg :where(tbody td,tfoot td):not(:where([class~=not-prose] *)){padding:.75em}.lg\:prose-lg :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose] *)){padding-left:0}.lg\:prose-lg :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose] *)){padding-right:0}.lg\:prose-lg :where(.lg\:prose-lg>:first-child):not(:where([class~=not-prose] *)){margin-top:0}.lg\:prose-lg :where(.lg\:prose-lg>:last-child):not(:where([class~=not-prose] *)){margin-bottom:0}}@media (min-width:1280px){.xl\:prose-xl{font-size:1.25rem;line-height:1.8}.xl\:prose-xl :where(p):not(:where([class~=not-prose] *)){margin-bottom:1.2em;margin-top:1.2em}.xl\:prose-xl :where([class~=lead]):not(:where([class~=not-prose] *)){font-size:1.2em;line-height:1.5;margin-bottom:1em;margin-top:1em}.xl\:prose-xl :where(blockquote):not(:where([class~=not-prose] *)){margin-bottom:1.6em;margin-top:1.6em;padding-left:1.0666667em}.xl\:prose-xl :where(h1):not(:where([class~=not-prose] *)){font-size:2.8em;line-height:1;margin-bottom:.8571429em;margin-top:0}.xl\:prose-xl :where(h2):not(:where([class~=not-prose] *)){font-size:1.8em;line-height:1.1111111;margin-bottom:.8888889em;margin-top:1.5555556em}.xl\:prose-xl :where(h3):not(:where([class~=not-prose] *)){font-size:1.5em;line-height:1.3333333;margin-bottom:.6666667em;margin-top:1.6em}.xl\:prose-xl :where(h4):not(:where([class~=not-prose] *)){line-height:1.6;margin-bottom:.6em;margin-top:1.8em}.xl\:prose-xl :where(img):not(:where([class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.xl\:prose-xl :where(video):not(:where([class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.xl\:prose-xl :where(figure):not(:where([class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.xl\:prose-xl :where(figure>*):not(:where([class~=not-prose] *)){margin-bottom:0;margin-top:0}.xl\:prose-xl :where(figcaption):not(:where([class~=not-prose] *)){font-size:.9em;line-height:1.5555556;margin-top:1em}.xl\:prose-xl :where(code):not(:where([class~=not-prose] *)){font-size:.9em}.xl\:prose-xl :where(h2 code):not(:where([class~=not-prose] *)){font-size:.8611111em}.xl\:prose-xl :where(h3 code):not(:where([class~=not-prose] *)){font-size:.9em}.xl\:prose-xl :where(pre):not(:where([class~=not-prose] *)){border-radius:.5rem;font-size:.9em;line-height:1.7777778;margin-bottom:2em;margin-top:2em;padding:1.1111111em 1.3333333em}.xl\:prose-xl :where(ol):not(:where([class~=not-prose] *)){margin-bottom:1.2em;margin-top:1.2em;padding-left:1.6em}.xl\:prose-xl :where(ul):not(:where([class~=not-prose] *)){margin-bottom:1.2em;margin-top:1.2em;padding-left:1.6em}.xl\:prose-xl :where(li):not(:where([class~=not-prose] *)){margin-bottom:.6em;margin-top:.6em}.xl\:prose-xl :where(ol>li):not(:where([class~=not-prose] *)){padding-left:.4em}.xl\:prose-xl :where(ul>li):not(:where([class~=not-prose] *)){padding-left:.4em}.xl\:prose-xl :where(.xl\:prose-xl>ul>li p):not(:where([class~=not-prose] *)){margin-bottom:.8em;margin-top:.8em}.xl\:prose-xl :where(.xl\:prose-xl>ul>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.2em}.xl\:prose-xl :where(.xl\:prose-xl>ul>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.2em}.xl\:prose-xl :where(.xl\:prose-xl>ol>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.2em}.xl\:prose-xl :where(.xl\:prose-xl>ol>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.2em}.xl\:prose-xl :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose] *)){margin-bottom:.8em;margin-top:.8em}.xl\:prose-xl :where(hr):not(:where([class~=not-prose] *)){margin-bottom:2.8em;margin-top:2.8em}.xl\:prose-xl :where(hr+*):not(:where([class~=not-prose] *)){margin-top:0}.xl\:prose-xl :where(h2+*):not(:where([class~=not-prose] *)){margin-top:0}.xl\:prose-xl :where(h3+*):not(:where([class~=not-prose] *)){margin-top:0}.xl\:prose-xl :where(h4+*):not(:where([class~=not-prose] *)){margin-top:0}.xl\:prose-xl :where(table):not(:where([class~=not-prose] *)){font-size:.9em;line-height:1.5555556}.xl\:prose-xl :where(thead th):not(:where([class~=not-prose] *)){padding-bottom:.8888889em;padding-left:.6666667em;padding-right:.6666667em}.xl\:prose-xl :where(thead th:first-child):not(:where([class~=not-prose] *)){padding-left:0}.xl\:prose-xl :where(thead th:last-child):not(:where([class~=not-prose] *)){padding-right:0}.xl\:prose-xl :where(tbody td,tfoot td):not(:where([class~=not-prose] *)){padding:.8888889em .6666667em}.xl\:prose-xl :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose] *)){padding-left:0}.xl\:prose-xl :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose] *)){padding-right:0}.xl\:prose-xl :where(.xl\:prose-xl>:first-child):not(:where([class~=not-prose] *)){margin-top:0}.xl\:prose-xl :where(.xl\:prose-xl>:last-child):not(:where([class~=not-prose] *)){margin-bottom:0}.xl\:text-5xl{font-size:3rem;line-height:1}}</style><title data-gatsby-head="true">eisen-s-blog</title><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style type="text/css">
    .custom-class.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .custom-class.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .custom-class svg,
    h2 .custom-class svg,
    h3 .custom-class svg,
    h4 .custom-class svg,
    h5 .custom-class svg,
    h6 .custom-class svg {
      visibility: hidden;
    }
    h1:hover .custom-class svg,
    h2:hover .custom-class svg,
    h3:hover .custom-class svg,
    h4:hover .custom-class svg,
    h5:hover .custom-class svg,
    h6:hover .custom-class svg,
    h1 .custom-class:focus svg,
    h2 .custom-class:focus svg,
    h3 .custom-class:focus svg,
    h4 .custom-class:focus svg,
    h5 .custom-class:focus svg,
    h6 .custom-class:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><script async="" defer="" data-website-id="443212e9-fd0b-411e-a523-0d0ec604ee8a" src="https://get.aisensiy.me/umami.js"></script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="md:text-left text-center md:fixed md:w-80 bg-gray-900 md:h-full text-white"><div class="p-4 mx-auto text-center"><button aria-label="Activate Light Mode" title="Activate Light Mode" class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" role="img"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button></div><div class="md:absolute bottom-0 py-12 mx-12 space-y-8"><h1 class="text-6xl font-black font-serif">Eisen&#x27;s Blog</h1><nav><ul class="text-md flex-row"><li><a class="leading-7 block hover:underline" href="/">Home</a></li><li><a class="leading-7 block hover:underline" href="/about/">About</a></li><li><a class="leading-7 block hover:underline" href="/archive/">Archive</a></li><li><a class="leading-7 block hover:underline" href="/tags/">Tags</a></li><li><a class="leading-7 block hover:underline" href="/serials/">Serials</a></li><li><a href="https://github.com/aisensiy" target="_blank" rel="noreferrer" class="leading-7 block hover:underline">GitHub</a></li></ul></nav><footer class="text-gray-400">© <!-- -->2022<!-- -->. All rights reserved.</footer></div></div><div class="md:ml-80 p-4 md:p-8 md:max-w-6xl main"><div><div class=""><div><h1><a href="/unbound-get-started/">unbound 的安装与基础应用</a></h1><h2>2022 December-06</h2><div class="prose prose-blog dark:prose-invert max-w-none lg:prose-lg xl:prose-xl prose-blockquote:leading-tight prose-p:leading-normal prose-li:leading-tight"><p>了解到 unbound 可以用于做本地的 recursive dns server 同时也能支持本地的域名解析，打算用这个东西给内网做域名解析。而用 unbound 有这么两个好处：</p>
<ol>
<li>使用 recursive dns server 可以避免把请求都发给上级的缓存服务器，很大程度上保证了个人隐私，也相对会更安全，当然搭配 pi-hole 这样的东西使用效果更佳 <a href="https://docs.pi-hole.net/guides/dns/unbound/">https://docs.pi-hole.net/guides/dns/unbound/</a></li>
<li>unbound 除了做 recursive dns server 外也能接管内网域名解析，作为一个 authoritative server 使用（当然，它并不是专门做这个的，但是规模比较小的网络是没问题的）</li>
</ol>
<h2 id="unbound-的安装" style="position:relative;">unbound 的安装<a href="#unbound-%E7%9A%84%E5%AE%89%E8%A3%85" aria-label="unbound 的安装 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>以下是在 ubuntu 20.04 的安装流程：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> unbound <span class="token parameter variable">-y</span></code></pre></div>
<h3 id="基础配置" style="position:relative;">基础配置<a href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE" aria-label="基础配置 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>先来一个简单的配置：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">server:
    # can be uncommented if you do not need user privilige protection
    # username: ""

    # can be uncommented if you do not need file access protection
    # chroot: ""

    # location of the trust anchor file that enables DNSSEC. note that
    # the location of this file can be elsewhere
    auto-trust-anchor-file: "/usr/local/etc/unbound/root.key"
    # auto-trust-anchor-file: "/var/lib/unbound/root.key"

    # send minimal amount of information to upstream servers to enhance privacy
    qname-minimisation: yes

    # specify the interface to answer queries from by ip-address.
    interface: 0.0.0.0
    # interface: ::0

    # addresses from the IP range that are allowed to connect to the resolver
    access-control: 192.168.0.0/16 allow
    # access-control: 2001:DB8/64 allow</code></pre></div>
<p>把它放到 <code>/etc/unbound/unbound.conf.d/myunbound.conf</code> 这里，然后 <code>systemctl restart unbound</code> 重启服务。</p>
<h3 id="解决-53-端口冲突的问题" style="position:relative;">解决 53 端口冲突的问题<a href="#%E8%A7%A3%E5%86%B3-53-%E7%AB%AF%E5%8F%A3%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98" aria-label="解决 53 端口冲突的问题 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>不出意外的话，重启 <code>unbound</code> 服务会报错，大概的报错信息是说 53 端口已经被占用了。这个时候可以通过 <code>netstat -tulpn</code> 来查看端口占用情况，发现是 <code>systemd-resolved</code> 占用了 53 端口，简单搜索会找到 <a href="https://unix.stackexchange.com/questions/304050/how-to-avoid-conflicts-between-dnsmasq-and-systemd-resolved">https://unix.stackexchange.com/questions/304050/how-to-avoid-conflicts-between-dnsmasq-and-systemd-resolved</a> 这么一个问题。按照其中内容修改 <code>/etc/systemd/resolved.conf</code> 设置 <code>DNSStubListener=no</code> 并重启 <code>systemd-resolved</code> 服务就可以了。</p>
<h2 id="测试-unbound-是否工作" style="position:relative;">测试 unbound 是否工作<a href="#%E6%B5%8B%E8%AF%95-unbound-%E6%98%AF%E5%90%A6%E5%B7%A5%E4%BD%9C" aria-label="测试 unbound 是否工作 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">dig</span> openbayes.com @127.0.0.1

<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.16</span>.1-Ubuntu <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> openbayes.com @127.0.0.1
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">52191</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">1</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">4096</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>openbayes.com.			IN	A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
openbayes.com.		<span class="token number">600</span>	IN	A	<span class="token number">106.75</span>.109.110

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">1524</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">127.0</span>.0.1<span class="token comment">#53(127.0.0.1)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Sun Dec 04 <span class="token number">14</span>:59:32 CST <span class="token number">2022</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">58</span></code></pre></div>
<p>可以看到第一次很慢，但是第二次由于已经有了缓存，速度会快起来：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">dig</span> openbayes.com @127.0.0.1

<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.16</span>.1-Ubuntu <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> openbayes.com @127.0.0.1
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">26243</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">1</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">4096</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>openbayes.com.			IN	A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
openbayes.com.		<span class="token number">535</span>	IN	A	<span class="token number">106.75</span>.109.110

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">0</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">127.0</span>.0.1<span class="token comment">#53(127.0.0.1)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Sun Dec 04 <span class="token number">15</span>:00:37 CST <span class="token number">2022</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">58</span></code></pre></div>
<h2 id="让-unbound-接管本机的域名解析" style="position:relative;">让 unbound 接管本机的域名解析<a href="#%E8%AE%A9-unbound-%E6%8E%A5%E7%AE%A1%E6%9C%AC%E6%9C%BA%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90" aria-label="让 unbound 接管本机的域名解析 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>上面的 <code>dig</code> 命令需要主动选择 <code>@127.0.0.1</code> 作为域名解析的服务。我们当然是希望默认就使用 <code>unbound</code> 来做域名解析。这里我参考的 unbound 文旦 <a href="https://unbound.docs.nlnetlabs.nl/en/latest/use-cases/home-resolver.html#setting-up-for-a-single-machine">https://unbound.docs.nlnetlabs.nl/en/latest/use-cases/home-resolver.html#setting-up-for-a-single-machine</a> 进行配置。</p>
<p>首先继续修改 <code>/etc/systemd/resolved.conf</code>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[Resolve]
DNS=127.0.0.1
#FallbackDNS=
#Domains=
DNSSEC=yes
#DNSOverTLS=no
#MulticastDNS=no
#LLMNR=no
#Cache=no-negative
DNSStubListener=no
#DNSStubListenerExtra=</code></pre></div>
<p>然后强制更新下 <code>/etc/resolv.conf</code>:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">ln</span> <span class="token parameter variable">-fs</span> /run/systemd/resolve/resolv.conf /etc/resolv.conf</code></pre></div>
<p>最后重启 <code>systemd-resolved</code> 服务：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">systemctl restart systemd-resolved</code></pre></div>
<p>执行 <code>dig</code> 的时候，就默认使用 <code>127.0.0.1#53</code> 了呢。</p>
<p>到此为止，unbound 的基本配置就完成了。</p>
<h2 id="添加-local-zone" style="position:relative;">添加 local-zone<a href="#%E6%B7%BB%E5%8A%A0-local-zone" aria-label="添加 local zone permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>最后就是利用 <code>unbound</code> 所提供的 <code>local-zone</code> 配置实现内网域名解析了：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">server:
    # can be uncommented if you do not need user privilige protection
    # username: ""

    # can be uncommented if you do not need file access protection
    # chroot: ""

    # location of the trust anchor file that enables DNSSEC. note that
    # the location of this file can be elsewhere
    # auto-trust-anchor-file: "/usr/local/etc/unbound/root.key"
    # auto-trust-anchor-file: "/var/lib/unbound/root.key"

    # send minimal amount of information to upstream servers to enhance privacy
    qname-minimisation: yes

    # specify the interface to answer queries from by ip-address.
    interface: 0.0.0.0
    # interface: ::0

    # addresses from the IP range that are allowed to connect to the resolver
    access-control: 192.168.0.0/16 allow
    access-control: 10.23.0.0/16 allow
    # access-control: 2001:DB8/64 allow

    local-zone: "home.lan." static
    local-data: "abc.home.lan. A 127.0.0.1"
    local-data: "bbc.home.lan. A 127.0.0.1"</code></pre></div>
<p><code>dig abc.home.lan</code> 就发现域名指向了 <code>127.0.0.1</code> 了。</p></div></div><hr class="mt-8"/></div><div class=""><div><h1><a href="/amd-3090-half-precision/">记一次 k8s gpu 集群中半精度性能差异引发的系统调优</a></h1><h2>2022 November-17</h2><div class="prose prose-blog dark:prose-invert max-w-none lg:prose-lg xl:prose-xl prose-blockquote:leading-tight prose-p:leading-normal prose-li:leading-tight"><p>最近发现跑 pytorch gpu benchmark 的时候，AMD epyc cpu 下的 rtx 3090 明显要比 intel 下 3090 慢，而且差距挺大的，非常不能理解。折腾了挺长一段时间才最终定位到是因为 cpu 在容器里的调度问题导致的。过程兜兜转转花了不少时间，这里就不说太多了，记录下大体过程和最后调优的措施。</p>
<h2 id="最开始的测试" style="position:relative;">最开始的测试<a href="#%E6%9C%80%E5%BC%80%E5%A7%8B%E7%9A%84%E6%B5%8B%E8%AF%95" aria-label="最开始的测试 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<h3 id="测试脚本" style="position:relative;">测试脚本<a href="#%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC" aria-label="测试脚本 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<ul>
<li>python gpu benchmark: <a href="https://github.com/ryujaehun/pytorch-gpu-benchmark">https://github.com/ryujaehun/pytorch-gpu-benchmark</a></li>
<li>model: <code>models.resnet.__all__[1:]</code> 只测试 resnet 模型</li>
<li>batch size: 64</li>
<li>cpu limit: 12</li>
<li>memory limit: 30G</li>
<li>gpu limit: 1</li>
<li>shm: docker 给 30G 而 k8s 里由于无法直接设置，就给了机器内存的大小</li>
</ul>
<h3 id="nvidia-docker-脚本" style="position:relative;">nvidia docker 脚本<a href="#nvidia-docker-%E8%84%9A%E6%9C%AC" aria-label="nvidia docker 脚本 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> --shm-size<span class="token operator">=</span>30g <span class="token parameter variable">--cpus</span><span class="token operator">=</span><span class="token number">12</span> <span class="token parameter variable">--memory</span><span class="token operator">=</span>30G --
gpus <span class="token string">'"device=1"'</span> uhub.service.ucloud.cn/openbayesruntimes/pytorch:1.9.0-py36-cu111.70</code></pre></div>
<h3 id="两个差异很大的结果" style="position:relative;">两个差异很大的结果<a href="#%E4%B8%A4%E4%B8%AA%E5%B7%AE%E5%BC%82%E5%BE%88%E5%A4%A7%E7%9A%84%E7%BB%93%E6%9E%9C" aria-label="两个差异很大的结果 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<h4 id="intel-平台" style="position:relative;">Intel 平台<a href="#intel-%E5%B9%B3%E5%8F%B0" aria-label="intel 平台 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">start
benchmark start : 2022/11/17 06:15:23
Number of GPUs on current device : 1
CUDA Version : 11.1
Cudnn Version : 8005
Device Name : NVIDIA GeForce RTX 3090
uname_result(system='Linux', node='d1d271bdf102', release='5.4.0-131-generic', version='#147-Ubuntu SMP Fri Oct 14 17:07:22 UTC 2022', machine='x86_64', processor='x86_64')
                     scpufreq(current=1184.1902125, min=800.0, max=3400.0)
                    cpu_count: 80
                    memory_available: 258789797888
Benchmarking Training half precision type resnet18
/usr/local/lib/python3.6/site-packages/torch/nn/functional.py:718: UserWarning: Named tensors and all their associated APIs are an experimental feature and subject to change. Please do not use them for anything important until they are released as stable. (Triggered internally at  /pytorch/c10/core/TensorImpl.h:1156.)
  return torch.max_pool2d(input, kernel_size, stride, padding, dilation, ceil_mode)
resnet18 model average train time : 41.39636039733887ms
Benchmarking Training half precision type resnet34
resnet34 model average train time : 55.32251834869385ms
Benchmarking Training half precision type resnet50
resnet50 model average train time : 92.97645568847656ms
Benchmarking Training half precision type resnet101
resnet101 model average train time : 147.91772842407227ms
Benchmarking Training half precision type resnet152
resnet152 model average train time : 209.90628242492676ms
Benchmarking Training half precision type resnext50_32x4d
resnext50_32x4d model average train time : 132.71542072296143ms
Benchmarking Training half precision type resnext101_32x8d
resnext101_32x8d model average train time : 336.4134645462036ms
Benchmarking Training half precision type wide_resnet50_2
wide_resnet50_2 model average train time : 156.14235401153564ms
Benchmarking Training half precision type wide_resnet101_2
wide_resnet101_2 model average train time : 259.703106880188ms
Benchmarking Inference half precision type resnet18
resnet18 model average inference time : 31.02853298187256ms
Benchmarking Inference half precision type resnet34
resnet34 model average inference time : 39.35199737548828ms
Benchmarking Inference half precision type resnet50
resnet50 model average inference time : 41.26767635345459ms
Benchmarking Inference half precision type resnet101
resnet101 model average inference time : 48.41951370239258ms
Benchmarking Inference half precision type resnet152
resnet152 model average inference time : 67.41719722747803ms
Benchmarking Inference half precision type resnext50_32x4d
resnext50_32x4d model average inference time : 44.739885330200195ms
Benchmarking Inference half precision type resnext101_32x8d
resnext101_32x8d model average inference time : 103.05868148803711ms
Benchmarking Inference half precision type wide_resnet50_2
wide_resnet50_2 model average inference time : 49.078497886657715ms
Benchmarking Inference half precision type wide_resnet101_2
wide_resnet101_2 model average inference time : 83.67201805114746ms
benchmark end : 2022/11/17 06:21:41
end</code></pre></div>
<h4 id="amd-平台" style="position:relative;">AMD 平台<a href="#amd-%E5%B9%B3%E5%8F%B0" aria-label="amd 平台 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">start
benchmark start : 2022/11/17 06:14:11
Number of GPUs on current device : 1
CUDA Version : 11.1
Cudnn Version : 8005
Device Name : NVIDIA GeForce RTX 3090
uname_result(system='Linux', node='925b73b78805', release='5.15.0-43-generic', version='#46-Ubuntu SMP Tue Jul 12 10:30:17 UTC 2022', machine='x86_64', processor='x86_64')
                     scpufreq(current=2784.047382812501, min=1500.0, max=2200.0)
                    cpu_count: 256
                    memory_available: 485026041856
Benchmarking Training half precision type resnet18
/usr/local/lib/python3.6/site-packages/torch/nn/functional.py:718: UserWarning: Named tensors and all their associated APIs are an experimental feature and subject to change. Please do not use them for anything important until they are released as stable. (Triggered internally at  /pytorch/c10/core/TensorImpl.h:1156.)
  return torch.max_pool2d(input, kernel_size, stride, padding, dilation, ceil_mode)
resnet18 model average train time : 75.70790767669678ms
Benchmarking Training half precision type resnet34
resnet34 model average train time : 82.6269006729126ms
Benchmarking Training half precision type resnet50
resnet50 model average train time : 111.1276912689209ms
Benchmarking Training half precision type resnet101
resnet101 model average train time : 161.16506576538086ms
Benchmarking Training half precision type resnet152
resnet152 model average train time : 228.9912509918213ms
Benchmarking Training half precision type resnext50_32x4d
resnext50_32x4d model average train time : 143.40569496154785ms
Benchmarking Training half precision type resnext101_32x8d
resnext101_32x8d model average train time : 354.08830165863037ms
Benchmarking Training half precision type wide_resnet50_2
wide_resnet50_2 model average train time : 164.76832389831543ms
Benchmarking Training half precision type wide_resnet101_2
wide_resnet101_2 model average train time : 271.076135635376ms
Benchmarking Inference half precision type resnet18
resnet18 model average inference time : 63.87866973876953ms
Benchmarking Inference half precision type resnet34
resnet34 model average inference time : 68.00977230072021ms
Benchmarking Inference half precision type resnet50
resnet50 model average inference time : 73.05157661437988ms
Benchmarking Inference half precision type resnet101
resnet101 model average inference time : 81.68745994567871ms
Benchmarking Inference half precision type resnet152
resnet152 model average inference time : 87.46984004974365ms
Benchmarking Inference half precision type resnext50_32x4d
resnext50_32x4d model average inference time : 83.56608867645264ms
Benchmarking Inference half precision type resnext101_32x8d
resnext101_32x8d model average inference time : 108.2996940612793ms
Benchmarking Inference half precision type wide_resnet50_2
wide_resnet50_2 model average inference time : 78.30146789550781ms
Benchmarking Inference half precision type wide_resnet101_2
wide_resnet101_2 model average inference time : 90.06356239318848ms
benchmark end : 2022/11/17 06:23:29
end</code></pre></div>
<p>可以看到，越小的模型性能差异越大，这里就让我非常怀疑是 cpu 的问题。</p>
<h2 id="关注主频" style="position:relative;">关注主频<a href="#%E5%85%B3%E6%B3%A8%E4%B8%BB%E9%A2%91" aria-label="关注主频 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>这里 AMD 的 cpu 是 <a href="https://www.amd.com/en/products/cpu/amd-epyc-7773x">7773x</a> ，64 核心，128 线程，看起来是个 monster 可是这种超多核心的服务器 cpu 的主频相对都低一些，比如这个 Base Clock 是 2.2GHz，Boost Clock 是 3.5GHz。和 Intel 平台的比，差了一点点（那边是 3.8GHz）但这不足以引起如此大的性能差异，同时在通过 <code>cat /proc/cpuinfo</code> 命令查看运行时的主频后也确认很多核心的主频都可以跑到 3.4GHz 的水平，说明没有什么诡异的 BIOS 配置限制了性能的发挥。所以主频不是导致性能差的罪魁祸首。</p>
<h2 id="继续翻阅-amd-的-cpu-调优手册" style="position:relative;">继续翻阅 AMD 的 CPU 调优手册<a href="#%E7%BB%A7%E7%BB%AD%E7%BF%BB%E9%98%85-amd-%E7%9A%84-cpu-%E8%B0%83%E4%BC%98%E6%89%8B%E5%86%8C" aria-label="继续翻阅 amd 的 cpu 调优手册 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>虽然主频没问题，但还是觉得 cpu 哪里不太对，于是开始在 bios 里翻各种配置项目，越翻越懵逼，看不懂那些项目什么意思，就只能通过搜索引擎找到 AMD EPYC CPU 的配置手册，不经意间看到一个 <a href="https://www.amd.com/system/files/documents/container-tuning-guide-kubernetes-amd-epyc7003-series-processors.pdf">Kubernetes Container Tuning Guide for AMD EPYC 7003 Series Processors</a> 这不就是我目前所需要的？在 3.2 Container Pinning Settings 这部分提到默认的调度规则是在所有的 cpu 上做调度：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/decdc5e60d0d898f78237884f3840635/dc333/container-pinning-settings.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 42.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhUlEQVQoz6WRX4vaQBTF8/2/ig/rQ/MkokZQi6tRmlYTNclk8s+ZZKLVtZvEcsqd4rLsQl964ccZuHDunXONn79e8do0WMYp5lECO06x4AkWPMVXxjHc+XBzgd9ti7quUdcNmqZB27Za33O/32H82GwQBAGel0s4mw3c/R5bz4Pn+/i+3SLgHFIpKKVQFIVWKQXKskRRSAghIaXUvevLCwwhJaQQiDlHGAQIwwCHw0G/szSFKktEjCFNU1SVwu12w7/KmM/nsG0bS9vGYvGM2WyG9XqN1WqFb44Dx3F0n9TzPOz3BzAW6l+9h5YQQsDodDrodrt4eurCNL/ANE30ej0Mh0MMBgOtljXS79FohH6/r7EsC9PpFJPJROt4PMZut4NB7owx+L6POI5xPB6RZdknkiTR+siLMqyq6g3K9nq9wsiyXJu5rqsn0LfImDLL81xDQ0jJ6HFNuvJH9JU554iiCCFjWmkTMiQlHhs9IPOPUHY08Hw+wzidTn/XVwqXywX/W38AW6uW7/q11S4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="container pinning settings"
        title="container pinning settings"
        src="/static/decdc5e60d0d898f78237884f3840635/5a190/container-pinning-settings.png"
        srcset="/static/decdc5e60d0d898f78237884f3840635/772e8/container-pinning-settings.png 200w,
/static/decdc5e60d0d898f78237884f3840635/e17e5/container-pinning-settings.png 400w,
/static/decdc5e60d0d898f78237884f3840635/5a190/container-pinning-settings.png 800w,
/static/decdc5e60d0d898f78237884f3840635/dc333/container-pinning-settings.png 938w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>那对于这个双路一共 256 线程的机器来说，调度频繁切换应该会是一个很大的开销吧？这里提到的 <code>static</code> 则是说只在特定的 cpu 里做调度。按照这个关键信息，我翻阅了 <a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/"></a> 知道了 <code>static</code> 规则用的就是 <code>cgroup</code> 的 <code>cpuset</code> 系统。那我是不是可以先用 <code>docker</code> 试试看？</p>
<h2 id="使用-cpuset-命令测试" style="position:relative;">使用 cpuset 命令测试<a href="#%E4%BD%BF%E7%94%A8-cpuset-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95" aria-label="使用 cpuset 命令测试 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker run --rm -it --shm-size=30g --cpuset-cpus 4-15 --cpus=12 --memory=30G --
gpus '"device=1"' uhub.service.ucloud.cn/openbayesruntimes/pytorch:1.9.0-py36-cu111.70</code></pre></div>
<p>这里就是增加了 <code>--cpuset-cpus 4-15</code> 告知 <code>docker</code> 这个容器的可用 cpu 的区间。结果发现性能有了很大的提升，实际速度也超过了 Intel 平台。那么这里就大体确定了是默认调度规则的问题了。</p>
<h2 id="解决-nvidia-docker-与-cpu-调度策略冲突的问题" style="position:relative;">解决 nvidia-docker 与 cpu 调度策略冲突的问题<a href="#%E8%A7%A3%E5%86%B3-nvidia-docker-%E4%B8%8E-cpu-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98" aria-label="解决 nvidia docker 与 cpu 调度策略冲突的问题 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>按照 <a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/">Changing the CPU Manager Policy</a> 我很快对一台机器进行了调整，并准备在 k8s 平台上再做一次 benchmark 结果发现使用 <code>nvidia-smi</code> 命令查看显卡信息的时候报错了：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Failed to initialize NVML: Unknown Error</code></pre></div>
<p>又是一番查询，发现是刚刚使用的 <code>cpu-manager-polcy=static</code> 会和 nvidia-docker 有冲突：容器因为 <code>static</code> 的调度规则必须修改容器的运行时，而这种行为是 nvidia docker 所不支持的。目前的解决方式是<strong>让所有调度 gpu 的 Pod 都必须具备 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Guaranteed 级别的 QoS</a>，同时所有的容器都必须有整数个的 cpu limitation</strong>。对于这种 Pod kubelet 会特殊对待，跳过对其 cpuset 进行更新（因为它锁定了 cpuset 所以按理说也不用更新）。同时这个支持也是在 k8s 1.22 版本之后才支持的。为此我们的集群也不得不升级到了 1.22 版本。</p></div></div><hr class="mt-8"/></div><div class=""><div><h1><a href="/use-owntracks-to-record-my-daily-location-usage/">使用 OwnTracks 记录每天关键地点的停留时间</a></h1><h2>2022 July-18</h2><div class="prose prose-blog dark:prose-invert max-w-none lg:prose-lg xl:prose-xl prose-blockquote:leading-tight prose-p:leading-normal prose-li:leading-tight"><p>众所周知，手机是可以做定位的。我个人比较喜欢做一些 "自我量化" 来追溯具体的时间都去哪里了，那通勤时间和办公室停留时间这种信息自然也很想记录下来。所以在很久之前我就开始各种搜罗，想要找一个方案。但很遗憾，找了一大圈，也没找到一个让我满意的，非常失望，这里记录下之前踩的坑，然后记录下目前找到的一个还可以的方案。</p>
<h2 id="使用-ios-的关键指令shortcuts" style="position:relative;">使用 iOS 的关键指令（shortcuts）<a href="#%E4%BD%BF%E7%94%A8-ios-%E7%9A%84%E5%85%B3%E9%94%AE%E6%8C%87%E4%BB%A4shortcuts" aria-label="使用 ios 的关键指令shortcuts permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>shortcuts 这个东西有点像是一个手机版本的 <a href="https://ifttt.com/">IFTTT</a>。它包含一些触发器，可以自动触发某些事件，然后去串联多个应用以实现一些很 fancy 的功能。常见的触发器包括：</p>
<ol>
<li>地理位置相关的：离开、到达某个区域</li>
<li>时间相关：几点几分到了</li>
<li>wifi 相关：wifi 开启、关闭、自动连接了什么局域网</li>
</ol>
<p>等等等，具体就不细说了。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9c99f29206cc6642ef1a8f5ec78070e6/8efc2/iphone-short-cuts.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 216.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAYAAAB4pah1AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFCUlEQVRIx5VW3U4bRxQ2ISQ3EW8QpDSkym2aCyTehWeI+hyV+hiVKvUOQWibJiKCGjt2RYDaBrsGDMixjfd3dmd2d9Zfdc56Fxtw7Kz0ecazu2fPN3O+c07uwYN5vHz5Eq9evcLy8jLm5uaQy+VmwsOHD/H8+XMsLS1hdXUVi4uLtJ7DD69f49mz7/Do8WMsLDzCwsJCBnppfn6eQfPR9SdPnuDFi+/x9OlTrKysJB9aW1vD+78+oFQsIb/7Nwr5AnZ3U+yhWPwH5fJnRrFYxs7OXnZ/ZyeP9++3sb29i42N3/HmzY/IyRC47APNDnDWTeZRBIQhMBgA1WodhUKJDTebLV6je/QMQesEcQy+cp2ei+aVwEnLw3FLoHEpYFoCliXgOBKVygny+U/Y2/vExmnNNJP7t2EYLnKu68MTNxCuB9tO4cP3IwTBgEFzWnOcSZDI0cR1JXxPwvPC4csxlNK8fvsFWpsEeiZHExXEcBVgWRZqtRoajQbOz89x+xoMBryHdzFgCKGQC6VE7Urjp/UY/X4fR0dHODs7R7PZhFIBtNbwPA8RncCEK45jhucpoiwRxwPE9CX6GV5kwPclj6MGU29Gka6zh0w5jGH5CeXDw0O4rnuvJ/cZS0FOscFgSPnnzRjX19eoVCps0HUFhPAQBAGmXXcoE1UOzBH3bdtho2Twa56NIqHsSARag/zodDr4+HH7DuXRk5xEN6PsuwptKbFnO+h0uzg8OORDILqWZcNxHD7paZTJcEZZRzHAGo2gdYwo0kyXaDuOy+uJF3HmzW3Qe0IMlWLZCch4Ap/dFyLgkdZIctPASqFJRBuvI/gyhJQBlKLxBvSf19TNPFuTNyOFYC5SEuX/ND5WY5i9KxQKRUgp8W3XgMF76Hs+2iawf9KHbfXRu+7D83xcX/fR7xs80uHcKGIco3HIp2zbcvgFINIxxx3dJKmloFOeOQ6J8qeGxocjjX7nAnuFIoQQ30SYTjkLG1/46NjAYcOAbRmwbJu9pJAxTZO9/SaDo5Qplnzfh1KKMSvVMcpaSRTqGu8OQhi9S2xsvMX+/mccHBzckd+05MAGqY70HKDSNODYJkzTgpSK6RJoP23b/qr8Ug8Tys7oKevsVMMwzBJrKrlJiWGMMunP8WO0bcA0+qhUqiiXy1xX8vk8e5d6MRNl4UoINUDbAqTvcxCTUrrdHmcaSmWGYcIwjNkok6BJi1EYDbUbZFAqGtO1UpOQPMdaJoOUICyL6rPiYi4lFagwK/azgrMNpSbKf3RR7mu322i1LvDlS2dMu+l8Uj6kPXQpH0oh0XI0ti5i3rd/j4648lWrVVZMCgr0SbV5LGMT70APILij0pk35C1lGzoYkiGVWIrP+4J8LGySQk96jTmIqWP4Wj6cKj0lNM69c/zW+RXdbhelUom9IopkmMa0g5ipLlMZVTqAF3sIg5AVQi9T7JEMKbBJgmnBvy++0zI7pJyEi+cGcIXKWjPPCxhpoUrbtantHP1QX6gkOPbS3jBBxGMYDhCGMd8j40RtHAGP3HC6bgAVCVjBGdM7Pj7G6ekp6vU694j1+gnvK4USrd2v65FD8YSGpVo46P0CV7icFKhPJGPUJ15cXPBar9fLEsWUzsFHFCZfDIKIY5EiPwhCbjhZ59FNGaCsPgq6l45DLaddgZd1CLSntVoDGxtb2Np6h7dv/8Tm5h88rq9volTa52esW1qnQ/kf+lqKrtEnw2gAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="iphone short cuts"
        title="iphone short cuts"
        src="/static/9c99f29206cc6642ef1a8f5ec78070e6/5a190/iphone-short-cuts.png"
        srcset="/static/9c99f29206cc6642ef1a8f5ec78070e6/772e8/iphone-short-cuts.png 200w,
/static/9c99f29206cc6642ef1a8f5ec78070e6/e17e5/iphone-short-cuts.png 400w,
/static/9c99f29206cc6642ef1a8f5ec78070e6/5a190/iphone-short-cuts.png 800w,
/static/9c99f29206cc6642ef1a8f5ec78070e6/8efc2/iphone-short-cuts.png 828w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>不过很显然，我可以使用那个地理位置的触发器去记录我什么时候离开了哪里、什么时候到达了哪里。比如对于我通勤的记录，那我就设置两个关键地点：家和公司，然后记录离开到达时间就行了。具体就是这么个样子：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e2d7bb4f6a7fb526700ad31b9355c5fb/81315/arrive-company-shortcut.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADuElEQVQ4y5VV21LcRhAVt28IYJL8tfOS5CmpisspyjHFxRCwHVO2H+yAXQQDy9502dVKq9toNDPSSHNSM9rFkOKBzNapbc30HnWf7p61VlaWuuvra/Xi4hKzLIuvrKzw5eVlvrCwYPDo0TpfW/uG67Pvv/uWLy8vGXtxcZEvLbW29tvY2OCrq6vc+vHnX0YHh39hf/9P7O7u48mT3/H06SZ2dl6YvaOXx/j1t2d4/MNP2D04xrOtA+y9OMTW1g42N//A/v4h9vYO8OrVGzx/vg2LlnBZCb2UlECn00e/74BxaTYLDkQUqBrAzwDC0e5ThiTJ2x8qoGnafSsn1IuiGEEwVVmWm8O6VhCiAucCBS0MeEHBMh9dN8WXkcJwQnH2+RSMFWgaBSklKC1gMVZ6/iSA63oqjhOUZQUhSpSVhJQ1GOMoCgHOK/QmEv2wgRNK+B0Hx5cc134bWt0AlNewPHfsZWmOqlJKhz2HTp8QhiwrQLICBauQMGCcAuOkQVXVkNqvNkmbj6xrWM449YajDNE0VH+fnOLt2/d49+49Pn48MSlL2Zj085zBcT2EUYJG4d4lSgWLFMoLE47xaKRev36D7e0dg6Ojl4ZQ61OWEmlK4LkulGpmhbjL+k96jmmRwOp1B95g4ILxRtU17lRtnnKec0M4HNpI0hRpktwhK8sSV0EHKc1gBcHUy+IRGlkYDeu6MVVuddRaSXBRgZAcQeBj7LpwXB85b0BZBS5qpFkOqnWmHFZZll4wvobnXCnf9xEEAcbjMVzXhRCirWDdmNaJoxEGFzauvAZnHnAxamDHwND1EYYT42flOfNc14dte0qnpIUfDGz0en3ovtROWsMoypDEU9hTadoDqpll8xXazxDqHuNcKs4l5hCiBqWibRvCDNK0AEkJ8tmzPrsNQgpYhDBPG4QUavZtMCfS7WKKkqSmyrY9xnSaIk3zmxfdxozQPKj7HMwL8go0HcHpneLTpwucnHzG2dkXM8vzSNOsQBQXDyFkZvQmkykuL6/h+6GR5L6U4+SBhIRw0JzAHvbx4cMp+j3byDDXbS7R/yBkyKkwlXacEcIwNoT/9Ukz9jBCXRhCqGkjSls7STJEUXKzr6HtG8I8Z2oeugEpbhHq9Ii+4uB5IziOizCcIooixHGMJEmgr74sy1rCNgKmGCshxLwXq1lkLSFjDKIUZm41bq+6rlHJGmEmv0ZIqVDDoYvz8ytcXHTMX0F7MbQp60tXlBXKqoYe0W63i16/j6HtgIvSEOqZ/xdrCUtn8lzKhQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="arrive company shortcut"
        title="arrive company shortcut"
        src="/static/e2d7bb4f6a7fb526700ad31b9355c5fb/5a190/arrive-company-shortcut.png"
        srcset="/static/e2d7bb4f6a7fb526700ad31b9355c5fb/772e8/arrive-company-shortcut.png 200w,
/static/e2d7bb4f6a7fb526700ad31b9355c5fb/e17e5/arrive-company-shortcut.png 400w,
/static/e2d7bb4f6a7fb526700ad31b9355c5fb/5a190/arrive-company-shortcut.png 800w,
/static/e2d7bb4f6a7fb526700ad31b9355c5fb/c1b63/arrive-company-shortcut.png 1200w,
/static/e2d7bb4f6a7fb526700ad31b9355c5fb/29007/arrive-company-shortcut.png 1600w,
/static/e2d7bb4f6a7fb526700ad31b9355c5fb/81315/arrive-company-shortcut.png 1656w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>我是每天创建一个笔记本，然后把信息都追加到笔记本里了。</p>
<p>然后似乎大功告成了，可是很遗憾，实际上完全不生效，网上一搜很多相关问题，但就是没解决方案，我尝试了很多的方法都不成功。只有偶尔会成功那么一下下...我甚至咨询了在 Apple 工作的同学，最终也没有得到解决...</p>
<h2 id="owntracks" style="position:relative;">owntracks<a href="#owntracks" aria-label="owntracks permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>iOS 自带方案不行，就只好自己写 app 了，不过很遗憾我并没有移动端开发的经验，所以这个事情就搁置了...直到我一天发现了 owntracks 这个东西。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ec642d3687bb6e37edd09ee325616e40/56e36/owntracks.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 86.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACDklEQVQ4y61RzW8ScRDdvww/oFgMPVS9G+PRkx40VS8ljSJSTEQbkxZi4kGjiy1b2x40Hgye9GZlaaHHAsvH7nLhc3efmSk/uuuC0cRNXub95s28mQFpflXBLFxI5hFJKbi28QlXnu0h/DiPP9UTpFlCZFVBMLGJq+sf8bKgYkX5hlBii/M06J8MRYMwyH2v4Pbbrwg8yPlqphqSKAo4JvMIJ/NYfLqDS+mdycmX07u4mDqt8fRM21AIkdQ2wkkF17OfcfN1geONV19w600Bi+ld1uZT21M39Z0cTrzHXFxmBB++Y4TiOYTGb6ERpp3tMYw8+YAz9zM4v7SGaCyLhVgW55bWELi3jrN3XyC6vIHocgYLsQwCd55j7pHM13gMQ4lNuBGM58abyQjyVvI4J/tw0rPl6ZfUahuEEkOHWtVRqukubjB347TmpNcNCf/5kyzbAcG2HRwfV1FUVVRrNVSOjnBYLuPH/j7KlQrqmsaR9J/FItRSCQcHhzBMEw4Ay7bZQ3IcZ+JOvNfrwbIsDIdD9Pt9DAYD5qPRiDmh2+1yjrht25Ne3lA8qMEt/j5oFqcekaPIhmTWbDbRaDSgaRpzXdf5TWi322i1Wox6vQ7DMJiTRrW0qc+QCkikSAZkSFxEoYkBYqBpmp7LJoZimtjEbUAbEciE8p1Oh41Enn53n6E4Q0wXoMa/+cSf8gvevElJ78MBRAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="owntracks"
        title="owntracks"
        src="/static/ec642d3687bb6e37edd09ee325616e40/5a190/owntracks.png"
        srcset="/static/ec642d3687bb6e37edd09ee325616e40/772e8/owntracks.png 200w,
/static/ec642d3687bb6e37edd09ee325616e40/e17e5/owntracks.png 400w,
/static/ec642d3687bb6e37edd09ee325616e40/5a190/owntracks.png 800w,
/static/ec642d3687bb6e37edd09ee325616e40/c1b63/owntracks.png 1200w,
/static/ec642d3687bb6e37edd09ee325616e40/29007/owntracks.png 1600w,
/static/ec642d3687bb6e37edd09ee325616e40/56e36/owntracks.png 1750w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>简单来说，owntracks 就是个不收集你个人信息，只负责将你的信息上报到你指定的服务器的一个工具。所以其实 owntracks 分为两个部分：</p>
<ol>
<li>app 使用手机的定位功能获取经纬度</li>
<li>server 将 app 上报的信息存下来</li>
</ol>
<h3 id="安装配置-app" style="position:relative;">安装配置 app<a href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-app" aria-label="安装配置 app permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>我最开始的需求很简单，就是周期性记录我的位置，然后周期性上报就好了，后续的数据处理交给服务端做好了。不过 OwnTracks 除了这个朴实的功能外，也有那种区域触发的功能。这样我就可以和 iOS 快捷指令一样关注几个地点就好了。</p>
<p>不过相比于 iOS 这边直接把数据记录到笔记本，我需要一个 track server 接受上报的信息。owntracks 支持两种协议：MQTT 和 HTTP，鉴于我只会 HTTP 就自己写了一个简单的 HTTP server 去接收这些信息了。然后在 app 这边配置下服务端信息就可以接收数据了。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/804202ac9e72326d898a87415ba42d29/8efc2/owntracks-server-config.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 216.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAYAAAB4pah1AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEjElEQVRIx91Xy04jVxBtIbHkL/gQtpMVf8IaVmjYTz6Ax3ZgMxGaQUEziQIJiiISsHgYjME2fmP3+/a73d0nqmq3sQcbG2WXko5u39dx3bpVdcuSsDzc3Nzj8vIGd3dlGIYNy/IghMswzVFk45blQ1FM5HJXuLq6xdevv6LTUSHZlodyqYLi3T0q5SpM04EQGaEH1+3BdUM4TgDPi3iMiIlQlg0mu7+v4OjoBN2uBknTPchGBMWIIesRVN1nDW3bZ21LpUdUq000mx0Ui2WYhs1ztMaxfYRhAt+PkCTgH5VqbQv5ssDfBYF/7gRKDQuKakHVbHS6Bo5//4txdn6N347+RKOpQNMdXkOQFcHoyoL70mNdRb2podFKUW2oqNRS0FzjSTDqLRPNJ4vHKjWFUSZU++AxtqEPTRNQVZMhTBd2/8jUWpbLx6PW0K2+jV2e99wQQRAjDGI+tjAdSDSpKAZDlnVeSLbIbjMDjQ+L5/VYgVKpioeHR7RaXR6XkiRBp9NBu91Gq9VCo9GAEIInaY5A4vs+NjY28O7dD1haWsLi4iIWFhYwNzfHmJ+fx/LyckrYarVRr9fRbDZRLleg6waTxHHCIAnDHj59+olJV1ZWsLa2hg8ffsTHj7vY29vD1tYW3r/fSI9M6pMNyM98Px57ZLLjLCKRk7bbCqrVFprNLkNVBTuvYTh8CQT61jSLo4NsR236LQagvuT7IbpdGbKsot3uMCzLAY17XsDw/QBBEPKxp0EiNavVKmq1Gl+Mqir4L8KEjuMw4fb2NlZXV7G+vo6dnR1sbm5id3cX+/v7uLy8HNz8VELbtiHLMk5PT3FwcIDj42Pk83mcn5/j5OQEuVwO3W53dsJZJY7jgW9OAvvh7e0tH0nTNN4YRRFvHsY0zUY0NE0TruvOvGkqoa7rHFqTJOljZsJnG43aI06SIboU8TQbPuswXvwwQV2J8GREsP3pekrfG3/0ImJ4QYyO0WMIJ+Kx6JU9UvogeS+SwXBScJ0Utp2tnQxODo1Gh18wSqIvF6VJwpjwnA6DxiUKaCEsWJYNx6HM7DBc1+e+5/no9aIXScCh59XrwfHSb2qDLDlUKhXc3OQ5yVKIUdbOQGE5TupqhIYa84U9yhFqSoQo7rsNu0j8nO7TfhodUZwgip5Dbti1su/h9kUsD0j7fd2O8fDUQ1OLoIj4bY49Nkr62mbvS6bJcD/sxYNviXR5fKzg4uKCbXl/X+SEWyqVUCgUBi/ga1LqJDCdiM8lUWoXwoZhCL5t00yRfgu+bbrVIJgMwwrheiHCoJf6IVVSk5BVW6+BqoqBH74WJVlJ9xZIb93wvyJ8zWaz23NC+hpHNhupNFygP6ev0Y3kPuPmLHKpfjtEmPohFUC3tw9DG1KNqBIrl+u4vi6O/N0QfbLriovakwvHTvsjhIVCaeSo5Ki2HSCfL+L0NNdPrLQxzeSa7uKPaxfF+neEaTQ4XGuPHMlKWyrjCMNjlnCh6h5r11Hd8TakxaQF/dEpFB7w5cshDg+/4fDwlwE+f/4ZZ2cXvIZNYqdFfkb4L/XTyxVHq1GLAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="owntracks server config"
        title="owntracks server config"
        src="/static/804202ac9e72326d898a87415ba42d29/5a190/owntracks-server-config.png"
        srcset="/static/804202ac9e72326d898a87415ba42d29/772e8/owntracks-server-config.png 200w,
/static/804202ac9e72326d898a87415ba42d29/e17e5/owntracks-server-config.png 400w,
/static/804202ac9e72326d898a87415ba42d29/5a190/owntracks-server-config.png 800w,
/static/804202ac9e72326d898a87415ba42d29/8efc2/owntracks-server-config.png 828w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>注意这里要配置到具体的某一个路径的，比如 <code>http://112.118.221.2/pub</code> 而不是只给个域名或者 ip 地址就完事了。</p>
<h3 id="编写-track-server" style="position:relative;">编写 track server<a href="#%E7%BC%96%E5%86%99-track-server" aria-label="编写 track server permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<blockquote>
<p>为啥不用官方的？</p>
<p>OwnTracks 有官方的 track server ，但有这么几个问题：</p>
<ol>
<li>代码是 c 的，自己部署有点晦涩难懂，只能用 docker 部署吧，但自己修改的可能性就很小了</li>
<li>同时支持 MQTT 和 HTTP 而实际上我觉得对个人来说 HTTP 会更简单一些吧，那 MQTT 部分的代码就很没必要了</li>
<li>有一些和 Google 地图集成的功能，这些东西在国内统统没得用</li>
</ol>
</blockquote>
<p>OwnTracks 会以 json 的格式把所有的信息都上报到服务器，提交的具体结构可以直接 print 出来看看。这里给出我的 server 的一个片段：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">
<span class="token keyword">import</span> json

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request


FILENAME <span class="token operator">=</span> <span class="token string">"data.jsonl"</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"hello"</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/pub"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># print raw request data</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>json<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">,</span> <span class="token string">"ab"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"\n"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"done"</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting server..."</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span></code></pre></div>
<p>可以看到我就是把所有的数据到塞到了一个 <code>data.jsonl</code> 的文件里了，反正就是我自己的数据，没几条，这样就够了。</p>
<h3 id="展示数据" style="position:relative;">展示数据<a href="#%E5%B1%95%E7%A4%BA%E6%95%B0%E6%8D%AE" aria-label="展示数据 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>有了这些数据，我就可以把每天的通勤给按照时间顺序展示出来了，代码如下：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">]</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>item <span class="token keyword">for</span> item <span class="token keyword">in</span> data <span class="token keyword">if</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"leave"</span><span class="token punctuation">,</span> <span class="token string">"enter"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    chinaTz <span class="token operator">=</span> pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span><span class="token string">"Asia/Shanghai"</span><span class="token punctuation">)</span>
    <span class="token comment"># datetime from unix timestamp</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"desc"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"desc"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"event"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"event"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"date"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">"tst"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> chinaTz<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>
                <span class="token string">"%m/%d"</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"time"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">"tst"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> chinaTz<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>
                <span class="token string">"%H:%M"</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"datetime"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">"tst"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> chinaTz<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>
                <span class="token string">"%m/%d %H:%M"</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"tst"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"tst"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> data
    <span class="token punctuation">]</span>
    <span class="token comment"># remove item with same time</span>
    masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tst"</span><span class="token punctuation">]</span> <span class="token operator">-</span> data<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tst"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">120</span> <span class="token keyword">and</span> \
           data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"desc"</span><span class="token punctuation">]</span> <span class="token operator">==</span> data<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"desc"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            masks<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
            masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"event"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> data<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"event"</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>item <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token comment"># group by time</span>
    grouped <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token string">"date"</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> grouped<span class="token punctuation">:</span>
            grouped<span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">"date"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        grouped<span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">"date"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>

    result <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            date<span class="token punctuation">,</span>
            <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                <span class="token punctuation">[</span>
                    <span class="token string-interpolation"><span class="token string">f"    </span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\t</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">[</span><span class="token string">'event'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\t</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">[</span><span class="token string">'desc'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token keyword">for</span> item <span class="token keyword">in</span> items
                <span class="token punctuation">]</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">for</span> date<span class="token punctuation">,</span> items <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>grouped<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>y <span class="token keyword">for</span> x <span class="token keyword">in</span> result <span class="token keyword">for</span> y <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain; charset=utf-8"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span></code></pre></div>
<p>最终展示效果大概就是这样子：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">07/18
    09:11	leave	home
    12:22	enter	gym
    13:41	leave	gym
    15:00	enter	office
07/17
    09:11	leave	home
    12:22	enter	gym
    13:41	leave	gym
    15:00	enter	office
    17:00 leave office</code></pre></div>
<p>这个 server 的代码也放到了 <a href="https://github.com/aisensiy/owntracks-server">owntracks-server</a>。</p>
<h2 id="遇到的坑" style="position:relative;">遇到的坑<a href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91" aria-label="遇到的坑 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>很久之前就处理过这种坐标数据，还是有不少坑的。趁这次再次接触到也做一个记录。</p>
<h3 id="ping-pang-问题" style="position:relative;">ping-pang 问题<a href="#ping-pang-%E9%97%AE%E9%A2%98" aria-label="ping pang 问题 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>经纬度坐标貌似并不是非常稳定，会有误差，你在同一个位置可能会有不同的坐标，这就会导致你可能动都没动但是突然你就离开了一个地方然后又回到了这个地方。</p>
<p>对于这种情况就只能做个简单的过滤，把那些时间戳非常接近的事件直接忽略掉。当然，这种过滤也可以顺便把你路过的那种地点一并清理掉。</p>
<h3 id="坐标系转换" style="position:relative;">坐标系转换<a href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%8D%A2" aria-label="坐标系转换 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>出于一些特殊的考虑，不同的地图给的具体经纬度都是有区别的，就是说你所在的同一个位置对于不同的地图给你标记的经纬度是不同的。目前有三个主流的坐标系：</p>
<ol>
<li>WGS84 坐标系	地球坐标系，国际通用坐标系</li>
<li>GCJ02 坐标系	火星坐标系，WGS84 坐标系加密后的坐标系；Google 国内地图、高德、QQ 地图 使用</li>
<li>BD09 坐标系	百度坐标系，GCJ02 坐标系加密后的坐标系</li>
</ol>
<p>在我 iphone 上我的实际位置和地图标记的位置是有偏差的，我想这应该是苹果没有考虑到中国和国外使用的坐标系是不同的，也就是说 iOS 给我获取的经纬度应该是 WGS84 的，但实际展示却用了 GCJ02 的高德地图，所以展示的位置就不对了。我猜测这也很有可能是快捷指令无法触发的原因所在。</p>
<p>在目前的情况下，这个问题只是对 app 本身的展示有影响，对事件触发并没有影响。可以先不管。</p>
<h2 id="后续的工作" style="position:relative;">后续的工作<a href="#%E5%90%8E%E7%BB%AD%E7%9A%84%E5%B7%A5%E4%BD%9C" aria-label="后续的工作 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ol>
<li>做一些基本的统计，比如通勤时间、比如办公时间</li>
<li>除了区域事件外也试试其他的数据，比如去自动发现停留区域，比如集成地图 api 展示具体的停留区域等</li>
<li>把数据直接塞进 <code>data.jsonl</code> 时间久了可能还是不太够，还是需要起码按照月份做个数据拆分</li>
</ol></div></div><hr class="mt-8"/></div><div class="flex justify-center mt-8"><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/1/">Previous</a><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/3/">Next</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-31932181-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-31932181-2', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/page/2/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-de470b8af9ac1c5aef33.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-5ab169558a5e9159e518.js\"],\"component---src-pages-about-js\":[\"/component---src-pages-about-js-b813d1ca9b4d950c2803.js\"],\"component---src-pages-archive-js\":[\"/component---src-pages-archive-js-e0e5e24e1e0ad5ad21b4.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-360aab752fb4821876db.js\"],\"component---src-pages-serials-js\":[\"/component---src-pages-serials-js-9163dfeba28e49ca8bbf.js\"],\"component---src-pages-tags-js\":[\"/component---src-pages-tags-js-0e7b88a7fad569293f85.js\"],\"component---src-templates-blog-js\":[\"/component---src-templates-blog-js-ea67f840c73a80025c06.js\"],\"component---src-templates-blogs-js\":[\"/component---src-templates-blogs-js-912ca61c17d2494dbe4a.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="9fc01686764c243a4b23";</script><script src="/webpack-runtime-5545472214425491217c.js" async></script><script src="/framework-f08798099596cbb53a9a.js" async></script><script src="/app-de470b8af9ac1c5aef33.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>
<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.52ec71851d565cb9d8bd.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! tailwindcss v2.2.4 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}body{background-color:rgba(255,255,255,var(--tw-bg-opacity))}.dark body,body{--tw-bg-opacity:1}.dark body{background-color:rgba(55,65,81,var(--tw-bg-opacity))}body{transition-duration:.15s;transition-duration:.5s;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.main .permalink{fill:currentColor;--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.dark .main .permalink{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.main{color:rgba(31,41,55,var(--tw-text-opacity))}.dark .main,.main{--tw-text-opacity:1}.dark .main{color:rgba(229,231,235,var(--tw-text-opacity))}.main h1{font-size:1.875rem;font-weight:800;letter-spacing:-.025em;line-height:2.25rem;margin-bottom:1rem;margin-top:1rem}@media (min-width:768px){.main h1{font-size:2.25rem;line-height:2.5rem}}.main h2{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));margin-bottom:1rem}.dark .main h2{--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity))}.main :not(pre)>code{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity));color:rgba(107,114,128,var(--tw-text-opacity));font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;margin-left:.25rem;margin-right:.25rem;padding-left:.25rem;padding-right:.25rem}.main{overflow-wrap:break-word}.blog-post-content h2{font-size:1.5rem;font-weight:800;letter-spacing:-.025em;line-height:2rem;margin-bottom:.75rem;margin-top:.75rem}@media (min-width:768px){.blog-post-content h2{font-size:1.875rem;line-height:2.25rem}}.blog-post-content h3{font-size:1.25rem;font-weight:800;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem}@media (min-width:768px){.blog-post-content h3{font-size:1.5rem;line-height:2rem}}.blog-post-content h4{font-weight:800;letter-spacing:-.025em;margin-bottom:.75rem;margin-top:.75rem}@media (min-width:768px){.blog-post-content h4{font-size:1.25rem;line-height:1.75rem}}.main ol,.main ul{margin-bottom:1rem;margin-left:1rem}.main ul{list-style-type:disc}.main ol{list-style-position:inside;list-style-type:decimal}.main a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.dark .main a{--tw-text-opacity:1;color:rgba(96,165,250,var(--tw-text-opacity))}.main a:hover{text-decoration:underline}.main img{--tw-border-opacity:1;--tw-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);border-color:rgba(229,231,235,var(--tw-border-opacity));border-radius:.75rem;border-width:1px;box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.main blockquote{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity));border-left-width:4px;padding-left:1.5rem}.main p,.table-of-content{margin-bottom:1rem}.table-of-content{--tw-border-opacity:1;border-color:rgba(59,130,246,var(--tw-border-opacity));border-width:1px;display:inline-block;margin-top:1rem;overflow:auto}.dark .table-of-content{--tw-border-opacity:1;border-color:rgba(30,64,175,var(--tw-border-opacity))}.table-of-content{--tw-bg-opacity:1;background-color:rgba(191,219,254,var(--tw-bg-opacity))}.dark .table-of-content{--tw-bg-opacity:1;background-color:rgba(59,130,246,var(--tw-bg-opacity))}.table-of-content{padding:1rem}.main .table-of-content a{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.dark .main .table-of-content a{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.table-of-content ul{margin-bottom:0}.table-of-content h2{font-size:1.25rem;font-weight:600;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem}.table-of-content p{display:inline;margin:0}.bottom-0{bottom:0}.m-0{margin:0}.mx-4{margin-left:1rem;margin-right:1rem}.mx-12{margin-left:3rem;margin-right:3rem}.mx-auto{margin-left:auto;margin-right:auto}.my-4{margin-bottom:1rem;margin-top:1rem}.mt-8{margin-top:2rem}.mb-4{margin-bottom:1rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.h-5{height:1.25rem}.w-5{width:1.25rem}.w-32{width:8rem}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.list-decimal{list-style-type:decimal}.flex-row{flex-direction:row}.justify-center{justify-content:center}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(.25rem*var(--tw-space-y-reverse));margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(2rem*var(--tw-space-y-reverse));margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)))}.overflow-auto{overflow:auto}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-l-4{border-left-width:4px}.border-solid{border-style:solid}.border-gray-200{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity))}.border-gray-800{--tw-border-opacity:1;border-color:rgba(31,41,55,var(--tw-border-opacity))}.border-blue-500{--tw-border-opacity:1;border-color:rgba(59,130,246,var(--tw-border-opacity))}.dark .dark\:border-blue-800{--tw-border-opacity:1;border-color:rgba(30,64,175,var(--tw-border-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.bg-gray-900{--tw-bg-opacity:1;background-color:rgba(17,24,39,var(--tw-bg-opacity))}.bg-blue-200{--tw-bg-opacity:1;background-color:rgba(191,219,254,var(--tw-bg-opacity))}.dark .dark\:bg-gray-700{--tw-bg-opacity:1;background-color:rgba(55,65,81,var(--tw-bg-opacity))}.fill-current{fill:currentColor}.p-4{padding:1rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-bottom:.25rem;padding-top:.25rem}.py-12{padding-bottom:3rem;padding-top:3rem}.text-center{text-align:center}.font-serif{font-family:ui-serif,Georgia,Cambria,Times New Roman,Times,serif}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.font-semibold{font-weight:600}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-black{font-weight:900}.leading-7{line-height:1.75rem}.tracking-tight{letter-spacing:-.025em}.text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.text-blue-600{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.hover\:underline:hover{text-decoration:underline}*,:after,:before{--tw-shadow:0 0 #0000;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.transition{transition-duration:.15s;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}@media (min-width:768px){.md\:fixed{position:fixed}.md\:absolute{position:absolute}.md\:ml-80{margin-left:20rem}.md\:h-full{height:100%}.md\:w-80{width:20rem}.md\:max-w-6xl{max-width:72rem}.md\:p-8{padding:2rem}.md\:text-left{text-align:left}.md\:text-xl{font-size:1.25rem;line-height:1.75rem}.md\:text-2xl{font-size:1.5rem;line-height:2rem}.md\:text-3xl{font-size:1.875rem;line-height:2.25rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}</style><meta name="generator" content="Gatsby 3.9.1"/><title data-react-helmet="true">aisensiy-s-blog</title><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><style type="text/css">
    .custom-class.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .custom-class.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .custom-class svg,
    h2 .custom-class svg,
    h3 .custom-class svg,
    h4 .custom-class svg,
    h5 .custom-class svg,
    h6 .custom-class svg {
      visibility: hidden;
    }
    h1:hover .custom-class svg,
    h2:hover .custom-class svg,
    h3:hover .custom-class svg,
    h4:hover .custom-class svg,
    h5:hover .custom-class svg,
    h6:hover .custom-class svg,
    h1 .custom-class:focus svg,
    h2 .custom-class:focus svg,
    h3 .custom-class:focus svg,
    h4 .custom-class:focus svg,
    h5 .custom-class:focus svg,
    h6 .custom-class:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><link as="script" rel="preload" href="/webpack-runtime-5e8236aef6fd945f2691.js"/><link as="script" rel="preload" href="/framework-e728256d7a1d703d32c2.js"/><link as="script" rel="preload" href="/app-7decc5285b369d37659c.js"/><link as="script" rel="preload" href="/75ce8a9e25edca21eb9c1a1dab0250d3ee550bef-e9b300a9f21137291b3a.js"/><link as="script" rel="preload" href="/component---src-templates-blogs-js-49c4c7b7e8475895eb83.js"/><link as="fetch" rel="preload" href="/page-data/page/16/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="md:text-left text-center md:fixed md:w-80 bg-gray-900 md:h-full text-white"><div class="p-4 mx-auto text-center"><button aria-label="Activate Light Mode" title="Activate Light Mode" class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" role="img"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button></div><div class="md:absolute bottom-0 py-12 mx-12 space-y-8"><h1 class="text-6xl font-black font-serif">Eisen&#x27;s Blog</h1><nav><ul class="text-md flex-row"><li><a class="leading-7 block hover:underline" href="/">Home</a></li><li><a class="leading-7 block hover:underline" href="/about">About</a></li><li><a class="leading-7 block hover:underline" href="/archive">Archive</a></li><li><a href="https://github.com/aisensiy" target="_blank" rel="noreferrer" class="leading-7 block hover:underline">GitHub</a></li></ul></nav><footer class="text-gray-400">© <!-- -->2021<!-- -->. All rights reserved.</footer></div></div><div class="md:ml-80 p-4 md:p-8 md:max-w-6xl main"><div><div><h1><a href="/spring-boot-get-started">Spring Boot Getting Started</a></h1><h2>2017 May-03</h2><div class="blog-post-content"><p>前一阵子去了联想的项目去做性能调优，顺便也正儿八经的接触了一下 spring boot 的体系（当然也使用了很多 spring cloud 的内容，这个以后再讲）。这里简单的对比一下它和我之前主要使用的 jersey 体系，讲一下我看到的它们两者之间的差异以及 spring boot 相比 jersey 的一些优势和个别的不足。</p>
<p>再次回到 <code class="language-text">spring</code> 的主题也是感慨万千，这让我想起来本科时候刚开始接触 web 开发的情况。那时候 <code class="language-text">spring + hibernate + structs</code> 是 web 开发的主流框架。不过鉴于当时我自己水平有限，<code class="language-text">spring</code> 的水平基本上提留在了 <code class="language-text">Spring in Action</code> 前三章的水平。在经历了 PHP Python（Django），ruby（Rails），Jersey 之后又能回到 Spring 不得不说 Pivotal 旗下的 Spring 团队功不可没。Spring boot 自己的 Reference 所说的，Spring boot 给了开发者一个很好的 getting started 的体验并且并且了大量 xml 配置的实现方式，本来我以为之前我所看到的如此简洁的 <code class="language-text">main</code> 只是因为是 demo 但是当我看到联想这边的生产代码也依然优雅的时候敬畏之心油然而生。</p>
<h2 id="spring-拥有完备的生态体系" style="position:relative;">spring 拥有完备的生态体系<a href="#spring-%E6%8B%A5%E6%9C%89%E5%AE%8C%E5%A4%87%E7%9A%84%E7%94%9F%E6%80%81%E4%BD%93%E7%B3%BB" aria-label="spring 拥有完备的生态体系 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>目前来看 Spring 的体系非常的完备，一方面其核心 DI 和 AOP 组件本来就是 java 语言的标配，再加上与各种持久化框架、模板引擎的完美整合已经称得上包罗万象。另一方面，微服务架构逐渐成为主流的今天，spring cloud 体系的构建也非常的及时，大量的组件解决了云环境、微服务的诸多问题。与 spring  强大的生态相比，jersey 作为一个纯粹的 web framework 来说实在是太无力了，并且其与其他模块的组合也显得捉襟见肘。jersey 自己采用一个叫做 <code class="language-text">hk2</code> 的依赖注入框架，它用起来并不那么方便，在之前的多个项目中，我们甚至需要把 hk2 和 guava 的容器建立一个 bridge 才能让它们一起工作，需要大量的模板代码，我曾经试图把之前遗留的模板代码进行重构但由于担心影响到生产环境的稳定性最终还是放弃了。</p>
<h2 id="jersey-的-sub-resource" style="position:relative;">Jersey 的 sub resource<a href="#jersey-%E7%9A%84-sub-resource" aria-label="jersey 的 sub resource permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>当时和 Jersey 相比，Spring MVC 绝对是 spring 体系中的一个弱势。Jersey 实现了 <code class="language-text">JAX-RS</code> 的标准，很明显这套标注的实现比 Spring MVC 的要好用，并且 jersey 中有一个非常重要的概念：sub resource，它允许一个 <code class="language-text">url</code> 进行链式解析。比如下面的 url:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/users/1234/posts/123</code></pre></div>
<p>可以理解为用户 <code class="language-text">1234</code> 的 id 为 <code class="language-text">123</code> 的文章。在 jersey 中，我们可以用一下的方式实现：</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">
<span class="token comment">//UsersApi.java</span>
<span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span> <span class="token comment">// [1]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersApi</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GET</span>
    <span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Context</span> <span class="token class-name">UserRepository</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> users<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@GET</span>
    <span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"{userId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOneUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">,</span> 
                                 <span class="token annotation punctuation">@Context</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserApi</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>   <span class="token comment">// [2] </span>
                            <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">UserNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [3]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//UserApi.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApi</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserApi</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GET</span>
    <span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"posts"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEvaluationsApi</span> <span class="token function">userEvaluationsApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserPostsApi</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//UserPostsApi.java</span>
<span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"projects"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserPostsApi</span><span class="token punctuation">.</span>java <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"{postId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ProjectApi</span> <span class="token function">getPostApi</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"postId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> postId<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@Context</span> <span class="token class-name">PostRepository</span> postRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> postRepository
                <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>postId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserPostApi</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">PostNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//UserPostApi.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserPostApi</span><span class="token punctuation">.</span>java <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Post</span> post<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">UserPostApi</span><span class="token punctuation">(</span><span class="token class-name">Post</span> post<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>post <span class="token operator">=</span> post<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
    <span class="token annotation punctuation">@GET</span>
    <span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Post</span> <span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> post<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>如上所示，四个类 <code class="language-text">UsersApi</code> <code class="language-text">UserApi</code> <code class="language-text">UserPostsApi</code> <code class="language-text">UserPostApi</code> 将整个流程切分成了四块，每个流程按照 url 逐步解析，其中：</p>
<ol>
<li><code class="language-text">UsersApi</code> 为入口（EntryPoint），只有它拥有类级别的 <code class="language-text">@Path</code></li>
<li>当需要进行下一步的 url 处理时，可以主动创建 sub resource</li>
<li>如果当前层次报错，则可以终止 url 的处理</li>
</ol>
<p>而 Spring MVC 则完全不支持这样的方式，和大多数 mvc 框架一样，它只能老老实实的按照 pattern 对整个 url 解析，不论是在处理 <code class="language-text">/users/123</code> 还是处理 <code class="language-text">/users/123/posts/1234</code> 都需要捕捉 <code class="language-text">UserNotFoundException</code> 的异常。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">
<span class="token comment">// UsersApi.java</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersApi</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">UsersApi</span><span class="token punctuation">(</span><span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// UserApi.java</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/users/{userId}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApi</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> GET<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-></span> user<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">UserNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// UserPostsApi.java</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/users/{userId}/posts"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserPostsApi</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PostRepository</span> postRepository<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{postId}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> GET<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token class-name">Post</span> <span class="token function">getPost</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"postId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> postId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userRepository<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> postRepository
                <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>postId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>post <span class="token operator">-></span> post<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">PostNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="将-jersey-和-spring-boot-整合的尝试" style="position:relative;">将 jersey 和 spring boot 整合的尝试<a href="#%E5%B0%86-jersey-%E5%92%8C-spring-boot-%E6%95%B4%E5%90%88%E7%9A%84%E5%B0%9D%E8%AF%95" aria-label="将 jersey 和 spring boot 整合的尝试 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>前面已经提到了 spring 可以和很多其他的框架完美的结合，那么能不能让 jersey 和 spring boot 完美的结合在一起呢？这样的话既拥有了 spring boot 又能拥有 jersey 的 sub resource 的构建方式，一举两得呀。但现实给我泼了桶冷水。</p>
<p>首先，Jersey 自成体系，想要和其他框架结合会产生一定的工程摩擦。Spring mvc 和 spring core 自然是很好的集成了的，但是 jersey 中自己的那个 hk2 依赖注入框架和 spring 就不能那么好的相处了。使用的时候只能将其全部换成 spring 的依赖注入方式。同时 spring mvc 有一个 mock mvc 测试体系，它大大加速的测试的速度，然而它仅仅支持 spring mvc。并且到目前为止，我都没有找到任何一个很好的测试 jersey 的方式，其自身的测试框架在 spring 体系下的结合实例我就没见到过，而其他 mock 的支持也没走通过。</p>
<p>另一方面，spring 体系中 spring mvc 虽然在我看起来还是有很多的缺点，但是它遵循的是大量 web 框架的模式，比如 django 的 <a href="https://docs.djangoproject.com/en/1.11/topics/http/urls/">url dispatcher</a> 比如 rails 的 <a href="http://guides.rubyonrails.org/routing.html">routes</a> 都是类似的 url 映射模式。Spring MVC 同样是沿着 web 的发展趋势一路走来，作为一个历史悠久的框架自然也继承了大多数 web MVC 的特点，也应该会被更多的人所接受，实在是无可厚非。所以，我不知道我自己坚持使用 jersey 是不是会给项目中其他成员带来伤害。</p>
<p>如下所示，jersey 的测试需要将整个 server 启动，采用 <code class="language-text">RANDOM_PORT</code> 的方式进行测试。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span>RANDOM_PORT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersApiTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${local.server.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@MockBean</span>
    <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">RestAssured</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_empty_user_lists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">when</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token string">"aisensiy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>restassured<span class="token punctuation">.</span></span>RestAssured</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">statusCode</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>而 spring mvc 的测试则可以使用 mock mvc 测试速度快，并且支持 <code class="language-text">standaloneSetup</code> 模式，对单个 controller 进行测试。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersApiTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        userRepository <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">UserRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 只对 UsersApi 进行测试</span>
        <span class="token class-name">MockMvc</span> mockMvc <span class="token operator">=</span> <span class="token class-name">MockMvcBuilders</span>
                            <span class="token punctuation">.</span><span class="token function">standaloneSetup</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsersApi</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setControllerAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomizeExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">RestAssuredMockMvc</span><span class="token punctuation">.</span><span class="token function">mockMvc</span><span class="token punctuation">(</span>mockMvc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_empty_user_lists_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">given</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">statusCode</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>当然，优雅的测试是重头戏，后面的文章中会介绍一些我自己发觉的测试的模式。</p>
<h2 id="参考" style="position:relative;">参考<a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ul>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html">Spring Web MVC framework</a></li>
<li><a href="https://www.thoughtworks.com/radar">工程摩擦力 engineering friction</a></li>
<li><a href="https://jersey.java.net/documentation/latest/test-framework.html">Jersey Test Framework</a></li>
<li><a href="https://jersey.java.net/documentation/latest/jaxrs-resources.html">Jersey Resources and Sub-Resources</a></li>
<li><a href="https://docs.djangoproject.com/en/1.11/topics/http/urls/">Django url dispatcher</a></li>
<li><a href="http://guides.rubyonrails.org/routing.html">Rails routes</a></li>
<li><a href="https://hk2.java.net/">HK2</a></li>
</ul></div></div><div><h1><a href="/python-data-science-2">Python Data Science, NumPy 2</a></h1><h2>2017 March-31</h2><div class="blog-post-content"><p>这篇文章延续<a href="/python-data-science-1">Python Data Science, NumPy 1</a>，介绍广播、高级索引以及数组排序。</p>
<h2 id="广播" style="position:relative;">广播<a href="#%E5%B9%BF%E6%92%AD" aria-label="广播 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>广播是在长度不同的数组上执行 ufunc（例如，加法，减法，乘法等）的一组规则。</p>
<p>对于大小相同的 NumPy 数组是逐个元素执行计算的：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
a <span class="token operator">+</span> b
<span class="token comment"># array([5, 6, 7])</span></code></pre></div>
<p>广播允许对不同大小的数组执行这些操作 - 例如，我们可以将一个标量（想象它是一个 0 维数组）和一个数组相加：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">a <span class="token operator">+</span> <span class="token number">5</span>
<span class="token comment"># array([5, 6, 7])</span></code></pre></div>
<p>我们可以认为是这个操作首先把 5 转换为了数组 [5, 5, 5] 然后进行运算。NumPy 广播在实际运算中并没有这么做，但是我们可以借用这个思路来理解广播。</p>
<p>当然，对于更高维的数组也是可以的：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
M <span class="token operator">+</span> a
<span class="token comment"># array([[ 1.,  2.,  3.],</span>
<span class="token comment">#        [ 1.,  2.,  3.],</span>
<span class="token comment">#        [ 1.,  2.,  3.]])</span></code></pre></div>
<p>一维数组 a 在第二维被拉伸（或者说是在第二维被广播）以便匹配 M 的维度。</p>
<p>还有更复杂的情况：即两个数组各自广播后计算：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
a <span class="token operator">+</span> b
<span class="token comment"># array([[0, 1, 2],</span>
<span class="token comment">#        [1, 2, 3],</span>
<span class="token comment">#        [2, 3, 4]])</span></code></pre></div>
<p>事实上，NumPy 是严格按照一些规则进行广播运算的：</p>
<ul>
<li>规则1：如果连个数组的维度不同，那么维度较少的数组在自己当前维度的前面填充长度为 1 的维度。</li>
<li>规则2：如果两个数组任意一个维度的长度不符，那么在这个维度上长度为 1 的那个数组在该维度上进行拉伸，即填充同样的数据以适应另一个数组。</li>
<li>规则3：如果任意维度上长度不等，但两个数组在该维度的长度都不是 1，则报错</li>
</ul>
<p>下面用几个例子进行说明。</p>
<h3 id="示例-1" style="position:relative;">示例 1<a href="#%E7%A4%BA%E4%BE%8B-1" aria-label="示例 1 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
M <span class="token operator">+</span> a</code></pre></div>
<p>其中</p>
<ul>
<li>M.shape = (2, 3)</li>
<li>a.shape = (3)</li>
</ul>
<p>按照规则 1 a 的维度少，在其前面补充维度：</p>
<ul>
<li>a.shape -> (1, 3)</li>
</ul>
<p>按照规则 2 第一维两者不同，所以对 a 进行拉伸：</p>
<ul>
<li>a.shape -> (2, 3)</li>
</ul>
<p>然后再进行相加。</p>
<h3 id="示例-2" style="position:relative;">示例 2<a href="#%E7%A4%BA%E4%BE%8B-2" aria-label="示例 2 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre></div>
<ul>
<li>a.shape = (3, 1)</li>
<li>b.shape = (3)</li>
</ul>
<p>按照规则 1 b 扩充维度</p>
<ul>
<li>b.shape = (1, 3)</li>
</ul>
<p>按照规则 2 长度为 1 的维度扩充：</p>
<ul>
<li>a.shape = (3, 3)</li>
<li>b.shape = (3, 3)</li>
</ul>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">a <span class="token operator">+</span> b
<span class="token comment"># array([[0, 1, 2],</span>
<span class="token comment">#        [1, 2, 3],</span>
<span class="token comment">#        [2, 3, 4]])</span></code></pre></div>
<h3 id="示例-3" style="position:relative;">示例 3<a href="#%E7%A4%BA%E4%BE%8B-3" aria-label="示例 3 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre></div>
<ul>
<li>M.shape = (3, 2)</li>
<li>a.shape = (3)</li>
</ul>
<p>按照规则 1 扩充 a 的维度</p>
<ul>
<li>a.shape = (1, 3)</li>
</ul>
<p>按照规则 2 a 被拉伸</p>
<ul>
<li>M.shape = (3, 2)</li>
<li>a.shape = (3, 3)</li>
</ul>
<p>然而此时两者的第二维没有一个为 1 但又不相当，按照规则 3 报错。</p>
<h2 id="比较、掩码、布尔运算" style="position:relative;">比较、掩码、布尔运算<a href="#%E6%AF%94%E8%BE%83%E3%80%81%E6%8E%A9%E7%A0%81%E3%80%81%E5%B8%83%E5%B0%94%E8%BF%90%E7%AE%97" aria-label="比较、掩码、布尔运算 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>上一部分介绍了 NumPy 有很多向量化快速运算的 universal functions，但是只介绍了算术运算的那些 ufuncs 实际上还有很多布尔运算的 ufuncs。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
x <span class="token operator">&lt;</span> <span class="token number">3</span>
<span class="token comment"># array([ True,  True, False, False, False], dtype=bool)</span>
x <span class="token operator">==</span> <span class="token number">3</span>
<span class="token comment"># array([False, False,  True, False, False], dtype=bool)</span></code></pre></div>
<p>可以看到这些运算的结果是一个布尔类型的长度相同的数组。布尔数组可以用于很多便捷的运算。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token comment"># 8</span>
np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token comment"># 8</span></code></pre></div>
<p>其中 <code class="language-text">np.count_nonzero</code> 可以用来计算 <code class="language-text">True</code> 元素的个数，当然还可以用 <code class="language-text">np.sum</code> 达到同样的目的，因为 <code class="language-text">False</code> 会被认为是 0 而 <code class="language-text">True</code> 会被转换为 1。</p>
<p>还有一些其他类似的操作：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">np<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">8</span><span class="token punctuation">)</span>
<span class="token comment"># True</span>
np<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># True</span></code></pre></div>
<p>当然，这些运算都可以添加 <code class="language-text">axis</code> 参数按照不同的轴进行运算。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">np<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># array([ True, False,  True], dtype=bool)</span></code></pre></div>
<p><strong>注意</strong> Python 有内置的 <code class="language-text">sum()</code> <code class="language-text">any()</code> 和 <code class="language-text">all()</code> 函数，它们和 NumPy 中的运算略有区别，尤其是在用于多维数组的情况。一定要确保自己用的是 <code class="language-text">np.sum()</code> <code class="language-text">np.any()</code> 以及 <code class="language-text">np.all()</code>。</p>
<p>处理基本的 <code class="language-text">></code> <code class="language-text">&lt;</code> <code class="language-text">!=</code> <code class="language-text">==</code> <code class="language-text">>=</code> <code class="language-text">&lt;=</code> 之外，还可以用 <code class="language-text">&amp;</code>（与） <code class="language-text">|</code>（或） <code class="language-text">^</code>（异或） <code class="language-text">~</code>（否） 进行复合布尔运算。比如</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inches <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>inches <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>就是 <code class="language-text">inches > 0.5</code> 与 <code class="language-text">inches &lt; 1</code> 的 <code class="language-text">与</code> 操作。注意考虑到运算符的优先级，这里的两个括号是必须的。</p>
<p>在前面的部分我们看到可以直接对布尔数组进行聚合。一个更强大的方式是使用布尔数组作为掩码来获取数据本身的特定子集。回到之前的 x 数组，假设我们想要一个数组中所有小于 5 的数据，我们可以这么做：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x<span class="token punctuation">[</span>x <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">]</span></code></pre></div>
<p>结果返回一个一维数组，其元素为满足条件式的所有数据；换言之获取的是所谓索引为 True 的元素。这些运算可以让我们轻易的获取想要的结果。</p>
<h2 id="fancy-indexing" style="position:relative;">Fancy Indexing<a href="#fancy-indexing" aria-label="fancy indexing permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>Fancing indexing 的概念非常简单：用索引数组访问多个数组元素。举一个例子：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
rand <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>RandomState<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

x <span class="token operator">=</span> rand<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># [51 92 14 71 60 20 82 86 74 74]</span></code></pre></div>
<p>如果我们想要访问其中三个元素，我们可以这样做：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">ind <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
x<span class="token punctuation">[</span>ind<span class="token punctuation">]</span>
<span class="token comment"># array([71, 86, 60])</span></code></pre></div>
<p>使用 fancy indexing 的时候，结果的形状与索引数组的形状（而不是原数组的形状）保持一致：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">ind <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
x<span class="token punctuation">[</span>ind<span class="token punctuation">]</span>
<span class="token comment"># array([[71, 86],</span>
<span class="token comment">#        [60, 20]])</span></code></pre></div>
<p>Fancy indexing 也支持多维数组，看下面这个例子：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">X <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># array([[ 0,  1,  2,  3],</span>
<span class="token comment">#        [ 4,  5,  6,  7],</span>
<span class="token comment">#        [ 8,  9, 10, 11]])</span></code></pre></div>
<p>和一般的索引类似，第一个索引对应行，第二个索引对应列：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">row <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
col <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
X<span class="token punctuation">[</span>row<span class="token punctuation">,</span> col<span class="token punctuation">]</span>
<span class="token comment"># array([ 2,  5, 11])</span></code></pre></div>
<p>我们可以把普通索引与 fancy indexing 一起使用：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">X<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># array([10,  8,  9])</span>

X<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># array([[ 6,  4,  5],</span>
<span class="token comment">#        [10,  8,  9]])</span></code></pre></div>
<p>我们还可以把掩码和 fancy indexing 一起使用：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">mask <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
X<span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span><span class="token punctuation">,</span> mask<span class="token punctuation">]</span>
<span class="token comment"># array([[ 0,  2],</span>
<span class="token comment">#        [ 4,  6],</span>
<span class="token comment">#        [ 8, 10]])</span></code></pre></div>
<h2 id="排序" style="position:relative;">排序<a href="#%E6%8E%92%E5%BA%8F" aria-label="排序 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p><code class="language-text">np.sort</code> <code class="language-text">np.argsort</code> 基本就是数组排序的全部内容了，NumPy 中的 np.sort 比 Python 的 sort sorted 要快的多。如果需要进行局部排序参见 <code class="language-text">np.partition</code> 的内容，这里不在赘述了。</p></div></div><div><h1><a href="/python-data-science-1">Python Data Science, NumPy 1</a></h1><h2>2017 March-18</h2><div class="blog-post-content"><p>NumPy（Numerical Python 的简称）提供了 Python 中高效计算的数据结构以及丰富的数据处理方法。Numpy 的 array 和 Python 的 list 接口非常相似，但 Numpy 却要比 list 快的多。NumPy 目前几乎是 Python 整个数据科学工具体系的核心，所以无论数据科学的哪个方面对你感兴趣，花费时间来学习使用 NumPy 的是非常值得的。</p>
<p>我们这里要讲的 NumPy 版本为 <code class="language-text">1.11.1</code> 可以通过如下的方法在 Python  中查看：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy
numpy<span class="token punctuation">.</span>__version__</code></pre></div>
<p>然后使用 NumPy 的时候基本都是用 <code class="language-text">np</code> 作为引入的缩写：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</code></pre></div>
<p>所以后面如果看到 <code class="language-text">np.xxx</code> 的地方就知道是在用 <code class="language-text">numpy</code> 了。</p>
<p>NumPy 这一章节包含两部分内容，一部分讲述其基础数据结构，里面涉及了一些很基础的、大家可能还没有深究的问题，比如为什么它比 Python 的 list 快很多、为什么它用起来和 list 非常相似，这也是这部分重点介绍的部分。另一部分就是介绍 NumPy 中都包含了什么基本的函数，这一部分的很多内容都可以通过文档查询的到，不过这里会讲述一些常用的以及让人迷惑的函数的用法。</p>
<p>虽然我已经尽量略去了那些额外的示例以及大部分人很少涉及到的犄角旮旯，但是这一部分依然会被分割为两个部分进行讲解，这一部分介绍了 NumPy 的基本数据结构以及其快速运算的原理以及基本的数据操作，下一部分介绍 NumPy 的广播运算、高级索引以及排序。</p>
<h2 id="python-的数据类型" style="position:relative;">Python 的数据类型<a href="#python-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-label="python 的数据类型 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<h3 id="python-int-不仅仅是-int" style="position:relative;">Python Int 不仅仅是 Int<a href="#python-int-%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF-int" aria-label="python int 不仅仅是 int permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>Python 属于动态类型语言，其变量在声明时是不需要定义其类型的，并且一个变量也可以被赋值为任意类型。比如：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> <span class="token number">4</span>
x <span class="token operator">=</span> <span class="token string">"four"</span></code></pre></div>
<p>在 Python 中是合法的，而在 C 这样的静态类型语言中这样就会报错：</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
x <span class="token operator">=</span> <span class="token string">"four"</span><span class="token punctuation">;</span></code></pre></div>
<p>动态类型增加了 Python 的易用性，但在实际运算的过程中 Python 的解释器总是要知道当前的这个变量到底存储的是什么类型以便进行相应的计算的，因此 Python 的变量不仅仅包含了数值，也包含了其类型的信息。</p>
<p>默认的 Python 语言是由 C 语言编写，并且 Python 的变量就是一个 C 的结构体。例如当我们在 Python 中定义一个整型：x = 100000，x 不是一个纯粹的整数，它是一个指向一个 C 语言结构体的指针。如果我们查看 Python 3.4 的源码就可以看到实现 Python 中的整型（实际上是长整型）的代码如下（其中的一些 C 语言宏已经被展开了）：</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_longobject</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> ob_refcnt<span class="token punctuation">;</span>
    PyTypeObject <span class="token operator">*</span>ob_type<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> ob_size<span class="token punctuation">;</span>
    <span class="token keyword">long</span> ob_digit<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>可以看到，除了保存了真正的数据的 <code class="language-text">ob_digit</code> 之外，Python 还保存了引用计数器、类型、数据长度这三个信息。</p>
<h3 id="list-也不仅仅是数组" style="position:relative;">List 也不仅仅是数组<a href="#list-%E4%B9%9F%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E6%95%B0%E7%BB%84" aria-label="list 也不仅仅是数组 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>Python 的 list 中的每一个元素可以是不同的类型，比如：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">L3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span></code></pre></div>
<p>是合法的。不过在这里灵活性在需要进行大量的数据操作的时候就成为了一种负担：为了允许动态类型，list 中的每一个元素都需要包含它自己的类型信息、引用计数以及其他信息。在这里所有的变量的类型是一样的，每个元素所包含的类型信息是冗余的，如果可以用固定类型数组来保存则会高效的多。</p>
<h2 id="numpy-数组" style="position:relative;">NumPy 数组<a href="#numpy-%E6%95%B0%E7%BB%84" aria-label="numpy 数组 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>与 Python list 不同，NumPy array 的所有元素类型相同。如果类型不同 NumPy 会进行类型转换（这里，整型被转为浮点类型）：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span></code></pre></div>
<p>如上，我们可以利用 Python 的 list 来创建 Numpy 的数组，也可以利用 NumPy 提供的函数来创建数组：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment"># 创建一个长度为 10，数据类型为整型，数据全为 0 的数组</span>
np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token comment"># 创建一个 3x5 的二维数组，数据类型为浮点型，数据全为 1</span>
np<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">)</span> <span class="token comment"># 创建一个 3x5 的数组，数据全为 3.14</span>

<span class="token comment"># 创建一个由线性序列填充的数组</span>
<span class="token comment"># 从 0 到 20，步长为 2</span>
<span class="token comment"># 与 Python 内建的 range 方法类似</span>
np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 创建一个从 0 到 1 均匀分割为 5 个元素的数组</span>
np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># 采用均匀分布创建一个 3x3 的数组</span>
<span class="token comment"># 默认均匀分布范围从 0 到 1</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 采用高斯分布生成的值填充的 3x3 的数组</span>
<span class="token comment"># 其中高斯分布的均值为 0 标准差为 1</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 创建一个采用 [0, 10] 分为的随机数填充的 3x3 的数组</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 创建一个 3x3 的单位矩阵</span>
np<span class="token punctuation">.</span>eye<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment"># 创建一个未初始化的数组，其中的值为所分配的内存的值</span>
np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre></div>
<h2 id="universal-functions" style="position:relative;">Universal Functions<a href="#universal-functions" aria-label="universal functions permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>NumPy 之所以成为了 Python 数据科学的基础在于其提供了一整套高效计算的方案，前面提到了其固定类型数组所带来的好处，这一部分讲述其通过 universal functions 实现的向量化操作。</p>
<p>默认的 Python 循环是非常缓慢的，虽然有一些其他的 Python 编译方案想要让 Python 的执行速度变得快起来，但是其普及程度都远不如默认的 CPython。例如下面的一个求倒数操作，Python 的执行速度慢的令人发指：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">compute_reciprocals</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">return</span> output

values <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

big_array <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">)</span>
<span class="token operator">%</span>timeit compute_reciprocals<span class="token punctuation">(</span>big_array<span class="token punctuation">)</span>
<span class="token comment"># 1 loop, best of 3: 205 ms per loop</span></code></pre></div>
<p>事实证明，这里的瓶颈不是操作本身，而是 CPython 在循环的每个周期必须进行的类型检查和函数调度。每次计算倒数时，Python 首先检查对象的类型并查找适合该类型的函数来执行计算。如果我们是在编译型的语言中，类型在代码执行之前就已知，那么计算速度就会快得多。</p>
<p>对于许多类型的操作，NumPy 提供了执行这种针对静态类型的编译型的操作，这被称为<em>向量化</em>运算。这可以通过简单地对整个数组执行操作来实现，这相当于对每个元素应用操作。这种向量化方法旨在将循环推入编译层，这是 NumPy 高效运算的基础。看一看对 big_array 的执行速度，与 Python 循环相比，我们看到了数量级的飞跃：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token operator">%</span>timeit <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> big_array<span class="token punctuation">)</span>
<span class="token comment"># 100 loops, best of 3: 4.14 ms per loop</span></code></pre></div>
<p>NumPy中的向量化操作通过 ufuncs 实现，其主要目的是加速 NumPy 数组中的重复操作。与等价的 Python 循环相比使用 ufuncs 的向量化运算基本上都是要快一些，在数组规模比较庞大的时情况下更是如此。当你在 Python 中看到了循环你就应当考虑它是否应当替换为一个向量化的操作。</p>
<p>大多数 Python 的基本运算 NumPy 都对其进行了向量化，即都有对应的 ufuncs：</p>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Equivalent ufunc</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">+</code></td>
<td><code class="language-text">np.add</code></td>
<td>Addition (e.g., <code class="language-text">1 + 1 = 2</code>)</td>
</tr>
<tr>
<td><code class="language-text">-</code></td>
<td><code class="language-text">np.subtract</code></td>
<td>Subtraction (e.g., <code class="language-text">3 - 2 = 1</code>)</td>
</tr>
<tr>
<td><code class="language-text">-</code></td>
<td><code class="language-text">np.negative</code></td>
<td>Unary negation (e.g., <code class="language-text">-2</code>)</td>
</tr>
<tr>
<td><code class="language-text">*</code></td>
<td><code class="language-text">np.multiply</code></td>
<td>Multiplication (e.g., <code class="language-text">2 * 3 = 6</code>)</td>
</tr>
<tr>
<td><code class="language-text">/</code></td>
<td><code class="language-text">np.divide</code></td>
<td>Division (e.g., <code class="language-text">3 / 2 = 1.5</code>)</td>
</tr>
<tr>
<td><code class="language-text">//</code></td>
<td><code class="language-text">np.floor_divide</code></td>
<td>Floor division (e.g., <code class="language-text">3 // 2 = 1</code>)</td>
</tr>
<tr>
<td><code class="language-text">**</code></td>
<td><code class="language-text">np.power</code></td>
<td>Exponentiation (e.g., <code class="language-text">2 ** 3 = 8</code>)</td>
</tr>
<tr>
<td><code class="language-text">%</code></td>
<td><code class="language-text">np.mod</code></td>
<td>Modulus/remainder (e.g., <code class="language-text">9 % 4 = 1</code>)</td>
</tr>
</tbody>
</table>
<p>还有一些额外的函数，这里仅仅展示其中的一部分：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># 绝对值</span>
np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># 三角函数</span>
np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># 指数函数</span>
np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
np<span class="token punctuation">.</span>power<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>

<span class="token comment"># 聚合操作</span>
x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># 15</span>
np<span class="token punctuation">.</span>multiply<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># 120</span>

<span class="token comment"># 外积操作</span>
x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>multiply<span class="token punctuation">.</span>outer<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token comment"># array([[ 1,  2,  3,  4,  5],</span>
<span class="token comment">#        [ 2,  4,  6,  8, 10],</span>
<span class="token comment">#        [ 3,  6,  9, 12, 15],</span>
<span class="token comment">#        [ 4,  8, 12, 16, 20],</span>
<span class="token comment">#        [ 5, 10, 15, 20, 25]])</span></code></pre></div>
<h2 id="numpy-数组的基本操作" style="position:relative;">NumPy 数组的基本操作<a href="#numpy-%E6%95%B0%E7%BB%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C" aria-label="numpy 数组的基本操作 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>NumPy 的数组操作和 Python 的 list 非常的类似，这里从以下几个方面进行介绍：</p>
<ul>
<li><em>数组的属性</em>：长度，维度，内存占用大小，元素的类型</li>
<li><em>数组的索引</em>：获取或修改数组中的单个元素</li>
<li><em>数组的切片</em>：获取或修改数组中的子数组内容</li>
<li><em>数组的重塑（reshape等操作）</em>：更改一个数组的形状</li>
<li><em>数组的连接与分割</em>：连接多个数组或者将单个数组分割为多个数组</li>
</ul>
<h3 id="numpy-的基本属性" style="position:relative;">NumPy 的基本属性<a href="#numpy-%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B1%9E%E6%80%A7" aria-label="numpy 的基本属性 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<ul>
<li><code class="language-text">.ndim</code> 维度</li>
<li><code class="language-text">.shape</code> 每个维度的长度</li>
<li><code class="language-text">.size</code> 整个数组的长度，等于各个维度长度之积</li>
<li><code class="language-text">.dtype</code> 内部数据的类型</li>
<li><code class="language-text">.itemsize</code> 每个元素的字节长度</li>
<li><code class="language-text">.nbytes</code> 整个数组的字节长度，等于 <code class="language-text">.itemsize * .size</code></li>
</ul>
<p>例子：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> x<span class="token punctuation">.</span>ndim
<span class="token keyword">print</span> x<span class="token punctuation">.</span>shape
<span class="token keyword">print</span> x<span class="token punctuation">.</span>size
<span class="token keyword">print</span> x<span class="token punctuation">.</span>dtype
<span class="token keyword">print</span> x<span class="token punctuation">.</span>itemsize
<span class="token keyword">print</span> x<span class="token punctuation">.</span>nbytes</code></pre></div>
<p>其结果：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
(3, 4)
12
int64
8
96</code></pre></div>
<h3 id="numpy-的索引" style="position:relative;">NumPy 的索引<a href="#numpy-%E7%9A%84%E7%B4%A2%E5%BC%95" aria-label="numpy 的索引 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>NumPy 数组的索引和 list 基本一致，也是从零开始计数，也支持负数索引，不过在多元数组时采用逗号分隔的 tuple 类型进行索引（list 采用多个方括号的方式，比如 a[1][2]）：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x1 <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> size<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
x1<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span>
x1<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

x2 <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
x2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12</span></code></pre></div>
<p>当然，NumPy 数组中的类型是一致的，因此赋值其他类型会被强制转换：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3.14</span> <span class="token comment"># 会被转换为 3</span></code></pre></div>
<h3 id="numpy-的数组切片" style="position:relative;">NumPy 的数组切片<a href="#numpy-%E7%9A%84%E6%95%B0%E7%BB%84%E5%88%87%E7%89%87" aria-label="numpy 的数组切片 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>NumPy 数组也支持用 <code class="language-text">:</code> 进行切片操作（slicing），切片的参数格式为</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[start:stop:step]</code></pre></div>
<p>其中如果 start 没有提供则为 0，如果 stop 没有提供则为当前维度的长度，如果 step 没有提供则为 1：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>

x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token comment"># [0, 1, 2, 3, 4]</span>

x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>
<span class="token comment"># [4, 5, 6]</span>

x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment"># [0, 2, 4, 6, 8]</span>

x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment"># [1, 3, 5, 7, 9]</span></code></pre></div>
<p>当 step 为负数时 start 和 stop 的默认值互换。这也是一种将数组倒序的方式：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]</span>

x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment"># [5, 3, 1]</span></code></pre></div>
<p>在对多维数组进行切片时不同维度通过逗号分隔：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x2 <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># array([[9, 2, 7, 6],</span>
<span class="token comment">#       [2, 6, 1, 1],</span>
<span class="token comment">#       [9, 0, 0, 8]])</span>

x2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>

<span class="token comment"># array([[9, 2, 7],</span>
<span class="token comment">#       [2, 6, 1]])</span>

x2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment"># array([[9, 7],</span>
<span class="token comment">#       [2, 1],</span>
<span class="token comment">#       [9, 0]])</span>

x2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># array([[8, 0, 0, 9],</span>
<span class="token comment">#       [1, 1, 6, 2],</span>
<span class="token comment">#       [6, 7, 2, 9]])</span></code></pre></div>
<p>对二维数组获取其某一行或者某一列可以通过全切片与索引配合使用：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>x2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 第一列</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 第一行</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># 第一行，后面的全切片可以省略</span></code></pre></div>
<p><strong>注意</strong> NumPy 的切片是一个引用，而不是像 list 里面的是一个拷贝：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x2_sub <span class="token operator">=</span> x2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x2_sub<span class="token punctuation">)</span>
<span class="token comment"># [[9 2]</span>
<span class="token comment">#  [2 6]]</span>
x2_sub<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x2<span class="token punctuation">)</span>
<span class="token comment"># [[99  2  7  6]</span>
<span class="token comment">#  [ 2  6  1  1]</span>
<span class="token comment">#  [ 9  0  0  8]]</span></code></pre></div>
<p>在处理大规模的数组的时候，这种操作不会带来大量额外的内存开销。在需要使用拷贝的时候可以用下面的方式进行：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x2_sub_copy <span class="token operator">=</span> x2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h3 id="数组的重塑" style="position:relative;">数组的重塑<a href="#%E6%95%B0%E7%BB%84%E7%9A%84%E9%87%8D%E5%A1%91" aria-label="数组的重塑 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>重塑，即修改数组的维度信息。比如把一个长度为 9 的一维数组变为一个 3x3 的二维数组：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>要注意，在 <code class="language-text">reshape</code> 时其创建的新的数组的 <code class="language-text">size</code> 必须和之前的数组一致。reshape 会尽量采用非拷贝的方式来处理初始数组，但是在初始数据没有提供连续的内存空间的时候就无法实施。类似的方法会在处理图像数据时很常见。</p>
<p>重塑方法另一个常用的情况是将一个一维的数组转换为一个二维的行或者列矩阵。可以通过 reshape 或者 newaxis 方法实现。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 用 reshape 创建一个 shape 为 (1, 3) 的二维数组</span>
x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 用 np.newaxis 创建一个 (1, 3) 的二维数组</span>
x<span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment"># 用 reshape 创建一个 (3, 1) 的二维数组</span>
x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 用 newaxis 创建一个 (3, 1) 的二维数组</span>
x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span></code></pre></div>
<p>类似的转换比较常见，尤其是在做机器学习算法中需要将数据扩充为多维数组时。</p>
<h3 id="数组的连接与分割" style="position:relative;">数组的连接与分割<a href="#%E6%95%B0%E7%BB%84%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%B8%8E%E5%88%86%E5%89%B2" aria-label="数组的连接与分割 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3>
<p>一维数组的连接：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># array([1, 2, 3, 3, 2, 1])</span>

z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># [ 1  2  3  3  2  1 99 99 99]</span></code></pre></div>
<p>二维数组的连接：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">grid <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>grid<span class="token punctuation">,</span> grid<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># array([[1, 2, 3],</span>
<span class="token comment">#        [4, 5, 6],</span>
<span class="token comment">#        [1, 2, 3],</span>
<span class="token comment">#        [4, 5, 6]])</span>

<span class="token comment"># 按照第二维连接</span>
np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>grid<span class="token punctuation">,</span> grid<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># array([[1, 2, 3, 1, 2, 3],</span>
<span class="token comment">#       [4, 5, 6, 4, 5, 6]])</span></code></pre></div>
<p>在数组维度不一致的情况下采用 np.vstack 与 np.hstack 更清晰一些：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
grid <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 按照行连接（垂直连接）</span>
np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> grid<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># array([[1, 2, 3],</span>
<span class="token comment">#        [9, 8, 7],</span>
<span class="token comment">#        [6, 5, 4]])</span>

y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 按照列连接（水平连接）</span>
np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">[</span>grid<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># array([[ 9,  8,  7, 99],</span>
<span class="token comment">#        [ 6,  5,  4, 99]])</span></code></pre></div>
<p>类似地，np.dstack 会按照数组的第三维连接。</p>
<p>与连接相反的操作是分割，通过 np.split，np.hsplit，np.vsplit 实现。通过传递一个索引数组说明分割的位置：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">x = [1, 2, 3, 99, 99, 3, 2, 1]
x1, x2, x3 = np.split(x, [3, 5])
print(x1, x2, x3)
# [1 2 3] [99 99] [3 2 1]</code></pre></div>
<p>N 个分割点会生成 N + 1 个子数组。 np.hsplit 与 np.vsplit 类似：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">grid <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
upper<span class="token punctuation">,</span> lower <span class="token operator">=</span> np<span class="token punctuation">.</span>vsplit<span class="token punctuation">(</span>grid<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>upper<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>lower<span class="token punctuation">)</span>

<span class="token comment"># [[0 1 2 3]</span>
<span class="token comment">#  [4 5 6 7]]</span>
<span class="token comment"># [[ 8  9 10 11]</span>
<span class="token comment">#  [12 13 14 15]]</span>

left<span class="token punctuation">,</span> right <span class="token operator">=</span> np<span class="token punctuation">.</span>hsplit<span class="token punctuation">(</span>grid<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span>

<span class="token comment"># [[ 0  1]</span>
<span class="token comment">#  [ 4  5]</span>
<span class="token comment">#  [ 8  9]</span>
<span class="token comment">#  [12 13]]</span>
<span class="token comment"># [[ 2  3]</span>
<span class="token comment">#  [ 6  7]</span>
<span class="token comment">#  [10 11]</span>
<span class="token comment">#  [14 15]]</span></code></pre></div>
<p>类似地, np.dsplit 会按照数组的第三维分割。</p>
<h2 id="聚合操作" style="position:relative;">聚合操作<a href="#%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C" aria-label="聚合操作 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>NumPy 支持各种聚合函数，比如 <code class="language-text">np.max</code> <code class="language-text">np.min</code> <code class="language-text">np.sum</code> <code class="language-text">np.median</code> 这些方法一看就懂，不再一一列举。不过一个比较让人迷惑的点在于如何按照不同的维度进行聚合。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span>
<span class="token comment"># [[ 0.22051857  0.27287109  0.96337129  0.78381157]</span>
<span class="token comment">#  [ 0.24552893  0.39914065  0.70804662  0.80235189]</span>
<span class="token comment">#  [ 0.33662843  0.65632293  0.25875078  0.52569568]]</span></code></pre></div>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>默认的 sum 是将所有维度的值加在一起，而聚合函数接受一个额外的参数 axis 用与指定沿着哪一个维度进行计算。例如我们想要按照列去找每一列的最小值就需要指定 axis=0：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># array([ 0.66859307,  0.03783739,  0.19544769,  0.06682827])</span></code></pre></div>
<p>结果返回四个值，对应四列的最小值。类似的我们可以找到每一行的最大值：</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">M<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># array([ 0.8967576 ,  0.99196818,  0.6687194 ])</span></code></pre></div>
<p>axis 是指那个<strong>将要被处理的维度</strong>，而不是将要返回的维度。因此指定 axis=0 意味着第一个维度是要被处理的维度：对于二维数组磊说，这意味着每一列的数据将要被聚合。也就是说指定的 axis 最终会被变成 1，例如这里的一个 3x4 的数组，如果指定 axis=0 那么第一维会变成 1 所以会成为一个 1x4 的数组，那么就是每一列做了聚合。类似地，如果 axis=1 那么数组会变成一个 3x1 的数组，那么数组就是按照行做了聚合。</p>
<p>大多数聚合函数都能够处理 NaN 数值的情况：计算过程中会忽略这些 NaN 数据，很多对于 NaN 处理的函数是在 NumPy 1.8 之后添加的，旧版本并不支持。</p></div></div><div class="flex justify-center mt-8"><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/15">Previous</a><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/17">Next</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-31932181-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-31932181-2', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/page/16";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f53e78942ac2ddb4ecf0.js"],"app":["/app-7decc5285b369d37659c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-66993b9f94f8c62f0827.js"],"component---src-pages-about-js":["/component---src-pages-about-js-ac7f015d2eb92a2d9a79.js"],"component---src-pages-archive-js":["/component---src-pages-archive-js-8a8f890c3c0c82adf322.js"],"component---src-pages-index-js":["/component---src-pages-index-js-77f905e505de36b88d66.js"],"component---src-templates-blog-js":["/component---src-templates-blog-js-618f624da6564e464c55.js"],"component---src-templates-blogs-js":["/component---src-templates-blogs-js-49c4c7b7e8475895eb83.js"]};/*]]>*/</script><script src="/polyfill-f53e78942ac2ddb4ecf0.js" nomodule=""></script><script src="/component---src-templates-blogs-js-49c4c7b7e8475895eb83.js" async=""></script><script src="/75ce8a9e25edca21eb9c1a1dab0250d3ee550bef-e9b300a9f21137291b3a.js" async=""></script><script src="/app-7decc5285b369d37659c.js" async=""></script><script src="/framework-e728256d7a1d703d32c2.js" async=""></script><script src="/webpack-runtime-5e8236aef6fd945f2691.js" async=""></script></body></html>
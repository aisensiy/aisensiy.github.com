<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.ef146435d2ba23f76dde.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! tailwindcss v2.2.4 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.main h1{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.875rem;font-weight:800;letter-spacing:-.025em;line-height:2.25rem;margin-bottom:1rem;margin-top:1rem}@media (min-width:768px){.main h1{font-size:2.25rem;line-height:2.5rem}}.main :not(pre)>code{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity));color:rgba(107,114,128,var(--tw-text-opacity));font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;margin-left:.25rem;margin-right:.25rem;padding-left:.25rem;padding-right:.25rem}.blog-post-content h2{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.5rem;font-weight:800;letter-spacing:-.025em;line-height:2rem;margin-bottom:.75rem;margin-top:.75rem;overflow:auto}@media (min-width:768px){.blog-post-content h2{font-size:1.875rem;line-height:2.25rem}}.blog-post-content h3{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.25rem;font-weight:800;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem;overflow:auto}@media (min-width:768px){.blog-post-content h3{font-size:1.5rem;line-height:2rem}}.blog-post-content h4{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-weight:800;letter-spacing:-.025em;margin-bottom:.75rem;margin-top:.75rem;overflow:auto}@media (min-width:768px){.blog-post-content h4{font-size:1.25rem;line-height:1.75rem}}.blog-post-content a.anchor{fill:"red"}.main ol,.main ul{margin-bottom:1rem;margin-left:1rem}.main ul{list-style-type:disc}.main ol{list-style-position:inside;list-style-type:decimal}.main a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.main a:hover{text-decoration:underline}.main img{--tw-border-opacity:1;--tw-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);border-color:rgba(229,231,235,var(--tw-border-opacity));border-radius:.75rem;border-width:1px;box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.main blockquote{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity));border-left-width:4px;padding-left:1.5rem}.main p,.table-of-content{margin-bottom:1rem}.table-of-content{--tw-border-opacity:1;--tw-bg-opacity:1;background-color:rgba(219,234,254,var(--tw-bg-opacity));border-color:rgba(107,114,128,var(--tw-border-opacity));border-width:1px;display:inline-block;margin-top:1rem;overflow:auto;padding:1rem}.table-of-content ul{margin-bottom:0}.table-of-content h2{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity));font-size:1.25rem;font-weight:600;letter-spacing:-.025em;line-height:1.75rem;margin-bottom:.75rem;margin-top:.75rem}.table-of-content p{display:inline;margin:0}.bottom-0{bottom:0}.m-0{margin:0}.mx-4{margin-left:1rem;margin-right:1rem}.mx-12{margin-left:3rem;margin-right:3rem}.my-3{margin-bottom:.75rem;margin-top:.75rem}.my-4{margin-bottom:1rem;margin-top:1rem}.mt-8{margin-top:2rem}.mb-4{margin-bottom:1rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.w-32{width:8rem}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.list-decimal{list-style-type:decimal}.flex-row{flex-direction:row}.justify-center{justify-content:center}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(.25rem*var(--tw-space-y-reverse));margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-bottom:calc(2rem*var(--tw-space-y-reverse));margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)))}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-l-4{border-left-width:4px}.border-solid{border-style:solid}.border-gray-200{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity))}.border-gray-500{--tw-border-opacity:1;border-color:rgba(107,114,128,var(--tw-border-opacity))}.border-gray-800{--tw-border-opacity:1;border-color:rgba(31,41,55,var(--tw-border-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.bg-gray-900{--tw-bg-opacity:1;background-color:rgba(17,24,39,var(--tw-bg-opacity))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgba(219,234,254,var(--tw-bg-opacity))}.p-4{padding:1rem}.p-8{padding:2rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-bottom:.25rem;padding-top:.25rem}.py-12{padding-bottom:3rem;padding-top:3rem}.text-center{text-align:center}.font-serif{font-family:ui-serif,Georgia,Cambria,Times New Roman,Times,serif}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.font-semibold{font-weight:600}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-black{font-weight:900}.leading-7{line-height:1.75rem}.tracking-tight{letter-spacing:-.025em}.text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.text-blue-600{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.hover\:underline:hover{text-decoration:underline}*,:after,:before{--tw-shadow:0 0 #0000;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}@media (min-width:768px){.md\:fixed{position:fixed}.md\:absolute{position:absolute}.md\:ml-80{margin-left:20rem}.md\:h-full{height:100%}.md\:w-80{width:20rem}.md\:max-w-6xl{max-width:72rem}.md\:text-left{text-align:left}.md\:text-xl{font-size:1.25rem;line-height:1.75rem}.md\:text-2xl{font-size:1.5rem;line-height:2rem}.md\:text-3xl{font-size:1.875rem;line-height:2.25rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}</style><meta name="generator" content="Gatsby 3.9.1"/><style type="text/css">
    .custom-class.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .custom-class.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .custom-class svg,
    h2 .custom-class svg,
    h3 .custom-class svg,
    h4 .custom-class svg,
    h5 .custom-class svg,
    h6 .custom-class svg {
      visibility: hidden;
    }
    h1:hover .custom-class svg,
    h2:hover .custom-class svg,
    h3:hover .custom-class svg,
    h4:hover .custom-class svg,
    h5:hover .custom-class svg,
    h6:hover .custom-class svg,
    h1 .custom-class:focus svg,
    h2 .custom-class:focus svg,
    h3 .custom-class:focus svg,
    h4 .custom-class:focus svg,
    h5 .custom-class:focus svg,
    h6 .custom-class:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><link as="script" rel="preload" href="/webpack-runtime-740a463c9caefa5269e5.js"/><link as="script" rel="preload" href="/framework-e728256d7a1d703d32c2.js"/><link as="script" rel="preload" href="/app-7172dabcafa34b87636a.js"/><link as="script" rel="preload" href="/component---src-templates-blogs-js-b12ffcc8090f5af651fa.js"/><link as="fetch" rel="preload" href="/page-data/page/11/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="md:text-left text-center md:fixed md:w-80 bg-gray-900 md:h-full text-white"><div class="md:absolute bottom-0 py-12 mx-12 space-y-8"><h1 class="text-6xl font-black font-serif">Eisen&#x27;s Blog</h1><nav><ul class="text-md flex-row"><li><a class="leading-7 block hover:underline" href="/">Home</a></li><li><a class="leading-7 block hover:underline" href="/about">About</a></li><li><a class="leading-7 block hover:underline" href="/archive">Archive</a></li><li><a href="https://github.com/aisensiy" target="_blank" rel="noreferrer" class="leading-7 block hover:underline">GitHub</a></li></ul></nav><footer class="text-gray-400">© <!-- -->2021<!-- -->. All rights reserved.</footer></div></div><div class="md:ml-80 p-8 md:max-w-6xl main"><div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/redux-with-react-router-update">Redux with react router update</a></h1><h2 class="text-gray-600 mb-4">2016 August-17</h2><div class="blog-post-content"><p>之前有写过一篇 <a href="/redux-with-react-router">Redux With React Router</a>，介绍 <code class="language-text">redux</code> 与 <code class="language-text">react-router</code> 结合实现多个视图的 WebApp，但是最近才发现有很多地方已经和之前使用的方式不一样了，这里做一个更新。</p>
<h2 id="use-react-router-without-redux" style="position:relative;">use react-router without redux<a href="#use-react-router-without-redux" aria-label="use react router without redux permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p><code class="language-text">react-router</code> 提供了 <code class="language-text">react</code> 的路由机制，在之前的文章中讲到了它可以和 <code class="language-text">react-router-redux</code> 一起使用。当时的目的是为了将路由的信息传递到 <code class="language-text">redux store</code> 中，在做 <code class="language-text">container component</code> 的 <code class="language-text">connect</code> 时可以通过 <code class="language-text">mapStateToProps</code> 的方式将路由中的信息提供给组件使用。但是随着 <code class="language-text">react-router</code> 的不断更新以及 <code class="language-text">react-router-redux</code> 的定位的不断明确，现在可以不适用 <code class="language-text">react-router-redux</code> 而仅仅用 <code class="language-text">redux-router</code> 完成将路由绑定到 <code class="language-text">container component</code>。而 <code class="language-text">react-router-redux</code> 成为了追朔包含了路由的用户行为的一个工具，而这个功能对于很多应用来说不是很有必要，其官方文档也强调:</p>
<blockquote>
<p>This library is not necessary for using Redux together with React Router. You can use the two together just fine without any additional libraries. It is useful if you care about recording, persisting, and replaying user actions, using time travel. If you don't care about these features, just use Redux and React Router directly.</p>
</blockquote>
<h2 id="采用-withrouter-的高阶组件实现路由的绑定" style="position:relative;">采用 withRouter 的高阶组件实现路由的绑定<a href="#%E9%87%87%E7%94%A8-withrouter-%E7%9A%84%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E8%B7%AF%E7%94%B1%E7%9A%84%E7%BB%91%E5%AE%9A" aria-label="采用 withrouter 的高阶组件实现路由的绑定 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>首先，对于直接在 <code class="language-text">Router</code> 中出现的组件，<code class="language-text">react-router</code> 通过 <code class="language-text">context</code> 的方式为该组件提供了当前路由的信息（如 <code class="language-text">params</code> <code class="language-text">location</code> 等）。但是如果是嵌套在路由创建的组件下的其他容器需要使用路由的信息呢？这个时候就需要用到 <code class="language-text">withRouter</code> 这个由 <code class="language-text">react-router</code> 提供的高阶组件了。在<a href="https://egghead.io/lessons/javascript-redux-using-withrouter-to-inject-the-params-into-connected-components">这里</a> 由 <code class="language-text">redux</code> 的作者提供了一个视频教程介绍了这个方法。可是如果你直接 <code class="language-text">npm install react-router --save</code> 之后就按着作者的来使用的话会发现根本没有 <code class="language-text">params</code> 的参数...原因在于 <code class="language-text">withRouter</code> 这个高阶参数在当前默认的最新版 <code class="language-text">react-router</code> 中根本没有提供这个东西，它仅仅注入了 <code class="language-text">router</code> 方便组件做导航而已...只有明确的指定 <code class="language-text">"react-router": "^3.0.0-alpha.1"</code> 的版本之后才能这么做...坑爹呀。</p>
<h2 id="参考" style="position:relative;">参考<a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ol>
<li><a href="https://egghead.io/lessons/javascript-redux-using-withrouter-to-inject-the-params-into-connected-components">How to use withRouter</a></li>
<li><a href="https://github.com/reactjs/react-router">react-router</a></li>
<li><a href="https://github.com/reactjs/react-router-tutorial">react-router-tutorial</a></li>
</ol></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/learn-wercker">Learn wercker</a></h1><h2 class="text-gray-600 mb-4">2016 June-02</h2><div class="blog-post-content"><p>半年来一直在做一个 PaaS 的项目，比较关注市面上的相关产品。最近发现一个叫做 wercker 的项目，感觉做的还不错，介绍一下。</p>
<h2 id="wercker-要解决的问题" style="position:relative;">wercker 要解决的问题<a href="#wercker-%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98" aria-label="wercker 要解决的问题 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>目前有很多的平台（如 mesos, rancher, kubernetes）都支持以 <code class="language-text">docker image</code> 的形式进行应用的部署，但是却没有很多的工具帮助将 ci/cd 与这些平台进行更好的对接。而 wercker 的口号是 <code class="language-text">From code to container</code>，强调自己可以做 ci/cd 的事情将代码转化为容器。那么之后就可以将这个容器作为交付的内容在需要的环境进行部署了。</p>
<h2 id="wercker-的特性" style="position:relative;">wercker 的特性<a href="#wercker-%E7%9A%84%E7%89%B9%E6%80%A7" aria-label="wercker 的特性 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ol>
<li>
<p>pipeline as cde</p>
<p>wercker 提供一个类似于 <code class="language-text">ansible</code> 的 <code class="language-text">wercker.yml</code> 并提供与 <code class="language-text">ansible</code> 类似的自定义命令来做部署的工作。</p>
<p>自定义命令的功能非常的强大，种类也非常的丰富。例如 <code class="language-text">npm-install</code> 安装 <code class="language-text">node</code> 的依赖，<code class="language-text">internal/docker-push</code> 将生成的 <code class="language-text">image</code> 上传到 <code class="language-text">docker registry</code>，<code class="language-text">marathon-deploy</code> 将应用部署到 <code class="language-text">marathon</code> 平台。</p>
<p>整个 <code class="language-text">pipeline</code> 可以通过这些命令拼装起来，所有的 pipeline 都可以通过一个 <code class="language-text">wercker.yml</code> 文件进行管理。</p>
</li>
<li>
<p>本地环境</p>
<p>wercker 有一个命令行工具 <code class="language-text">wercker-cli</code> 支持在本地通过 <code class="language-text">docker</code> 和 <code class="language-text">wercker-cli</code> 构建一个本地的开发环境，并且支持在本地环境提供 <code class="language-text">backing service</code>。</p>
</li>
<li>
<p>多 vendor 支持</p>
<p>wercker 可以和多个 <code class="language-text">PaaS</code> 对接的，包括 <code class="language-text">heroku</code> <code class="language-text">kubernetes</code> <code class="language-text">marathon</code> <code class="language-text">ecs</code> 等。这一点非常的难能可贵，想象一下，作为一个开发者，当有了类似于 <code class="language-text">ecs</code> 或者 <code class="language-text">heroku</code> 这样的公有云之后再配合 <code class="language-text">wercker</code> 这样的工具可以快速的搭建 <code class="language-text">pipeline</code> 以及完成以前需要花费更多时间才能得到的 <code class="language-text">ci/cd</code> 开发效率真是大大的提升。</p>
</li>
<li>
<p>ui 界面</p>
<p>提供一个 ui 界面管理整个 pipeline</p>
</li>
<li>
<p>与 github &#x26; bitbucket 对接</p>
<p>支持 github bitbucket hook，在有新的 commit 之后自动构建、部署。
管理关键数据，有些数据不适合存放在 <code class="language-text">wercker.yml</code> 中，例如 <code class="language-text">heroku</code> 的 <code class="language-text">accesskey</code>，<code class="language-text">docker-hub</code> 的账号密码。</p>
</li>
</ol>
<h2 id="参考" style="position:relative;">参考<a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p><a href="http://wercker.com">wercker</a></p></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/webpack-redux-minify">Webpack and Redux, minify the output bundle</a></h1><h2 class="text-gray-600 mb-4">2016 May-29</h2><div class="blog-post-content"><p>webpack + redux + react 开发前端最终会将所有的 js 依赖打包成为一个（或者几个，因配置不同而不同）js 文件。虽然 <code class="language-text">webpack</code> 很好的帮助我们解决了依赖的问题，避免了一大堆分散的 js 文件出现在页面里，但是最终打包出来的 js 文件依然会变成所有依赖的 js 的 size 的总和，成为前端页面响应速度的巨大负担。不过通过一些调优可以最大化的减少最终的打包文件的大小并提升运行性能。</p>
<h2 id="dev--production-env" style="position:relative;"><code class="language-text">dev</code> &#x26; <code class="language-text">production</code> env<a href="#dev--production-env" aria-label="dev  production env permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>首先，我们可以通过设定不同的 <code class="language-text">NODE_ENV</code> 环境变量去控制在不同的环境下引入的配置。通过在 <code class="language-text">webpack.config.js</code> 中读取 <code class="language-text">process.env.NODE_ENV</code> 可以为 <code class="language-text">webpack</code> 提供不同的 <code class="language-text">plugin</code> 用于控制 <code class="language-text">webpack</code> 的打包机制。下面是一个例子：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> plugins <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token constant">API_PREFIX</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'"{{API_PREFIX}}"'</span><span class="token punctuation">,</span>
    <span class="token string">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>DedupePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>OccurenceOrderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    compress<span class="token operator">:</span> <span class="token punctuation">{</span>
      warnings<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token constant">API_PREFIX</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'"{{API_PREFIX}}"'</span><span class="token punctuation">,</span>
    <span class="token string">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<p>其中 <code class="language-text">DefinePlugin</code> 可以为 <code class="language-text">webpack</code> 提供全局变量，这里我们利用它将 <code class="language-text">node</code> 中的 <code class="language-text">process.env.NODE_ENV</code> 转换为 <code class="language-text">webpack</code> 构建最终的 <code class="language-text">js</code> 时用到的全局变量。如果直接在 <code class="language-text">webpack</code> 构建时处理的 <code class="language-text">js</code> 文件中直接引用 <code class="language-text">nodejs</code> 才能读取的 <code class="language-text">process.env</code> 是不会有任何效果的。</p>
<p>然后，我们通过这个 <code class="language-text">process.env.NODE_ENV</code> 的不同加载不同的 <code class="language-text">configureStore.js</code>，将在 <code class="language-text">production</code> 环境下用不到的 <code class="language-text">redux</code> 中间件清理掉。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./configureStore.prod'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./configureStore.dev'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">configureStore.prod.js</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">'redux-thunk'</span>
<span class="token keyword">import</span> rootReducer <span class="token keyword">from</span> <span class="token string">'../reducers/index'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span> initialState<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> store<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">configureStore.dev.js</code>:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">'redux-thunk'</span>
<span class="token keyword">import</span> createLogger <span class="token keyword">from</span> <span class="token string">'redux-logger'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rootReducer <span class="token keyword">from</span> <span class="token string">'../reducers/index'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span> initialState<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">,</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> store<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="利用-webpack-插件压缩输出文件" style="position:relative;">利用 <code class="language-text">webpack</code> 插件压缩输出文件<a href="#%E5%88%A9%E7%94%A8-webpack-%E6%8F%92%E4%BB%B6%E5%8E%8B%E7%BC%A9%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6" aria-label="利用 webpack 插件压缩输出文件 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>在各种前端构建工具中都受不了 <code class="language-text">uglify</code> 的过程，<code class="language-text">webpack</code> 也不例外。在上文 <code class="language-text">webpack.config.js</code> 的例子中对 <code class="language-text">production</code> 环境下的 <code class="language-text">webpack</code> 就提供了各种插件用于压缩文件。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  compress<span class="token operator">:</span> <span class="token punctuation">{</span>
    warnings<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h2 id="采用-webpack-bundle-size-analyzer-分析依赖大小" style="position:relative;">采用 <code class="language-text">webpack-bundle-size-analyzer</code> 分析依赖大小<a href="#%E9%87%87%E7%94%A8-webpack-bundle-size-analyzer-%E5%88%86%E6%9E%90%E4%BE%9D%E8%B5%96%E5%A4%A7%E5%B0%8F" aria-label="采用 webpack bundle size analyzer 分析依赖大小 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>如果以上两种优化都做了（尤其是 uglify）那么恭喜你，你的 js 输出文件已经是处理前的三分之一了。我在自己的一个项目中最终的 <code class="language-text">bundle.js</code> 文件从 <code class="language-text">2.2MB</code> 降到了 <code class="language-text">800KB</code> 效果还是非常好的。</p>
<p>但是 <code class="language-text">800KB</code> 还是好大的一个文件，如果还想继续优化呢？那就需要有针对性的进行优化了。我们在开发的过场中依赖了乱七八糟的 <code class="language-text">package</code> 那么是不是能通过减少依赖或者是更换依赖的方式来进一步的减少最终输出文件的大小呢？那么，首先需要知道每个依赖占据的比例了。这里我们采用一个工具 <code class="language-text">webpack-bundle-size-analyzer</code> 分析所有依赖的大小。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g webpack-bundle-size-analyzer</code></pre></div>
<p>然后</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">webpack --json <span class="token operator">|</span> webpack-bundle-size-analyzer</code></pre></div>
<p>就可以看到所有依赖的大小占比了：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">react: 667.34 KB (28.9%)
  fbjs: 33.59 KB (5.03%)
  &lt;self>: 633.74 KB (95.0%)
moment: 454.54 KB (19.7%)
bootstrap: 273.93 KB (11.9%)
jquery: 251.51 KB (10.9%)
react-router: 159.31 KB (6.91%)
  history: 52.69 KB (33.1%)
    deep-equal: 3.8 KB (7.22%)
    query-string: 1.62 KB (3.08%)
      strict-uri-encode: 182 B (10.9%)
      &lt;self>: 1.45 KB (89.1%)
    &lt;self>: 47.26 KB (89.7%)
  warning: 1.76 KB (1.11%)
  invariant: 1.48 KB (0.929%)
  hoist-non-react-statics: 1.35 KB (0.850%)
  &lt;self>: 102.03 KB (64.0%)
formsy-react-components: 36.24 KB (1.57%)
  classnames: 2.58 KB (7.11%)
  &lt;self>: 33.66 KB (92.9%)
superagent: 30.57 KB (1.32%)
  component-emitter: 3.11 KB (10.2%)
  reduce-component: 405 B (1.29%)
  &lt;self>: 27.06 KB (88.5%)
formsy-react: 30.55 KB (1.32%)
  form-data-to-object: 1.19 KB (3.91%)
  &lt;self>: 29.36 KB (96.1%)
axios: 29.18 KB (1.26%)
redux: 25.8 KB (1.12%)
  lodash: 3.34 KB (12.9%)
  symbol-observable: 451 B (1.71%)
  &lt;self>: 22.02 KB (85.4%)
react-redux: 25.54 KB (1.11%)
  lodash: 3.34 KB (13.1%)
  invariant: 1.48 KB (5.80%)
  hoist-non-react-statics: 1.35 KB (5.30%)
  &lt;self>: 19.37 KB (75.8%)
redux-logger: 8.29 KB (0.359%)
style-loader: 6.99 KB (0.303%)
webpack: 3 KB (0.130%)
  node-libs-browser: 2.76 KB (91.8%)
    process: 2.76 KB (100%)
    &lt;self>: 0 B (0.00%)
  &lt;self>: 251 B (8.17%)
object-assign: 1.95 KB (0.0844%)
css-loader: 1.47 KB (0.0638%)
redux-thunk: 306 B (0.0130%)
superagent-prefix: 198 B (0.00838%)
react-dom: 63 B (0.00267%)
&lt;self>: 300.1 KB (13.0%)</code></pre></div>
<p>这里在优化前的输出情况，其中 <code class="language-text">react</code> 最大，占整个输出的 <code class="language-text">28.9%</code>，未压缩前 <code class="language-text">bundle.js</code> 为 <code class="language-text">2.24MB</code>。<code class="language-text">react</code> 是我们的核心依赖，是没什么办法做优化了，但是占比第二高的 <code class="language-text">moment</code> 仅仅是一个用于日期格式化的工具，占比如此之高实在是可疑。通过搜索其他的可选方案，我将 <code class="language-text">moment</code> 替换为 <code class="language-text">date-fns</code>，bundle 文件减小为 <code class="language-text">1.7MB</code> 压缩后文件减小为 <code class="language-text">558KB</code>。</p>
<h2 id="最后的最后" style="position:relative;">最后的最后<a href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%9C%80%E5%90%8E" aria-label="最后的最后 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>如果你真的还觉得太大了...那，就只有靠 nginx 那边做 <code class="language-text">gzip</code> 优化了...</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">gzip  on;
gzip_types      text/plain application/xml text/css text/html application/javascript;</code></pre></div>
<h2 id="参考" style="position:relative;">参考<a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ol>
<li><a href="https://webpack.github.io/docs/optimization.html">webpack optimization</a></li>
<li><a href="http://moduscreate.com/optimizing-react-es6-webpack-production-build/">Optimizing React + ES6 + Webpack Production Build</a></li>
<li><a href="http://stackoverflow.com/questions/17093796/date-formatting-with-without-moment-js">date-format-without-moment</a></li>
<li><a href="http://stackoverflow.com/questions/30030031/passing-environment-dependent-variables-in-webpack">passing-environment-dependent-variables-in-webpack</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html">nginx gzip</a></li>
</ol></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/webpack-with-bootstrap">Webpack with Bootstrap</a></h1><h2 class="text-gray-600 mb-4">2016 May-20</h2><div class="blog-post-content"><p>最近开始利用业余时间采用 <code class="language-text">react + redux</code> 的前端架构山寨一个金数据（或者说是 WuFoo，毕竟两个东西看起来真的很像）以增加自己对这些框架的熟练度。在这个过程中记录下一些自己遇到的坑。今天就是一个 <code class="language-text">webpack</code> 如何和 <code class="language-text">bootstrap</code> 结合的坑。</p>
<p>为了在项目之初就一个不是那么丑的界面，都会选择一些比较成熟的前端 css 框架。<code class="language-text">bootstrap</code> 是比较流行的一个。<code class="language-text">bootstrap</code> 一方面是基本的 <code class="language-text">css</code> 另一方面还有一些 <code class="language-text">jQuery</code> 的插件形式的类库支持其中的一些组件，当然还有一些它所需要的字体文件。那么这里问题就来了：</p>
<ol>
<li>如何在 <code class="language-text">webpack</code> 中引入 <code class="language-text">jQuery</code> 以及它的插件</li>
<li>如何在 <code class="language-text">webpack</code> 引入一些其他类型的文件，例如字体</li>
</ol>
<h2 id="引入-bootstrap" style="position:relative;">引入 bootstrap<a href="#%E5%BC%95%E5%85%A5-bootstrap" aria-label="引入 bootstrap permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>首先，我们还是要安装 <code class="language-text">bootstrap</code> 以及它所依赖的 <code class="language-text">jquery</code>。</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">npm install --save bootstrap-sass jquery</code></pre></div>
<p>这里顺便说一句，虽然 <code class="language-text">jquery</code> 看似过时了，但是它所构建的生态是非常庞大的，尤其是像 <code class="language-text">jquery-ui</code> 这样的东西可以说是一些富交互应用所必须的。那么如何将 <code class="language-text">react</code> 的 <code class="language-text">component</code> 和 <code class="language-text">jquery</code> 的一些组件很好的结合是在选择 <code class="language-text">react</code> 这样的框架之初就考虑进去的。后面在涉及到一些复杂的交互的时候会出现 <code class="language-text">jquery-ui</code> 与 <code class="language-text">react</code> 一起使用的例子。</p>
<p>然后，我们可以在 <code class="language-text">webpack.config.js</code> 中以 entry 的形式引入 <code class="language-text">bootstrap-loader</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">var path = require("path");

module.exports = {
  devtool: 'cheap-module-source-map',
  entry: [
    'bootstrap-loader',
    './index.js'
  ],
  output: {
    path: path.join(__dirname, "dist"),
    filename: "bundle.js"
  },
  module: {
    loaders: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        loader: "babel-loader"
      },
      {
        test: /\.scss$/,
        exclude: /node_modules/,
        loader: "style!css!sass"
      }
    ]
  }
};</code></pre></div>
<p>注意看 <code class="language-text">entry</code> 本来就是一个数组，我们可以在这里引入多个入口。</p>
<h2 id="use-bootstrap-loader" style="position:relative;">Use bootstrap-loader<a href="#use-bootstrap-loader" aria-label="use bootstrap loader permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>做了一番调研之后发现其实没必要自己把所有的事情都做了，有这么一个 <code class="language-text">bootstrap-loader</code> 可以帮助在 <code class="language-text">webpack</code> 的项目中引入 <code class="language-text">bootstrap</code>。</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">npm install --save-dev bootstrap-loader</code></pre></div>
<p>不过单单是安装它是不过的，其实 <code class="language-text">bootstrap-loader</code> 所做的事情就是帮助我们把各种样子的文件引入到我们的项目中，那么为了处理不同类型的文件需要一些其他的 <code class="language-text">loader</code> 的支持（前面的博客有提及 <code class="language-text">webpack</code> 只能处理 <code class="language-text">js</code> 如果需要处理其他类型的东西就需要 <code class="language-text">loader</code> 的帮助）。这里，我们还要引入一大堆的 <code class="language-text">loader</code>。</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">npm install --save-dev resolve-url-loader url-loader file-loader imports-loader</code></pre></div>
<p>其中 <code class="language-text">file-loader</code> 用于加载其他类型的文件，<code class="language-text">url-loader</code> 和 <code class="language-text">file-loader</code> 类似，只是在文件比较小的时候返回 Data Url 的形式。<code class="language-text">resolve-url-loader</code> 和之前提到的 <code class="language-text">sass-loader</code> 一起使用，用于处理 <code class="language-text">sass</code> 中 <code class="language-text">url()</code> 的路径。这些 <code class="language-text">loader</code> 都要和 <code class="language-text">webpack.config.js</code> 中的 <code class="language-text">loaders</code> 配置项配合使用:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">var path = require("path");

module.exports = {
  ...
  module: {
    loaders: [
      ...
      {
        test: /\.woff2?(\?v=[0-9]\.[0-9]\.[0-9])?$/,
        loader: "url?limit=10000"
      },
      {
        test: /\.(ttf|eot|svg)(\?[\s\S]+)?$/,
        loader: 'file'
      }
    ]
  }
};</code></pre></div>
<h2 id="use-imports-loader-to-support-jquery" style="position:relative;">Use imports-loader to support jQuery<a href="#use-imports-loader-to-support-jquery" aria-label="use imports loader to support jquery permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p><code class="language-text">imports-loader</code> 是个很有意思的 <code class="language-text">loader</code> 它定义了一个简单的格式用于引入使用它的类库所需要的依赖。</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">module.exports = {
  ...
  module: {
    loaders: [
      ...
      {
        test: /bootstrap-sass\/assets\/javascripts\//,
        loader: 'imports?jQuery=jquery'
      }
    ]
  }
};</code></pre></div>
<p>如上所示，在 <code class="language-text">webpack.config.js</code> 中加入这样一个 <code class="language-text">loader</code>。其中说明在引入 <code class="language-text">bootstrap</code> 下的 <code class="language-text">javascripts</code> 时，为他们提供 <code class="language-text">jQuery</code> 这样的变量。那么 <code class="language-text">imports-loader</code> 会在引入 <code class="language-text">bootstrap</code> 的 <code class="language-text">js</code> 之前为他们提供如下的代码:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  var jQuery = require('jquery');</code></pre></div>
<p>估计在后续使用 <code class="language-text">jquery</code> 的其他东西的时候还会用到它的。</p>
<h2 id="参考" style="position:relative;">参考<a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<ol>
<li><a href="https://github.com/shakacode/bootstrap-loader">bootstrap-loader</a></li>
<li><a href="https://github.com/webpack/imports-loader">imports-loader</a></li>
<li><a href="https://github.com/webpack/file-loader">file-loader</a></li>
<li><a href="https://github.com/webpack/url-loader">url-loader</a></li>
<li><a href="https://github.com/bholloway/resolve-url-loader">resolve-url-loader</a></li>
</ol></div></div><div><h1 class="text-4xl font-extrabold tracking-tight my-4 text-gray-800"><a href="/ddd-repository">DDD Repository</a></h1><h2 class="text-gray-600 mb-4">2016 May-17</h2><div class="blog-post-content"><p>标题是 <code class="language-text">Repository</code>，但是内容是我如何从错用的 <code class="language-text">Repository</code> 变成了感觉还算对的 <code class="language-text">Repository</code> 的过程。</p>
<h2 id="之前的做法" style="position:relative;">之前的做法<a href="#%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95" aria-label="之前的做法 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>DDD 里面的 <code class="language-text">Repository</code> 是一个处理数据存储或者说是数据持久化的单元。通常一个 <code class="language-text">Aggregate</code> 对应一个 <code class="language-text">Repository</code>。对于通常的 web 服务，很多时候我们都是在与数据存储打交道，以至于很多时候存储就成为了真个应用最关键的逻辑了。那么刚刚接触 DDD 的时候，我就觉得 Repository 就是以前经常使用的类似 DAO 的东西。下面这样的代码经常出现在我们的应用里面。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Application</span> app <span class="token operator">=</span> applicationRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> user<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span>routes<span class="token punctuation">.</span><span class="token function">application</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>其中 <code class="language-text">applicationRepository</code> 管理了对于应用的创建。为了创建我们的对象 <code class="language-text">app</code> 我们将一堆需要的参数扔进一个 <code class="language-text">applicationRepository</code> 这样子的不知道背后是什么鬼实现的黑盒子，出来就是我们想要的东西了。再看另外一个例子。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationRecord</span> <span class="token keyword">implements</span> <span class="token class-name">Application</span><span class="token punctuation">,</span> <span class="token class-name">Record</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeEnv</span><span class="token punctuation">(</span><span class="token class-name">String</span> envName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mapper<span class="token punctuation">.</span><span class="token function">removeEnv</span><span class="token punctuation">(</span>envName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在这里例子里面，<code class="language-text">application</code> 可以有环境变量，在 <code class="language-text">application</code> 中提供了一个 <code class="language-text">removeEnv</code> 的方法，<code class="language-text">mapper</code> 是一个具体的持久层工具 <code class="language-text">Mybatis</code> 需要的东西，可以忽略。当我需要删除环境变量的时候，我只需要做如下的事情。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token class-name">Application</span> app <span class="token operator">=</span> applicationRepository<span class="token punctuation">.</span><span class="token function">ofId</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">removeEnv</span><span class="token punctuation">(</span>envName<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在这里事实上我根本没有显性的调用任何持久化方法，在 <code class="language-text">app</code> 里面持久化就偷偷的帮我把事情做了。然后需要注意的是我的 <code class="language-text">Application</code> 仅仅是一个接口，实现它的是一个 <code class="language-text">ApplicationRecord</code> 它内部通过注入的方式塞进去了 <code class="language-text">Mybatis DataMapper</code> 的东西从而实现了持久化的工作。然后在 <code class="language-text">Mybatis</code> 可以放一个叫做 <code class="language-text">ObjectFactory</code> 的东西使得 <code class="language-text">Mybatis</code> 和 java injector 关联子一起，当从 <code class="language-text">Mybatis</code> 获取对象时 <code class="language-text">Mybatis</code> 会自动的讲所有的依赖注入到这个对象里。</p>
<p>说白了就是<strong>将数据层和模型绑定在一起，持久层做了业务层的事情</strong>。</p>
<h2 id="希望的样子" style="position:relative;">希望的样子<a href="#%E5%B8%8C%E6%9C%9B%E7%9A%84%E6%A0%B7%E5%AD%90" aria-label="希望的样子 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<p>然而我希望的是可以将业务层做成这个样子：</p>
<ol>
<li>没有对什么持久层的依赖，甚至完全不知晓持久层。</li>
<li>领域模型不应该是接口而已，接口不能描述具体的业务行为，我同意接口和实现分离的方式，但是分离的实现也应该是领域模型重要的一部分而不是和持久层放在一起</li>
<li><code class="language-text">Repository</code> 作为和存储打交道的组件应该仅仅是做<strong>持久化</strong>，它就是拿来一个对象，然后存到数据库里，没有任何业务逻辑，没有任何花哨的方法。</li>
</ol>
<h2 id="改进后的样子" style="position:relative;">改进后的样子<a href="#%E6%94%B9%E8%BF%9B%E5%90%8E%E7%9A%84%E6%A0%B7%E5%AD%90" aria-label="改进后的样子 permalink" class="custom-class after"><svg aria-hidden="true" height="20" version="1.1" viewBox="0 0 16 16" width="20"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">interface ApplicationRepository {
    void save(Application application);
    Application ofId(String appId);
}</code></pre></div>
<p>没有什么 <code class="language-text">addEnv</code> <code class="language-text">removeEnv</code> 等等，这些都是 <code class="language-text">Application</code> 自己要做的。<code class="language-text">Mybatis</code> 版本的 <code class="language-text">Repository</code> 具体的 <code class="language-text">mapper</code> 仅仅出现在 <code class="language-text">MybatisApplicationRepository</code> 里面，其他地方都不会出现。按照这个思路把上边的代码修改之后是下面这个样子。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Application</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> user<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
applicationRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span>routes<span class="token punctuation">.</span><span class="token function">application</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>新创建的 <code class="language-text">app</code> 本身就是一个 <code class="language-text">POJO</code> 里面全部都是纯粹的业务代码。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Envs</span> envs<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeEnv</span><span class="token punctuation">(</span><span class="token class-name">String</span> envName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        envs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>envName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">Application</code> 有一个 <code class="language-text">envs</code> 的属性，在调用 <code class="language-text">removeEnv</code> 之后，<code class="language-text">application</code> 的环境变量就更新了。如果需要持久化，就单独调用 <code class="language-text">applicationRepository</code>。</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token class-name">Application</span> app <span class="token operator">=</span> applicationRepository<span class="token punctuation">.</span><span class="token function">ofId</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">removeEnv</span><span class="token punctuation">(</span>envName<span class="token punctuation">)</span><span class="token punctuation">;</span>
applicationRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这样的话持久化就和业务逻辑完全的分离开了，所有的 <code class="language-text">POJO</code> 保证即使没有持久化也都可以正常的运转。领域对象是 <code class="language-text">class</code> 而不是 <code class="language-text">interface</code> 保证了内部的逻辑都是包含在业务层的。</p></div></div><div class="flex justify-center mt-8"><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/10">Previous</a><a class="w-32 text-center px-4 py-1 border mx-4 border-gray-800 border-solid" href="/page/12">Next</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/page/11";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f53e78942ac2ddb4ecf0.js"],"app":["/app-7172dabcafa34b87636a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-66993b9f94f8c62f0827.js"],"component---src-pages-about-js":["/component---src-pages-about-js-6bc175747f9032e0ad2c.js"],"component---src-pages-archive-js":["/component---src-pages-archive-js-eee45a6e83732c56546a.js"],"component---src-pages-index-js":["/component---src-pages-index-js-ff1e3d65c7896de76df4.js"],"component---src-templates-blog-js":["/component---src-templates-blog-js-eab5dfdd85f22c0fa7c8.js"],"component---src-templates-blogs-js":["/component---src-templates-blogs-js-b12ffcc8090f5af651fa.js"]};/*]]>*/</script><script src="/polyfill-f53e78942ac2ddb4ecf0.js" nomodule=""></script><script src="/component---src-templates-blogs-js-b12ffcc8090f5af651fa.js" async=""></script><script src="/app-7172dabcafa34b87636a.js" async=""></script><script src="/framework-e728256d7a1d703d32c2.js" async=""></script><script src="/webpack-runtime-740a463c9caefa5269e5.js" async=""></script></body></html>